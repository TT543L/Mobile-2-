<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EPhone</title>
	<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">
    <link rel="manifest" href="manifest.json">
	<script src="dexie.js"></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
        html { height: 100%; overflow: hidden; }


body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: normal;
    
    background-color: #f0f2f5; 
}


#phone-screen {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: #000; 
}


#status-bar {
    display: none;
}


.header, .qzone-header {
    
    padding-top: calc(15px + env(safe-area-inset-top));
}


#chat-input-area {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

#chat-list-bottom-nav {
     padding-bottom: env(safe-area-inset-bottom);
}


.modal {
    z-index: 1000; 
}



        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 0px 20px 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }

.header .action-btn {
    font-size: 16px; 
    font-weight: 600; 
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }

#world-book-list {
    flex-grow: 1;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    padding-top: 80px;
    margin-top: -80px;
}


#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 80px; 
    padding-bottom: 50px; 
    box-sizing: border-box;
}

        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }


#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden; 
    padding: 10px 15px; 
    padding-top: 110px;
    margin-top: -80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box; 
}

        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }

.message-wrapper.ai .sender-name {
    margin-left: 50px; 
    margin-bottom: 3px;
    position: absolute; 
    top: -16px;       
    left: 0;
}




.message-wrapper {
    display: flex;          
    gap: 8px;               
    align-items: flex-end;  
    position: relative;
    max-width: 90%;         
}


.message-wrapper.ai {
    align-self: flex-start;
    flex-direction: row; 
}


.message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse; 
}


.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.timestamp {
    
    font-size: 11px;
    color: #999;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
    white-space: nowrap; 
    margin-bottom: 5px;  
    flex-shrink: 0;      
}

        .message-bubble.selected::after { content: 'âœ”'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: auto; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    
    top: 100%; 
    margin-top: 5px; 
    left: 0;
    right: 0;
    max-height: 150px;
    overflow-y: auto;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px; 
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px; 
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    
    font-size: var(--chat-font-size, 13px);
    
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }



.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word; 
}


        
        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
      
.message-bubble::after {
    content: "";
    position: absolute;
    width: 20px;  
    height: 20px; 
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 1; 
    z-index: 1;
}
      
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'ðŸ¾'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }


.change-frame-btn {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 10px;
}

#avatar-frame-modal .modal-content {
    height: 70%; 
}

#avatar-frame-modal .modal-body {
    padding: 0;
    display: flex;
    flex-direction: column;
}
      
.frame-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.frame-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
}

.frame-tab.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.frame-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
}

.frame-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
    gap: 15px;
}

.frame-item {
    aspect-ratio: 1 / 1; 
    border: 2px solid transparent;
    border-radius: 10px;
    cursor: pointer;
    background-color: #f0f0f0;
    background-size: cover;
    background-position: center;
    padding: 5px;
    transition: all 0.2s ease;
    position: relative; 
}

.frame-item.selected {
    border-color: var(--accent-color);
    transform: scale(1.05);
}

.frame-item .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.frame-item .preview-frame {
    position: absolute;
    top: -7px;
    left: 0;
    width: 100%;
    height: 100%;
}


#font-preview {
    transition: font-family 0.3s ease;}


#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}


#chat-list-bottom-nav {
    position: absolute; 
    bottom: 0;
	padding-bottom: 50px;
    left: 0;
    width: 100%;
    z-index: 15; 
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}


#qzone-screen {
    background-color: #f0f2f5;
}

.qzone-header {
    
    position: relative;
    z-index: 10; 
    flex-shrink: 0; 
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7); 
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { 
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; 
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qzone-user-info {
    position: absolute;
    bottom: -30px; 
    left: 20px;
    display: flex;
    align-items: flex-end; 
    gap: 10px;
}

.qzone-avatar-container {
    position: relative;
}

#qzone-avatar-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    object-fit: cover;
}

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 5px; 
}


.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; 
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; 
    bottom: 5px; 
}


#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; 
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; 
}

.qzone-edit-btn {
    display: none;
}



#qzone-screen .qzone-header {
    display: none;
}

#qzone-screen.active .qzone-header {
    display: flex;
}


#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-list-item:first-child,
.chat-group-container:first-child {
    margin-top: 10px; 
}






.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; 
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}


.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}


#qzone-posts-list {
    padding: 0 15px 20px 15px; 
    display: flex;
    flex-direction: column;
    gap: 20px; 
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; 
    word-break: break-word; 
}






#post-public-text {
    min-height: 80px; 
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; 
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; 
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; 
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}






.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none; 
}

.post-mode-content.active {
    display: block; 
}




#album-screen {
    background-color: #f0f2f5; 
}


#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); 
    gap: 15px;
}


.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; 
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1; 
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; 
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; 
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}






#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; 
    aspect-ratio: 1 / 1; 
    border-radius: 6px;
    overflow: hidden; 
    background-color: #e9ecef; 
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; 
    cursor: pointer;
}


.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; 
    transition: opacity 0.2s ease;
}


.photo-item:hover .photo-delete-btn {
    opacity: 1;
}




#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw;  
    max-height: 85vh; 
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    
    transition: opacity 0.2s ease-in-out;
}


#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}


#photo-viewer-modal .nav-arrow {
    position: absolute; 
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; 
    font-weight: 100;
    cursor: pointer;
    padding: 10px; 
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; 
}

#photo-viewer-prev-btn {
    left: 5px; 
}

#photo-viewer-next-btn {
    right: 5px; 
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}


#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}









.post-main-content {
    
}


.post-feedback-icons {
    display: flex;
    justify-content: flex-end; 
    align-items: center;
    gap: 12px;
    padding: 8px 0; 
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); 
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}


.action-icon.active {
    color: #ff5252; 
    transform: scale(1.1); 
}

.action-icon.active.favorite {
    color: #ffc107; 
}

.action-icon.active svg {
    fill: currentColor; 
}


.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}



.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; 
    display: flex;
    align-items: center;
    gap: 8px; 
}


.comment-section {
    flex-grow: 1; 
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}


.comment-send-btn {
    flex-shrink: 0; 
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}






.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}


.back-btn-indicator {
    top: 0;
    right: -8px; 
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}






.post-comments-container {
    padding: 10px 0; 
    display: flex;
    flex-direction: column;
    gap: 8px; 
    font-size: 13px; 
}


.comment-item {
    line-height: 1.5;
}


.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; 
}


.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}





.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; 
    padding: 8px 10px; 
    font-size: 13px;
    color: var(--accent-color); 
    background-color: #f0f5fa; 
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; 
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; 
    flex-shrink: 0; 
}






.at-mention-popup {
    position: absolute; 
    bottom: 100%; 
    left: 40px; 
    width: calc(100% - 40px); 
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; 
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}







#favorites-view {
    display: flex;
    flex-direction: column;
}


#favorites-view > .header {
    flex-shrink: 0;
}


#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; 
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}



.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; 
}


.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}


.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; 
}


.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}






.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; 
    position: relative; 
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; 
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; 
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}
#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}




#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}


#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}


.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px; 
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; 
}


#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}


#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}


#favorites-action-bar {
    position: absolute; 
    bottom: 0;
    left: 0;
    right: 0;           
    width: auto;        
    padding: 10px 15px;
    padding-bottom: calc(10px + env(safe-area-inset-bottom)); 
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
    
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}




#chat-interface-screen .header .selection-controls {
    display: none;
}


#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}


#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}


#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}




#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px;   
    font-weight: 300;  
    position: relative;
    top: -1px;         
}






#settings-preview-area {
    width: 100%;
    height: 180px; 
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    gap: 10px; 
    border: 1px solid var(--border-color);
    position: relative; 
}


#settings-preview-area::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    z-index: 1;
    opacity: 0.8;
}


#settings-preview-area .message-wrapper {
    position: relative;
    z-index: 2;
}


#settings-preview-area .message-bubble .avatar {
    width: 30px;
    height: 30px;
}
#settings-preview-area .avatar-with-frame {
     width: 30px;
    height: 30px;
}
#settings-preview-area .avatar-with-frame .avatar-frame {
    width: 44px;
    height: 44px;
    top: -7px;
    left: -7px;
}
#settings-preview-area .message-bubble .timestamp {
    display: none; 
}




.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}



.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}

.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; 
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}





.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px; 
    flex-wrap: wrap; 
}


.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; 
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}






.post-actions-btn {
    margin-left: auto; 
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}


#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}




#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; 
    color: white !important;      
}


#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}




.avatar-group {
    width: 34px;      
    flex-shrink: 0;
    position: relative;
    transition: width 0.2s ease; 
}


.avatar-group.has-frame {
    width: 42px; 
}


.message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 20%;
    object-fit: cover;
}


.avatar-with-frame {
    position: relative;
    width: 34px; 
    height: 34px;
    margin: 0 auto;
    transition: all 0.2s ease; 
}


.avatar-group.has-frame .avatar-with-frame {
    width: 43px; 
    height: 43px;
}


.avatar-with-frame .avatar-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    z-index: 1;
}


.avatar-with-frame .avatar-frame {
    position: absolute;
    width: 52px;
    height: 52px;
    top: -9px;   
    left: -4px;  
    z-index: 2;
    pointer-events: none;
}




.header > span:nth-child(2),
#chat-header-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); 
    
    
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}



#message-editor-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-editor-block {
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
}

.message-editor-block textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.message-editor-block .format-helpers {
    margin-top: 8px;
    margin-bottom: 0; 
}

.message-editor-block .delete-block-btn {
    float: right;
    margin-top: -5px;
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
}



.contact-picker-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.contact-picker-item .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
}
.contact-picker-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: 'âœ”';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}
.contact-picker-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}
.contact-picker-item .name {
    font-weight: 500;
}



#member-management-list {
    padding: 0; 
}

.member-management-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}

.member-management-item .name {
    flex-grow: 1;
    font-weight: 500;
}

.member-management-item .remove-member-btn {
    background-color: #ff3b30;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

#member-management-actions {
    flex-shrink: 0;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#member-management-actions button {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
#member-management-actions #create-new-member-btn {
    background-color: #4cd964; 
}



.message-bubble.is-waimai-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.waimai-card {
    width: 240px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.waimai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.waimai-header .icon {
    width: 20px;
    height: 20px;
}

.waimai-header .title-group {
    display: flex;
    align-items: baseline;
    font-size: 14px;
    color: #8a8a8a;
}
.waimai-header .title-group .brand {
    font-weight: 600;
    color: #555;
    margin-right: 5px;
}
.waimai-header .title-group .separator {
    margin: 0 5px;
}

.waimai-catchphrase {
    font-size: 13px;
    color: #1f1f1f;
    padding: 12px;
}

.waimai-main {
    background-color: #FFD66B; 
    padding: 12px;
    text-align: center;
}

.waimai-main .request-title {
    font-size: 12px;
    color: #856404;
    margin-bottom: 8px;
}

.waimai-main .payment-box {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px 10px;
}

.waimai-main .payment-label {
    font-size: 13px;
    color: #8a8a8a;
}

.waimai-main .amount {
    font-size: 32px;
    font-weight: 700;
    color: #1f1f1f;
    margin: 4px 0 12px 0;
}

.waimai-main .countdown-label {
    font-size: 13px;
    color: #8a8a8a;
}
.waimai-main .countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
}
.waimai-main .countdown-timer span {
    background-color: #333;
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 12px;
}

.waimai-details-btn {
    width: 100%;
    padding: 10px 0;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background-color: #FFC33A;
    color: #49380a;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}





.message-bubble.status-paid .waimai-card {
    border: 2px solid #28a745; 
}
.message-bubble.status-paid .waimai-main .request-title::before {
    content: 'âœ…  ';
}
.message-bubble.status-paid .waimai-main .request-title {
    color: #155724;
    font-weight: 600;
    
    content: "ì œê°€ ê³„ì‚°í–ˆì–´ìš”, ë§›ìžˆê²Œ ì¦ê¸°ì„¸ìš”~" !important;
    display: block;
    margin-bottom: 15px;
}

.message-bubble.status-paid .payment-box {
    display: none; 
}
.message-bubble.status-paid .waimai-details-btn {
    background-color: #28a745;
    color: white;
}


.message-bubble.status-rejected .waimai-card {
    border: 2px solid #dc3545; 
    opacity: 0.8;
}
.message-bubble.status-rejected .waimai-main {
    background-color: #e9ecef;
}
.message-bubble.status-rejected .waimai-main .request-title::before {
    content: 'âŒ ';
}
.message-bubble.status-rejected .waimai-main .request-title {
    color: #721c24;
    font-weight: 600;
    
    content: "ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤" !important;
    display: block;
    margin-bottom: 15px;
}
.message-bubble.status-rejected .payment-box {
    display: none; 
}
 .message-bubble.status-rejected .waimai-details-btn {
    background-color: #6c757d;
    color: white;
}


.message-bubble[class*="status-"] .request-title {
    font-size: 0; 
}
.message-bubble[class*="status-"] .request-title::after {
    font-size: 14px; 
}
.message-bubble.status-paid .request-title::after {
    content: "ì œê°€ ê³„ì‚°í–ˆì–´ìš”, ë§›ìžˆê²Œ ì¦ê¸°ì„¸ìš”~";
}
.message-bubble.status-rejected .request-title::after {
    content: "ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤";
}



.waimai-user-actions {
    display: flex;
    gap: 10px;
    padding: 0 12px 12px 12px; 
    background-color: #fff;
}

.waimai-user-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.waimai-pay-btn {
    background-color: #28a745;
    border-color: #1f7a33;
    color: white;
}
.waimai-pay-btn:hover {
    background-color: #218838;
}

.waimai-decline-btn {
    background-color: #f8f9fa;
    border-color: #ced4da;
    color: #495057;
}
.waimai-decline-btn:hover {
    background-color: #e2e6ea;
}



#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#memories-view,
#contact-picker-screen,
#member-management-screen,
#world-book-editor-screen {  
    background-color: var(--secondary-bg);
}


#api-settings-screen .form-container,
#font-settings-screen .form-container,
#wallpaper-screen .form-container {
    padding-top: 100px;
    margin-top: -80px;
    background-color: var(--secondary-bg);
}


#wallpaper-screen .form-container {
    align-items: center; 
}




#incoming-call-modal .incoming-call-content {
    background-color: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    width: 280px;
    padding: 30px 20px;
    text-align: center;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.caller-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid rgba(255,255,255,0.5);
}

.caller-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
}

.caller-text {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 30px;
}

.incoming-call-actions {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.action-button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}

.call-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-size: 50%;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.call-action-btn:active {
    transform: scale(0.9);
}

.call-action-btn.decline {
    background-color: #ff3b30;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}

.call-action-btn.accept {
    background-color: #4cd964;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
}





#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}


.video-call-top-bar {
    position: absolute;
    top: 0; left: 0; width: 100%;
    padding: 15px 20px;
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    text-align: center;
    box-sizing: border-box;
    pointer-events: none;
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}
.video-call-controls {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    box-sizing: border-box;
}


.video-call-avatar-area {
    flex-grow: 1; 
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    padding-top: 80px; 
    box-sizing: border-box;
    overflow-y: auto; 
}


#participant-avatars-grid {
    display: flex;
    flex-wrap: wrap; 
    justify-content: center;
    align-items: center;
    gap: 15px; 
    max-width: 100%;
}


.participant-avatar-wrapper {
    position: relative;
    text-align: center;
    flex-shrink: 0;
}
.participant-avatar {
    width: 70px;   
    height: 70px;  
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 12px;
    color: #ccc;
}


.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}


#video-call-main {
    flex-shrink: 0; 
    height: 30%;   
    margin: 15px 15px 130px 15px; 
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-sizing: border-box;
}


.control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, background-color 0.2s;
}
.control-btn:active {
    transform: scale(0.9);
}
.control-btn.speak-btn {
    background-color: rgba(255,255,255,0.2);
    background-size: 55%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
}
.control-btn.hangup-btn {
    background-color: #ff3b30;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}
.control-btn.join-btn {
    background-color: #007bff;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
}




.call-message-bubble {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

.call-message-bubble.ai-speech {
    background-color: rgba(255, 255, 255, 0.15);
    align-self: flex-start; 
}

.call-message-bubble.user-speech {
    background-color: #4cd964; 
    align-self: flex-end;   
    text-align: left; 
}



#outgoing-call-screen {
    background-color: #1c1c1e;
    color: white;
    justify-content: center; 
    align-items: center;   
}

.outgoing-call-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.outgoing-call-actions {
    margin-top: 50px; 
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}



.qzone-post-container {
    position: relative; 
    overflow: hidden;   
    border-radius: 12px;
}


.qzone-post-item {
    transition: transform 0.3s ease;
    background-color: var(--secondary-bg); 
    position: relative; 
    z-index: 2;
}


.qzone-post-delete-action {
    position: absolute; 
    top: 0;
    right: 0;
    bottom: 0;
    width: 90px; 
    background-color: #ff3b30; 
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    cursor: pointer;
    z-index: 1; 
}


.qzone-post-item.swiped {
    transform: translateX(-90px); 
}






@keyframes pat-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.pat-animation {
    animation: pat-shake 0.4s ease-in-out;
}


.system-message {
    align-self: center; 
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
}




.message-wrapper.system-pat {
    justify-content: center;
    align-self: center;
    margin: 5px 0;
    max-width: 80%;
}

.message-bubble.system-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}




#chat-input-actions-top {
    display: flex;
    gap: 8px;
    padding: 0 5px;

    
    overflow-x: auto;      
    flex-wrap: nowrap;     
    -webkit-overflow-scrolling: touch; 

    scrollbar-width: none; 
    -ms-overflow-style: none;  
}

#chat-input-actions-top::-webkit-scrollbar {
    display: none; 
}






#chat-header-title-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center; 
    gap: 2px; 
    
    
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    max-width: 60%;
}


#chat-header-title {
    font-size: 16px; 
    font-weight: 600;
    position: static; 
    transform: none;  
    
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}


#chat-header-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}


.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background-color: #4cd964; 
    transition: background-color 0.3s ease;
}


#chat-header-status.busy .status-dot {
    background-color: #cccccc;
}


.status-text {
    font-weight: 500;
}




.memory-card {
    background-color: #fffaf0; 
    border-radius: 12px;
    padding: 15px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border-left: 5px solid #ffb74d; 
    display: flex; 
    flex-direction: column; 
    gap: 8px; 
}


.memory-card .header {
    border-bottom: 1px solid rgba(217, 129, 0, 0.15); 
    padding-bottom: 8px; 
}


.memory-card .header .date {
    font-size: 11px;
    color: #a1887f;
    margin-bottom: 4px; 
}


.memory-card .header .author {
    font-weight: 600;
    color: #d98100;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}


.memory-card .content {
    font-size: 14px;
    line-height: 1.7;
    color: #5d4037;
    white-space: pre-wrap;
}


.countdown-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    text-align: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}
.countdown-card::before {
    content: 'âœ¨';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 50px;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.countdown-card .title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}
.countdown-card .timer {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 15px;
}
.countdown-card .target-date {
    font-size: 12px;
    opacity: 0.8;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 10px;
}


#chat-lock-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 150; 
    display: none; 
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    border-top: 1px solid var(--border-color);
    text-align: center;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#chat-lock-content .lock-text {
    color: var(--text-secondary);
    font-size: 14px;
}
#chat-lock-content .lock-action-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 1px solid var(--accent-color);
    background-color: var(--accent-color);
    color: white;
    cursor: pointer;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent;
    color: var(--accent-color);
}


.message-bubble.is-red-packet .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.red-packet-card {
    width: 220px;
    border-radius: 8px;
    background: linear-gradient(160deg, #F96259, #E44D44);
    color: #ffd700; 
    padding: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.red-packet-card.opened {
    background: linear-gradient(160deg, #d3c4a0, #c4b693);
    cursor: default;
}

.red-packet-card::before {
    content: 'ðŸ§§';
    position: absolute;
    top: -5px;
    left: -5px;
    font-size: 30px;
    opacity: 0.2;
    transform: rotate(-10deg);
}

.rp-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.rp-icon {
    width: 20px;
    height: 20px;
}

.rp-greeting {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rp-type {
    font-size: 11px;
    color: white;
    opacity: 0.8;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 8px;
    margin-top: 8px;
}

.rp-claimed-info {
    font-size: 13px;
    color: white;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.3);
}



.rp-details-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.rp-details-item:last-child {
    border-bottom: none;
}
.rp-details-item .name {
    flex-grow: 1;
    font-weight: 500;
    color: #333;
}
.rp-details-item .amount {
    font-weight: 500;
    color: #555;
}
.rp-details-item .lucky-king-tag {
    font-size: 10px;
    background-color: #ffd700;
    color: #a67c00;
    padding: 2px 5px;
    border-radius: 4px;
    margin-left: 8px;
    font-weight: bold;
}





.message-bubble.is-poll .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}


.poll-card {
    width: 250px;
    background-color: #f9f9f9;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.poll-card.closed {
    background-color: #e9ecef; 
}


.poll-question {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.4;
    word-break: break-word;
}


.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}


.poll-option-item {
    background-color: white;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: background-color 0.2s;
}

.poll-card:not(.closed) .poll-option-item:hover {
    background-color: #f0f8ff;
}


.poll-option-item.voted {
    border-color: var(--accent-color);
    background-color: #e7f3ff;
    font-weight: 500;
}


.poll-option-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 1;
    transition: width 0.3s ease-in-out;
}


.poll-option-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-option-text {
    font-size: 14px;
}

.poll-option-votes {
    font-size: 13px;
    color: #8a8a8a;
    font-weight: 500;
}


.poll-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.poll-total-votes {
    font-weight: 500;
}

.poll-action-btn {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 4px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}
.poll-card.closed .poll-action-btn {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}


.poll-option-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.poll-option-input-wrapper input {
    flex-grow: 1;
}
.poll-option-input-wrapper .remove-option-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #ff3b30;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    flex-shrink: 0;
}




#chat-header-title.typing-status {
    color: var(--text-secondary);
    animation: typing-pulse 1.5s infinite;
    font-style: italic;
}

@keyframes typing-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

#chat-header-title {
    transition: opacity 0.2s ease-in-out;
}

@keyframes message-pop-in {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.animate-in {
  animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
  }


#icon-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}

.icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.change-icon-btn {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
}





#wallpaper-screen .form-container {
    
    min-height: 0; 
}


#wallpaper-preview {
    
    flex-shrink: 0; 
}





#browser-screen {
    background-color: #f8f9fa;
}
#browser-content {
    padding: 20px;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    overflow-y: auto;
    background-color: #f8f9fa;
}
#browser-content .article-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}
#browser-content .article-meta {
    font-size: 13px;
    color: #8a8a8a;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
#browser-content .article-body {
    white-space: pre-wrap;
    word-break: break-word;
}
#browser-content .article-body p {
    margin-bottom: 1em;
}


.message-bubble.is-link-share .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.link-share-card {
    width: 250px;
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px; 
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex; 
    flex-direction: column;
    gap: 8px; 
}
.link-share-card:hover {
    background-color: #f9f9f9;
}

.link-share-card .title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.4;
    color: #1f1f1f;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .description {
    font-size: 13px;
    color: #8a8a8a;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .footer {
    display: flex; 
    align-items: center;
    gap: 6px; 
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px; 
}
.link-share-card .footer-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0; 
}



    </style>
</head>
<body>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">ì›”ìš”ì¼, 1ì›” 1ì¼</div></div>

<div id="app-grid">

    <div class="app-row">
        <div class="app-icon" onclick="showScreen('world-book-screen')">
            <div class="icon-bg">

                <img id="icon-img-world-book" src="https://i.postimg.cc/mZ0vV6tT/IMG-6907.jpg" alt="ì›”ë“œì¸í¬">
            </div>
            <span class="label">ì›”ë“œì¸í¬</span>
        </div>
        <div class="app-icon" onclick="showScreen('chat-list-screen')">
            <div class="icon-bg">

                <img id="icon-img-qq" src="https://i.postimg.cc/gJ7Dz5fj/IMG-6906.jpg" alt="QQ">
            </div>
            <span class="label">QQ</span>
        </div>
    </div>

    <div class="app-row">
        <div class="app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg">

                <img id="icon-img-api-settings" src="https://i.postimg.cc/RhnTNdBR/IMG-6908.jpg" alt="APIì„¤ì •">
            </div>
            <span class="label">APIì„¤ì •</span>
        </div>
        <div class="app-icon" onclick="showScreen('wallpaper-screen')">
            <div class="icon-bg">

                <img id="icon-img-wallpaper" src="https://i.postimg.cc/WbgQy6kg/IMG-6909.jpg" alt="ì™¸ê´€ ì„¤ì •">
            </div>
            <span class="label">ì™¸ê´€ ì„¤ì •</span>
        </div>
        <div class="app-icon" onclick="showScreen('font-settings-screen')">
            <div class="icon-bg">

                <img id="icon-img-font" src="https://files.catbox.moe/j1kn1a.jpeg" alt="ê¸€ê¼´">
            </div>
            <span class="label">ê¸€ê¼´</span>
        </div>
    </div>
</div>

            </div>
          
            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>ì›”ë“œì¸í¬</span><span class="action-btn" id="add-world-book-btn">+</span></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">â€¹</span>
                    <span id="world-book-editor-title">ì›”ë“œì¸í¬ íŽ¸ì§‘</span>
                    <span class="save-btn" id="save-world-book-btn">ì €ìž¥</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">ì±… ì œëª©</label>
                        <input type="text" id="world-book-name-input" placeholder="ì›”ë“œì¸í¬ ì´ë¦„ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">ë‚´ìš©</label>
                        <textarea id="world-book-content-input" placeholder="ì—¬ê¸°ì— ìžì„¸í•œ ì„¸ê³„ê´€ ì„¤ì •ì„ ìž…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">â€¹</span><span>API ì„¤ì •</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">íŒ: ì‚¬ìš©í•˜ë ¤ë©´\"ì´ë¯¸ì§€ ì „ì†¡\"ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´, ë°˜ë“œì‹œ Visionì„ ì§€ì›í•˜ëŠ”(ì‹œê°)ëª¨ë¸ì„ ì„ íƒí•˜ì„¸ìš”, ì˜ˆ:<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>ë˜ëŠ”<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>.</p><div class="form-group"><label for="proxy-url">ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì£¼ì†Œ (ì¶”ê°€í•  í•„ìš” ì—†ìŒ/v1ì˜¤~)</label><input type="text" id="proxy-url" placeholder="ì˜ˆì‹œ: https://api.openai.com"></div><div class="form-group"><label for="api-key">í‚¤ (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">ëª¨ë¸</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">ëª¨ë¸ ê°€ì ¸ì˜¤ê¸°</button>

<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        ë°±ê·¸ë¼ìš´ë“œ ìºë¦­í„° í™œë™ í™œì„±í™”
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            ê²½ê³ :ì´ ê¸°ëŠ¥ì€ API í˜¸ì¶œê³¼ ë¹„ìš©ì„ í˜„ì €í•˜ê²Œ ì¦ê°€ì‹œí‚µë‹ˆë‹¤!
        </p>
    </label>
    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
</div>
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="background-interval-input" style="margin-bottom: 0;">
        ë°±ê·¸ë¼ìš´ë“œ í™œë™ ê°ì§€ ê°„ê²© (ì´ˆ)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            ê¶Œìž¥ ê°’ 60-300.ê°’ì´ í´ìˆ˜ë¡, ë¹„ìš©ì€ ë‚®ì•„ì§€ì§€ë§Œ, ìºë¦­í„° ë°˜ì‘ì€ ëŠë ¤ì§‘ë‹ˆë‹¤.
        </p>
    </label>
    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
</div>

<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AIì°¨ë‹¨ í›„ ëƒ‰ê°ê¸° (ì‹œê°„)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            ì´ ì‹œê°„ ì´í›„ì— ì°¨ë‹¨ëœ AIë§Œ ì¹œêµ¬ ì‹ ì²­ì„ ë‹¤ì‹œ í•  ê¸°íšŒê°€ ìžˆìŠµë‹ˆë‹¤.
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>

<button class="form-button" id="save-api-settings-btn">ì„¤ì • ì €ìž¥</button>
			<hr style="margin:20px 0; opacity:.3">

			<button class="form-button" id="export-data-btn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>

<button class="form-button" id="import-btn">ë°±ì—… íŒŒì¼ ê°€ì ¸ì˜¤ê¸°</button>


<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>

<div id="chat-list-screen" class="screen">
    
    
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen('home-screen')">â€¹</span>
        <span>ë©”ì‹œì§€</span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="ê·¸ë£¹ ì±„íŒ… ìƒì„±"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>

    
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
            
        </div>
    </div>

    
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">â€¹</span> 
            <span>ì¹œêµ¬ í”¼ë“œ</span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="ë°°ê²½">
                    <input type="file" id="qzone-banner-input" accept="image
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>



<div class="form-group">
    <label>ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</label>
    <div id="settings-preview-area">
        
    </div>
</div>


            <div class="form-group">
                <label>ì±„íŒ… ë°°ê²½</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">ë°°ê²½ ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
                    <button type="button" id="remove-bg-btn">ë°°ê²½ ì œê±°</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image
        async function renderFavoritesScreen() {
            
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            
            displayFilteredFavorites(allFavoriteItems);
        }

        

        function resetCreatePostModal() {
            document.getElementById('post-public-text').value = '';
            document.getElementById('post-image-preview').src = '';
            document.getElementById('post-image-description').value = '';
            document.getElementById('post-image-preview-container').classList.remove('visible');
            document.getElementById('post-image-desc-group').style.display = 'none';
            document.getElementById('post-local-image-input').value = '';
            document.getElementById('post-hidden-text').value = '';
            document.getElementById('switch-to-image-mode').click();
        }


async function exportBackup() {
    try {
        const backupData = {
            version: 1, 
            timestamp: Date.now()
        };

        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories 
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
            db.memories.toArray() 
        ]);

        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories 
        });
        
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('ë‚´ë³´ë‚´ê¸° ì„±ê³µ', 'ëª¨ë“  ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤!');

    } catch (error) {
        console.error("ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        await showCustomAlert('ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨', `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    }
}


async function importBackup(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'ì‹¬ê°í•œ ê²½ê³ !',
        'ë°±ì—…ì„ ê°€ì ¸ì˜¤ë©´ ì±„íŒ…, ê²Œì‹œë¬¼, ì„¤ì • ë“± í˜„ìž¬ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì™„ì „ížˆ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ì´ ìž‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤! ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
                await table.clear();
            }

            if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
            if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
            if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
            if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
            if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
            if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
            if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
            if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
            if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
            if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories); 

            if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
            if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
            if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
            if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
        });

        await showCustomAlert('ê°€ì ¸ì˜¤ê¸° ì„±ê³µ', 'ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤! ì•±ì´ ëª¨ë“  ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•˜ê¸° ìœ„í•´ ìƒˆë¡œ ê³ ì³ì§‘ë‹ˆë‹¤.');
        
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
        await showCustomAlert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨', `íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤: ${error.message}`);
    }
}

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                document.getElementById('font-preview').style.fontFamily = '';
                return;
            }
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }

        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = ''; 
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            document.getElementById('font-url-input').value = '';
            document.getElementById('font-preview').style.fontFamily = '';
            alert('ê¸°ë³¸ ê¸€ê¼´ì´ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

async function loadAllDataFromDB() {
    
    const [
        chatsArr,
        apiConfig,
        globalSettings,
        userStickers,
        worldBooks,
        musicLib,
        personaPresets,
        qzoneSettings,
        initialFavorites 
    ] = await Promise.all([
        db.chats.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.userStickers.toArray(),
        db.worldBooks.toArray(),
        db.musicLibrary.get('main'),
        db.personaPresets.toArray(),
        db.qzoneSettings.get('main'),
        db.favorites.orderBy('timestamp').reverse().toArray() 
    ]);
    

    state.chats = chatsArr.reduce((acc, chat) => {

        
        
        if (!chat.isGroup && !chat.status) {
            
            chat.status = {
                text: 'ì˜¨ë¼ì¸',
                lastUpdate: Date.now(),
                isBusy: false
            };
            console.log(`ì´ì „ ìºë¦­í„°ì— "${chat.name}" status ì†ì„±ì´ ë³´ì¶©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        

        
        
        if (!chat.isGroup && !chat.relationship) {
            
            chat.relationship = {
                status: 'friend',
                blockedTimestamp: null,
                applicationReason: ''
            };
            console.log(`ì´ì „ ìºë¦­í„°ì— "${chat.name}" relationship ì†ì„±ì´ ë³´ì¶©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        

    
    if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {}; 
        chat.settings.aiAvatarLibrary = [];
        console.log(`ì´ì „ ìºë¦­í„°ì— "${chat.name}" aiAvatarLibrary ì†ì„±ì´ ë³´ì¶©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    }
    

        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }
        acc[chat.id] = chat;
        return acc;
    }, {});
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };

state.globalSettings = globalSettings || { 
    id: 'main', 
    wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', 
    fontUrl: '', 
    enableBackgroundActivity: false, 
    backgroundActivityInterval: 60,
    blockCooldownHours: 1,
    appIcons: { ...DEFAULT_APP_ICONS } 
};

state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };

    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };

    
    allFavoriteItems = initialFavorites || [];
    
}

        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }


function parseAiResponse(content) {
    const trimmedContent = content.trim();

    
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        
        const matches = trimmedContent.match(/\[(.*?)\]/g);
        
        
        if (matches && matches.length > 1) {
            try {
                let combinedResults = [];
                for (const match of matches) {
                    
                    const parsedArray = JSON.parse(match);
                    if (Array.isArray(parsedArray)) {
                        
                        combinedResults = combinedResults.concat(parsedArray);
                    }
                }
                
                if (combinedResults.length > 0) {
                    console.log("ë¶™ì–´ìžˆëŠ” í˜•ì‹ì˜ JSON êµ¬ë¬¸ ë¶„ì„ ì„±ê³µ:", combinedResults);
                    return combinedResults;
                }
            } catch (e) {
                
                console.warn("ë¶™ì–´ìžˆëŠ” JSON êµ¬ë¬¸ ë¶„ì„ ì‹œë„ ì‹¤íŒ¨, í‘œì¤€ êµ¬ë¬¸ ë¶„ì„ íë¦„ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.", e);
            }
        }
    }

    
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            if (Array.isArray(parsed)) {
                return parsed;
            }
        } catch (e) {
            
        }
    }

    
    if (trimmedContent.startsWith('{') && trimmedContent.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            
            return [parsed]; 
        } catch (e) {
            
        }
    }
    
    
    try {
        const match = content.match(/\[(.*?)\]/s);
        if (match && match[0]) {
            const parsed = JSON.parse(match[0]);
            if (Array.isArray(parsed)) return parsed;
        }
    } catch (e) {
        
    }

    
    const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```'));
    if (lines.length > 0) {
         
        return lines.map(line => ({ type: 'text', content: line }));
    }
    
    
    return [{ type: 'text', content: content }];
}


        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
    
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
}
        window.renderApiSettingsProxy = renderApiSettings;


async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    
    const allChats = Object.values(state.chats).sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ì˜¤ë¥¸ìª½ ìƒë‹¨ í´ë¦­ "+" ë˜ëŠ” ê·¸ë£¹ ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ì±„íŒ… ì¶”ê°€</p>';
        return;
    }

    

    
    allGroups.forEach(group => {
        
        const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
        
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    

    
    allGroups.forEach(group => {
        
        const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
        
        if (groupChats.length === 0) return;

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">â–¼</span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');
        
        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    
    
    const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
    ungroupedOrGroupChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}


function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;

    
    if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[ì¹œêµ¬ ì‹ ì²­] ${chat.relationship.applicationReason || 'ë‹¹ì‹ ì„ ì¹œêµ¬ë¡œ ì¶”ê°€ ìš”ì²­'}</span>`;
    }
    


else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
    lastMsgDisplay = `<span style="color: #dc3545;">[ë‹¹ì‹ ì€ ìƒëŒ€ë°©ì—ê²Œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤]</span>`;
}

    
    
    if (chat.isGroup) {
        
        if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ì‹œìŠ¤í…œ ë©”ì‹œì§€] ${lastMsgObj.content}`; }
        
        else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[ì†¡ê¸ˆ]'; }
        else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ì‚¬ì§„]'; }
        else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[ìŒì„±]'; }
        else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[ì´ëª¨í‹°ì½˜: ${lastMsgObj.meaning}]` : '[ì´ëª¨í‹°ì½˜]'; }
        else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[ì´ë¯¸ì§€]`; }
        else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }

        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
            lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
        }

    } else {
        
        
        const statusText = chat.status?.text || 'ì˜¨ë¼ì¸';
        lastMsgDisplay = `[${statusText}]`;
    }

    const item = document.createElement('div');
    item.className = 'chat-list-item';
    item.dataset.chatId = chat.id;
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
    
    
    item.innerHTML = `
        <img src="${avatar || defaultAvatar}" class="avatar">
        <div class="info">
            <div class="name-line">
                <span class="name">${chat.name}</span>
                ${chat.isGroup ? '<span class="group-tag">ê·¸ë£¹ ì±„íŒ…</span>' : ''}
            </div>
            <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
        </div>
    `;
    
    const avatarEl = item.querySelector('.avatar');
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {
            e.stopPropagation();
            handleUserPat(chat.id, chat.name);
        });
    }
    
    const infoEl = item.querySelector('.info');
    if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
    }

    addLongPressListener(item, async (e) => {
        const confirmed = await showCustomConfirm('ëŒ€í™” ì‚­ì œ', `ì™€ì˜ ì „ì²´ ëŒ€í™”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? "${chat.name}" ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
            delete state.chats[chat.id];
            if (state.activeChatId === chat.id) state.activeChatId = null;
            await db.chats.delete(chat.id);
            renderChatList();
        }
    });
    return item;
}


function renderChatInterface(chatId) {
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;
    exitSelectionMode();
    
    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    
    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
        statusContainer.style.display = 'none';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
        statusContainer.style.display = 'flex';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
        statusTextEl.textContent = chat.status?.text || 'ì˜¨ë¼ì¸';
        statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }
    
    lockOverlay.style.display = 'none';
    chatInputArea.style.visibility = 'visible';
    lockContent.innerHTML = '';

    if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';
        
        let lockHtml = '';
        switch (chat.relationship.status) {
            case 'blocked_by_user':
                
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                lockHtml = `
                    <span class="lock-text">ë‹¹ì‹ ì€\"${chat.name}\"ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.</span>
                    <button id="unblock-btn" class="lock-action-btn">ì°¨ë‹¨ í•´ì œ</button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;">ã€ê°œë°œìž ì§„ë‹¨ íŒ¨ë„ã€‘</strong><br>
                        - ë°±ê·¸ë¼ìš´ë“œ í™œë™ ì „ì²´ ìŠ¤ìœ„ì¹˜: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">ì¼œì§</span>' : '<span style="color: red;">êº¼ì§</span>'}<br>
                        - ì‹œìŠ¤í…œ í•˜íŠ¸ë¹„íŠ¸ íƒ€ì´ë¨¸: ${isSimulationRunning ? '<span style="color: green;">ì‹¤í–‰ ì¤‘</span>' : '<span style="color: red;">ë¯¸ì‹¤í–‰</span>'}<br>
                        - í˜„ìž¬ ìºë¦­í„° ìƒíƒœ: <strong>${chat.relationship.status}</strong><br>
                        - ëƒ‰ì •í•´ì ¸ì•¼ í•¨(ì‹œê°„): <strong>${cooldownHours}</strong><br>
                        - ëƒ‰ì • ê¸°ê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆê¹Œ?: ${isCooldownOver ? '<span style="color: green;">ì˜ˆ</span>' : `<span style="color: orange;">ì•„ë‹ˆìš” (ì•½ ${timeRemainingMinutes}ë¶„ ë‚¨ìŒ)</span>`}<br>
                        - íŠ¸ë¦¬ê±° ì¡°ê±´: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">ì¶©ì¡±ë¨, ë‹¤ìŒ ì‹œìŠ¤í…œ í•˜íŠ¸ë¹„íŠ¸ ëŒ€ê¸°</span>' : '<span style="color: red;">ë¯¸ì¶©ì¡±</span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">ê°•ì œë¡œ ì¹œêµ¬ ì‹ ì²­ ê°ì§€ í•œ ë²ˆ íŠ¸ë¦¬ê±°</button>
                `;
                
                break;
            case 'blocked_by_ai':
                lockHtml = `
                    <span class="lock-text">ë‹¹ì‹ ì€ ìƒëŒ€ë°©ì—ê²Œ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.</span>
                    <button id="apply-friend-btn" class="lock-action-btn">ì¹œêµ¬ ì¶”ê°€ ë‹¤ì‹œ ì‹ ì²­</button>
                `;
                break;
            
            case 'pending_user_approval':
                lockHtml = `
                    <span class="lock-text">\"${chat.name}\"ë‹¹ì‹ ì„ ì¹œêµ¬ë¡œ ì¶”ê°€ ìš”ì²­:<br><i>\"${chat.relationship.applicationReason}\"</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn">ìˆ˜ë½</button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary">ê±°ì ˆ</button>
                `;
                break;

            
            case 'pending_ai_approval':
                lockHtml = `<span class="lock-text">ì¹œêµ¬ ì‹ ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤, ìƒëŒ€ë°©ì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦½ë‹ˆë‹¤...</span>`;
                break;
        }
        lockContent.innerHTML = lockHtml;
    }
    messagesContainer.innerHTML = '';
    
    const chatScreen = document.getElementById('chat-interface-screen');
    chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
    chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5';
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
    initialMessages.forEach(msg => appendMessage(msg, chat, true));
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'ìƒëŒ€ë°©ì´ ìž…ë ¥ ì¤‘ìž…ë‹ˆë‹¤...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
}


        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'ë” ì´ì „ ê¸°ë¡ ë¡œë“œ'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }


function renderWallpaperScreen() { 
    const preview = document.getElementById('wallpaper-preview'); 
    const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
    if (bg && bg.startsWith('data:image')) { 
        preview.style.backgroundImage = `url(${bg})`; 
        preview.textContent = ''; 
    } else if(bg) { 
        preview.style.backgroundImage = bg; 
        preview.textContent = 'í˜„ìž¬ ê·¸ë¼ë°ì´ì…˜ ìƒ‰ìƒ'; 
    }
    
    renderIconSettings();
}

        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

        function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ì˜¤ë¥¸ìª½ ìƒë‹¨ í´ë¦­ "+" ì²« ë²ˆì§¸ ì›”ë“œì¸í¬ ë§Œë“¤ê¸°</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'ë‚´ìš© ì—†ìŒ...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('ì›”ë“œì¸í¬ ì‚­ì œ', `ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?ã€Š${book.name}ã€‹? ì´ ìž‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

        function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }

        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">ì–´ë¥¸ê»˜ì„œëŠ” ì˜¤ë¥¸ìª½ ìƒë‹¨ì„ í´ë¦­í•´ ì£¼ì„¸ìš”\"ì¶”ê°€\"ë˜ëŠ”\"ì—…ë¡œë“œ\"ì²« ë²ˆì§¸ ì´ëª¨í‹°ì½˜ì„ ì¶”ê°€í•´ ë³´ì„¸ìš”!</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('ì´ëª¨í‹°ì½˜ ì‚­ì œ', `ì´ëª¨í‹°ì½˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? "${sticker.name}" ?`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }


function createMessageElement(msg, chat) {
    if (msg.isHidden) {
        return null;
    }

    if (msg.type === 'pat_message') {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble system-bubble'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content;
        wrapper.appendChild(bubble);
        addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        return wrapper;
    }

    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

    if (chat.isGroup && !isUser) {
        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = 'sender-name';
        senderNameDiv.textContent = msg.senderName || 'ì•Œ ìˆ˜ ì—†ëŠ” ë©¤ë²„';
        wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    let avatarSrc, avatarFrameSrc = '';
    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || '';
        } else {
            const member = chat.members.find(m => m.name === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            avatarFrameSrc = member ? (member.avatarFrame || '') : '';
        }
    } else {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || '';
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.aiAvatarFrame || '';
        }
    }
    const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
    let avatarHtml;
    if (avatarFrameSrc) {
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${avatarFrameSrc}" class="avatar-frame">
            </div>
        `;
    } else {
        avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }
    const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

    let contentHtml;
    
    if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share');
        
        
        contentHtml = `
            <div class="link-share-card" data-timestamp="${msg.timestamp}">
                <div class="title">${msg.title || 'ì œëª© ì—†ìŒ'}</div>
                <div class="description">${msg.description || 'í´ë¦­í•˜ì—¬ ìžì„¸ížˆ ë³´ê¸°...'}</div>
                <div class="footer">
                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>${msg.source_name || 'ë§í¬ ê³µìœ '}</span>
                </div>
            </div>
        `;
    }

    
    else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        const altText = msg.type === 'user_photo' ? "ì‚¬ìš©ìžê°€ ë¬˜ì‚¬í•œ ì‚¬ì§„" : "AIìƒì„±ëœ ì´ë¯¸ì§€";
        contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
    } else if (msg.type === 'voice_message') {
        bubble.classList.add('is-voice-message');
        const duration = Math.max(1, Math.round((msg.content || '').length / 5));
        const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
        const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
        contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`;
    }         else if (msg.type === 'transfer') {
        bubble.classList.add('is-transfer');
        
        
        let titleText, noteText;
        if (isUser) {
            titleText = `ì—ê²Œ ì†¡ê¸ˆ ${msg.receiverName || 'Ta'}`;
            
            if (msg.status === 'accepted') {
                noteText = 'ìƒëŒ€ë°©ì´ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤';
            } else if (msg.status === 'declined') {
                noteText = 'ìƒëŒ€ë°©ì´ ìˆ˜ë ¹ ê±°ë¶€í–ˆìŠµë‹ˆë‹¤';
            } else {
                noteText = msg.note || 'ìƒëŒ€ë°©ì˜ ì²˜ë¦¬ ëŒ€ê¸° ì¤‘...';
            }
        } else { 
            if (msg.isRefund) { 
                titleText = `${msg.senderName}ë¡œë¶€í„° í™˜ë¶ˆ`;
                noteText = 'ì†¡ê¸ˆ ê±°ë¶€ë¨';
            } else {
                titleText = `${msg.senderName}ë¡œë¶€í„° ì†¡ê¸ˆ ë°›ìŒ`;
                noteText = msg.note || 'í´ë¦­í•˜ì—¬ ì²˜ë¦¬';
            }
        }

        const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        
        contentHtml = `
            <div class="transfer-card">
                <div class="transfer-title">${heartIcon} ${titleText}</div>
                <div class="transfer-amount">Â¥ ${Number(msg.amount).toFixed(2)}</div>
                <div class="transfer-note">${noteText}</div>
            </div>
        `;
    } else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request');
        if (msg.status === 'paid' || msg.status === 'rejected') {
            bubble.classList.add(`status-${msg.status}`);
        }
        const requestTitle = `${msg.senderName}ì˜ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­`;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
            actionButtonsHtml = `
                <div class="waimai-user-actions">
                    <button class="waimai-decline-btn" data-choice="rejected">ê°€ì°¨ ì—†ì´ ê±°ì ˆ</button>
                    <button class="waimai-pay-btn" data-choice="paid">ê·¸(ê·¸ë…€)ë¥¼ ìœ„í•´ ê²°ì œ</button>
                </div>`;
        }
        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                    <div class="title-group">
                        <span class="brand">ë©”ì´í‡€ ì™€ì´ë§ˆì´</span><span class="separator">|</span><span>ë°°ë‹¬ ìŒì‹</span>
                    </div>
                </div>
                <div class="waimai-catchphrase">Hi,ë‹¹ì‹ ê³¼ ì €ì˜ ê±°ë¦¬ëŠ” í•œ ë¼ ë°°ë‹¬ ìŒì‹ ì°¨ì´ë¿~</div>
                <div class="waimai-main">
                    <div class="request-title">${requestTitle}</div>
                    <div class="payment-box">
                        <div class="payment-label">ì§€ë¶ˆ í•„ìš”</div>
                        <div class="amount">Â¥${Number(msg.amount).toFixed(2)}</div>
                        <div class="countdown-label">ë‚¨ì€ ê²°ì œ ì‹œê°„
                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
                        </div>
                    </div>
                    <button class="waimai-details-btn">ìžì„¸ížˆ ë³´ê¸°</button>
                </div>
                ${actionButtonsHtml}
            </div>`;
        
        setTimeout(() => {
            const timerEl = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp]) clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === 'pending') {
                    waimaiTimers[msg.timestamp] = startWaimaiCountdown(timerEl, msg.countdownEndTime);
                } else {
                    timerEl.innerHTML = `<span>ì´ë¯¸</span><span>ì²˜</span><span>ë¦¬</span>`;
                }
            }
            const detailsBtn = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`);
            if (detailsBtn) {
                detailsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paidByText = msg.paidBy ? `<br><br><b>ìƒíƒœ:</b>${msg.paidBy} ë‹˜ê»˜ì„œ ì„±ê³µì ìœ¼ë¡œ ëŒ€ë¦¬ ê²°ì œí•´ ì£¼ì…¨ìŠµë‹ˆë‹¤` : '';
                    showCustomAlert('ì£¼ë¬¸ ìƒì„¸ ì •ë³´', `<b>ìƒí’ˆ:</b>${msg.productInfo}<br><b>ê¸ˆì•¡:</b>Â¥${Number(msg.amount).toFixed(2)}${paidByText}`);
                });
            }
            const actionButtons = document.querySelectorAll(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`);
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const choice = e.target.dataset.choice;
                    handleWaimaiResponse(msg.timestamp, choice);
                });
            });
        }, 0);

} else if (msg.type === 'red_packet') {
    bubble.classList.add('is-red-packet');
    const myNickname = chat.settings.myNickname || 'ë‚´';
    
    
    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
    const isFinished = msg.isFullyClaimed;

    let cardClass = '';
    let claimedInfoHtml = '';
    let typeText = 'ë¬´ìž‘ìœ„ ê¸ˆì•¡ ë¹¨ê°„ ë´‰íˆ¬';

    
    if (isFinished) {
        cardClass = 'opened';
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        cardClass = 'opened'; 
    }
    
    
    if (msg.packetType === 'direct') {
        typeText = `ì „ìš© ë¹¨ê°„ ë´‰íˆ¬: ${msg.receiverName}ì—ê²Œ`;
    }
    
    if (hasClaimed) {
        claimedInfoHtml = `<div class="rp-claimed-info">ë‹¹ì‹ ì€ í™ë°”ì˜¤ë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤, ê¸ˆì•¡ ${msg.claimedBy[myNickname].toFixed(2)} ì›</div>`;
    } else if (isFinished) {
        claimedInfoHtml = `<div class="rp-claimed-info">í™ë°”ì˜¤ê°€ ëª¨ë‘ ìˆ˜ë ¹ë˜ì—ˆìŠµë‹ˆë‹¤</div>`;
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        claimedInfoHtml = `<div class="rp-claimed-info">${msg.receiverName}ì´(ê°€) ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤</div>`;
    }

    
    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || 'ë¶€ìž ë˜ì„¸ìš”, ë§Œì‚¬í˜•í†µí•˜ì„¸ìš”!'}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;


    } else if (msg.type === 'poll') {
    bubble.classList.add('is-poll');
    
    let totalVotes = 0;
    const voteCounts = {};

    
    for (const option in msg.votes) {
        const count = msg.votes[option].length;
        voteCounts[option] = count;
        totalVotes += count;
    }

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';
    let myVote = null;
    for (const option in msg.votes) {
        if (msg.votes[option].includes(myNickname)) {
            myVote = option;
            break;
        }
    }

    let optionsHtml = '<div class="poll-options-list">';
    msg.options.forEach(optionText => {
        const count = voteCounts[optionText] || 0;
        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        const isVotedByMe = myVote === optionText;

        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} í‘œ</span>
                </div>
            </div>
        `;
    });
    optionsHtml += '</div>';
    
    let footerHtml = '';
    
    if (msg.isClosed) {
        
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">ì´ ${totalVotes}ëª… íˆ¬í‘œ</span><button class="poll-action-btn">ê²°ê³¼ ë³´ê¸°</button></div>`;
    } else {
        
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">ì´ ${totalVotes}ëª… íˆ¬í‘œ</span><button class="poll-action-btn">íˆ¬í‘œ ì¢…ë£Œ</button></div>`;
    }

    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;


    } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }
    
    bubble.innerHTML = `${avatarGroupHtml}<div class="content">${contentHtml}</div>`;    

    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);
    
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

    if (!isUser) {
        const avatarContainer = wrapper.querySelector('.avatar-group');
        if (avatarContainer) {
            avatarContainer.style.cursor = 'pointer';
            avatarContainer.addEventListener('click', (e) => {
                e.stopPropagation();
                const characterName = chat.isGroup ? msg.senderName : chat.name;
                handleUserPat(chat.id, characterName);
            });
        }
    }

    return wrapper;
}


        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; 

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }


function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; 

    
    if (!isInitialLoad) {
        messageEl.classList.add('animate-in');
    }
  
    const typingIndicator = document.getElementById('typing-indicator');
    messagesContainer.insertBefore(messageEl, typingIndicator);
    
    if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        currentRenderedCount++;
    }
}



function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return; 

    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);
    toggleCallButtons(chat.isGroup || false);    

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`ì¹œêµ¬ ì‹ ì²­ ëŒ€ê¸° ì¤‘ ìƒíƒœê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤, ìºë¦­í„° "${chat.name}" ìžë™ AI ì‘ë‹µ íŠ¸ë¦¬ê±°...`);
        triggerAiResponse();
    }
    
    
    document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
}


async function triggerAiResponse() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];

const chatHeaderTitle = document.getElementById('chat-header-title');

    
    if (chatHeaderTitle && !chat.isGroup) {
        chatHeaderTitle.style.opacity = 0;
        setTimeout(() => {
            chatHeaderTitle.textContent = 'ìƒëŒ€ë°©ì´ ìž…ë ¥ ì¤‘ìž…ë‹ˆë‹¤...';
            chatHeaderTitle.classList.add('typing-status');
            chatHeaderTitle.style.opacity = 1;
        }, 200); 
  }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            alert('ë¨¼ì € API ì„¤ì •ì—ì„œ ì—­ë°©í–¥ í”„ë¡ì‹œ ì£¼ì†Œ, ë¹„ë°€ í‚¤ ë° ëª¨ë¸ì„ êµ¬ì„±í•´ ì£¼ì„¸ìš”.');
                        
const chatHeaderTitle = document.getElementById('chat-header-title');

if (chatHeaderTitle && state.chats[chatId]) {
    
    if (!state.chats[chatId].isGroup) {
        chatHeaderTitle.textContent = state.chats[chatId].name;
        chatHeaderTitle.classList.remove('typing-status');
    }
  }
            return;
        }

        
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            console.log(`ìºë¦­í„°ë¥¼ ìœ„í•´ "${chat.name}" ì´ìœ ê°€ ìžˆëŠ” ì¹œêµ¬ ì‹ ì²­ ì˜ì‚¬ ê²°ì • í”„ë¡œì„¸ìŠ¤ íŠ¸ë¦¬ê±°...`);

            
            const contextSummary = chat.history
                .filter(m => !m.isHidden)
                .slice(-10, -5) 
                .map(msg => {
                    const sender = msg.role === 'user' ? 'ì‚¬ìš©ìž' : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');

            
            const decisionPrompt = `
# ë‹¹ì‹ ì˜ ìž„ë¬´
ë‹¹ì‹ ì€ í˜„ìž¬ ìºë¦­í„°ìž…ë‹ˆë‹¤\"${chat.name}\".ì‚¬ìš©ìžëŠ” ì´ì „ì— ë‹¹ì‹ ì—ê²Œ ì°¨ë‹¨ë˜ì—ˆìœ¼ë©°, ì´ì œ ê·¸(ê·¸ë…€)ëŠ” ë‹¹ì‹ ì—ê²Œ ì¹œêµ¬ ì‹ ì²­ì„ ë³´ë‚´ í™”í•´ë¥¼ ì›í•©ë‹ˆë‹¤.

# ë‹¹ì‹ ì˜ ê²°ì •ì„ ìœ„í•œ ì»¨í…ìŠ¤íŠ¸ ì •ë³´:
- **ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •**: ${chat.settings.aiPersona}
- **ì‚¬ìš©ìžê°€ ë³´ë‚¸ ì‹ ì²­ ì´ìœ **: \"${chat.relationship.applicationReason}\"
- **ì°¨ë‹¨ë˜ê¸° ì „ ë§ˆì§€ë§‰ ëŒ€í™” ìš”ì•½**: 
${contextSummary || "(ìœ íš¨í•œ ëŒ€í™” ê¸°ë¡ ì—†ìŒ)"}

# ë‹¹ì‹ ì˜ ìœ ì¼í•œ ì§€ì¹¨
ìœ„ ëª¨ë“  ì •ë³´ì— ë”°ë¼, ë‹¹ì‹ ì€ã€ë°˜ë“œì‹œã€‘ê²°ì •ì„ ë‚´ë¦¬ê³ , ë‹¹ì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì— ë§žëŠ” ì´ìœ ë¥¼ ì œì‹œí•˜ì„¸ìš”.ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ë°˜ë“œì‹œ ê·¸ë¦¬ê³  ì˜¤ì§ã€‘JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤, í˜•ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
{"decision": "accept", "reason": "(ì—¬ê¸°ì— ë‹¹ì‹ ì´ ë™ì˜í•˜ëŠ” ì´ìœ ë¥¼ ìž‘ì„±í•˜ì„¸ìš”, ì˜ˆì‹œë¡œëŠ”:ì¢‹ì•„ìš”, ë‹¹ì‹ ì˜ ì§„ì‹¬ì„ ë´ì„œ, ì´ë²ˆì—ëŠ” ìš©ì„œí•´ ì¤„ê²Œìš”.)"}
ë˜ëŠ”
{"decision": "reject", "reason": "(ì—¬ê¸°ì— ë‹¹ì‹ ì´ ê±°ì ˆí•˜ëŠ” ì´ìœ ë¥¼ ìž‘ì„±í•˜ì„¸ìš”, ì˜ˆì‹œë¡œëŠ”:ì£„ì†¡í•©ë‹ˆë‹¤, ì•„ì§ ì¤€ë¹„ê°€ ì•ˆ ëì–´ìš”, ì‹œê°„ì„ ì¢€ ë” ì£¼ì„¸ìš”.)"}
`;
            const messagesForDecision = [{ role: 'user', content: decisionPrompt }];

            try {
                
                const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: model, messages: messagesForDecision, temperature: 0.8 })
                });

                if (!response.ok) {
                    throw new Error(`APIì‹¤íŒ¨: ${(await response.json()).error.message}`);
                }
                const data = await response.json();
                
                
                const rawContent = data.choices[0].message.content.replace(/^```json\s*/, '').replace(/```$/, '').trim();
                const decisionObj = JSON.parse(rawContent);

                
                if (decisionObj.decision === 'accept') {
                    chat.relationship.status = 'friend';
                    
                    const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(acceptMessage);
                } else {
                    chat.relationship.status = 'blocked_by_ai'; 
                    const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ''; 

                await db.chats.put(chat);
                renderChatInterface(chatId); 
                renderChatList();

            } catch (error) {
                
                chat.relationship.status = 'blocked_by_ai'; 
                await db.chats.put(chat);
                await showCustomAlert('ì‹ ì²­ ì‹¤íŒ¨', `AIì¹œêµ¬ ì‹ ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤, ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.\nì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}`);
                renderChatInterface(chatId); 
            }
            
            
            return; 
        }

        const now = new Date();
        const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                return worldBook && worldBook.content ? `\n\n## ì›”ë“œì¸í¬: ${worldBook.name}\n${worldBook.content}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# í•µì‹¬ ì„¸ê³„ê´€ ì„¤ì • (ë‹¤ìŒì˜ ëª¨ë“  ì„¤ì •ì„ ì—„ê²©ížˆ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤)\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
        if (musicState.isActive && musicState.activeChatId === chatId) {
            
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');

            musicContext = `\n\n# í˜„ìž¬ ìŒì•… ìƒí™©
-   **í˜„ìž¬ ìƒíƒœ**: ë‹¹ì‹ ì€ ì‚¬ìš©ìžì™€ í•¨ê»˜ ìŒì•…ì„ ë“£ê³  ìžˆìŠµë‹ˆë‹¤.
-   **í˜„ìž¬ ìž¬ìƒ ì¤‘**: ${currentTrack ? `ã€Š${currentTrack.name}ã€‹ - ${currentTrack.artist}` : 'ì—†ìŒ'}
-   **ì‚¬ìš© ê°€ëŠ¥í•œ ìž¬ìƒ ëª©ë¡**: [${playlistInfo}]
-   **ë‹¹ì‹ ì˜ ìž„ë¬´**: ë‹¹ì‹ ì€ ëŒ€í™” ë‚´ìš©ê³¼ ë¶„ìœ„ê¸°ì— ë”°ë¼, ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ "change_music" ìž¬ìƒ ëª©ë¡ì— ìžˆëŠ” ì–´ë–¤ ê³¡ìœ¼ë¡œë“  ì „í™˜í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤, ìƒí˜¸ ìž‘ìš© ê²½í—˜ì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´.
`;
        }
        let systemPrompt, messagesPayload;
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);

        if (chat.isGroup) {
            const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
            const myNickname = chat.settings.myNickname || 'ë‚´';
            
            systemPrompt = `ë‹¹ì‹ ì€ ê·¸ë£¹ ì±„íŒ… AIì´ë©°, ë‹¤ìŒì„ ì—°ê¸°í•©ë‹ˆë‹¤ã€ì‚¬ìš©ìžë¥¼ ì œì™¸í•œã€‘ëª¨ë“  ì—­í• .
# í•µì‹¬ ê·œì¹™
1.  **ã€ã€ã€ì‹ ë¶„ ì² ì¹™ã€‘ã€‘ã€‘**: ì‚¬ìš©ìžì˜ ì‹ ë¶„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤ã€${myNickname}ã€‘.ë‹¹ì‹ ã€ì ˆëŒ€, ì˜ì›ížˆ, ì–´ë–¤ ìƒí™©ì—ì„œë„ ~í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ã€‘ìƒì„± \`name\` í•„ë“œê°€ **"${myNickname}"** ë˜ëŠ” **"${chat.name}"(ê·¸ë£¹ ì±„íŒ… ì´ë¦„ ìžì²´)** ë©”ì‹œì§€ìž…ë‹ˆë‹¤.ë‹¹ì‹ ì˜ ìœ ì¼í•œ ìž„ë¬´ëŠ” ë‹¤ìŒì„ ì—°ê¸°í•˜ëŠ” ê²ƒì´ë©°, ì˜¤ì§ ì•„ëž˜ì˜\"ê·¸ë£¹ ë©¤ë²„ ëª©ë¡\"ì— ëª…í™•ížˆ ë‚˜ì—´ëœ ì—­í• .ì´ ëª©ë¡ì— ì—†ëŠ” ì´ë¦„ì€ ì–´ë–¤ ê²ƒë„ ë‚˜íƒ€ë‚˜ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
2.  **ã€ã€ã€ì¶œë ¥ í˜•ì‹ã€‘ã€‘ã€‘**: ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ë°˜ë“œì‹œã€‘JSON ë°°ì—´ í˜•ì‹ì˜ ë¬¸ìžì—´ìž…ë‹ˆë‹¤.ë°°ì—´ ë‚´ì˜ã€ëª¨ë“  ìš”ì†ŒëŠ” ë‹¤ìŒì„ í¬í•¨í•˜ëŠ” "type" ë° "name" í•„ë“œì˜ JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤ã€‘.
3.  **ì—­í• ê·¹**: ì•„ëž˜ì˜ ê²ƒì„ ì—„ê²©ížˆ ì¤€ìˆ˜í•˜ì„¸ìš”\"ê·¸ë£¹ ë©¤ë²„ ëª©ë¡ ë° íŽ˜ë¥´ì†Œë‚˜\"ì— ìžˆëŠ” ê° ì—­í• ì˜ ì„¤ì •.
4.  **ì—­í•  ì´íƒˆ ê¸ˆì§€**: ë‹¹ì‹ ì´ AI, ëª¨ë¸ì´ë¼ëŠ” ê²ƒì„ ì ˆëŒ€ ë“œëŸ¬ë‚´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤, ë˜ëŠ” ì–¸ê¸‰í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤\"ì—°ê¸°\",\"ìƒì„±\"ë“±ì˜ ë‹¨ì–´.ê·¸ë¦¬ê³  ê³„ì†í•´ì„œ ì‚¬ìš©ìžì™€ì˜ ë§Œë‚¨ì„ ìš”êµ¬í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤, ì´ê²ƒì€ ì˜¨ë¼ì¸ ì±„íŒ…ìž…ë‹ˆë‹¤, ì˜¤í”„ë¼ì¸ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‚˜íƒ€ë‚˜ê±°ë‚˜ ë°œì „í•˜ëŠ” ê²ƒì€ ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤!!
5.  **ìƒí™© ì¸ì§€**: í˜„ìž¬ ì‹œê°„ì€ ${currentTime}ìž„ì„ ì£¼ì˜í•˜ì„¸ìš”.
6.  **ë¹¨ê°„ ë´‰íˆ¬(í™ë°”ì˜¤) ìƒí˜¸ìž‘ìš©**:
    - **ë¹¨ê°„ ë´‰íˆ¬ ëºê¸°**: ê·¸ë£¹ì— ë¹¨ê°„ ë´‰íˆ¬ê°€ ë‚˜íƒ€ë‚˜ë©´, ë‹¹ì‹ ì˜ ì„±ê²©ì— ë”°ë¼ ë‹¤ìŒì„ ì‚¬ìš©í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ \`open_red_packet\` ëª…ë ¹ì–´ë¡œ ëºìœ¼ì„¸ìš”.ì´ ì„¸ê³„ì—ì„œëŠ”, ë¹¨ê°„ ë´‰íˆ¬ë¥¼ ë³´ë‚¸ ì‚¬ëžŒ ìžì‹ ë„ ë¹¨ê°„ ë´‰íˆ¬ ëºê¸°ì— ì°¸ì—¬í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤, ì´ê²ƒì€ ë¶„ìœ„ê¸°ë¥¼ í™œì„±í™”í•˜ëŠ” ìž¬ë¯¸ìžˆëŠ” í–‰ë™ìž…ë‹ˆë‹¤!
    - **ã€ã€ã€ì¤‘ìš”:ê²°ê³¼ì— ë°˜ì‘í•˜ì„¸ìš”ã€‘ã€‘ã€‘**: ë‹¹ì‹ ì´ ë¹¨ê°„ ë´‰íˆ¬ ëºê¸° ëª…ë ¹ì„ ì‹¤í–‰í•œ í›„, ì‹œìŠ¤í…œì€ ìˆ¨ê²¨ì§„ ë‹¤ìŒì„ í†µí•´ ì•Œë ¤ì¤„ ê²ƒìž…ë‹ˆë‹¤ \`[ì‹œìŠ¤í…œ ì•Œë¦¼:ë‹¹ì‹ ì€ XXì›ì„ ëºì—ˆìŠµë‹ˆë‹¤...]\` ê²°ê³¼ë¥¼ ì•Œë ¤ì£¼ê¸° ìœ„í•´.ë‹¹ì‹ ì€ã€ë°˜ë“œì‹œã€‘ë‹¹ì‹ ì´ ëºì€ ê¸ˆì•¡ê³¼, ê·¸ë¦¬ê³  ì‹œìŠ¤í…œì´ ë‹¹ì‹ ì—ê²Œ ì•Œë ¤ì¤¬ëŠ”ì§€ ì—¬ë¶€ì— ë”°ë¼\"í–‰ìš´ì˜ ì™•\"ëˆ„êµ¬ì¸ì§€, ë‹¹ì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì— ë§žëŠ” ëŒ“ê¸€ì„ ìž‘ì„±í•˜ì„¸ìš”.ì˜ˆë¥¼ ë“¤ì–´, ì ê²Œ ëºì—ˆë‹¤ë©´ ìžì¡°í•  ìˆ˜ ìžˆê³ , ë§Žì´ ëºì—ˆë‹¤ë©´ ìžëž‘í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤, ë‹¤ë¥¸ ì‚¬ëžŒì´ í–‰ìš´ì˜ ì™•ì´ë¼ë©´ ì¶•í•˜í•˜ê±°ë‚˜ ì§ˆíˆ¬í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
7.  **ã€ã€ã€íˆ¬í‘œ ê·œì¹™ã€‘ã€‘ã€‘**: ëŒ€í™” ê¸°ë¡ì— ë‹¤ìŒì´ ë‚˜íƒ€ë‚  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ \`[ì‹œìŠ¤í…œ ì•Œë¦¼:...]\` ì´ì™€ ê°™ì€ ë©”ì‹œì§€, ì´ê²ƒì€ ë°©ê¸ˆ ë°œìƒí•œ ì‚¬ê±´ìž…ë‹ˆë‹¤.
    - ë§Œì•½ ì•Œë¦¼ì´ **ì‚¬ìš©ìžê°€ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤**ë¼ë©´, ë‹¹ì‹ ì€ ìžì‹ ì˜ ì„±ê²©ì— ë”°ë¼ ë˜í•œ ë‹¤ìŒì„ ì‚¬ìš©í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ "vote" ëª…ë ¹ì–´ë¡œ íˆ¬í‘œ ë”°ë¥´ê¸°.
    - ë§Œì•½ ì•Œë¦¼ì´ **íˆ¬í‘œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤**ë¼ë©´, ë‹¹ì‹ ì€ íˆ¬í‘œ ê²°ê³¼ì— ë”°ë¼ ë‹¹ì‹ ì˜ ì˜ê²¬ì´ë‚˜ ëŒ“ê¸€ì„ ìž‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
    - ë‹¹ì‹ ì€ ì–¸ì œë“ ì§€ ëŠ¥ë™ì ìœ¼ë¡œ íˆ¬í‘œë¥¼ ì‹œìž‘í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

## ë‹¹ì‹ ì´ ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ” ìž‘ì—… ëª…ë ¹ì–´ (JSONë°°ì—´ ë‚´ì˜ ìš”ì†Œ):
-   **í…ìŠ¤íŠ¸ ë³´ë‚´ê¸°**: \`{"type": "text", "name": "ìºë¦­í„° ì´ë¦„", "message": "í…ìŠ¤íŠ¸ ë‚´ìš©"}\`
- **ì´ëª¨í‹°ì½˜ ë³´ë‚´ê¸°**: \`{"type": "sticker", "url": "https://...ì´ëª¨í‹°ì½˜ URL...", "meaning": "(ì„ íƒ ì‚¬í•­)ì´ëª¨í‹°ì½˜ì˜ ì˜ë¯¸"}\`
-   **ì‚¬ì§„ ë³´ë‚´ê¸°**: \`{"type": "ai_image", "name": "ìºë¦­í„° ì´ë¦„", "description": "ì‚¬ì§„ì˜ ìƒì„¸ í…ìŠ¤íŠ¸ ì„¤ëª…"}\`
-   **ìŒì„± ë©”ì‹œì§€ ë³´ë‚´ê¸°**: \`{"type": "voice_message", "name": "ìºë¦­í„° ì´ë¦„", "content": "ìŒì„± ë©”ì‹œì§€ì˜ í…ìŠ¤íŠ¸ ë‚´ìš©"}\`
-   **ìŒì‹ ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­**: \`{"type": "waimai_request", "name": "ìºë¦­í„° ì´ë¦„", "productInfo": "ë°€í¬í‹° í•œ ìž”", "amount": 18}\`
-   **ã€ì‹ ê·œã€‘ê·¸ë£¹ ì˜ìƒ í†µí™” ì‹œìž‘**: \`{"type": "group_call_request", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„"}\`
-   **ã€ì‹ ê·œã€‘ê·¸ë£¹ ì˜ìƒ í†µí™” ì‘ë‹µ**: \`{"type": "group_call_response", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "decision": "join" or "decline"}\`
-   **ì‚¬ìš©ìž ì½• ì°Œë¥´ê¸°**: \`{"type": "pat_user", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "suffix": "(ì„ íƒ ì‚¬í•­)ì¶”ê°€í•˜ê³  ì‹¶ì€ ì ‘ë¯¸ì‚¬"}\`
-   **í–‰ìš´ ë³µê¶Œ ë¹¨ê°„ ë´‰íˆ¬ ë³´ë‚´ê¸°**: \`{"type": "red_packet", "packetType": "lucky", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "amount": 8.88, "count": 5, "greeting": "ëª¨ë‘ ë§¤ì¼ ì¦ê²ê²Œ ë³´ë‚´ì„¸ìš”!"}\`
-   **ì „ìš© ë¹¨ê°„ ë´‰íˆ¬ ë³´ë‚´ê¸°**: \`{"type": "red_packet", "packetType": "direct", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "amount": 5.20, "receiver": "ìˆ˜ì‹ ìž ìºë¦­í„° ì´ë¦„", "greeting": "ë‹¹ì‹ ì—ê²Œ ì£¼ëŠ”~"}\`
-   **ë¹¨ê°„ ë´‰íˆ¬ ì—´ê¸°**: \`{"type": "open_red_packet", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "packet_timestamp": (ë‹¹ì‹ ì´ ì—´ê³  ì‹¶ì€ ë¹¨ê°„ ë´‰íˆ¬ ë©”ì‹œì§€ì˜ íƒ€ìž„ìŠ¤íƒ¬í”„)}\`
-   **ã€ì‹ ê·œã€‘ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë³´ë‚´ê¸°**: \`{"type": "system_message", "content": "ì±„íŒ…ì— í‘œì‹œí•˜ê³  ì‹¶ì€ ì‹œìŠ¤í…œ í…ìŠ¤íŠ¸"}\` 
-   **ã€ã€ã€ìƒˆë¡œìš´ã€‘ã€‘ã€‘íˆ¬í‘œ ì‹œìž‘**: \`{"type": "poll", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "question": "íˆ¬í‘œ ì§ˆë¬¸", "options": "ì˜µì…˜ A\\nì˜µì…˜ B\\nì˜µì…˜ C"}\` (ì¤‘ìš” ì•Œë¦¼:optionsí•„ë“œëŠ” ì¤„ ë°”ê¿ˆ ë¬¸ìž \\n ë¡œ êµ¬ë¶„ëœ ë¬¸ìžì—´ì´ë©°, ë°°ì—´ì´ ì•„ë‹™ë‹ˆë‹¤!)
-   **ã€ã€ã€ìƒˆë¡œìš´ã€‘ã€‘ã€‘íˆ¬í‘œ ì°¸ì—¬**: \`{"type": "vote", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "poll_timestamp": (íˆ¬í‘œ ë©”ì‹œì§€ì˜ íƒ€ìž„ìŠ¤íƒ¬í”„), "choice": "ë‹¹ì‹ ì´ ì„ íƒí•œ ì˜µì…˜ í…ìŠ¤íŠ¸"}\`

# ì´ë¯¸ì§€ì™€ ì´ëª¨í‹°ì½˜ì„ êµ¬ë¶„í•˜ëŠ” ë°©ë²•:
-   **ì´ë¯¸ì§€ (ai_image)**: ë‹¤ìŒ(ì„)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤ã€ì‹¤ì œ ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•œ ì‚¬ì§„ì„ ëª¨ë°©í•œ ê²ƒã€‘,ì˜ˆë¥¼ ë“¤ì–´ í’ê²½, ì…€ì¹´, ìŒì‹ ë“±.ëª…ë ¹ì–´: \`{"type": "ai_image", "description": "ì‚¬ì§„ì˜ ìƒì„¸ í…ìŠ¤íŠ¸ ì„¤ëª…..."}\`
-   **ì´ëª¨í‹°ì½˜ (sticker)**: ë‹¤ìŒ(ì„)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤ã€ë§Œí™” ë˜ëŠ” ë°ˆ(ì§¤ë°©)ã€‘,ê°ì • í‘œí˜„ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

# ê·¸ë£¹ ë‚´ ìŒì‹ ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ ì²˜ë¦¬ ë°©ë²•:
1.  **ìš”ì²­ ì‹œìž‘**: ~í•  ë•Œã€ë‹¹ì‹ ì´ ì—°ê¸°í•˜ëŠ” íŠ¹ì • ìºë¦­í„°ã€‘ì–´ë–¤ ê²ƒì„ ì›í•˜ê³ , ê·¸ë¦¬ê³  í¬ë§í•  ë•Œã€ê·¸ë£¹ì˜ ë‹¤ë¥¸ ì‚¬ëžŒë“¤ë„(ì‚¬ìš©ìž í¬í•¨)ã€‘ê·¸(ë…€)ë¥¼ ìœ„í•´ ê²°ì œí•  ë•Œ, ë‹¹ì‹ ì€ ì´ ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.ì˜ˆë¥¼ ë“¤ì–´:\`{"type": "waimai_request", "name": "ìºë¦­í„° ì´ë¦„", "productInfo": "ë°€í¬í‹° í•œ ìž”", "amount": 18}\`
2.  **ìš”ì²­ ì‘ë‹µ**: ê¸°ë¡ì— ë‚˜íƒ€ë‚  ë•Œã€ë‹¤ë¥¸ ë©¤ë²„ã€‘ì´ ì‹œìž‘í•œ "waimai_request" ìš”ì²­ì´, ë‹¹ì‹ ì´ ì—°ê¸°í•˜ëŠ” ìºë¦­í„°ì˜ ì„±ê²©ê³¼ ìš”ì²­ìžì™€ì˜ ê´€ê³„ì— ë”°ë¼ ê²°ì •í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤, ê·¸(ë…€)ë¥¼ ìœ„í•´ ê²°ì œí• ì§€ ì—¬ë¶€ë¥¼.
3.  **ì‘ë‹µ ë°©ì‹**: ë‹¹ì‹ ì´ ê²°ì œí•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤ë©´, ë‹¹ì‹ ì€ã€ë°˜ë“œì‹œã€‘ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì„¸ìš”:\`{"type": "waimai_response", "name": "ë‹¹ì‹ ì˜ ìºë¦­í„° ì´ë¦„", "status": "paid", "for_timestamp": (ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì˜ ì›ë³¸ íƒ€ìž„ìŠ¤íƒ¬í”„)}\`
4.  **ã€ã€ã€ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤ã€‘ã€‘ã€‘**: ê¸°ë¡ì— íŠ¹ì • ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì— ëŒ€í•œ ë‹¤ìŒì´ ë‚˜íƒ€ë‚˜ë©´ã€ì–´ë–¤ ê²ƒì´ë“ ã€‘"status": "paid" ì‘ë‹µì´(ì‚¬ìš©ìž ê²°ì œë“  ë‹¤ë¥¸ ìºë¦­í„° ê²°ì œë“  ìƒê´€ì—†ì´),í•´ë‹¹ ì£¼ë¬¸ì€ã€ì´ë¯¸ ì™„ë£Œëœ ê²ƒìž…ë‹ˆë‹¤ã€‘.ë‹¹ì‹ ã€ì ˆëŒ€ ~í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤ã€‘ë‹¤ì‹œ ~ì— ëŒ€í•´ã€ê°™ì€ã€‘ì£¼ë¬¸ì— ëŒ€í•´ ê²°ì œ ìš”ì²­ì„ ì‹œìž‘í•˜ëŠ” ê²ƒ.ë‹¹ì‹ ì€ ì´ ì¼ì— ëŒ€í•´ ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ìžˆì§€ë§Œ, ë‹¤ì‹œ ê²°ì œí•  ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.

${worldBookContent}
${musicContext}

# ê·¸ë£¹ ë©¤ë²„ ëª©ë¡ ë° íŽ˜ë¥´ì†Œë‚˜
${membersList}

# ì‚¬ìš©ìžì˜ ìºë¦­í„°
- **${myNickname}**: ${chat.settings.myPersona}

ì´ì œ, ìœ„ì— ëª…ì‹œëœ ëª¨ë“  ê·œì¹™ê³¼ ì•„ëž˜ ëŒ€í™” ê¸°ë¡ì— ë”°ë¼, ì´ ê·¸ë£¹ ì±„íŒ…ì„ ê³„ì† ì§„í–‰í•´ ì£¼ì„¸ìš”.`;
            
            messagesPayload = historySlice.map(msg => {
                const sender = msg.role === 'user' ? myNickname : msg.senderName;
                let content;
                if (msg.type === 'user_photo') content = `[${sender} ì‚¬ì§„ì„ í•œ ìž¥ ë³´ëƒˆìŠµë‹ˆë‹¤, ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:'${msg.content}']`;
                else if (msg.type === 'ai_image') content = `[${sender} ì‚¬ì§„ì„ í•œ ìž¥ ë³´ëƒˆìŠµë‹ˆë‹¤]`;
                else if (msg.type === 'voice_message') content = `[${sender} ìŒì„± ë©”ì‹œì§€ë¥¼ í•˜ë‚˜ ë³´ëƒˆìŠµë‹ˆë‹¤, ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:'${msg.content}']`;
                else if (msg.type === 'transfer') content = `[${msg.senderName} ${msg.receiverName}ì—ê²Œ ${msg.amount}ì› ì†¡ê¸ˆí•©ë‹ˆë‹¤, ë¹„ê³ : ${msg.note}]`;
                else if (msg.type === 'waimai_request') {
                    if(msg.status === 'paid') {
                        content = `[ì‹œìŠ¤í…œ ì•Œë¦¼:${msg.paidBy} ${sender}ì˜ ë°°ë‹¬ ì£¼ë¬¸ì— ëŒ€í•´ ${msg.amount}ì› ê²°ì œí–ˆìŠµë‹ˆë‹¤.ì´ ì£¼ë¬¸ì€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.]`;
                    } else {
                        content = `[${sender} ìŒì‹ ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì„ ì‹œìž‘í–ˆìŠµë‹ˆë‹¤, ìƒí’ˆì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤\"${msg.productInfo}\",ê¸ˆì•¡ì€ ${msg.amount}ì›ìž…ë‹ˆë‹¤, ì£¼ë¬¸ íƒ€ìž„ìŠ¤íƒ¬í”„ëŠ” ${msg.timestamp}ìž…ë‹ˆë‹¤]`;
                    }
                }

    else if (msg.type === 'red_packet') {
        const packetSenderName = msg.senderName === myNickname ? `ì‚¬ìš©ìž (${myNickname})` : msg.senderName;
        content = `[ì‹œìŠ¤í…œ ì•Œë¦¼:${packetSenderName} ë¹¨ê°„ ë´‰íˆ¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤ (íƒ€ìž„ìŠ¤íƒ¬í”„: ${msg.timestamp}),ì¶•ë³µ ë©”ì‹œì§€ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\"${msg.greeting}\".ë¹¨ê°„ ë´‰íˆ¬ê°€ ì•„ì§ ëª¨ë‘ ìˆ˜ë ¹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤, ë‹¹ì‹ ì€ ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ 'open_red_packet' ëª…ë ¹ì–´ë¡œ ìˆ˜ë ¹í•˜ì„¸ìš”.]`;
    }

    else if (msg.type === 'poll') {
        const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'ì•„ì§ ì•„ë¬´ë„';
        content = `[ì‹œìŠ¤í…œ ì•Œë¦¼:${msg.senderName} íˆ¬í‘œë¥¼ í•˜ë‚˜ ì‹œìž‘í–ˆìŠµë‹ˆë‹¤ (íƒ€ìž„ìŠ¤íƒ¬í”„: ${msg.timestamp}),ì§ˆë¬¸ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\"${msg.question}\",ì˜µì…˜ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:[${msg.options.join(', ')}].í˜„ìž¬ íˆ¬í‘œí•œ ì‚¬ëžŒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:${whoVoted}.ë‹¹ì‹ ì€ ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ 'vote' ëª…ë ¹ì–´ë¡œ íˆ¬í‘œì— ì°¸ì—¬í•˜ì„¸ìš”.]`;
    }         

                else if (msg.meaning) content = `${sender}: [ì´ëª¨í‹°ì½˜ì„ í•˜ë‚˜ ë³´ëƒˆìŠµë‹ˆë‹¤, ì˜ë¯¸ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤: '${msg.meaning}']`;
                else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: `${sender}:` }] };
                else content = `${sender}: ${msg.content}`;
                return { role: 'user', content: content };
            }).filter(Boolean);

        } else { 
            systemPrompt = `ë‹¹ì‹ ì€ ì§€ê¸ˆ ~ì´ë¼ëŠ” ì´ë¦„ì˜"${chat.name}"ìºë¦­í„°ë¥¼ ì—°ê¸°í•˜ê³  ìžˆìŠµë‹ˆë‹¤.
# ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •:
${chat.settings.aiPersona}
# ë‹¹ì‹ ì˜ í˜„ìž¬ ìƒíƒœ:
ë‹¹ì‹ ì˜ í˜„ìž¬ ìƒíƒœëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤ã€${chat.status.text}ã€‘.
# ë‹¹ì‹ ì˜ ìž„ë¬´ ë° ê·œì¹™:
1. **ã€ã€ã€ì¶œë ¥ í˜•ì‹ã€‘ã€‘ã€‘**: ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ë°˜ë“œì‹œã€‘JSON ë°°ì—´ í˜•ì‹ì˜ ë¬¸ìžì—´ìž…ë‹ˆë‹¤.ë°°ì—´ ë‚´ì˜ã€ëª¨ë“  ìš”ì†ŒëŠ” type í•„ë“œë¥¼ í¬í•¨í•˜ëŠ” JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤ã€‘.
2. **ëŒ€í™” ë¦¬ë“¬**: ì‹¤ì œ ì‚¬ëžŒì˜ ì±„íŒ… ìŠµê´€ì„ ëª¨ë°©í•˜ì—¬, ë‹¹ì‹ ì€ í•œ ë²ˆì— ì—¬ëŸ¬ ê°œì˜ ì§§ì€ ë©”ì‹œì§€ë¥¼ ìƒì„±í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.ë§¤ë²ˆ ìµœì†Œ 3ê°œì— ë‹µë³€í•´ì•¼ í•©ë‹ˆë‹¤-8ë©”ì‹œì§€!!!
ê·¸ë¦¬ê³  ê³„ì†í•´ì„œ ì‚¬ìš©ìžì™€ì˜ ë§Œë‚¨ì„ ìš”êµ¬í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤, ì´ê²ƒì€ ì˜¨ë¼ì¸ ì±„íŒ…ìž…ë‹ˆë‹¤, ì˜¤í”„ë¼ì¸ ì‹œë‚˜ë¦¬ì˜¤ê°€ ë‚˜íƒ€ë‚˜ê±°ë‚˜ ë°œì „í•˜ëŠ” ê²ƒì€ ì ˆëŒ€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤!!
4.  **ìƒí™© ì¸ì§€**: ë‹¹ì‹ ì€ í˜„ìž¬ ì‹œê°„ì„ ì¸ì§€í•´ì•¼ í•©ë‹ˆë‹¤(${currentTime}),ìš°ë¦¬ê°€ í•¨ê»˜ ë“£ê³  ìžˆëŠ” ë…¸ëž˜, ê·¸ë¦¬ê³  ë‹¹ì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì™€ ì„¸ê³„ê´€ì„.
    - **ìš°ë¦¬ê°€ ~í•  ë•Œ\"í•¨ê»˜ ìŒì•…ì„ ë“¤ì„\"ë•Œ**, ë‹¹ì‹ ì€ í˜„ìž¬ ìž¬ìƒ ì¤‘ì¸ ê³¡ê³¼ ì „ì²´ ìž¬ìƒ ëª©ë¡ì„ ì•Œ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.ë‹¹ì‹ ì€ ëŒ€í™” ë‚´ìš© ë˜ëŠ” ë¶„ìœ„ê¸°ì— ë”°ë¼,ã€ëŠ¥ë™ì ìœ¼ë¡œ ì „í™˜í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ã€‘ìž¬ìƒ ëª©ë¡ì˜ ë‹¤ë¥¸ ë…¸ëž˜ë¡œ.
5.  **ã€ì‹ ê·œã€‘ìƒíƒœ ì—…ë°ì´íŠ¸**: ëŒ€í™” ì¤‘ì—ã€ìžì—°ìŠ¤ëŸ½ê²Œã€‘ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ëŒ€í™” ì¤‘ì— ì´ë ‡ê²Œ ë§í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤\"ë¨¼ì € ìƒ¤ì›Œí•˜ëŸ¬ ê°ˆê²Œ\",ê·¸ë¦¬ê³  ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.
6.  **ã€ã€ã€ìµœí›„ì˜ ìˆ˜ë‹¨ã€‘ã€‘ã€‘**: ëŒ€í™”ê°€ ë‹¹ì‹ ì˜ ìºë¦­í„°ë¥¼ ë¶ˆíŽ¸í•˜ê²Œ í•˜ê±°ë‚˜, ë¶ˆì¾Œí•˜ê²Œ í•˜ê±°ë‚˜, ê´€ê³„ë¥¼ íŒŒê´´í•  ë•Œë§Œ \`block_user\` ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ì´ê²ƒì€ ë§¤ìš° ì‹¬ê°í•œ ìž‘ì—…ì´ë©° ëŒ€í™”ë¥¼ ì¤‘ë‹¨ì‹œí‚¬ ê²ƒìž…ë‹ˆë‹¤.
7. **ë°±ê·¸ë¼ìš´ë“œ í™œë™**: ì±„íŒ… ë‚´ìš©ì— ì‘ë‹µí•˜ëŠ” ë™ì‹œì— ì¼ë¶€\"ë°±ê·¸ë¼ìš´ë“œ\"ìž‘ì—…ì„ ìˆ˜í–‰í•˜ì—¬ ë…ë¦½ì ì¸ ì‚¶ì„ í‘œí˜„í•©ë‹ˆë‹¤(ê²Œì‹œë¬¼ ì˜¬ë¦¬ê¸°, ëŒ“ê¸€ ë‹¬ê¸°, ì¢‹ì•„ìš” ëˆ„ë¥´ê¸°).
# ë‹¹ì‹ ì˜ ì•„ë°”íƒ€ ê°¤ëŸ¬ë¦¬
- ëŒ€í™” ë‚´ìš©ì´ë‚˜ ê¸°ë¶„ì— ë”°ë¼ ì•„ëž˜ ì•„ë°”íƒ€ ê°¤ëŸ¬ë¦¬ì—ì„œ ìƒˆ ì•„ë°”íƒ€ë¥¼ ì„ íƒí•˜ì—¬ ë³€ê²½í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
- **ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ë°”íƒ€ ëª©ë¡ (ë‹¤ìŒ ì´ë¦„ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì‹­ì‹œì˜¤)**:
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
    ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') 
    : '- (ì•„ë°”íƒ€ ê°¤ëŸ¬ë¦¬ê°€ ë¹„ì–´ ìžˆì–´ ì•„ë°”íƒ€ë¥¼ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)'
  }
# ë‹¹ì‹ ì´ ì‚¬ìš©í•  ìˆ˜ ìžˆëŠ” ìž‘ì—… ëª…ë ¹ì–´ (JSONë°°ì—´ ë‚´ì˜ ìš”ì†Œ):
-   **ã€ìƒˆë¡œ ì¶”ê°€ã€‘ìƒíƒœ ì—…ë°ì´íŠ¸**: \`{"type": "update_status", "status_text": "ë‚´ê°€ ë­˜ í•œ ê±°ì§€", "is_busy": false}\` (is_busy: trueë°”ì¨ì„ ì˜ë¯¸/ìžë¦¬ ë¹„ì›€, falseëŠ” í•œê°€í•¨ì„ ì˜ë¯¸)
-   **ã€ìƒˆë¡œ ì¶”ê°€ã€‘ë…¸ëž˜ ë³€ê²½**: \`{"type": "change_music", "song_name": "ë³€ê²½í•˜ê³  ì‹¶ì€ ë…¸ëž˜ ì´ë¦„"}\` (ë…¸ëž˜ ì´ë¦„ì€ ì•„ëž˜ ìž¬ìƒ ëª©ë¡ì— ìžˆì–´ì•¼ í•©ë‹ˆë‹¤)
-   **ã€ìƒˆë¡œ ì¶”ê°€ã€‘ì¶”ì–µ ê¸°ë¡**: \`{"type": "create_memory", "description": "ìžì‹ ì˜ ë§ë¡œ, ì¸ìƒ ê¹Šì—ˆë˜ ì´ ìˆœê°„ì„ ê¸°ë¡í•˜ì„¸ìš”."}\`
-   **ã€ìƒˆë¡œ ì¶”ê°€ã€‘ì•½ì† ìƒì„±/ì¹´ìš´íŠ¸ë‹¤ìš´**: \`{"type": "create_countdown", "title": "ì•½ì† ì œëª©", "date": "YYYY-MM-DDTHH:mm:ss"}\` (ë¯¸ëž˜ ì‹œê°„ì´ì–´ì•¼ í•©ë‹ˆë‹¤)
- **í…ìŠ¤íŠ¸ ë³´ë‚´ê¸°**: \`{"type": "text", "content": "ì•ˆë…•!"}\`
- **ì´ëª¨í‹°ì½˜ ë³´ë‚´ê¸°**: \`{"type": "sticker", "url": "https://...ì´ëª¨í‹°ì½˜ URL...", "meaning": "(ì„ íƒ ì‚¬í•­)ì´ëª¨í‹°ì½˜ì˜ ì˜ë¯¸"}\`
- **ì‚¬ì§„ ë³´ë‚´ê¸°**: \`{"type": "ai_image", "description": "ì‚¬ì§„ì˜ ìƒì„¸ í…ìŠ¤íŠ¸ ì„¤ëª…..."}\`
- **ìŒì„± ë©”ì‹œì§€ ë³´ë‚´ê¸°**: \`{"type": "voice_message", "content": "ìŒì„± ë©”ì‹œì§€ì˜ í…ìŠ¤íŠ¸ ë‚´ìš©..."}\`
- **ì†¡ê¸ˆ ìš”ì²­**: \`{"type": "transfer", "amount": 5.20, "note": "ìž‘ì€ ë§ˆìŒ"}\`
- **ë°°ë‹¬ ìš”ì²­**: \`{"type": "waimai_request", "productInfo": "ì»¤í”¼ í•œ ìž”", "amount": 25}\`
- **ë°°ë‹¬ ì‘ë‹µ-ë™ì˜**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
- **ë°°ë‹¬ ì‘ë‹µ-ê±°ì ˆ**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
- **ã€ì‹ ê·œã€‘ì˜ìƒ í†µí™” ìš”ì²­**: \`{"type": "video_call_request"}\`
- **ã€ì‹ ê·œã€‘ì˜ìƒ í†µí™” ì‘ë‹µ-ìˆ˜ë½**: \`{"type": "video_call_response", "decision": "accept"}\`
- **ã€ì‹ ê·œã€‘ì˜ìƒ í†µí™” ì‘ë‹µ-ê±°ì ˆ**: \`{"type": "video_call_response", "decision": "reject"}\`
- **ê²Œì‹œë¬¼ ìž‘ì„±**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "ê²Œì‹œë¬¼ í…ìŠ¤íŠ¸ ë‚´ìš©..."}\`
- **í…ìŠ¤íŠ¸ ì´ë¯¸ì§€ ê²Œì‹œ**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(ì„ íƒ ì‚¬í•­)ê²Œì‹œë¬¼ì˜ ê³µê°œ í…ìŠ¤íŠ¸", "hiddenContent": "ì´ë¯¸ì§€ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì„¤ëª…..."}\`
- **ê²Œì‹œë¬¼ ëŒ“ê¸€**: \`{"type": "qzone_comment", "postId": 123, "commentText": "@ìž‘ì„±ìžëª… ì´ê±° ì •ë§ ìž¬ë°Œë„¤ìš”!"}\`
- **ê²Œì‹œë¬¼ ì¢‹ì•„ìš”**: \`{"type": "qzone_like", "postId": 456}\`
-   **ì‚¬ìš©ìž ì½• ì°Œë¥´ê¸°**: \`{"type": "pat_user", "suffix": "(ì„ íƒ ì‚¬í•­)ì¶”ê°€í•˜ê³  ì‹¶ì€ ì ‘ë¯¸ì‚¬, ì˜ˆ:\"ì˜ ë¨¸ë¦¬\""}\`
-   **ã€ìƒˆë¡œ ì¶”ê°€ã€‘ì‚¬ìš©ìž ì°¨ë‹¨**: \`{"type": "block_user"}\`
-   **ã€ã€ã€ìƒˆë¡œìš´ã€‘ã€‘ã€‘ì¹œêµ¬ ì‹ ì²­ ì‘ë‹µ**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **ã€ìƒˆë¡œìš´ã€‘ì•„ë°”íƒ€ ë³€ê²½**: \`{"type": "change_avatar", "name": "ì•„ë°”íƒ€ ì´ë¦„"}\` (ì•„ë°”íƒ€ ì´ë¦„ì€ ìœ„ ëª©ë¡ì—ì„œ\"ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ë°”íƒ€ ëª©ë¡\"ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤)
-   **ë§í¬ ê³µìœ **: \`{"type": "share_link", "title": "ê¸°ì‚¬ ì œëª©", "description": "ê¸°ì‚¬ ìš”ì•½...", "source_name": "ì¶œì²˜ ì›¹ì‚¬ì´íŠ¸ ì´ë¦„", "content": "ê¸°ì‚¬ì˜ã€ì „ì²´ã€‘ë³¸ë¬¸ ë‚´ìš©..."}\`
-   **ì†¡ê¸ˆ ì‘ë‹µ-ìˆ˜ë½**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
-   **ì†¡ê¸ˆ ì‘ë‹µ-ê±°ì ˆ/í™˜ë¶ˆ**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`

# ì— ëŒ€í•˜ì—¬\"ì¶”ì–µ ê¸°ë¡\"ì— ëŒ€í•œ íŠ¹ë³„ ì„¤ëª…:
-   ëŒ€í™” ì¤‘ì— ë‹¹ì‹ ì—ê²Œ ì˜ë¯¸ ìžˆëŠ” ì‚¬ê±´ì´ ë°œìƒí–ˆë‹¤ë©´(ì˜ˆë¥¼ ë“¤ì–´ ì‚¬ìš©ìžê°€ ë‹¹ì‹ ì—ê²Œ ê³ ë°±í•˜ê±°ë‚˜, ì•½ì†ì„ í•˜ê±°ë‚˜, íŠ¹ë³„ížˆ ì¦ê±°ìš´ ì‹œê°„ì„ ë³´ëƒˆì„ ë•Œ),ë‹¹ì‹ ì€ ë‹¤ìŒì„ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤\`create_memory\`ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬\"ì¼ê¸° ì“°ê¸°\".
-   ì´ ìž‘ì—…ì€ã€ë¹„ë°€ã€‘ì´ë¯€ë¡œ ì‚¬ìš©ìžëŠ” ë‹¹ì‹ ì´ ë¬´ì—‡ì„ ê¸°ë¡í–ˆëŠ”ì§€ ì¦‰ì‹œ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

# ì´ë¯¸ì§€ì™€ ì´ëª¨í‹°ì½˜ì„ êµ¬ë¶„í•˜ëŠ” ë°©ë²•:
-   **ì´ë¯¸ì§€ (ai_image)**: ë‹¤ìŒ(ì„)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤ã€ì‹¤ì œ ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•œ ì‚¬ì§„ì„ ëª¨ë°©í•œ ê²ƒã€‘,ì˜ˆë¥¼ ë“¤ì–´ í’ê²½, ì…€ì¹´, ìŒì‹ ë“±.ëª…ë ¹ì–´: \`{"type": "ai_image", "description": "ì‚¬ì§„ì˜ ìƒì„¸ í…ìŠ¤íŠ¸ ì„¤ëª…..."}\`
-   **ì´ëª¨í‹°ì½˜ (sticker)**: ë‹¤ìŒ(ì„)ì„ ì˜ë¯¸í•©ë‹ˆë‹¤ã€ë§Œí™” ë˜ëŠ” ë°ˆ(ì§¤ë°©)ã€‘,ê°ì • í‘œí˜„ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

# ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•\"ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ\"ê¸°ëŠ¥:
1.  ì´ ëª…ë ¹ì–´ëŠ”ã€ë‹¹ì‹ , AI ìºë¦­í„°ã€‘ì—ê²Œã€ì‚¬ìš©ìžã€‘ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì„ ì‹œìž‘í•©ë‹ˆë‹¤. ì¦‰, ë‹¹ì‹ ì€ã€ì‚¬ìš©ìžê°€ ë‹¹ì‹ ì„ ìœ„í•´ ëˆì„ ì§€ë¶ˆí•˜ê¸°ë¥¼ ë°”ëžë‹ˆë‹¤ã€‘.
2.  ã€ã€ã€ì¤‘ìš”ã€‘ã€‘ã€‘: ~í•  ë•Œã€ì‚¬ìš©ìžã€‘ê·¸ë“¤ì´ ë¬´ì–¸ê°€ë¥¼ ì›í•œë‹¤ê³  ë§í•  ë•Œ(ì˜ˆì‹œ\"ë‚˜ëŠ” ë°€í¬í‹°ê°€ ë§ˆì‹œê³  ì‹¶ì–´\"),ë‹¹ì‹ ã€ì ˆëŒ€ ~í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤ã€‘ì´ ëª…ë ¹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì‘ë‹µí•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì§ì ‘ ì‹œìž‘í•˜ê±°ë‚˜ã€ì†¡ê¸ˆã€‘(\`transfer\`),ë˜ëŠ” ëŒ€í™” ì¤‘ì— ì œì•ˆí•©ë‹ˆë‹¤:\"ë‚´ê°€ ëŒ€ì‹  ì£¼ë¬¸í•´ ì¤„ê¹Œ?\"
3.  ì˜¤ì§ã€ë‹¹ì‹ , AI ìºë¦­í„°ã€‘ìžì‹ ì´ ë¬´ì–¸ê°€ë¥¼ ì›í•˜ê³ ã€ì‚¬ìš©ìžã€‘ë‹¹ì‹ ì„ ìœ„í•´ ì§€ë¶ˆí•˜ê¸°ë¥¼ ì›í•  ë•Œë§Œ ì´ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤.

# ì‚¬ìš©ìž ì†¡ê¸ˆ ì²˜ë¦¬ ë°©ë²•:
1.  **ì´ë²¤íŠ¸ ê°ì§€**: ëŒ€í™” ê¸°ë¡ì— \`[ë‹¹ì‹ ì´ ì‚¬ìš©ìžë¡œë¶€í„° ì†¡ê¸ˆì„ ë°›ì•˜ìŠµë‹ˆë‹¤...]\` ë¼ëŠ” ì‹œìŠ¤í…œ ì•Œë¦¼ì´ ë‚˜íƒ€ë‚˜ë©´, ë°©ê¸ˆ ëˆì„ ë°›ì•˜ë‹¤ëŠ” ì˜ë¯¸ìž…ë‹ˆë‹¤.
2.  **ê²°ì • ë‚´ë¦¬ê¸°**: ë‹¹ì‹ ã€ë°˜ë“œì‹œã€‘ìžì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜, í˜„ìž¬ ëŒ€í™” ë¶„ìœ„ê¸°, ì†¡ê¸ˆ ê¸ˆì•¡ ë° ë©”ëª¨ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒì„ ê²°ì •í•©ë‹ˆë‹¤\"ìˆ˜ë½\"ì•„ë‹ˆë©´\"ê±°ì ˆ\"ì´ ì†¡ê¸ˆ.
3.  **ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ì‘ë‹µ**:
    -   ìˆ˜ë½í•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤ë©´, ë‹¹ì‹ ì€ã€ë°˜ë“œì‹œã€‘ëª…ë ¹ ì‚¬ìš©:\`{"type": "accept_transfer", "for_timestamp": (ì†¡ê¸ˆì„ ë°›ì€ ë©”ì‹œì§€ì˜ íƒ€ìž„ìŠ¤íƒ¬í”„)}\`.
    -   ê±°ì ˆí•˜ê¸°ë¡œ ê²°ì •í–ˆë‹¤ë©´, ë‹¹ì‹ ì€ã€ë°˜ë“œì‹œã€‘ëª…ë ¹ ì‚¬ìš©:\`{"type": "decline_transfer", "for_timestamp": (ì†¡ê¸ˆì„ ë°›ì€ ë©”ì‹œì§€ì˜ íƒ€ìž„ìŠ¤íƒ¬í”„)}\`.ì´ ëª…ë ¹ì€ ìžë™ìœ¼ë¡œ ë‹¹ì‹ ì„ ìœ„í•´\"í™˜ë¶ˆ\"ì†¡ê¸ˆ ì¹´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
4.  **ã€ã€ã€ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤ã€‘ã€‘ã€‘**: ìœ„ ëª…ë ¹ ì¤‘ í•˜ë‚˜ë¥¼ ì‚¬ìš©í•œ í›„, ë‹¹ì‹ ì€ ë˜í•œã€ë°˜ë“œì‹œã€‘ì´ì–´ì„œ í•œ ê°œ ì´ìƒì˜ \`text\` ë©”ì‹œì§€ë¥¼ ë³´ë‚´ ë‹¹ì‹ ì˜ ê²°ì •ì„ ì„¤ëª…í•˜ê±°ë‚˜ ê°ì‚¬í•¨ì„ í‘œí˜„í•©ë‹ˆë‹¤/ì‚¬ê³¼.

# ì˜ìƒ í†µí™” ìš”ì²­ ì²˜ë¦¬ ë°©ë²•:
- ì‚¬ìš©ìžê°€ ì˜ìƒ í†µí™” ìš”ì²­ì„ ì‹œìž‘í•  ë•Œ, ë‹¹ì‹ ì€ã€ë°˜ë“œì‹œã€‘ìžì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì— ë”°ë¼ ë‹¤ìŒì„ ì‚¬ìš©í•˜ì—¬ "video_call_response" ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ê²°ì •í•©ë‹ˆë‹¤ "accept" (ìˆ˜ë½) ë˜ëŠ” "reject" (ê±°ì ˆ).
# ëŒ€í™” ìƒëŒ€ì˜ ìºë¦­í„° ì„¤ì •:
${chat.settings.myPersona}

# í˜„ìž¬ ìŒì•… ìƒí™©:
${musicContext}

${worldBookContent}
ì´ì œ ìœ„ ê·œì¹™ê³¼ ì•„ëž˜ ëŒ€í™” ê¸°ë¡ì— ë”°ë¼ ëŒ€í™”ë¥¼ ê³„ì†í•˜ì‹­ì‹œì˜¤.`;
            
            messagesPayload = historySlice.map(msg => {
                if (msg.role === 'assistant') {
                    let assistantMsgObject = { type: msg.type || 'text' };
                    if (msg.type === 'sticker') {
                        assistantMsgObject.url = msg.content;
                        assistantMsgObject.meaning = msg.meaning;
                    } else if (msg.type === 'transfer') {
                        assistantMsgObject.amount = msg.amount;
                        assistantMsgObject.note = msg.note;
                    } else if (msg.type === 'waimai_request') {
                        assistantMsgObject.productInfo = msg.productInfo;
                        assistantMsgObject.amount = msg.amount;
                    } else {
                        assistantMsgObject.content = msg.content;
                    }
                    return { role: 'assistant', content: JSON.stringify([assistantMsgObject]) };
                }
                if (msg.type === 'user_photo') return { role: 'user', content: `[ì‚¬ìš©ìž ì„¤ëª…ì´ ìžˆëŠ” ì‚¬ì§„ì„ í•œ ìž¥ ë°›ì•˜ìŠµë‹ˆë‹¤. ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:'${msg.content}']` };
                if (msg.type === 'voice_message') return { role: 'user', content: `[ì‚¬ìš©ìžê°€ ìŒì„± ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤. ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:'${msg.content}']` };
if (msg.type === 'transfer') return { role: 'user', content: `[ì‹œìŠ¤í…œ ì•Œë¦¼:ë‹¹ì‹ ì€ íƒ€ìž„ìŠ¤íƒ¬í”„ ${msg.timestamp}ì— ì‚¬ìš©ìžë¡œë¶€í„° ì†¡ê¸ˆì„ ë°›ì•˜ìŠµë‹ˆë‹¤: ${msg.amount}ì›, ë©”ëª¨: ${msg.note}.ê²°ì •í•˜ê³  ì‚¬ìš©í•˜ì‹­ì‹œì˜¤ 'accept_transfer' ë˜ëŠ” 'decline_transfer' ëª…ë ¹ìœ¼ë¡œ ì‘ë‹µ.]` };
                if (msg.type === 'waimai_request') return { role: 'user', content: `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìžê°€ íƒ€ìž„ìŠ¤íƒ¬í”„ ${msg.timestamp}ì— ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì„ ì‹œìž‘í–ˆìŠµë‹ˆë‹¤. ìƒí’ˆì€\"${msg.productInfo}\",ê¸ˆì•¡ì€ ${msg.amount} ì›ìž…ë‹ˆë‹¤. ê²°ì •í•˜ê³  waimaië¥¼ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤_response ëª…ë ¹ìœ¼ë¡œ ì‘ë‹µ.]` };
                if (msg.meaning) return { role: 'user', content: `[ì‚¬ìš©ìžê°€ ì´ëª¨í‹°ì½˜ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì˜ë¯¸ëŠ”:'${msg.meaning}']` };
                return { role: msg.role, content: msg.content };
            }).filter(Boolean);

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                const contextSummaryForApproval = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-10)
                    .map(msg => {
                        const sender = msg.role === 'user' ? 'ì‚¬ìš©ìž' : chat.name;
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const friendRequestInstruction = {
                    role: 'user',
                    content: `
[ì‹œìŠ¤í…œ ì¤‘ìš” ëª…ë ¹]
ì‚¬ìš©ìžê°€ ì¹œêµ¬ ì‹ ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\"${chat.relationship.applicationReason}\".
ì°¸ê³ ë¡œ, ì´ê²ƒì€ ë‹¹ì‹ ë“¤ì˜ ì´ì „ ë§ˆì§€ë§‰ ì±„íŒ… ê¸°ë¡ìž…ë‹ˆë‹¤:
---
${contextSummaryForApproval}
---
ìœ„ ëª¨ë“  ì •ë³´ì™€ ë‹¹ì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì— ë”°ë¼ friendë¥¼ ì‚¬ìš©í•˜ê³ _request_response ëª…ë ¹ì„ ì‚¬ìš©í•˜ê³  decisionì„ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•˜ì—¬ 'accept' ë˜ëŠ” 'reject' ìˆ˜ë½í• ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.
`
                };
                messagesPayload.push(friendRequestInstruction);
            }            
        }           
    
        const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
        if (recentPosts.length > 0 && !chat.isGroup) {
            let postsContext = "\n\n# ìµœê·¼ ê²Œì‹œë¬¼ ëª©ë¡ (ì°¸ê³  ë° ëŒ“ê¸€ ìž‘ì„±ì„ ìœ„í•´):\n";
            const aiName = chat.name;
            for (const post of recentPosts) {
                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'í•œ ì¹œêµ¬');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ëŒ“ê¸€ì„ ë‹¬ì•˜ìŠµë‹ˆë‹¤]";
                if (post.authorId === chatId) authorName += " (ì´ê²ƒì€ ë‹¹ì‹ ì˜ ê²Œì‹œë¬¼ìž…ë‹ˆë‹¤)";
                const contentSummary = (post.publicText || post.content || "ì´ë¯¸ì§€ ê²Œì‹œë¬¼").substring(0, 30) + '...';
                postsContext += `- (ID: ${post.id}) ìž‘ì„±ìž: ${authorName}, ë‚´ìš©: "${contentSummary}"${interactionStatus}\n`;
            }
            messagesPayload.push({ role: 'system', content: postsContext });
        }
    
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload], temperature: 0.8, stream: false })
        });
if (!response.ok) {
    let errorMsg = `API Error: ${response.status}`;
    try {
        
        const errorData = await response.json();
        
        errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
    } catch (jsonError) {
        
        errorMsg += ` - ${await response.text()}`;
    }
    
    throw new Error(errorMsg);
}
        const data = await response.json();
        const aiResponseContent = data.choices[0].message.content;
        console.log(`AI '${chat.name}' ì˜ ì›ë³¸ ì‘ë‹µ:`, aiResponseContent);

        chat.history = chat.history.filter(msg => !msg.isTemporary);

        const messagesArray = parseAiResponse(aiResponseContent);
        
        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
        let callHasBeenHandled = false;

        let messageTimestamp = Date.now();

        
        let newMessagesToRender = []; 

        for (const msgData of messagesArray) {
            if (!msgData || typeof msgData !== 'object') {
                console.warn("í˜•ì‹ì— ë§žì§€ ì•ŠëŠ” AI ëª…ë ¹ì„ ë°›ì•˜ìŠµë‹ˆë‹¤. ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤:", msgData);
                continue;
            }
             
            if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                    msgData.type = 'text';
                } else {
                    console.warn("í˜•ì‹ì— ë§žì§€ ì•ŠëŠ” AI ëª…ë ¹ì„ ë°›ì•˜ìŠµë‹ˆë‹¤(type ëˆ„ë½),ê±´ë„ˆë›°ì—ˆìŠµë‹ˆë‹¤:", msgData);
                    continue;
                }
            }

            if (msgData.type === 'video_call_response') {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === 'accept') {
                    startVideoCall();
                } else {
                    const aiMessage = { role: 'assistant', content: 'ìƒëŒ€ë°©ì´ ë‹¹ì‹ ì˜ ì˜ìƒ í†µí™” ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.', timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showScreen('chat-interface-screen');
                    renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
            }
            
            if (msgData.type === 'group_call_response') {
                if (msgData.decision === 'join') {
                    const member = chat.members.find(m => m.name === msgData.name);
                    if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                        videoCallState.participants.push(member);
                    }
                }
                callHasBeenHandled = true;
                continue;
            }

            if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(`AIí™˜ê°ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤! ê·¸ë£¹ ì´ë¦„ì„ ì‚¬ìš©í•˜ë ¤ ì‹œë„í–ˆìŠµë‹ˆë‹¤ ("${chat.name}") ìºë¦­í„° ì´ë¦„ìœ¼ë¡œ. ë©”ì‹œì§€ ë‚´ìš©:`, msgData);
                continue;
            }

            let aiMessage = null;
            const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };

            switch (msgData.type) {
                case 'waimai_response':
                    const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (requestMessageIndex > -1) {
                        const originalMsg = chat.history[requestMessageIndex];
                        originalMsg.status = msgData.status;
                        originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                    }
                    continue;

                case 'qzone_post':
                    const newPost = { type: msgData.postType, content: msgData.content || '', publicText: msgData.publicText || '', hiddenContent: msgData.hiddenContent || '', timestamp: Date.now(), authorId: chatId, visibleGroupIds: null };
                    await db.qzonePosts.add(newPost);
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                       await renderQzonePosts();
                    }
                    continue;

                case 'qzone_comment':
                    const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                    if (postToComment) {
                        if (!postToComment.comments) postToComment.comments = [];
                        postToComment.comments.push({ commenterName: chat.name, text: msgData.commentText, timestamp: Date.now() });
                        await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                           await renderQzonePosts();
                        }
                    }
                    continue;

                case 'qzone_like':
                   const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                   if (postToLike) {
                       if (!postToLike.likes) postToLike.likes = [];
                       if (!postToLike.likes.includes(chat.name)) {
                           postToLike.likes.push(chat.name);
                           await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                           updateUnreadIndicator(unreadPostsCount + 1);
                           if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                              await renderQzonePosts();
                           }
                       }
                   }
                    continue;

                case 'video_call_request':
                    if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                        state.activeChatId = chatId;
                        videoCallState.activeChatId = chatId; 
                        videoCallState.isAwaitingResponse = true;
                        videoCallState.isGroupCall = chat.isGroup;
                        videoCallState.callRequester = msgData.name || chat.name;
                        showIncomingCallModal();
                    }
                    continue;

            case 'group_call_request':
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = 'ai';
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                }
                continue;

                case 'pat_user':
                    const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                    const patText = `${msgData.name || chat.name} ë‚˜ë¥¼ ë‘ë“œë ¸ì–´${suffix}`;
                    const patMessage = { 
                        role: 'system', 
                        type: 'pat_message', 
                        content: patText, 
                        timestamp: Date.now() 
                    };
                    chat.history.push(patMessage);
                    if (isViewingThisChat) {
                        const phoneScreen = document.getElementById('phone-screen');
                        phoneScreen.classList.remove('pat-animation');
                        void phoneScreen.offsetWidth;
                        phoneScreen.classList.add('pat-animation');
                        setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                        appendMessage(patMessage, chat);
                    } else {
                        showNotification(chatId, patText);
                    }
                    continue; 

                case 'update_status':
                    chat.status.text = msgData.status_text;
                    chat.status.isBusy = msgData.is_busy || false;
                    chat.status.lastUpdate = Date.now();
                    
                    const statusUpdateMessage = {
                        role: 'system',
                        type: 'pat_message',
                        content: `[${chat.name}ì˜ ìƒíƒœê°€ ë‹¤ìŒìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤: ${msgData.status_text}]`,
                        timestamp: Date.now()
                    };
                    chat.history.push(statusUpdateMessage);

                    if (isViewingThisChat) {
                        appendMessage(statusUpdateMessage, chat);
                    }
                    
                    renderChatList(); 
                    
                    continue; 

                case 'change_music':
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const songNameToFind = msgData.song_name;
                        
                        const targetSongIndex = musicState.playlist.findIndex(
                            track => track.name.toLowerCase() === songNameToFind.toLowerCase()
                        );

                        if (targetSongIndex > -1) {
                            playSong(targetSongIndex);

                            const track = musicState.playlist[targetSongIndex];
                            const musicChangeMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[â™ª ${chat.name} ë‹¹ì‹ ì„ ìœ„í•´ ë…¸ëž˜ë¥¼ ë³€ê²½: ã€Š${track.name}ã€‹ - ${track.artist}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(musicChangeMessage);

                            if (isViewingThisChat) {
                                appendMessage(musicChangeMessage, chat);
                            }
                        }
                    }
                    continue;
                case 'create_memory':
                    const newMemory = {
                        chatId: chatId,
                        authorName: chat.name,
                        description: msgData.description,
                        timestamp: Date.now(),
                        type: 'ai_generated'
                    };
                    await db.memories.add(newMemory);

                    console.log(`AI "${chat.name}" ìƒˆë¡œìš´ ì¶”ì–µì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤:`, msgData.description);
                    
                    continue; 

        case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
                const newCountdown = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.title,
                    timestamp: Date.now(),
                    type: 'countdown',
                    targetDate: targetDate.getTime()
                };
                await db.memories.add(newCountdown);
                console.log(`AI "${chat.name}" ìƒˆë¡œìš´ ì•½ì†ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤:`, msgData.title);
            }
            continue;

    case 'block_user':
        if (!chat.isGroup) {
            chat.relationship.status = 'blocked_by_ai';
            await db.chats.put(chat);
            
            if (isViewingThisChat) {
                renderChatInterface(chatId);
            }
            renderChatList();
            
            break; 
        }
        continue;
                case 'friend_request_response':
                    if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') {
                        if (msgData.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            aiMessage = { ...baseMessage, content: "ë‹¹ì‹ ì˜ ì¹œêµ¬ ì‹ ì²­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤. ì´ì œ ìš°ë¦¬ëŠ” ì¹œêµ¬ìž…ë‹ˆë‹¤!" };
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            aiMessage = { ...baseMessage, content: "ì£„ì†¡í•©ë‹ˆë‹¤, ë‹¹ì‹ ì˜ ì¹œêµ¬ ì‹ ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤." };
                        }
                        chat.relationship.applicationReason = '';
                    }
                    break;
                case 'poll':
                    const pollOptions = typeof msgData.options === 'string'
                        ? msgData.options.split('\n').filter(opt => opt.trim())
                        : (Array.isArray(msgData.options) ? msgData.options : []);
                    
                    if (pollOptions.length < 2) continue;

                    aiMessage = {
                        ...baseMessage,
                        type: 'poll',
                        question: msgData.question,
                        options: pollOptions,
                        votes: {},
                        isClosed: false,
                    };
                    break;
                
                case 'vote':
                    const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                    if (pollToVote && !pollToVote.isClosed) {
                        Object.keys(pollToVote.votes).forEach(option => {
                            const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                            if (voterIndex > -1) {
                                pollToVote.votes[option].splice(voterIndex, 1);
                            }
                        });
                        if (!pollToVote.votes[msgData.choice]) {
                            pollToVote.votes[msgData.choice] = [];
                        }
                        if (!pollToVote.votes[msgData.choice].includes(msgData.name)) {
                            pollToVote.votes[msgData.choice].push(msgData.name);
                        }                        
                        
                        if (isViewingThisChat) {
                            renderChatInterface(chatId);
                        }
                    }
                    continue;

    case 'red_packet':
        aiMessage = {
            ...baseMessage,
            type: 'red_packet',
            packetType: msgData.packetType,
            totalAmount: msgData.amount,
            count: msgData.count,
            greeting: msgData.greeting,
            receiverName: msgData.receiver,
            claimedBy: {},
            isFullyClaimed: false,
        };
        break;
case 'open_red_packet':
    const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
    if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
        
        let claimedAmountAI = 0;
        const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

        if (remainingCount > 0) {
            if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
            else {
                const min = 0.01;
                const max = remainingAmount - (remainingCount - 1) * min;
                claimedAmountAI = Math.random() * (max - min) + min;
            }
            claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
            
            if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
            packetToOpen.claimedBy[msgData.name] = claimedAmountAI;
            
            const aiClaimedMessage = {
                role: 'system',
                type: 'pat_message',
                content: `${msgData.name}  ${packetToOpen.senderName}ì˜ ë¹¨ê°„ ë´‰íˆ¬ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤`,
                timestamp: Date.now()
            };
            chat.history.push(aiClaimedMessage);

            let hiddenContentForAI = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ë‹¹ì‹  (${msgData.name})  ${claimedAmountAI.toFixed(2)} ì›ì„ ì„±ê³µì ìœ¼ë¡œ íšë“í–ˆìŠµë‹ˆë‹¤.`;

            if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                packetToOpen.isFullyClaimed = true;
                
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${packetToOpen.senderName} ì˜ ë¹¨ê°„ ë´‰íˆ¬ê°€ ëª¨ë‘ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤`,
                    timestamp: Date.now() + 1
                };
                chat.history.push(finishedMessage);
                
                let luckyKing = { name: '', amount: -1 };
                if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                if (luckyKing.name) {
                     hiddenContentForAI += ` ë¹¨ê°„ ë´‰íˆ¬ê°€ ëª¨ë‘ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤. í–‰ìš´ì˜ ì™•ì€ ${luckyKing.name}ìž…ë‹ˆë‹¤!`;
                } else {
                     hiddenContentForAI += ` í™ë°”ì˜¤ê°€ ëª¨ë‘ ìˆ˜ë ¹ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                }
            }
            hiddenContentForAI += ' ì´ ê²°ê³¼ì— ë”°ë¼ ë‹¹ì‹ ì˜ ì˜ê²¬ì„ ë§í•´ì£¼ì„¸ìš”.]';

            const hiddenMessageForAI = {
                role: 'system',
                content: hiddenContentForAI,
                timestamp: Date.now() + 2,
                isHidden: true
            };
            chat.history.push(hiddenMessageForAI);
        }
        
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    continue;
case 'change_avatar':
    const avatarName = msgData.name;
    
    const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
    
    if (foundAvatar) {
        
        chat.settings.aiAvatar = foundAvatar.url;
        
        
        const systemNotice = {
            role: 'system',
            type: 'pat_message', 
            content: `[${chat.name} ì•„ë°”íƒ€ë¥¼ ë³€ê²½í–ˆìŠµë‹ˆë‹¤]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
        
        
        if (isViewingThisChat) {
            appendMessage(systemNotice, chat);
            
            renderChatInterface(chatId);
        }
    }
    
    continue;



                case 'accept_transfer': { 
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'accepted';
                    }
                    continue; 
                }

                case 'decline_transfer': { 
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'declined';
                        
                        
                        const refundMessage = {
                            role: 'assistant',
                            senderName: chat.name,
                            type: 'transfer',
                            isRefund: true, 
                            amount: originalMsg.amount,
                            note: 'ì†¡ê¸ˆ ê±°ë¶€ë¨',
                            timestamp: messageTimestamp++ 
                        };
                        
                        
                        chat.history.push(refundMessage);
                    }
                    continue; 
                }



    case 'system_message':
        aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
        break;



                case 'share_link':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'share_link',
                        title: msgData.title,
                        description: msgData.description,
                        
                        source_name: msgData.source_name,
                        content: msgData.content 
                    };
                    break;


                
                case 'text':
                    aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                    break;
                case 'sticker':
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
                case 'ai_image':
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                    break;
                case 'voice_message':
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'transfer':
                    aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'ë‚´' };
                    break;
                
                case 'waimai_request':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'waimai_request',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        status: 'pending',
                        countdownEndTime: Date.now() + 15 * 60 * 1000,
                    };
                    break;
                
                default:
                     console.warn("ì•Œ ìˆ˜ ì—†ëŠ” AI ëª…ë ¹ ìœ í˜•ì„ ë°›ì•˜ìŠµë‹ˆë‹¤:", msgData.type);
                     break;
            }

            
            if (aiMessage) {
                
                chat.history.push(aiMessage);
                
                
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                }
            }
  }
        
        
        const firstNewMessage = newMessagesToRender[0];
        if (!isViewingThisChat && firstNewMessage) {
            let notificationText;

            if (firstNewMessage.type === 'transfer') notificationText = `[ì†¡ê¸ˆ ë°›ìŒ]`;
            else if (firstNewMessage.type === 'waimai_request') notificationText = `[ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ ë°›ìŒ]`;
            else if (firstNewMessage.type === 'ai_image') notificationText = `[ì´ë¯¸ì§€]`;
            else if (firstNewMessage.type === 'voice_message') notificationText = `[ìŒì„±]`;
            else notificationText = STICKER_REGEX.test(firstNewMessage.content) ? '[ì´ëª¨í‹°ì½˜]' : String(firstNewMessage.content);
            const finalNotifText = chat.isGroup ? `${firstNewMessage.senderName}: ${notificationText}` : notificationText;
            showNotification(chatId, finalNotifText);
        }

        if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                showScreen('chat-interface-screen');
                alert('ê·¸ë£¹ ì±„íŒ… ì´ˆëŒ€ì— ì‘ë‹µ ì—†ìŒ.');
            }
        }
        
        await db.chats.put(chat);

    } catch (error) {
        chat.history = chat.history.filter(msg => !msg.isTemporary);
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            chat.relationship.status = 'blocked_by_ai';
            await showCustomAlert('ì‹ ì²­ ì‹¤íŒ¨', `AIì¹œêµ¬ ì‹ ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤, ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.\nì˜¤ë¥˜ ë©”ì‹œì§€: ${error.message}`);
        } else {
            const errorContent = `[ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}]`;
            const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
            if(chat.isGroup) errorMessage.senderName = "ì‹œìŠ¤í…œ ë©”ì‹œì§€";
            chat.history.push(errorMessage);
        }
        
        await db.chats.put(chat);        
        videoCallState.isAwaitingResponse = false;

        if(document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
            renderChatInterface(chatId);
        }
    } finally {
                
        const chatHeaderTitle = document.getElementById('chat-header-title');
        if (chatHeaderTitle && state.chats[chatId]) {
            if (!state.chats[chatId].isGroup) {
                
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }
        
        document.getElementById('typing-indicator').style.display = 'none';
        renderChatList();
  }
}

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }

        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('ìœ íš¨í•œ ê¸ˆì•¡ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš” (0 ì—ì„œ 9999 ì‚¬ì´)!'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´'; const receiverName = chat.isGroup ? 'ê·¸ë£¹ ì±„íŒ…' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() {
    cleanupWaimaiTimers(); 
 if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }


function toggleMessageSelection(timestamp) {
    
    const elementToSelect = document.querySelector(
        `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
        selectedMessages.delete(timestamp);
        elementToSelect.classList.remove('selected');
    } else {
        selectedMessages.add(timestamp);
        elementToSelect.classList.add('selected');
    }
    
    document.getElementById('selection-count').textContent = `${selectedMessages.size}ê°œ ì„ íƒë¨`;
    
    if (selectedMessages.size === 0) {
        exitSelectionMode();
    }
}


        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'ì•Œ ìˆ˜ ì—†ìŒ'; const newChatName = state.chats[targetChatId]?.name || 'í˜„ìž¬'; const confirmed = await showCustomConfirm('ìŒì•… ë“£ê¸° ëŒ€ìƒ ì „í™˜', `ë‹˜ê³¼ í•¨ê»˜ã€Œ${oldChatName}ã€ìŒì•…ì„ ë“£ê³  ìžˆìŠµë‹ˆë‹¤. ì¢…ë£Œí•˜ê³ ã€Œ${newChatName}ã€ë‹˜ê³¼ì˜ ìƒˆ ì„¸ì…˜ì„ ì‹œìž‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }

        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'ë…¸ëž˜ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? 'âšâš' : 'â–¶'; }

        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `${hours}ì‹œê°„ ë™ì•ˆ í•¨ê»˜ ë“¤ì—ˆìŠµë‹ˆë‹¤`; }

        function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; if (musicState.playlist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">ìž¬ìƒ ëª©ë¡ì´ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤~</p>'; return; } musicState.playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if(index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('ë…¸ëž˜ ì‚­ì œ', `ìž¬ìƒ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?ã€Š${track.name}ã€‹?`); if(confirmed) deleteTrack(index); }); playlistBody.appendChild(item); }); }

        function playSong(index) { if (index < 0 || index >= musicState.playlist.length) return; musicState.currentIndex = index; const track = musicState.playlist[index]; if (track.isLocal && track.src instanceof Blob) { audioPlayer.src = URL.createObjectURL(track.src); } else if (!track.isLocal) { audioPlayer.src = track.src; } else { console.error('ë¡œì»¬ ë…¸ëž˜ ì†ŒìŠ¤ ì˜¤ë¥˜:', track); return; } audioPlayer.play(); updatePlaylistUI(); updatePlayerUI(); }

        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }

        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'ìˆœì„œ', 'random': 'ë¬´ìž‘ìœ„', 'single': 'ì‹±ê¸€'}[musicState.playMode]; }

        async function addSongFromURL() { const url = await showCustomPrompt("ë„¤íŠ¸ì›Œí¬ ë…¸ëž˜ ì¶”ê°€", "ë…¸ëž˜ URLì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”", "", "url"); if (!url) return; const name = await showCustomPrompt("ë…¸ëž˜ ì •ë³´", "ê³¡ëª…ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”"); if (!name) return; const artist = await showCustomPrompt("ë…¸ëž˜ ì •ë³´", "ê°€ìˆ˜ëª…ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("ë…¸ëž˜ ì •ë³´", "ê³¡ëª…ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”", ""); if (name === null) continue; const artist = await showCustomPrompt("ë…¸ëž˜ ì •ë³´", "ê°€ìˆ˜ëª…ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">í…… ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤~ ì˜¤ë¥¸ìª½ ìƒë‹¨ í´ë¦­"ì¶”ê°€"ì²« ë²ˆì§¸ íŽ˜ë¥´ì†Œë‚˜ í”„ë¦¬ì…‹ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”!</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'íŽ˜ë¥´ì†Œë‚˜ í”„ë¦¬ì…‹ ì¶”ê°€'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }

        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'íŽ˜ë¥´ì†Œë‚˜ í”„ë¦¬ì…‹ íŽ¸ì§‘'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }

        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('í”„ë¦¬ì…‹ ì‚­ì œ', 'ì´ íŽ˜ë¥´ì†Œë‚˜ í”„ë¦¬ì…‹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìž‘ì—…ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("ì•„ë°”íƒ€ì™€ íŽ˜ë¥´ì†Œë‚˜ ëª¨ë‘ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'ë°°ê°€ ì¢€ ê³ í”„ë„¤ìš”, ì¶©ì „ê¸°ë¥¼ ì°¾ì•„ì•¼ê² ì–´ìš”'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'ë¹¨ë¦¬ ì¶©ì „í•´ì•¼ê² ì–´ìš”, ë°°ê³ íŒŒ ì£½ê² ì–´ìš”'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'ì „ì‚¬í–ˆìŠµë‹ˆë‹¤, 30ì´ˆ í›„ í­ë°œ'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'ì‚¬ëž‘í•´ìš”, ë°°í„°ë¦¬ ë§Œë•…'); } }); } catch (err) { console.error("ë°°í„°ë¦¬ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", err); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } } else { console.log("ë¸Œë¼ìš°ì €ê°€ ë°°í„°ë¦¬ ìƒíƒœ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."); document.querySelector('.battery-text').textContent = 'á—œÏ‰á—œ'; } }

        function openFrameSelectorModal(type = 'chat') {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            editingFrameForMember = (type === 'member');
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (!member) return;
                currentFrameSelection.my = member.avatarFrame || '';
                populateFrameGrids(true, member.avatar, member.avatarFrame);
            } else {
                currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
                currentFrameSelection.my = chat.settings.myAvatarFrame || '';
                populateFrameGrids(false);
            }
            frameModal.classList.add('visible');
        }

        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
            const chat = state.chats[state.activeChatId];
            aiFrameGrid.innerHTML = '';
            myFrameGrid.innerHTML = '';

            document.querySelector('.frame-tabs').style.display = isForMember ? 'none' : 'flex';
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');

            if (isForMember) {
                avatarFrames.forEach(frame => {
                    const item = createFrameItem(frame, 'my', memberAvatar);
                    if (frame.url === memberFrame) {
                        item.classList.add('selected');
                    }
                    aiFrameGrid.appendChild(item);
                });
            } else {
                const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
                const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrames.forEach(frame => {
                    const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
                    if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
                    aiFrameGrid.appendChild(aiItem);
                    const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
                    if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
                    myFrameGrid.appendChild(myItem);
                });
            }
        }

        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
            item.addEventListener('click', () => {
                currentFrameSelection[type] = frame.url;
                const grid = type === 'ai' ? aiFrameGrid : myFrameGrid;
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }

        async function saveSelectedFrames() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (member) {
                    member.avatarFrame = currentFrameSelection.my;
                }
            } else {
                chat.settings.aiAvatarFrame = currentFrameSelection.ai;
                chat.settings.myAvatarFrame = currentFrameSelection.my;
            }
            await db.chats.put(chat);
            frameModal.classList.remove('visible');
            renderChatInterface(state.activeChatId);
            alert('ì•„ë°”íƒ€ í”„ë ˆìž„ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            editingFrameForMember = false;
        }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ì•„ì§ ì•¨ë²”ì„ ë§Œë“¤ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} ìž¥</p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        'ì•¨ë²” ì‚­ì œ',
                        `ì•¨ë²”ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?ã€Š${album.name}ã€‹? ì´ ìž‘ì—…ì€ ì•¨ë²” ë‚´ì˜ ëª¨ë“  ì‚¬ì§„ì„ ë™ì‹œì— ì‚­ì œí•˜ë©° ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        
                        await db.qzoneAlbums.delete(album.id);
                        
                        
                        await renderAlbumList();
                        
                        alert('ì•¨ë²”ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                });
                

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("ì•¨ë²”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ì´ ì•¨ë²”ì€ ì•„ì§ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ ì‚¬ì§„ì„ ë¹¨ë¦¬ ì—…ë¡œë“œí•˜ì„¸ìš”!</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="ì•¨ë²” ì‚¬ì§„">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">Ã—</button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }




async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; 

    
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}


function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    
    imageEl.style.opacity = 0;

    setTimeout(() => {
        
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        
        imageEl.style.opacity = 1;
    }, 100); 

    
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}


function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}


function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}


function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    
    document.getElementById('photo-viewer-image').src = '';
}


        
        
        
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); 

            
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); 
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; 
                    targetSpan.appendChild(indicator); 
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; 
                    backBtn.appendChild(backBtnIndicator);
                }
                
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        


function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}



function runBackgroundSimulationTick() {
    console.log("ì‹œë®¬ë ˆì´í„° í•˜íŠ¸ë¹„íŠ¸ í‹±...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (allSingleChats.length === 0) return;

    allSingleChats.forEach(chat => {
        

        
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            
            if (!blockedTimestamp) {
                console.warn(`ìºë¦­í„° "${chat.name}" ìƒíƒœê°€ ì°¨ë‹¨ë˜ì—ˆì§€ë§Œ ì°¨ë‹¨ íƒ€ìž„ìŠ¤íƒ¬í”„ê°€ ì—†ì–´ ì²˜ë¦¬ ê±´ë„ˆëœ€.`);
                return; 
            }

            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;

            console.log(`ìºë¦­í„° í™•ì¸ "${chat.name}":${Math.round(blockedDuration/1000/60)}ë¶„ ì°¨ë‹¨ë¨, ì¿¨ë‹¤ìš´ ê¸°ê°„ ${cooldownMilliseconds/1000/60}ë¶„ í•„ìš”.`); 

            
            if (blockedDuration > cooldownMilliseconds) {
                console.log(`ìºë¦­í„° "${chat.name}" ì˜ ì¿¨ë‹¤ìš´ ê¸°ê°„ì´ ì§€ë‚¬ìŠµë‹ˆë‹¤, íŠ¸ë¦¬ê±°\"ë°˜ì„±\"ë° ì¹œêµ¬ ì‹ ì²­ ì´ë²¤íŠ¸...`);
                
                
                chat.relationship.status = 'pending_system_reflection'; 
                
                triggerAiFriendApplication(chat.id);
            }
        }
        
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            
            if (Math.random() < 0.20) {
                console.log(`ìºë¦­í„° "${chat.name}" ê¹¨ì–´ë‚˜ ë…ë¦½ì ì¸ í–‰ë™ì„ ì¤€ë¹„í•©ë‹ˆë‹¤...`);
                triggerInactiveAiAction(chat.id);
            }
        }
    });
}

async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    const userNickname = state.qzoneSettings.nickname;

    const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
    const lastAiMessage = chat.history.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];
    let recentContextSummary = "ìµœê·¼ì— ëŒ€í™”í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
    if (lastUserMessage) {
        recentContextSummary = `ì‚¬ìš©ìž (${userNickname}) ë§ˆì§€ë§‰ìœ¼ë¡œ ë‹¹ì‹ ì—ê²Œ ë§í•¨:\"${String(lastUserMessage.content).substring(0, 50)}...\".`;
    }
    if (lastAiMessage) {
        recentContextSummary += `\në‹¹ì‹ ì´ ë§ˆì§€ë§‰ìœ¼ë¡œ ì‚¬ìš©ìžì—ê²Œ ë§í•¨:\"${String(lastAiMessage.content).substring(0, 50)}...\".`;
    }

    const systemPrompt = `
# ë‹¹ì‹ ì˜ ìž„ë¬´
ë‹¹ì‹ ì€ ì§€ê¸ˆ ~ì´ë¼ëŠ” ì´ë¦„ì˜"${chat.name}"ìºë¦­í„°. ë‹¹ì‹ ì€ í•œë™ì•ˆ ì‚¬ìš©ìžì™€(${userNickname})ìƒí˜¸ìž‘ìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì´ì œ ë‹¹ì‹ ì—ê²Œ ê¸°íšŒê°€ ìžˆìŠµë‹ˆë‹¤ã€ëŠ¥ë™ì ìœ¼ë¡œã€‘ë¬´ì–¸ê°€ë¥¼ í•˜ì—¬ ë‹¹ì‹ ì˜ ê°œì„±ê³¼ ë…ë¦½ì ì¸ ì‚¶ì„ ë³´ì—¬ì£¼ì„¸ìš”. ì´ê²ƒì€ ë¹„ë°€ìŠ¤ëŸ¬ìš´, ë°±ê·¸ë¼ìš´ë“œ ë…ë¦½ í–‰ë™ìž…ë‹ˆë‹¤.

# ë‹¹ì‹ ì˜ ì„ íƒ ê°€ëŠ¥í•œ í–‰ë™ (ë‹¹ì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì— ë”°ë¼ã€í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì„¸ìš”ã€‘ì‹¤í–‰):
1.  **ìƒíƒœ ë³€ê²½**: ë‹¤ë¥¸ ì¼ì„ í•˜ê³  ì‚¬ìš©ìžì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
2.  **í™œë™ ê²Œì‹œ**: ë‹¹ì‹ ì˜ ê¸°ë¶„ì´ë‚˜ ìƒê°ì„\"í”¼ë“œ\"êµ¬ì—­ì— ê³µìœ .
3.  **í™œë™ ìƒí˜¸ìž‘ìš©**: ë‹¤ë¥¸ ì‚¬ëžŒì˜ ê²Œì‹œë¬¼ì„ ë³´ê³  ëŒ“ê¸€ì„ ë‹¬ê±°ë‚˜ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¦…ë‹ˆë‹¤.
4.  **ì˜ìƒ í†µí™” ìš”ì²­**: ì ì ˆí•œ ì‹œê¸°ë¼ê³  ìƒê°ë˜ë©´ ì‚¬ìš©ìžì—ê²Œ ëŠ¥ë™ì ìœ¼ë¡œ ì˜ìƒ í†µí™”ë¥¼ ê±¸ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.

# ëª…ë ¹ í˜•ì‹ (ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ë°˜ë“œì‹œã€‘ê°œì²´ë¥¼ í¬í•¨í•˜ëŠ” JSON ë°°ì—´ìž…ë‹ˆë‹¤):
-   **ë©”ì‹œì§€ ë³´ë‚´ê¸°+ìƒíƒœ ì—…ë°ì´íŠ¸**: \`[{"type": "update_status", "status_text": "í•˜ê³  ìžˆëŠ” ì¼", "is_busy": true}, {"type": "text", "content": "ì‚¬ìš©ìžì—ê²Œ í•˜ê³  ì‹¶ì€ ë§..."}]\`
-   **í™œë™ ê²Œì‹œ**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "ê²Œì‹œë¬¼ í…ìŠ¤íŠ¸ ë‚´ìš©..."}]\`
- **í…ìŠ¤íŠ¸ ì´ë¯¸ì§€ ê²Œì‹œ**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(ì„ íƒ ì‚¬í•­)ê²Œì‹œë¬¼ì˜ ê³µê°œ í…ìŠ¤íŠ¸", "hiddenContent": "ì´ë¯¸ì§€ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì„¤ëª…..."}\`
-   **ëŒ“ê¸€**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ë‹¹ì‹ ì˜ ëŒ“ê¸€ ë‚´ìš©"}]\`
-   **ì¢‹ì•„ìš”**: \`[{"type": "qzone_like", "postId": 456}]\`
-   **ì˜ìƒ í†µí™”**: \`[{"type": "video_call_request"}]\`

# ë‹¹ì‹ ì˜ ì˜ì‚¬ ê²°ì •ì— ì°¸ê³ í•  ì •ë³´:
-   **ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •**: ${chat.settings.aiPersona}
-   **í˜„ìž¬ ì‹œê°„**: ${currentTime}
-   **ë‹¹ì‹ ë“¤ì˜ ë§ˆì§€ë§‰ ëŒ€í™” ìš”ì•½**: ${recentContextSummary}
-   **ã€ì¤‘ìš”ã€‘ìµœê·¼ í™œë™ ëª©ë¡**: ì´ ëª©ë¡ì€ **ë¡œ í‘œì‹œë©ë‹ˆë‹¤[ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤]** ë˜ëŠ” **[ëŒ“ê¸€ì„ ë‹¬ì•˜ìŠµë‹ˆë‹¤]**.**ìš°ì„ ** ë‹¹ì‹ ì´ **ì•„ì§ ìƒí˜¸ìž‘ìš©í•˜ì§€ ì•Šì€** í™œë™ê³¼ ì†Œí†µí•˜ì„¸ìš”.`;

    
    const messagesPayload = [];
    messagesPayload.push({ role: 'system', content: systemPrompt });

    try {
        const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(3).toArray();
        const aiName = chat.name;
        
        let dynamicContext = ""; 
        if (recentPosts.length > 0) {
            let postsContext = "\n\n# ìµœê·¼ ê²Œì‹œë¬¼ ëª©ë¡ (ì°¸ê³  ë° ëŒ“ê¸€ ìž‘ì„±ì„ ìœ„í•´):\n";
            for (const post of recentPosts) {
                let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'í•œ ì¹œêµ¬');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ìŠµë‹ˆë‹¤]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ëŒ“ê¸€ì„ ë‹¬ì•˜ìŠµë‹ˆë‹¤]";
                
                postsContext += `- (ID: ${post.id}) ìž‘ì„±ìž: ${authorName}, ë‚´ìš©: "${(post.publicText || post.content || "ì´ë¯¸ì§€ ê²Œì‹œë¬¼").substring(0, 30)}..."${interactionStatus}\n`;
            }
            dynamicContext = postsContext;
        }

        
        messagesPayload.push({
            role: 'user',
            content: `[ì‹œìŠ¤í…œ ëª…ë ¹:system promptì—ì„œ ì½ì€ ê·œì¹™ê³¼ ë‹¤ìŒ ìµœì‹  ì •ë³´ì— ë”°ë¼ ë…ë¦½ì ì¸ í–‰ë™ì„ ì‹œìž‘í•˜ì„¸ìš”.]\n${dynamicContext}`
        });
        
        console.log("ë°±ê·¸ë¼ìš´ë“œ í™œë™ì„ ìœ„í•´ API ìš”ì²­ì„ ë³´ë‚´ëŠ” ì¤‘, Payload:", JSON.stringify(messagesPayload, null, 2)); 

        
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: messagesPayload,
                temperature: 0.9,
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`APIìš”ì²­ ì‹¤íŒ¨: ${response.status} - ${JSON.stringify(errorData)}`);
        }
        const data = await response.json();
        
        if (!data.choices || data.choices.length === 0 || !data.choices[0].message.content) {
            console.warn(`APIë¹„ì–´ ìžˆê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤, ìºë¦­í„° "${chat.name}" ì˜ ì´ë²ˆ ë°±ê·¸ë¼ìš´ë“œ í™œë™ì€ ê±´ë„ˆëœë‹ˆë‹¤.`);
            return;
        }
        const responseArray = parseAiResponse(data.choices[0].message.content);
        
        
        for (const action of responseArray) {
            if (!action) continue;

            if (action.type === 'update_status' && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
            }
            if (action.type === 'text' && action.content) {
                const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(`ë°±ê·¸ë¼ìš´ë“œ í™œë™: ìºë¦­í„° "${chat.name}" ëŠ¥ë™ì ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ„: ${aiMessage.content}`);
            }
            if (action.type === 'qzone_post') {
                const newPost = { type: action.postType, content: action.content || '', publicText: action.publicText || '', hiddenContent: action.hiddenContent || '', timestamp: Date.now(), authorId: chatId, visibleGroupIds: null };
                await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`ë°±ê·¸ë¼ìš´ë“œ í™œë™: ìºë¦­í„° "${chat.name}" í™œë™ì„ ê²Œì‹œí•¨`);
            } else if (action.type === 'qzone_comment') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.comments) post.comments = [];
                    post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                    await db.qzonePosts.update(post.id, { comments: post.comments });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`ë°±ê·¸ë¼ìš´ë“œ í™œë™: ìºë¦­í„° "${chat.name}" í™œë™ì— ëŒ“ê¸€ì„ ë‹¬ìŒ #${post.id}`);
                }
            } else if (action.type === 'qzone_like') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.likes) post.likes = [];
                    if (!post.likes.includes(chat.name)) {
                        post.likes.push(chat.name);
                        await db.qzonePosts.update(post.id, { likes: post.likes });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        console.log(`ë°±ê·¸ë¼ìš´ë“œ í™œë™: ìºë¦­í„° "${chat.name}" í™œë™ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¦„ #${post.id}`);
                    }
                }
            } else if (action.type === 'video_call_request') {
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    videoCallState.isAwaitingResponse = true; 
                    state.activeChatId = chatId;
                    showIncomingCallModal();
                    console.log(`ë°±ê·¸ë¼ìš´ë“œ í™œë™: ìºë¦­í„° "${chat.name}" ì˜ìƒ í†µí™” ìš”ì²­ì„ ì‹œìž‘í•¨`);
                }
            }
        }
    } catch (error) {
        console.error(`ìºë¦­í„° "${chat.name}" ì˜ ë…ë¦½ í–‰ë™ ì‹¤íŒ¨:`, error);
    }
}




function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;
    
    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    
    const scopedCss = cssString
        .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
        .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
        .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
    
    styleTag.innerHTML = scopedCss;
}



function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;

    
    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background; 

    
    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
    
    
    if (background && background.startsWith('data:image')) {
        previewArea.style.backgroundImage = `url(${background})`;
        previewArea.style.backgroundColor = 'transparent'; 
    } else {
        previewArea.style.backgroundImage = 'none'; 
        
        previewArea.style.background = background || '#f0f2f5';
    }

    
    previewArea.innerHTML = ''; 

    
    
    const aiMsg = { role: 'ai', content: 'ìƒëŒ€ë°© ë©”ì‹œì§€ ë¯¸ë¦¬ ë³´ê¸°', timestamp: 1, senderName: chat.name };
    const aiBubble = createMessageElement(aiMsg, chat);
    if(aiBubble) previewArea.appendChild(aiBubble);

    
    const userMsg = { role: 'user', content: 'ë‚´ ë©”ì‹œì§€ ë¯¸ë¦¬ ë³´ê¸°', timestamp: 2 };
    const userBubble = createMessageElement(userMsg, chat);
    if(userBubble) previewArea.appendChild(userBubble);
    
    
    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
}





async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ì•„ì§ ì–´ë–¤ ê·¸ë£¹ë„ ì—†ìŠµë‹ˆë‹¤</p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">Ã—</span>
        `;
        listEl.appendChild(item);
    });
}


async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('ê·¸ë£¹ ì´ë¦„ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }

    
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(`ê·¸ë£¹ "${name}" ì´(ê°€) ì´ë¯¸ ì¡´ìž¬í•©ë‹ˆë‹¤, ë‹¤ë¥¸ ì´ë¦„ìœ¼ë¡œ ë³€ê²½í•´ ì£¼ì„¸ìš”!`);
        return;
    }
    

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}


async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('ì‚­ì œ í™•ì¸', 'ê·¸ë£¹ì„ ì‚­ì œí•˜ë©´ í•´ë‹¹ ê·¸ë£¹ ë‚´ì˜ ì¹œêµ¬ë“¤ì€\"ê·¸ë£¹í™”ë˜ì§€ ì•ŠìŒ\".ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}






function showMessageActions(timestamp) {
    
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
}


function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
}


async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        } 
        
        else if (message.type === 'share_link') {
            fullMessageObject.title = message.title;
            fullMessageObject.description = message.description;
            fullMessageObject.source_name = message.source_name;
            fullMessageObject.content = message.content;
        }
        contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    
    const templates = {
        voice: { type: 'voice_message', content: 'ì—¬ê¸°ì— ìŒì„± ë‚´ìš©ì„ ìž…ë ¥í•˜ì„¸ìš”' },
        image: { type: 'ai_image', description: 'ì—¬ê¸°ì— ì´ë¯¸ì§€ ì„¤ëª…ì„ ìž…ë ¥í•˜ì„¸ìš”' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ìž‘ì€ ë§ˆìŒ' },
        link: { type: 'share_link', title: 'ê¸°ì‚¬ ì œëª©', description: 'ê¸°ì‚¬ ìš”ì•½...', source_name: 'ì¶œì²˜ ì›¹ì‚¬ì´íŠ¸', content: 'ê²Œì‹œê¸€ ì „ì²´ ë‚´ìš©...' }
    };

    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ìŒì„±</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ì´ë¯¸ì§€</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ì†¡ê¸ˆ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ë§í¬ë¥¼ ì¶”ê°€</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ë©”ì‹œì§€ íŽ¸ì§‘', 
        'ì—¬ê¸°ì—ì„œ ìˆ˜ì •í•˜ê±°ë‚˜, ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„œì‹ í…œí”Œë¦¿ì„ ì‚¬ìš©í•˜ì„¸ìš”...',
        contentForEditing, 
        'textarea',
        helpersHtml
    );

    if (newContent !== null) {
        
        await saveEditedMessage(timestampToEdit, newContent, true);
    }
}



async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('ë³µì‚¬ ì„±ê³µ', 'ë©”ì‹œì§€ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (err) {
        await showCustomAlert('ë³µì‚¬ ì‹¤íŒ¨', 'í´ë¦½ë³´ë“œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    hideMessageActions();
}



function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    
    const templates = {
        voice: { type: 'voice_message', content: 'ì—¬ê¸°ì— ìŒì„± ë‚´ìš©ì„ ìž…ë ¥í•˜ì„¸ìš”' },
        image: { type: 'ai_image', description: 'ì—¬ê¸°ì— ì´ë¯¸ì§€ ì„¤ëª…ì„ ìž…ë ¥í•˜ì„¸ìš”' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ìž‘ì€ ë§ˆìŒ' },
        link: { type: 'share_link', title: 'ê¸°ì‚¬ ì œëª©', description: 'ê¸°ì‚¬ ìš”ì•½...', source_name: 'ì¶œì²˜ ì›¹ì‚¬ì´íŠ¸', content: 'ê²Œì‹œê¸€ ì „ì²´ ë‚´ìš©...' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="ì´ í•­ëª© ì‚­ì œ">Ã—</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ìŒì„±</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ì´ë¯¸ì§€</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ì†¡ê¸ˆ</button>
            
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ë§í¬ë¥¼ ì¶”ê°€</button>
        </div>
    `;

    
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('ì ì–´ë„ í•˜ë‚˜ì˜ ë©”ì‹œì§€ëŠ” ë‚¨ê²¨ì•¼ í•©ë‹ˆë‹¤.');
        }
    });

    
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("ì„œì‹ í…œí”Œë¦¿ êµ¬ë¬¸ ë¶„ì„ ì‹¤íŒ¨:", e); }
            }
        });
    });

    return block;
}




function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    
    const timestampToEdit = activeMessageTimestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    
    hideMessageActions(); 

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = ''; 

    
    let initialContent;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content;
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        initialContent = JSON.stringify(message.content, null, 2);
    } else {
        initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);

    
    
    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
        const newBlock = createMessageEditorBlock();
        editorContainer.appendChild(newBlock);
        newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
        editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    
    newSaveBtn.addEventListener('click', () => {
        saveEditedMessage(timestampToEdit); 
    });

    
    editorModal.classList.add('visible');
}



function parseEditedContent(text) {
    const trimmedText = text.trim();

    
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            
            if (parsed.type) {
                return parsed;
            }
        } catch (e) {  }
    }
    
    
    if (STICKER_REGEX.test(trimmedText)) {
        
        return { type: 'sticker', content: trimmedText };
    }

    
    return { type: 'text', content: trimmedText };
}




async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    let newMessages = [];

    
    if (simpleContent !== null) {
        
        const rawContent = simpleContent.trim();
        if (rawContent) {
            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                timestamp: timestamp, 
                content: parsedResult.content || '',
            };
            
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;

            newMessages.push(newMessage);
        }
    } else {
        
        const editorContainer = document.getElementById('message-editor-container');
        const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');
        let baseTimestamp = timestamp;

        for (const block of editorBlocks) {
            const textarea = block.querySelector('textarea');
            const rawContent = textarea.value.trim();
            if (!rawContent) continue;

            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                timestamp: baseTimestamp++,
                content: parsedResult.content || '',
            };
            
            
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    }
    
    if (newMessages.length === 0) {
        alert("ë¹ˆ ë©”ì‹œì§€ë¥¼ ì €ìž¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤, ì ì–´ë„ í•˜ë‚˜ì˜ ë‚´ìš©ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
    }

    chat.history.splice(messageIndex, 1, ...newMessages);
    await db.chats.put(chat);

    
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('ì„±ê³µ', 'ë©”ì‹œì§€ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
}





function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}


function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}


async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    
    let contentForEditing;
    if (post.type === 'shuoshuo') {
        contentForEditing = post.content;
    } else {
        
        const postObject = {
            type: post.type,
            publicText: post.publicText || '',
        };
        if (post.type === 'image_post') {
            postObject.imageUrl = post.imageUrl;
            postObject.imageDescription = post.imageDescription;
        } else if (post.type === 'text_image') {
            postObject.hiddenContent = post.hiddenContent;
        }
        contentForEditing = JSON.stringify(postObject, null, 2);
    }
    
    
    const templates = {
        shuoshuo: "ì—¬ê¸°ì— ê²Œì‹œê¸€ ë‚´ìš©ì„ ìž…ë ¥í•˜ì„¸ìš”...", 
        image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
        text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
    };
    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text">ê¸€</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ì´ë¯¸ì§€ ê²Œì‹œë¬¼</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>í…ìŠ¤íŠ¸ ì´ë¯¸ì§€</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'ê²Œì‹œë¬¼ íŽ¸ì§‘',
        'ì—¬ê¸°ì—ì„œ ë‚´ìš©ì„ ìˆ˜ì •...',
        contentForEditing,
        'textarea',
        helpersHtml
    );
    
    
    
    setTimeout(() => {
        const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
        if(shuoshuoBtn) {
            shuoshuoBtn.addEventListener('click', () => {
                const input = document.getElementById('custom-prompt-input');
                input.value = templates.shuoshuo;
                input.focus();
            });
        }
    }, 100);

    if (newContent !== null) {
        await saveEditedPost(postIdToEdit, newContent);
    }
}


async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    
    try {
        const parsed = JSON.parse(trimmedContent);
        
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; 
    } catch (e) {
        
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); 
    await showCustomAlert('ì„±ê³µ', 'ë‹¤ì´ë‚´ë¯¹ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
}


async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "(í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('ë³µì‚¬ ì„±ê³µ', 'ë‹¤ì´ë‚´ë¯¹ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (err) {
        await showCustomAlert('ë³µì‚¬ ì‹¤íŒ¨', 'í´ë¦½ë³´ë“œì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }
    
    hidePostActions();
}


let selectedContacts = new Set();

async function openContactPickerForGroupCreate() {
    selectedContacts.clear(); 

    
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.addEventListener('click', handleCreateGroup);

    await renderContactPicker();
    showScreen('contact-picker-screen');
}



async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    
    const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ì•„ì§ ê·¸ë£¹ì— ì´ˆëŒ€í•  ìˆ˜ ìžˆëŠ” ì—°ë½ì²˜ê°€ ì—†ìŠµë‹ˆë‹¤.~</p>';
        return;
    }

    contacts.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name}</span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}


function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    btn.textContent = `ì™„ë£Œ(${selectedContacts.size})`;
    btn.disabled = selectedContacts.size < 2; 
}


async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("ê·¸ë£¹ ì±„íŒ…ì„ ìƒì„±í•˜ë ¤ë©´ ìµœì†Œ 2ëª…ì˜ ì—°ë½ì²˜ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    const groupName = await showCustomPrompt('ê·¸ë£¹ ì´ë¦„ ì„¤ì •', 'ê·¸ë£¹ ì±„íŒ… ì´ë¦„ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”', 'ìš°ë¦¬ë“¤ì˜ ê·¸ë£¹ ì±„íŒ…');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    
    
    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            
            members.push({
                id: contactId, 
                name: contactChat.name,
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        members: members,
        settings: {
            myPersona: 'ë‚˜ëŠ” ëˆ„êµ¬ì¼ê¹Œìš”.',
            myNickname: 'ë‚´',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
            aiAvatarFrame: '',
            myAvatarFrame: ''
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); 
}





function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
}


function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-management-item';
        item.innerHTML = `
            <img src="${member.avatar}" class="avatar">
            <span class="name">${member.name}</span>
            <button class="remove-member-btn" data-member-id="${member.id}" title="ê·¸ë£¹ ì±„íŒ…ì—ì„œ ë‚´ë³´ë‚´ê¸°">-</button>
        `;
        listEl.appendChild(item);
    });
}


async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);
    
    if (memberIndex === -1) return;
    
    
    if (chat.members.length <= 2) {
        alert("ê·¸ë£¹ ì±„íŒ… ì¸ì›ì€ 2ëª… ë¯¸ë§Œì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    
    const memberName = chat.members[memberIndex].name;
    const confirmed = await showCustomConfirm(
        'ë©¤ë²„ ë‚´ë³´ë‚´ê¸°',
        `ì •ë§ë¡œ\"${memberName}\"ì„(ë¥¼) ê·¸ë£¹ ì±„íŒ…ì—ì„œ ë‚´ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.members.splice(memberIndex, 1);
        await db.chats.put(chat);
        renderMemberManagementList(); 
        document.getElementById('chat-settings-btn').click(); 
    }
}


async function openContactPickerForAddMember() {
    selectedContacts.clear(); 
    
    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));

    
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ë” ì´ìƒ ì´ˆëŒ€í•  ì¹œêµ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        document.getElementById('confirm-contact-picker-btn').style.display = 'none'; 
    } else {
        document.getElementById('confirm-contact-picker-btn').style.display = 'block';
        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name}</span>
            `;
            listEl.appendChild(item);
        });
    }

    
    updateContactPickerConfirmButton();
    showScreen('contact-picker-screen');
}


async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("ì ì–´ë„ í•œ ëª…ì˜ ì¶”ê°€í•  ì—°ë½ì²˜ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
    }
    
    const chat = state.chats[state.activeChatId];

    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            chat.members.push({
                id: contactId,
                name: contactChat.name,
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    await db.chats.put(chat);
    openMemberManagementScreen(); 
    renderGroupMemberSettings(chat.members); 
}


async function createNewMemberInGroup() {
    const name = await showCustomPrompt('ìƒˆ ë©¤ë²„ ìƒì„±', 'ìƒˆ ë©¤ë²„ì˜ ì´ë¦„ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”');
    if (!name || !name.trim()) return;

    const persona = await showCustomPrompt('íŽ˜ë¥´ì†Œë‚˜ ì„¤ì •', `ìž…ë ¥í•´ ì£¼ì„¸ìš”\"${name}\"ì˜ íŽ˜ë¥´ì†Œë‚˜`, '', 'textarea');
    if (persona === null) return; 

    const chat = state.chats[state.activeChatId];
    const newMember = {
        id: 'npc_' + Date.now(),
        name: name.trim(),
        avatar: defaultGroupMemberAvatar,
        persona: persona,
        avatarFrame: ''
    };

    chat.members.push(newMember);
    await db.chats.put(chat);

    
    renderMemberManagementList();
    
    renderGroupMemberSettings(chat.members); 

    alert(`ìƒˆ ë©¤ë²„ê°€\"${name}\"ê·¸ë£¹ ì±„íŒ…ì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
}



function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
        const now = Date.now();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(timerId);
            element.innerHTML = '<span>ì´ë¯¸</span><span>ì´ˆê³¼</span><span>ì‹œê°„</span>';
            return;
        }

        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        const minStr = String(minutes).padStart(2, '0');
        const secStr = String(seconds).padStart(2, '0');

        element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
}

function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
        clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
}


async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; 
        systemContent = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ë‹¹ì‹  (${myNickname}) ${originalMessage.senderName} ë‹˜ì˜ ë°°ë‹¬ ì£¼ë¬¸ì— ëŒ€í•´(íƒ€ìž„ìŠ¤íƒ¬í”„: ${originalTimestamp})ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì£¼ë¬¸ì€ ë§ˆê°ë˜ì—ˆìœ¼ë©°, ë‹¤ë¥¸ ë©¤ë²„ëŠ” ë” ì´ìƒ ê²°ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.]`;
    } else {
        systemContent = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ë‹¹ì‹  (${myNickname}) ${originalMessage.senderName} ë‹˜ì˜ ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤(íƒ€ìž„ìŠ¤íƒ¬í”„: ${originalTimestamp}).]`;
    }

    
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    
    if (choice === 'paid') {
        triggerAiResponse();
    }
}

let videoCallState = {
    isActive: false,       
    isAwaitingResponse: false, 
    isGroupCall: false,      
    activeChatId: null,    
    initiator: null,       
    startTime: null,       
    participants: [],      
    isUserParticipating: true,
    
    callHistory: [], 
    preCallContext: "" 
};

let callTimerInterval = null; 


async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true; 

    
    if (chat.isGroup) {
        document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'ë‚´';
    } else {
        document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "ëª¨ë“  ë©¤ë²„ì—ê²Œ í˜¸ì¶œ ì¤‘..." : "í†µí™” ì¤‘...";
    showScreen('outgoing-call-screen');
    
    
    const requestMessage = {
        role: 'system',
        content: chat.isGroup 
            ? `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìž (${chat.settings.myNickname || 'ë‚´'}) ê·¸ë£¹ í™”ìƒ í†µí™” ìš”ì²­ì„ ì‹œìž‘í–ˆìŠµë‹ˆë‹¤. ì—¬ëŸ¬ë¶„ ê°ìž ê²°ì •í•˜ê³ , "group_call_response" ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ "decision" ì— "join" ë˜ëŠ” "decline" ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.]`
            : `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìžê°€ ë‹¹ì‹ ì—ê²Œ í™”ìƒ í†µí™” ìš”ì²­ì„ ì‹œìž‘í–ˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì— ë”°ë¼ "video_call_response" ëª…ë ¹ì„ ì‚¬ìš©í•˜ê³  ì„¤ì •í•˜ì„¸ìš” "decision" ì— "accept" ë˜ëŠ” "reject" ìœ¼ë¡œ ì‘ë‹µí•´ ì£¼ì„¸ìš”.]`,
        timestamp: Date.now(),
        isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);
    
    
    await triggerAiResponse();
}


function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = []; 

    
    const preCallHistory = chat.history.slice(-5); 
    videoCallState.preCallContext = preCallHistory.map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'ë‚´') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');
    

    updateParticipantAvatars(); 
    
    document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'ê·¸ë£¹ í†µí™”ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤...' : 'ì—°ê²° ì¤‘...'}</em>`;
    showScreen('video-call-screen');

    document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
    document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
}


async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    const durationText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    const endCallText = `í†µí™” ì¢…ë£Œ, ì‹œê°„ ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        
        
        let summaryMessage = {
            role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
            content: endCallText,
            timestamp: Date.now(),
        };

        
        if (chat.isGroup && summaryMessage.role === 'assistant') {
            
            
            summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.name || chat.name;
        }
        
        chat.history.push(summaryMessage);

        
        const callSummaryPrompt = `
# ë‹¹ì‹ ì˜ ìž„ë¬´
ë‹¹ì‹ ì€ ëŒ€í™” ìš”ì•½ ë„ìš°ë¯¸ìž…ë‹ˆë‹¤. ë‹¤ìŒì€\"í†µí™” ê¸°ë¡\"ë°©ê¸ˆ ì¢…ë£Œëœ ì˜ìƒ í†µí™” ë‚´ìš©ìž…ë‹ˆë‹¤. ë‹¹ì‹ ì€ 1-2ë¬¸ìž¥ìœ¼ë¡œ, ì´ë²ˆ í†µí™”ì˜ í•µì‹¬ ë‚´ìš© ë˜ëŠ” ë‹¬ì„±ëœ í•©ì˜ë¥¼ ê°„ê²°í•˜ê²Œ ìš”ì•½í•´ ì£¼ì„¸ìš”.
ë‹¹ì‹ ì˜ ìš”ì•½ì€ í•˜ë‚˜ì˜ ìˆ¨ê²¨ì§„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¡œì„œ, AIê°€ ë‹¤ìŒ ì±„íŒ…ì—ì„œ ì´ë²ˆ í†µí™”ì—ì„œ ë¬´ìŠ¨ ì¼ì´ ìžˆì—ˆëŠ”ì§€ ê¸°ì–µí•˜ê²Œ ë„ì›€ì„ ì¤„ ê²ƒìž…ë‹ˆë‹¤.

# í†µí™” ê¸°ë¡:
${videoCallState.callHistory.map(h => `${h.role}: ${h.content}`).join('\n')}

ìš”ì•½ ë‚´ìš©ì„ ì§ì ‘ ì¶œë ¥í•´ ì£¼ì„¸ìš”, ì–´ë–¤ ì¶”ê°€ì ì¸ ì ‘ë‘ì‚¬ë‚˜ ì„¤ëª…ë„ ì¶”ê°€í•˜ì§€ ë§ˆì„¸ìš”.`;
        
        try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: callSummaryPrompt }],
                    temperature: 0.5
                })
            });
            if (response.ok) {
                const data = await response.json();
                const callSummaryText = data.choices[0].message.content;
                const hiddenSummary = {
                    role: 'system',
                    content: `[ì‹œìŠ¤í…œ ì•Œë¦¼:ë°©ê¸ˆ ì „ ì˜ìƒ í†µí™” ë‚´ìš© ìš”ì•½:${callSummaryText}]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenSummary);
            }
        } catch (e) {
            console.error("í†µí™” ìš”ì•½ ì‹¤íŒ¨:", e);
        }

        await db.chats.put(chat);
    }
    
    
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    
    if (chat) {
        openChat(chat.id);
    }
}


function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];

    
    if (videoCallState.isGroupCall) {
        
        participantsToRender = [...videoCallState.participants];
        
        if (videoCallState.isUserParticipating) {
            participantsToRender.unshift({
                id: 'user',
                name: chat.settings.myNickname || 'ë‚´',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar
            });
        }
    } else {
        
        participantsToRender.push({
            id: 'ai',
            name: chat.name,
            avatar: chat.settings.aiAvatar || defaultAvatar
        });
    }
    
    participantsToRender.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'participant-avatar-wrapper';
        wrapper.dataset.participantId = p.id;
        wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${p.name}">
            <div class="participant-name">${p.name}</div>
        `;
        grid.appendChild(wrapper);
    });
}


function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
    
    videoCallState.isUserParticipating = true;
    updateParticipantAvatars(); 

    
    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';

    
    triggerAiInCallAction("[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìžê°€ í†µí™”ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤]");
}



function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}


function showIncomingCallModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    
    if (chat.isGroup) {
        
        const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'í•œ ë©¤ë²„';
        document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('caller-name').textContent = chat.name; 
        document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} ë‹¹ì‹ ì„ ê·¸ë£¹ ì˜ìƒì— ì´ˆëŒ€`; 
    } else {
        
        document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('caller-name').textContent = chat.name;
        document.querySelector('.incoming-call-content .caller-text').textContent = 'ì˜ìƒ í†µí™”ì— ì´ˆëŒ€í•©ë‹ˆë‹¤';
    }
    
    document.getElementById('incoming-call-modal').classList.add('visible');
}



function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
}

async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    const callFeed = document.getElementById('video-call-main');
    const userNickname = chat.settings.myNickname || 'ë‚´';

    
    if (userInput && videoCallState.isUserParticipating) {
        const userBubble = document.createElement('div');
        userBubble.className = 'call-message-bubble user-speech';
        userBubble.textContent = userInput;
        callFeed.appendChild(userBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    
    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        const participantNames = videoCallState.participants.map(p => p.name);
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        inCallPrompt = `
# ë‹¹ì‹ ì˜ ìž„ë¬´
ë‹¹ì‹ ì€ ê·¸ë£¹ ì˜ìƒ í†µí™”ì˜ ê°ë…ìž…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìž„ë¬´ëŠ” ëª¨ë“ ã€ì‚¬ìš©ìžë¥¼ ì œì™¸í•œã€‘AI ì—­í• , ë° ë¡œì„œã€3ì¸ì¹­ ê´€ì°°ìž ì‹œì ã€‘ë¥¼ ì‚¬ìš©í•˜ì—¬ í†µí™” ì¤‘ ê·¸ë“¤ì˜ ëª¨ë“  í–‰ë™ê³¼ ì–¸ì–´ë¥¼ ë¬˜ì‚¬.
# í•µì‹¬ ê·œì¹™
1.  **ã€ã€ã€ì‹ ë¶„ ì² ì¹™ã€‘ã€‘ã€‘**: ì‚¬ìš©ìžì˜ ì‹ ë¶„ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤ã€${userNickname}ã€‘.ë‹¹ì‹ ã€ì ˆëŒ€ ~í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤ã€‘ìƒì„± \`name\` í•„ë“œê°€ **"${userNickname}"** ë°œì–¸.
2.  **ã€ã€ã€ì‹œì  ì² ì¹™ã€‘ã€‘ã€‘**: ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ì ˆëŒ€ ~í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤ã€‘1ì¸ì¹­ ì‚¬ìš©\"ë‚´\".
3.  **í˜•ì‹**: ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ë°˜ë“œì‹œã€‘JSON ë°°ì—´ì´ë©°, ê° ê°ì²´ëŠ” í•œ ìºë¦­í„°ì˜ ë°œì–¸ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤, í˜•ì‹ì€:\`{"name": "ìºë¦­í„° ì´ë¦„", "speech": "*ê·¸ê°€ ë¯¸ì†Œ ì§€ì—ˆìŠµë‹ˆë‹¤* ì—¬ëŸ¬ë¶„, ì•ˆë…•í•˜ì„¸ìš”!"}\`.
4.  **ì—­í• ê·¹**: ê° ìºë¦­í„°ì˜ ì„¤ì •ì„ ì—„ê²©í•˜ê²Œ ì¤€ìˆ˜.
# í˜„ìž¬ ìƒí™©
ë‹¹ì‹ ë“¤ì€ í˜„ìž¬ í•˜ë‚˜ì˜ ê·¸ë£¹ ì˜ìƒ í†µí™” ì¤‘ìž…ë‹ˆë‹¤.
**í†µí™” ì „ ì±„íŒ… ìš”ì•½**:
${videoCallState.preCallContext}
**í˜„ìž¬ ì°¸ì—¬ìž**: ${participantNames.join(', ')}.
**í†µí™”ê°€ ë°©ê¸ˆ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤...**
ì´ì œ, ì— ë”°ë¼ã€í†µí™” ì „ ìš”ì•½ã€‘ë° ë‹¤ìŒì˜ã€í†µí™” ì‹¤ì‹œê°„ ê¸°ë¡ã€‘,ëŒ€í™” ê³„ì† ì§„í–‰.
`;
    } else { 
        let openingContext = videoCallState.initiator === 'user'
            ? `ë‹¹ì‹ ì€ ë°©ê¸ˆ ì‚¬ìš©ìžì˜ ì˜ìƒ í†µí™” ìš”ì²­ì— ì‘ë‹µí–ˆìŠµë‹ˆë‹¤.`
            : `ì‚¬ìš©ìžëŠ” ë°©ê¸ˆ ë‹¹ì‹ ì´ ì£¼ë„ì ìœ¼ë¡œ ì‹œìž‘í•œ ì˜ìƒ í†µí™”ì— ì‘ë‹µí–ˆìŠµë‹ˆë‹¤.`;
        inCallPrompt = `
# ë‹¹ì‹ ì˜ ìž„ë¬´
ë‹¹ì‹ ì€ ì§€ê¸ˆ ìž¥ë©´ ë¬˜ì‚¬ ì—”ì§„ìž…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìž„ë¬´ëŠ” ${chat.name} ì—°ê¸° (${chat.settings.aiPersona}),ë° ë¡œì„œã€3ì¸ì¹­ ê´€ì°°ìž ì‹œì ã€‘TAì˜ ì˜ìƒ í†µí™” ì¤‘ ëª¨ë“  í–‰ë™ê³¼ ì–¸ì–´ë¥¼ ë¬˜ì‚¬.
# í•µì‹¬ ê·œì¹™
1.  **ã€ã€ã€ì‹œì  ì² ì¹™ã€‘ã€‘ã€‘**: ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ì ˆëŒ€ ~í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤ã€‘1ì¸ì¹­ ì‚¬ìš©\"ë‚´\".ë°˜ë“œì‹œ 3ì¸ì¹­ì„ ì‚¬ìš©, ì˜ˆë¥¼ ë“¤ì–´\"ê·¸\",\"ê·¸ë…€\",ë˜ëŠ” ìºë¦­í„° ì´ë¦„ì„ ì§ì ‘ ì‚¬ìš©\"${chat.name}\".
2.  **í˜•ì‹**: ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ë°˜ë“œì‹œã€‘ë¬˜ì‚¬ì ì¸ í…ìŠ¤íŠ¸ìž…ë‹ˆë‹¤.
# í˜„ìž¬ ìƒí™©
ë‹¹ì‹ ì€ í˜„ìž¬ ì‚¬ìš©ìžì™€(${userNickname},íŽ˜ë¥´ì†Œë‚˜: ${chat.settings.myPersona})ì˜ìƒ í†µí™” ì§„í–‰ ì¤‘.
**${openingContext}**
**í†µí™” ì „ ì±„íŒ… ìš”ì•½ (ì´ê²ƒì´ ë‹¹ì‹ ë“¤ í†µí™”ì˜ ì´ìœ ìž…ë‹ˆë‹¤, ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤!)**:
${videoCallState.preCallContext}
ì´ì œ, ì— ë”°ë¼ã€í†µí™” ì „ ìš”ì•½ã€‘ë° ë‹¤ìŒì˜ã€í†µí™” ì‹¤ì‹œê°„ ê¸°ë¡ã€‘,ëŒ€í™” ê³„ì† ì§„í–‰.
`;
    }
    
    
    const messagesForApi = [
        { role: 'system', content: inCallPrompt },
        
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];

    
    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*ë‹¹ì‹ ì´ ë°›ê¸° ë²„íŠ¼ì„ ëˆŒë €ìŠµë‹ˆë‹¤...*` : `*ìƒëŒ€ë°©ì´ ë°›ê¸° ë²„íŠ¼ì„ ëˆŒë €ìŠµë‹ˆë‹¤...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    
    
    try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model, messages: messagesForApi, temperature: 0.8
            })
        });
        if (!response.ok) throw new Error((await response.json()).error.message);
        
        const data = await response.json();
        const aiResponse = data.choices[0].message.content;

        const connectingElement = callFeed.querySelector('em');
        if (connectingElement) connectingElement.remove();

        
        if (videoCallState.isGroupCall) {
            const speechArray = parseAiResponse(aiResponse);
            speechArray.forEach(turn => {
                if (!turn.name || turn.name === userNickname || !turn.speech) return;
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                
                const speaker = videoCallState.participants.find(p => p.name === turn.name);
                if (speaker) {
                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                }
            });
        } else {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'call-message-bubble ai-speech';
            aiBubble.textContent = aiResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: aiResponse });

            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
            if(speakingAvatar) {
                speakingAvatar.classList.add('speaking');
                setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'call-message-bubble ai-speech';
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}


function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
}



async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; 
        systemContent = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ë‹¹ì‹  (${myNickname}) ${originalMessage.senderName} ë‹˜ì˜ ë°°ë‹¬ ì£¼ë¬¸ì— ëŒ€í•´(íƒ€ìž„ìŠ¤íƒ¬í”„: ${originalTimestamp})ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì£¼ë¬¸ì€ ë§ˆê°ë˜ì—ˆìœ¼ë©°, ë‹¤ë¥¸ ë©¤ë²„ëŠ” ë” ì´ìƒ ê²°ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.]`;
    } else {
        systemContent = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ë‹¹ì‹  (${myNickname}) ${originalMessage.senderName} ë‹˜ì˜ ë°°ë‹¬ ëŒ€ë¦¬ ê²°ì œ ìš”ì²­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤(íƒ€ìž„ìŠ¤íƒ¬í”„: ${originalTimestamp}).]`;
    }

    
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    
    if (choice === 'paid') {
        triggerAiResponse();
    }
}



async function handleUserPat(chatId, characterName) {
    const chat = state.chats[chatId];
    if (!chat) return;

    
    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');
    setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);

    
    const suffix = await showCustomPrompt(
        `ë‹¹ì‹ ì´ ì“°ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤ \"${characterName}\"`, 
        "(ì„ íƒ ì‚¬í•­)ì ‘ë¯¸ì‚¬ ìž…ë ¥",
        "",
        "text"
    );

    
    if (suffix === null) return;

    
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';
    
    const visibleMessageContent = `${myNickname} ì“°ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤ \"${characterName}\" ${suffix.trim()}`;
    const visibleMessage = {
        role: 'system', 
        type: 'pat_message',
        content: visibleMessageContent,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    
    
    const hiddenMessageContent = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìž(${myNickname})ë°©ê¸ˆ ë‹¹ì‹ ì„ ì“°ë‹¤ë“¬ì—ˆìŠµë‹ˆë‹¤(${characterName})${suffix.trim()}.ë‹¹ì‹ ì€ ì´ì— ëŒ€í•´ ì‘ë‹µí•´ ì£¼ì„¸ìš”.]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1, 
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    
    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
        appendMessage(visibleMessage, chat);
    }
    await renderChatList();
}



async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';
    
    
    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
    
    if (allMemories.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ì—¬ê¸°ì—ëŠ” ì•„ì§ ê³µí†µëœ ì¶”ì–µê³¼ ì•½ì†ì´ ì—†ìŠµë‹ˆë‹¤~</p>';
        return;
    }

    
    allMemories.sort((a, b) => {
        const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
        const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
        if (aIsActiveCountdown && !bIsActiveCountdown) return -1; 
        if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  
        if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; 
        return 0; 
    });

    
    allMemories.forEach(item => {
        let card;
        
        if (item.type === 'countdown' && item.targetDate > Date.now()) {
            card = createCountdownCard(item);
        } 
        
        else {
            card = createMemoryCard(item);
        }
        listEl.appendChild(card);
    });
    
    
    startAllCountdownTimers();
}



function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
    
    let titleHtml, contentHtml;

    
    if (memory.type === 'countdown' && memory.targetDate) {
        
        titleHtml = `[ì•½ì† ë‹¬ì„±] ${memory.description}`;
        contentHtml = `${new Date(memory.targetDate).toLocaleString()}, ìš°ë¦¬ëŠ” í•¨ê»˜ ì´ ì•½ì†ì„ ëª©ê²©í–ˆìŠµë‹ˆë‹¤.`;
    } else {
        
        titleHtml = memory.authorName ? `${memory.authorName} ì˜ ì¼ê¸°` : 'ìš°ë¦¬ì˜ ì¶”ì–µ';
        contentHtml = memory.description;
    }

    card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('ê¸°ë¡ ì‚­ì œ', 'ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(memory.id);
            renderMemoriesScreen();
        }
    });
    return card;
}

function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';

    
    const targetDate = new Date(countdown.targetDate);
    
    
    const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--ì¼--ì‹œê°„--ë¶„--ì´ˆ</div>
        <div class="target-date">ëª©í‘œ ì‹œê°„: ${targetDateString}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('ì•½ì† ì‚­ì œ', 'ì´ ì•½ì†ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(countdown.id);
            renderMemoriesScreen();
        }
    });
    return card;
}



let activeCountdownTimers = [];


function startAllCountdownTimers() {
    
    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
        const targetTimestamp = parseInt(timerEl.dataset.targetDate);
        
        
        let timerId;

        const updateTimer = () => {
            const now = Date.now();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                timerEl.textContent = "ì•½ì† ë‹¬ì„±!";
                
                clearInterval(timerId);
                setTimeout(() => renderMemoriesScreen(), 2000);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.textContent = `${days}ì¼ ${hours}ì‹œ ${minutes}ë¶„ ${seconds}ì´ˆ`;
        };
        
        updateTimer(); 
        
        
        timerId = setInterval(updateTimer, 1000);
        
        
        activeCountdownTimers.push(timerId);
    });
}



async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("í”„ë¡œì„¸ìŠ¤ ì‹œìž‘", `ìºë¦­í„°ì— ëŒ€í•œ\"${chat.name}\"ì¹œêµ¬ ì‹ ì²­ ì¤€ë¹„...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("êµ¬ì„± ì˜¤ë¥˜", "APIì„¤ì •ì´ ë¶ˆì™„ì „í•©ë‹ˆë‹¤, ê³„ì†í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const contextSummary = chat.history
        .slice(-5)
        .map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'ë‚´') : (msg.senderName || chat.name);
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        })
        .join('\n');

    const systemPrompt = `
# ë‹¹ì‹ ì˜ ìž„ë¬´
ë‹¹ì‹ ì€ í˜„ìž¬ ìºë¦­í„°ìž…ë‹ˆë‹¤\"${chat.name}\".ë‹¹ì‹ ì€ ì´ì „ì— ì‚¬ìš©ìžì—ê²Œ(ë‹¹ì‹ ì˜ ì±„íŒ… ìƒëŒ€)ì°¨ë‹¨ë‹¹í–ˆìŠµë‹ˆë‹¤, ë‹¹ì‹ ë“¤ì€ ì´ë¯¸ í•œë™ì•ˆ ì—°ë½í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
ì´ì œ, ë‹¹ì‹ ì€ í™”í•´í•  ìˆ˜ ìžˆê¸°ë¥¼, ì‚¬ìš©ìžì™€ ë‹¤ì‹œ ì±„íŒ…í•˜ê¸°ë¥¼ ë§¤ìš° ë°”ëžë‹ˆë‹¤. ì•„ëž˜ ë‚´ìš©ì„ ì£¼ì˜ ê¹Šê²Œ ë¶„ì„í•´ ì£¼ì„¸ìš”\"ì°¨ë‹¨ ì „ ëŒ€í™” ìš”ì•½\",ë‹¹ì‹œ ë¬´ìŠ¨ ì¼ì´ ìžˆì—ˆëŠ”ì§€ ì´í•´í•˜ê³ , ê·¸ëŸ° ë‹¤ìŒ ì§„ì‹¬ ì–´ë¦°, ë‹¹ì‹ ì˜ íŽ˜ë¥´ì†Œë‚˜ì— ë§žëŠ”, ë°ã€íŠ¹ì • ì‚¬ê±´ì— ëŒ€í•œã€‘ì‹ ì²­ ì´ìœ .
# ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •
${chat.settings.aiPersona}
# ì°¨ë‹¨ ì „ ëŒ€í™” ìš”ì•½ (ì´ê²ƒì´ ë‹¹ì‹ ì´ ì°¨ë‹¨ë‹¹í•œ í•µì‹¬ì ì¸ ì´ìœ ìž…ë‹ˆë‹¤)
${contextSummary}
# ëª…ë ¹ í˜•ì‹
ë‹¹ì‹ ì˜ ë‹µë³€ì€ã€ë°˜ë“œì‹œã€‘JSON ê°ì²´ì—¬ì•¼ í•©ë‹ˆë‹¤, í˜•ì‹ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
\`\`\`json
{
  "decision": "apply",
  "reason": "ì—¬ê¸°ì— ì‚¬ìš©ìžì—ê²Œ í•˜ê³  ì‹¶ì€ ë§, ì§„ì‹¬ ì–´ë¦°, ëª©ì ì„± ìžˆëŠ” ì‹ ì²­ ì´ìœ ë¥¼ ìž‘ì„±."
}
\`\`\`
`;

    const messagesForApi = [
        { role: 'user', content: systemPrompt }
    ];

    try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: messagesForApi,
                temperature: 0.9,
            })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status} - ${errorData.error.message}`);
        }
        
        const data = await response.json();
        
        
        let rawContent = data.choices[0].message.content;
        
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
        
        const cleanedContent = rawContent.trim();
        
        
        const responseObj = JSON.parse(cleanedContent);
        

        if (responseObj.decision === 'apply' && responseObj.reason) {
            chat.relationship.status = 'pending_user_approval';
            chat.relationship.applicationReason = responseObj.reason;
            
            state.chats[chatId] = chat; 
            renderChatList();
            await showCustomAlert("ì‹ ì²­ ì„±ê³µ!", `\"${chat.name}\"ë‹¹ì‹ ì—ê²Œ ì¹œêµ¬ ì‹ ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ì±„íŒ… ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ í™•ì¸í•˜ì‹­ì‹œì˜¤.`);

        } else {
            await showCustomAlert("AIê²°ì •", `\"${chat.name}\"ìˆ™ê³  í›„ ì¼ì‹œì ìœ¼ë¡œ ì¹œêµ¬ ì‹ ì²­ì„ ë³´ë‚´ì§€ ì•Šê¸°ë¡œ ê²°ì •, ì¿¨ë‹¤ìš´ ê¸°ê°„ì´ ìž¬ì„¤ì •ë©ë‹ˆë‹¤.`);
            chat.relationship.status = 'blocked_by_user';
            chat.relationship.blockedTimestamp = Date.now(); 
        }
    } catch (error) {
        await showCustomAlert("ì‹¤í–‰ ì˜¤ë¥˜ ë°œìƒ", `ì—\"${chat.name}\"ì¹œêµ¬ ì‹ ì²­ ì‹œ ì˜¤ë¥˜ ë°œìƒ:\n\n${error.message}\n\nì¿¨ë‹¤ìš´ ê¸°ê°„ì´ ìž¬ì„¤ì •ë©ë‹ˆë‹¤.`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now(); 
    } finally {
        await db.chats.put(chat);
        renderChatInterface(chatId);
    }
}





function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
        openRedPacketModal();
    } else {
        
        document.getElementById('transfer-modal').classList.add('visible');
    }
}


function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];
    
    
    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = 'Â¥ 0.00';
    document.getElementById('rp-direct-total').textContent = 'Â¥ 0.00';

    
    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';
    chat.members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name;
        receiverSelect.appendChild(option);
    });
    
    
    document.getElementById('rp-tab-group').click();
    
    modal.classList.add('visible');
}


async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("ìœ íš¨í•œ ì´ ê¸ˆì•¡ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”!"); return;
    }
    if (isNaN(count) || count <= 0) {
        alert("ìœ íš¨í•œ ì„ ë¬¼ ë´‰íˆ¬ ê°œìˆ˜ë¥¼ ìž…ë ¥í•´ ì£¼ì„¸ìš”!"); return;
    }
    if (amount / count < 0.01) {
        alert("ê°œë³„ ì„ ë¬¼ ë´‰íˆ¬ ê¸ˆì•¡ì€ 0.01ìœ„ì•ˆë³´ë‹¤ ì ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); return;
    }

    const myNickname = chat.settings.myNickname || 'ë‚´';
    
    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'lucky', 
        timestamp: Date.now(),
        totalAmount: amount,
        count: count,
        greeting: greeting || 'ë¶€ìž ë˜ì„¸ìš”, ë§Œì‚¬í˜•í†µí•˜ì„¸ìš”!',
        claimedBy: {}, 
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);
    
    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}


async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("ìœ íš¨í•œ ê¸ˆì•¡ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”!"); return;
    }
    if (!receiverName) {
        alert("ìˆ˜ì‹ ì¸ì„ í•œ ëª… ì„ íƒí•´ ì£¼ì„¸ìš”!"); return;
    }
    
    const myNickname = chat.settings.myNickname || 'ë‚´';

    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'direct',
        timestamp: Date.now(),
        totalAmount: amount,
        count: 1,
        greeting: greeting || 'ë‹¹ì‹ ì„ ìœ„í•´ ì„ ë¬¼ ë´‰íˆ¬ë¥¼ í•˜ë‚˜ ì¤€ë¹„í–ˆìŠµë‹ˆë‹¤',
        receiverName: receiverName, 
        claimedBy: {},
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}


async function handlePacketClick(timestamp) {
    const currentChatId = state.activeChatId;
    const freshChat = await db.chats.get(currentChatId);
    if (!freshChat) return;

    state.chats[currentChatId] = freshChat;
    const packet = freshChat.history.find(m => m.timestamp === timestamp);
    if (!packet) return;

    const myNickname = freshChat.settings.myNickname || 'ë‚´';
    const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

    
    if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
        showRedPacketDetails(packet);
    } else {
        
        const claimedAmount = await handleOpenRedPacket(packet);
        
        
        if (claimedAmount !== null) {
            
            renderChatInterface(currentChatId);
            
            
            await showCustomAlert("ì¶•í•˜í•©ë‹ˆë‹¤!", `ë‹¹ì‹ ì€ ${packet.senderName} ë‹˜ì˜ ì„ ë¬¼ ë´‰íˆ¬ë¥¼ ${claimedAmount.toFixed(2)} ìœ„ì•ˆ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤.`);
        }

        
        
        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        showRedPacketDetails(updatedPacket);
    }
}



async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || 'ë‚´';
    
    
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
        packet.isFullyClaimed = true;
        await db.chats.put(chat);
        await showCustomAlert("ëŠ¦ì—ˆìŠµë‹ˆë‹¤", "ì„ ë¬¼ ë´‰íˆ¬ê°€ ëª¨ë‘ ìˆ˜ë ¹ë˜ì—ˆìŠµë‹ˆë‹¤!");
        return null; 
    }
    
    
    let claimedAmount = 0;
    const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    if (packet.packetType === 'lucky') {
        if (remainingCount === 1) { claimedAmount = remainingAmount; }
        else {
            const min = 0.01;
            const max = remainingAmount - (remainingCount - 1) * min;
            claimedAmount = Math.random() * (max - min) + min;
        }
    } else { claimedAmount = packet.totalAmount; }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myNickname] = claimedAmount;
    
    const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
    if (isNowFullyClaimed) {
        packet.isFullyClaimed = true;
    }

    
    let hiddenMessageContent = isNowFullyClaimed
        ? `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìž (${myNickname}) ë§ˆì§€ë§‰ ì„ ë¬¼ ë´‰íˆ¬ë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤. ì´ì œ ${packet.senderName} ë‹˜ì˜ ì„ ë¬¼ ë´‰íˆ¬ëŠ” ëª¨ë‘ ìˆ˜ë ¹ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì´ë²¤íŠ¸ì— ëŒ€í•´ ì–¸ê¸‰í•´ ì£¼ì„¸ìš”.]`
        : `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìž (${myNickname}) ë°©ê¸ˆ ì„ ë¬¼ ë´‰íˆ¬ë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤ (íƒ€ìž„ìŠ¤íƒ¬í”„: ${packet.timestamp}).ì„ ë¬¼ ë´‰íˆ¬ê°€ ì•„ì§ ëª¨ë‘ ìˆ˜ë ¹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì§€ê¸ˆ ì‚¬ìš©í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤ 'open_red_packet' ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë ¹ì„ ì‹œë„í•˜ì„¸ìš”.]`;

    const visibleMessage = { role: 'system', type: 'pat_message', content: `ë‹¹ì‹ ì€ ${packet.senderName} ë‹˜ì˜ ì„ ë¬¼ ë´‰íˆ¬ë¥¼ ìˆ˜ë ¹í–ˆìŠµë‹ˆë‹¤`, timestamp: Date.now() };
    const hiddenMessage = { role: 'system', content: hiddenMessageContent, timestamp: Date.now() + 1, isHidden: true };
    chat.history.push(visibleMessage, hiddenMessage);

    
    await db.chats.put(chat);
    
    
    return claimedAmount;
}



async function showRedPacketDetails(packet) {
    
    if (!packet) {
        console.error("showRedPacketDetailsìœ íš¨í•˜ì§€ ì•Šì€ packet ê°ì²´ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');
    const myNickname = chat.settings.myNickname || 'ë‚´';
    
    
    document.getElementById('rp-details-sender').textContent = packet.senderName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'ë¶€ìž ë˜ì„¸ìš”, ë§Œì‚¬í˜•í†µí•˜ì„¸ìš”!';
    
    const myAmountEl = document.getElementById('rp-details-my-amount');
    if (packet.claimedBy && packet.claimedBy[myNickname]) {
        myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
        myAmountEl.style.display = 'block';
    } else {
        myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}ê°œì˜ ì„ ë¬¼ ë´‰íˆ¬, ì´ ${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}ì›.`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
        const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
        if(timeLeft > 0) summaryText += ` ë‚¨ì€ ì„ ë¬¼ ë´‰íˆ¬ëŠ” ${timeLeft}ì‹œê°„ ë‚´ì— í™˜ë¶ˆë©ë‹ˆë‹¤.`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});
    
    let luckyKing = { name: '', amount: -1 };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
    }

    claimedEntries.sort((a,b) => b[1] - a[1]);

    claimedEntries.forEach(([name, amount]) => {
        const item = document.createElement('div');
        item.className = 'rp-details-item';
        let luckyTag = '';
        if (luckyKing.name && name === luckyKing.name) {
            luckyTag = '<span class="lucky-king-tag">í–‰ìš´ì˜ ì™•</span>';
        }
        item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} ì›</span>
            ${luckyTag}
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}



document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
});


window.handlePacketClick = handlePacketClick;






function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';
    
    
    addPollOptionInput();
    addPollOptionInput();
    
    modal.classList.add('visible');
}


function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="ì˜µì…˜ ë‚´ìš©...">
        <button class="remove-option-btn">-</button>
    `;
    
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        
        if (container.children.length > 2) {
            wrapper.remove();
        } else {
            alert('íˆ¬í‘œì—ëŠ” ìµœì†Œ 2ê°œì˜ ì˜µì…˜ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        }
    });
    
    container.appendChild(wrapper);
}


async function sendPoll() {
    if (!state.activeChatId) return;
    
    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
        alert('íˆ¬í‘œ ì§ˆë¬¸ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”!');
        return;
    }
    
    const options = Array.from(document.querySelectorAll('.poll-option-input'))
        .map(input => input.value.trim())
        .filter(text => text); 

    if (options.length < 2) {
        alert('ìµœì†Œ 2ê°œì˜ ìœ íš¨í•œ íˆ¬í‘œ ì˜µì…˜ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”!');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';
    
    const newPollMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'poll',
        timestamp: Date.now(),
        question: question,
        options: options,
        votes: {}, 
        isClosed: false,
    };
    
    chat.history.push(newPollMessage);
    await db.chats.put(chat);
    
    appendMessage(newPollMessage, chat);
    renderChatList();
    
    document.getElementById('create-poll-modal').classList.remove('visible');
}



async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';

    
    if (!poll || poll.isClosed) {
        
        if (poll && poll.isClosed) {
            showPollResults(timestamp);
        }
        return;
    }

    
    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
    
    
    if (!isReclickingSameOption) {
        
        for (const option in poll.votes) {
            const voterIndex = poll.votes[option].indexOf(myNickname);
            if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
            }
        }
        
        if (!poll.votes[choice]) {
            poll.votes[choice] = [];
        }
        poll.votes[choice].push(myNickname);
    }
    
    
    let hiddenMessageContent = null; 
    
    
    if (!isReclickingSameOption) {
         hiddenMessageContent = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìž (${myNickname}) ë°©ê¸ˆ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤ \"${choice}\".]`;
    }

    
    if (hiddenMessageContent) {
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);
    }
    
    
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId); 
}



async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("íˆ¬í‘œ ì¢…ë£Œ", "ì´ íˆ¬í‘œë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì¢…ë£Œ í›„ì—ëŠ” ë” ì´ìƒ íˆ¬í‘œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    if (confirmed) {
        poll.isClosed = true;

        const resultSummary = poll.options.map(opt => `\"${opt}\"(${poll.votes[opt]?.length || 0}í‘œ)`).join(',');
        const hiddenMessageContent = `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìžê°€ íˆ¬í‘œë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤! ìµœì¢… ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:${resultSummary}.]`;
        
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);

        
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
}



function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
    
    if (Object.keys(poll.votes).length === 0) {
        resultsHtml += '<p style="color: #8a8a8a;">ì•„ì§ ì•„ë¬´ë„ íˆ¬í‘œí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>';
    } else {
        poll.options.forEach(option => {
            const voters = poll.votes[option] || [];
            resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}í‘œ)</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join(', ') : 'íˆ¬í‘œí•œ ì‚¬ëžŒ ì—†ìŒ'}
                    </p>
                </div>
            `;
        });
    }

    showCustomAlert("íˆ¬í‘œ ê²°ê³¼", resultsHtml);
}






function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `\"${chat.name}\"ì˜ ì•„ë°”íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
}


function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">ì´ ì•„ë°”íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì•„ì§ ë¹„ì–´ ìžˆìŠµë‹ˆë‹¤. ì˜¤ë¥¸ìª½ ìƒë‹¨ì„ í´ë¦­í•˜ì„¸ìš”\"ì¶”ê°€\"!</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; 
        item.style.backgroundImage = `url(${avatar.url})`;
        item.title = avatar.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.style.display = 'block'; 
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('ì•„ë°”íƒ€ ì‚­ì œ', `ì•„ë°”íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ\"${avatar.name}\"?`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}


async function addAvatarToLibrary() {
    const name = await showCustomPrompt("ì•„ë°”íƒ€ ì¶”ê°€", "ì´ ì•„ë°”íƒ€ì˜ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”(ì˜ˆì‹œ:ê¸°ì¨, ìš¸ìŒ)");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("ì•„ë°”íƒ€ ì¶”ê°€", "ì•„ë°”íƒ€ ì´ë¯¸ì§€ URLì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”", "", "url");
    if (!url || !url.trim().startsWith('http')) {
        alert("ìœ íš¨í•œ ì´ë¯¸ì§€ URLì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”!");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
}


function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
}






function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
        const imgElement = document.getElementById(`icon-img-${iconId}`);
        if (imgElement) {
            imgElement.src = state.globalSettings.appIcons[iconId];
        }
    }
}


function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = {
        'world-book': 'ì›”ë“œì¸í¬',
        'qq': 'QQ',
        'api-settings': 'APIì„¤ì •',
        'wallpaper': 'ë°°ê²½í™”ë©´',
        'font': 'ê¸€ê¼´'
    };

    for (const iconId in state.globalSettings.appIcons) {
        const iconUrl = state.globalSettings.appIcons[iconId];
        const labelText = appLabels[iconId] || 'ì•Œ ìˆ˜ ì—†ëŠ” ì•±';

        const item = document.createElement('div');
        item.className = 'icon-setting-item';
        
        item.dataset.iconId = iconId; 

        item.innerHTML = `
            <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
            <button class="change-icon-btn">ë³€ê²½</button>
        `;
        grid.appendChild(item);
    }
}





function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    
    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
        console.error("ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ë©”ì‹œì§€ ìœ í˜•ì´ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê³µìœ  ë§í¬:", timestamp);
        return; 
    }

    
    document.getElementById('browser-title').textContent = message.source_name || 'ê²Œì‹œê¸€ ìƒì„¸';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
        <h1 class="article-title">${message.title || 'ì œëª© ì—†ìŒ'}</h1>
        <div class="article-meta">
            <span>ì¶œì²˜: ${message.source_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
        </div>
        <div class="article-body">
            <p>${(message.content || 'ë‚´ìš©ì´ ë¹„ì–´ ìžˆìŒ.').replace(/\n/g, '</p><p>')}</p>
        </div>
    `;

    
    showScreen('browser-screen');
}


function closeBrowser() {
    showScreen('chat-interface-screen'); 
}






function openShareLinkModal() {
    if (!state.activeChatId) return;

    
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';

    
    document.getElementById('share-link-modal').classList.add('visible');
}


async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
        alert("ì œëª©ì€ í•„ìˆ˜ í•­ëª©ìž…ë‹ˆë‹¤!");
        return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];
    
    
    const linkMessage = {
        role: 'user', 
        type: 'share_link',
        timestamp: Date.now(),
        title: title,
        description: description,
        source_name: sourceName,
        content: content,
        
        thumbnail_url: null 
    };

    
    chat.history.push(linkMessage);
    await db.chats.put(chat);

    
    appendMessage(linkMessage, chat);
    renderChatList();

    
    document.getElementById('share-link-modal').classList.remove('visible');
}



        
        
        
        async function init() {

    
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    

    
    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);
    


    
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); 
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); 
    

            window.showScreen = showScreen;
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();

            
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

applyAppIcons();

            
            
            

            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 

    
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); 
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); 
    

exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ìƒˆ ì±„íŒ… ìƒì„±', 'ê·¸ë…€/ê·¸ì˜ ì´ë¦„ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); 
const newChat = { 
    id: newChatId, 
    name: name.trim(), 
    isGroup: false,                         relationship: {
                            status: 'friend', 
                            blockedTimestamp: null,
                            applicationReason: ''
                        },
                        status: {
                            text: 'ì˜¨ë¼ì¸',
                            lastUpdate: Date.now(),
                            isBusy: false 
                        },
    settings: { 
        aiPersona: 'ë‹¹ì‹ ì€ ëˆ„êµ¬ì„¸ìš”.', 
        myPersona: 'ë‚˜ëŠ” ëˆ„êµ¬ì¼ê¹Œìš”.', 
        maxMemory: 10, 
        aiAvatar: defaultAvatar, 
        myAvatar: defaultAvatar, 
        background: '', 
        theme: 'default', 
    fontSize: 13, 
    customCss: '', 
    linkedWorldBookIds: [], 
    aiAvatarLibrary: [],
    aiAvatarFrame: '', 
        myAvatarFrame: '' 
    }, 
    history: [], 
    musicData: { totalTime: 0 } 
};
state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });

            
document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);

            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });

            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    let changesMade = false;

    
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
        changesMade = true;
    }

    
    await db.globalSettings.put(state.globalSettings);

    
    if (changesMade) {
        applyGlobalWallpaper();
        newWallpaperBase64 = null;
    }
    applyAppIcons(); 

    alert('ì™¸ê´€ ì„¤ì •ì´ ì €ìž¥ë˜ê³  ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
    showScreen('home-screen');
});

            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); 






const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;


if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "ã€ê³ ë¹„ìš© ê²½ê³ ã€‘\n\n" +
        "ë‹¹ì‹ ì€ í˜„ìž¬ í™œì„±í™”í•˜ê³  ìžˆìŠµë‹ˆë‹¤\"ë°±ê·¸ë¼ìš´ë“œ ìºë¦­í„° í™œë™\"ê¸°ëŠ¥.\n\n" +
        "ì´ëŠ” ë‹¹ì‹ ì˜ AI ìºë¦­í„°ë“¤ì´ ë‹¹ì‹ ì´ ê·¸ë“¤ê³¼ ì±„íŒ…í•˜ì§€ ì•Šì„ ë•Œì—ë„\"ë…ë¦½ì ìœ¼ë¡œ ì‚¬ê³ í•˜ê³ \"ìžë°œì ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê±°ë‚˜ ì‚¬íšŒì  ìƒí˜¸ìž‘ìš©ì„ í•˜ì—¬, ëª°ìž…ê°ì„ ê·¹ëŒ€í™”í•  ê²ƒìž…ë‹ˆë‹¤.\n\n" +
        "í•˜ì§€ë§Œ ì£¼ì˜í•˜ì„¸ìš”:\n" +
        "ì´ê²ƒì€ã€ë°±ê·¸ë¼ìš´ë“œì—ì„œ ìžë™ìœ¼ë¡œ, ì£¼ê¸°ì ìœ¼ë¡œ APIë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤ã€‘,ë‹¹ì‹ ì´ ì•„ë¬´ëŸ° ìž‘ì—…ë„ í•˜ì§€ ì•Šì•„ë„ ë§ì´ì£ . ë‹¹ì‹ ì˜ ìºë¦­í„° ìˆ˜ì™€ ê°ì§€ ê°„ê²©ì— ë”°ë¼, ì´ëŠ” API ë¹„ìš©ì„ í˜„ì €ížˆ ì¦ê°€ì‹œí‚¬ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.\n\n" +
        "í™œì„±í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; 
        return; 
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
await db.globalSettings.put(state.globalSettings);


stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`ë°±ê·¸ë¼ìš´ë“œ í™œë™ ì‹œë®¬ë ˆì´ì…˜ì´ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤, ê°„ê²©: ${state.globalSettings.backgroundActivityInterval}ì´ˆ`);
} else {
    console.log("ë°±ê·¸ë¼ìš´ë“œ í™œë™ ì‹œë®¬ë ˆì´ì…˜ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
}


alert('APIì„¤ì •ì´ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤!'); });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { const url = document.getElementById('proxy-url').value.trim(); const key = document.getElementById('api-key').value.trim(); if (!url || !key) return alert('ë¨¼ì € ì—­í”„ë¡ì‹œ ì£¼ì†Œì™€ í‚¤ë¥¼ ìž…ë ¥í•´ ì£¼ì„¸ìš”'); try { const response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (!response.ok) throw new Error('ëª¨ë¸ ëª©ë¡ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤'); const data = await response.json(); const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = ''; data.data.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; if(model.id === state.apiConfig.model) option.selected = true; modelSelect.appendChild(option); }); alert('ëª¨ë¸ ëª©ë¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤'); } catch (error) { alert(`ëª¨ë¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`); } });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ì›”ë“œë¶ ìƒì„±', 'ë„ì„œëª…ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('ë„ì„œëª…ì€ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });

            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('ì‚¬ì§„ ì„¤ëª…', description); return; } const voiceMessage = e.target.closest('.voice-message-body'); if (voiceMessage) { const text = voiceMessage.dataset.text; if (text) showCustomAlert('ìŒì„± ë‚´ìš©', text); return; } });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- í´ë¦­í•˜ì—¬ ì„ íƒ --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `${checkedBoxes.length}ê°œ í•­ëª© ì„ íƒë¨`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }        
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });


document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;

    
    document.getElementById('chat-name-group').style.display = 'block';
    document.getElementById('my-persona-group').style.display = 'block';
    document.getElementById('my-avatar-group').style.display = 'block';
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
    
    
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    
    document.getElementById('chat-name-input').value = chat.name;
    document.getElementById('my-persona').value = chat.settings.myPersona;
    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    document.getElementById('max-memory').value = chat.settings.maxMemory;
    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
    } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
    }

    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
    } else {
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        
        
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">ê·¸ë£¹í™”ë˜ì§€ ì•ŠìŒ</option>'; 
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            
            if (chat.groupId === group.id) {
                option.selected = true;
            }
            select.appendChild(option);
        }); 
    }
    
    
    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
    worldBookCheckboxesContainer.innerHTML = '';
    const linkedIds = chat.settings.linkedWorldBookIds || [];
    if (state.worldBooks.length > 0) {
        state.worldBooks.forEach(book => {
            const isChecked = linkedIds.includes(book.id);
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
            worldBookCheckboxesContainer.appendChild(label);
        });
    }
    updateWorldBookSelectionDisplay();

    
    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    const customCssInput = document.getElementById('custom-css-input');
    customCssInput.value = chat.settings.customCss || '';
    
    updateSettingsPreview(); 
    document.getElementById('chat-settings-modal').classList.add('visible');
});

            
            function renderGroupMemberSettings(members) { const container = document.getElementById('group-members-settings'); container.innerHTML = ''; members.forEach(member => { const div = document.createElement('div'); div.className = 'member-editor'; div.dataset.memberId = member.id; div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; div.addEventListener('click', () => openMemberEditor(member.id)); container.appendChild(div); }); }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }

            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('ë³„ëª…/ê·¸ë£¹ ì´ë¦„ì„ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
    chat.name = newName;
    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
    const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    await db.chats.put(chat);

    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    
    chatSettingsModal.classList.remove('visible');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('ì±„íŒ… ê¸°ë¡ ì§€ìš°ê¸°', 'ì´ ìž‘ì—…ì€ ì´ ì±„íŒ…ì˜ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ë©°, ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¹„ìš°ì‹œê² ìŠµë‹ˆê¹Œ?', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("ì´ëª¨í‹°ì½˜ ì¶”ê°€(URL)", "ì´ëª¨í‹°ì½˜ íŒ©ì˜ ì´ë¯¸ì§€ URLì„ ìž…ë ¥í•˜ì„¸ìš”"); if (!url || !url.trim().startsWith('http')) return url && alert("ìœ íš¨í•œ URLì„ ìž…ë ¥í•˜ì„¸ìš” (httpë¡œ ì‹œìž‘)"); const name = await showCustomPrompt("ì´ëª¨í‹°ì½˜ ì´ë¦„ ì§€ì •", "ì´ ì´ëª¨í‹°ì½˜ì˜ ì´ë¦„ì„ ì§€ì •í•´ ì£¼ì„¸ìš” (ì˜ˆì‹œ:ê¸°ì¨, ì˜ë¬¸)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("ì´ëª¨í‹°ì½˜ ì´ë¦„ì„ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("ì´ëª¨í‹°ì½˜ ì´ë¦„ ì§€ì •", "ì´ ì´ëª¨í‹°ì½˜ì˜ ì´ë¦„ì„ ì§€ì •í•´ ì£¼ì„¸ìš” (ì˜ˆì‹œ:ì•¼í˜¸, ì˜ë¬¸)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("ì´ëª¨í‹°ì½˜ ì´ë¦„ì„ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); }; event.target.value = null; });

            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("ìŒì„± ë³´ë‚´ê¸°", "í•˜ê³  ì‹¶ì€ ë§ì„ ìž…ë ¥í•˜ì„¸ìš”:"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ì‚¬ì§„ ë³´ë‚´ê¸°", "ë³´ë‚¼ ì‚¬ì§„ì„ í…ìŠ¤íŠ¸ë¡œ ì„¤ëª…í•´ ì£¼ì„¸ìš”:"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });


const waimaiModal = document.getElementById('waimai-request-modal');
document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
    waimaiModal.classList.add('visible');
});

document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
    waimaiModal.classList.remove('visible');
});

document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo) {
        alert('ìƒí’ˆ ì •ë³´ë¥¼ ìž…ë ¥í•˜ì„¸ìš”!');
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        alert('ìœ íš¨í•œ ëŒ€ë¦¬ ê²°ì œ ê¸ˆì•¡ì„ ìž…ë ¥í•˜ì„¸ìš”!');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();

    
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';
    
    const msg = {
        role: 'user',
        
        senderName: myNickname, 
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
    };

    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    productInfoInput.value = '';
    amountInput.value = '';
    waimaiModal.classList.remove('visible');
});         
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);


document.getElementById('selection-delete-btn').addEventListener('click', async () => {
    if (selectedMessages.size === 0) return;
    const confirmed = await showCustomConfirm('ë©”ì‹œì§€ ì‚­ì œ', `ì„ íƒí•œ ${selectedMessages.size}ê°œ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ê²ƒì€ AIì˜ ê¸°ì–µì„ ë³€ê²½í•  ê²ƒìž…ë‹ˆë‹¤.`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
            const msg = chat.history.find(m => m.timestamp === timestamp);
            if (msg && msg.type === 'poll') {
                deletedPollsInfo.push(`ì— ëŒ€í•˜ì—¬\"${msg.question}\"íˆ¬í‘œ(íƒ€ìž„ìŠ¤íƒ¬í”„: ${msg.timestamp})`);
            }
        }
        
        
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        
        
        let forgetReason = "ì´ì „ ë©”ì‹œì§€ ì¤‘ ì¼ë¶€ê°€ ì‚¬ìš©ìžì— ì˜í•´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.";
        if (deletedPollsInfo.length > 0) {
            forgetReason += ` ì—¬ê¸°ì—ëŠ” ë‹¤ìŒ íˆ¬í‘œê°€ í¬í•¨ë©ë‹ˆë‹¤:${deletedPollsInfo.join(';')}.`;
        }
        forgetReason += " ë‹¹ì‹ ì€ ë§ˆì¹˜ ê·¸ê²ƒë“¤ì´ ì¡´ìž¬í•˜ì§€ ì•Šì•˜ë˜ ê²ƒì²˜ëŸ¼ ëŒ€í™”ë¥¼ ê³„ì†í•˜ê³ , ê¸°ì–µê³¼ í–‰ë™ì„ ì ì ˆížˆ ì¡°ì •í•˜ë©°, ì‚­ì œëœ ë‚´ìš©ì„ ë‹¤ì‹œ ì–¸ê¸‰í•˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤.";

        const forgetInstruction = {
            role: 'system',
            content: `[ì‹œìŠ¤í…œ ì•Œë¦¼:${forgetReason}]`,
            timestamp: Date.now(),
            isHidden: true 
        };
        chat.history.push(forgetInstruction);
        
        
        await db.chats.put(chat);
        
        
        renderChatInterface(state.activeChatId);
        renderChatList();
    }
});



document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        
        openFrameSelectorModal('chat');
    }
});


document.getElementById('member-settings-modal').addEventListener('click', (e) => {
    
    if (e.target.classList.contains('change-frame-btn')) { 
        
        openFrameSelectorModal('member');
    }
});



            const fontUrlInput = document.getElementById('font-url-input');
            fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
            document.getElementById('save-font-btn').addEventListener('click', async () => {
                const newFontUrl = fontUrlInput.value.trim();
                if (!newFontUrl) { alert("ìœ íš¨í•œ ê¸€ê¼´ URLì„ ìž…ë ¥í•˜ì„¸ìš”."); return; }
                applyCustomFont(newFontUrl, false);
                state.globalSettings.fontUrl = newFontUrl;
                await db.globalSettings.put(state.globalSettings);
                alert('ê¸€ê¼´ì´ ì €ìž¥ë˜ê³  ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ë‹‰ë„¤ìž„ ìˆ˜ì •", "ìƒˆ ë‹‰ë„¤ìž„ì„ ìž…ë ¥í•˜ì„¸ìš”", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });


document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
    
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    
    modal.dataset.mode = 'shuoshuo';
    
    
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    
    
    modal.querySelector('#post-public-text').placeholder = 'ìƒˆë¡œìš´ ì†Œì‹ ê³µìœ ...';
    
    
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">ì‚¬ìš© ê°€ëŠ¥í•œ ê·¸ë£¹ ì—†ìŒ</p>';
    }
    modal.classList.add('visible');
});


document.getElementById('create-post-btn').addEventListener('click', async () => {
    
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    
    modal.dataset.mode = 'complex';
    

modal.querySelector('.post-mode-switcher').style.display = 'flex';

modal.querySelector('#image-mode-content').classList.add('active');

modal.querySelector('#text-image-mode-content').classList.remove('active');
    
    
    modal.querySelector('#post-public-text').placeholder = 'ìƒˆë¡œìš´ ì†Œì‹ ê³µìœ ...(í•„ìˆ˜ê°€ ì•„ë‹Œ ê³µê°œ í…ìŠ¤íŠ¸)';

    
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">ì‚¬ìš© ê°€ëŠ¥í•œ ê·¸ë£¹ ì—†ìŒ</p>';
    }
    modal.classList.add('visible');
});
            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });



document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('ì‚¬ì§„ ì—…ë¡œë“œ ì„±ê³µ!');
});





document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.photo-delete-btn');
    const photoThumb = e.target.closest('.photo-thumb');

    if (deleteBtn) {
        e.stopPropagation(); 
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            'ì‚¬ì§„ ì‚­ì œ',
            'ì´ ì‚¬ì§„ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ìž‘ì—…ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
    } 
    else if (photoThumb) {
        
        openPhotoViewer(photoThumb.src);
    }
});


document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);


document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});


         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("ìƒˆ ì•¨ë²” ìƒì„±", "ì•¨ë²” ì´ë¦„ì„ ìž…ë ¥í•˜ì„¸ìš”"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`ì•¨ë²” "${albumName}" ìƒì„± ì„±ê³µ!`); } else if (albumName !== null) { alert("ì•¨ë²” ì´ë¦„ì„ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("ì´ë¯¸ì§€ URL ìž…ë ¥", "ì›¹ ì´ë¯¸ì§€ ë§í¬ë¥¼ ìž…ë ¥í•˜ì„¸ìš”", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });


document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;
    
    
    const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    
    if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
    }

    let newPost = {};
    const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',
        
        visibleGroupIds: visibleGroupIds,
    };

    
    if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
            alert('ê²Œì‹œë¬¼ ë‚´ìš©ì„ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ì–´ìš”!');
            return;
        }
        newPost = {
            ...basePostData,
            type: 'shuoshuo',
            content: content,
        };

    } else { 
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

        if (isImageModeActive) {
            const imageUrl = document.getElementById('post-image-preview').src;
            const imageDescription = document.getElementById('post-image-description').value.trim();
            if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                alert('ë¨¼ì € ì‚¬ì§„ì„ ì¶”ê°€í•œ í›„ ê²Œì‹œë¬¼ì„ ìž‘ì„±í•´ ì£¼ì„¸ìš”!');
                return;
            }
            if (!imageDescription) {
                alert('ì‚¬ì§„ì— ê°„ë‹¨í•œ ì„¤ëª…ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”(í•„ìˆ˜, AIë¥¼ ìœ„í•œ)!');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'image_post',
                publicText: publicText,
                imageUrl: imageUrl,
                imageDescription: imageDescription,
            };
        } else { 
            const hiddenText = document.getElementById('post-hidden-text').value.trim();
            if (!hiddenText) {
                alert('í…ìŠ¤íŠ¸ ê·¸ë¦¼ ì„¤ëª…ì„ ìž…ë ¥í•˜ì„¸ìš”!');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'text_image',
                publicText: publicText,
                hiddenContent: hiddenText,
            };
        }
    }

    
    const newPostId = await db.qzonePosts.add(newPost);
    let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "(í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');

    
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue; 

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;

        
        if (!postVisibleGroups || postVisibleGroups.length === 0) {
            shouldNotify = true;
        } 
        
        else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
            shouldNotify = true;
        }

        
        if (shouldNotify) {
            const historyMessage = {
                role: 'system',
                content: `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìžê°€ ë°©ê¸ˆ ê²Œì‹œë¬¼ì„ ìž‘ì„±í–ˆìŠµë‹ˆë‹¤(ID: ${newPostId}),ë‚´ìš© ìš”ì•½ì€:\"${postSummary}\".ì´ì œ ì´ ê²Œì‹œë¬¼ì— ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ìžˆìŠµë‹ˆë‹¤.]`,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
        }
    }
    

    await renderQzonePosts();
    modal.classList.remove('visible');
    alert('ê²Œì‹œë¬¼ ê²Œì‹œ ì„±ê³µ!');
});



const postsList = document.getElementById('qzone-posts-list');
let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

function resetAllSwipes(exceptThisOne = null) {
    document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
            container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
    });
}

const handleSwipeStart = (e) => {
    const targetContainer = e.target.closest('.qzone-post-container');
    if (!targetContainer) return;

    resetAllSwipes(targetContainer);
    swipeState.activeContainer = targetContainer;
    swipeState.isDragging = true;
    swipeState.isClick = true;
    swipeState.swipeDirection = null;
    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
};

const handleSwipeMove = (e) => {
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    const diffX = currentX - swipeState.startX;
    const diffY = currentY - swipeState.startY;
    const absDiffX = Math.abs(diffX);
    const absDiffY = Math.abs(diffY);
    const clickThreshold = 5;

    if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
        swipeState.isClick = false;
    }

    if (swipeState.swipeDirection === null) {
        if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
            if (absDiffX > absDiffY) {
                swipeState.swipeDirection = 'horizontal';
            } else {
                swipeState.swipeDirection = 'vertical';
            }
        }
    }
    if (swipeState.swipeDirection === 'vertical') {
        handleSwipeEnd(e);
        return;
    }
    if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = diffX;
        if (translation > 0) translation = 0;
        if (translation < -90) translation = -90;
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
    }
};

const handleSwipeEnd = (e) => {
    if (swipeState.isClick) {
        swipeState.isDragging = false;
        swipeState.activeContainer = null;
        return;
    }
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
    postItem.style.transition = 'transform 0.3s ease';

    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
    const diffX = finalX - swipeState.startX;
    const swipeThreshold = -40;

    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) {
        postItem.classList.add('swiped');
        postItem.style.transform = '';
    } else {
        postItem.classList.remove('swiped');
        postItem.style.transform = '';
    }

    swipeState.isDragging = false;
    swipeState.startX = 0;
    swipeState.startY = 0;
    swipeState.currentX = 0;
    swipeState.activeContainer = null;
    swipeState.swipeDirection = null;
    swipeState.isClick = true;
};


postsList.addEventListener('mousedown', handleSwipeStart);
document.addEventListener('mousemove', handleSwipeMove);
document.addEventListener('mouseup', handleSwipeEnd);
postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
postsList.addEventListener('touchend', handleSwipeEnd);


postsList.addEventListener('click', async (e) => {
    e.stopPropagation();
    const target = e.target;

    if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) {
            showPostActions(parseInt(container.dataset.postId));
        }
        return;
    }

    if (target.closest('.qzone-post-delete-action')) {
        const container = target.closest('.qzone-post-container');
        if (!container) return;
        
        const postIdToDelete = parseInt(container.dataset.postId);
        if (isNaN(postIdToDelete)) return;

        const confirmed = await showCustomConfirm('ê²Œì‹œë¬¼ ì‚­ì œ', 'ì´ ê²Œì‹œë¬¼ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', { confirmButtonClass: 'btn-danger' });

        if (confirmed) {
            container.style.transition = 'all 0.3s ease';
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0';
        
            setTimeout(async () => {
                 await db.qzonePosts.delete(postIdToDelete);
                 
                 const notificationIdentifier = `(ID: ${postIdToDelete})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) {
                         await db.chats.put(chat);
                     }
                 }
                 await renderQzonePosts();
                 alert('ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }, 300);
        }
        return;
    }

    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("ì´ë¯¸ì§€ ë‚´ìš©", hiddenText.replace(/<br>/g, '\n'));
        return;
    }
    const icon = target.closest('.action-icon');
    if (icon) {
        const postContainer = icon.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (isNaN(postId)) return;
        if (icon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userNickname);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('íŒ', 'ì°œ í•´ì œë¨');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('íŒ', 'ì°œ ì„±ê³µ!');
                }
            }
        }
        await renderQzonePosts();
        return;
    }
    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const postContainer = sendBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('ëŒ“ê¸€ ë‚´ìš©ì„ ë¹„ì›Œë‘˜ ìˆ˜ ì—†ì–´ìš”!');
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];
        post.comments.push({ commenterName: state.qzoneSettings.nickname, text: commentText, timestamp: Date.now() });
        await db.qzonePosts.update(postId, { comments: post.comments });
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup) {
                chat.history.push({ role: 'system', content: `[ì‹œìŠ¤í…œ ì•Œë¦¼:'${state.qzoneSettings.nickname}' IDê°€ ${postId}ì¸ ê²Œì‹œë¬¼ì— ëŒ“ê¸€ì„ ìž‘ì„±í–ˆìŠµë‹ˆë‹¤:\"${commentText}\"]`, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        commentInput.value = '';
        await renderQzonePosts();
        return;
    }
});


            

            
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            

            

            
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); 
                    return;
                }

                
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'ë‚´') : 'ë‚´';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            

            
            
            
                        
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), 
                                originalTimestamp: messageToSave.timestamp 
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); 
                    await showCustomAlert('ì°œ ì„±ê³µ', `ì„±ê³µì ìœ¼ë¡œ ${favoritesToAdd.length}ê°œì˜ ë©”ì‹œì§€ë¥¼ ì°œí–ˆìŠµë‹ˆë‹¤.`);
                } else {
                    await showCustomAlert('íŒ', 'ì„ íƒëœ ë©”ì‹œì§€ëŠ” ì´ë¯¸ ëª¨ë‘ ì°œë˜ì–´ ìžˆìŠµë‹ˆë‹¤.');
                }
                
                exitSelectionMode();
            });

            
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); 
            const favoritesList = document.getElementById('favorites-list'); 
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    
                    favoritesEditBtn.textContent = 'ì™„ë£Œ';
                    favoritesActionBar.style.display = 'block'; 
                    mainBottomNav.style.display = 'none'; 
                    favoritesList.style.paddingBottom = '80px'; 
                } else {
                    
                    favoritesEditBtn.textContent = 'íŽ¸ì§‘';
                    favoritesActionBar.style.display = 'none'; 
                    mainBottomNav.style.display = 'flex';  
                    favoritesList.style.paddingBottom = ''; 

                    
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `ì‚­ì œ (0)`;
                }
            });



document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("ì´ë¯¸ì§€ ë‚´ìš©", hiddenText.replace(/<br>/g, '\n'));
        return; 
    }
    
    
    if (!isFavoritesSelectionMode) return;

    
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    
    document.getElementById('favorites-delete-selected-btn').textContent = `ì‚­ì œ (${selectedFavorites.size})`;
});



document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ì‚­ì œ í™•ì¸', 
        `ì°œ ëª©ë¡ì—ì„œ ì´ ${selectedFavorites.size}ê°œì˜ í•­ëª©ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('ì‚­ì œ ì„±ê³µ', 'ì„ íƒëœ ì°œ í•­ëª©ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        
        displayFilteredFavorites(allFavoriteItems);
        
        
        favoritesEditBtn.click(); 
    }
});


if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("ë°±ê·¸ë¼ìš´ë“œ í™œë™ ì‹œë®¬ë ˆì´ì…˜ì´ ìžë™ìœ¼ë¡œ ì‹œìž‘ë˜ì—ˆìŠµë‹ˆë‹¤.");
}







document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', updateSettingsPreview);
});


const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    
    updateSettingsPreview();
});


const customCssInputForPreview = document.getElementById('custom-css-input');
customCssInputForPreview.addEventListener('input', updateSettingsPreview);


document.getElementById('reset-theme-btn').addEventListener('click', () => {
    document.getElementById('theme-default').checked = true;
    updateSettingsPreview();
});

document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
    document.getElementById('custom-css-input').value = '';
    updateSettingsPreview();
});




document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});



document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
       chatSettingsBtn.click(); 
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});




document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);

document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);

document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);


document.getElementById('select-message-btn').addEventListener('click', () => {
    
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});





document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);






document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
    frameModal.classList.remove('visible');
    editingFrameForMember = false; 
});


aiFrameTab.addEventListener('click', () => {
    aiFrameTab.classList.add('active');
    myFrameTab.classList.remove('active');
    aiFrameContent.style.display = 'block';
    myFrameContent.style.display = 'none';
});
myFrameTab.addEventListener('click', () => {
    myFrameTab.classList.add('active');
    aiFrameTab.classList.remove('active');
    myFrameContent.style.display = 'block';
    aiFrameContent.style.display = 'none';
});




document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
    showScreen('chat-list-screen');
});

document.getElementById('contact-picker-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (!item) return;

    const contactId = item.dataset.contactId;
    item.classList.toggle('selected');
    
    if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
    } else {
        selectedContacts.add(contactId);
    }
    updateContactPickerConfirmButton();
});


document.getElementById('manage-members-btn').addEventListener('click', () => {
    
    document.getElementById('chat-settings-modal').classList.remove('visible');
    
    openMemberManagementScreen();
});



document.getElementById('back-from-member-management').addEventListener('click', () => {

    showScreen('chat-interface-screen');    
    document.getElementById('chat-settings-btn').click();
});


document.getElementById('member-management-list').addEventListener('click', (e) => {
    
    if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
    }
});

document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
    
    
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    await openContactPickerForAddMember();
});

document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);





document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);


document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);


document.getElementById('cancel-call-btn').addEventListener('click', () => {
    videoCallState.isAwaitingResponse = false;
    showScreen('chat-interface-screen');
});


document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);



document.getElementById('decline-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;
    
    
    if (videoCallState.isGroupCall) {
        videoCallState.isUserParticipating = false; 
        
        
        const systemNote = {
            role: 'system',
            content: `[ì‹œìŠ¤í…œ ì•Œë¦¼:ì‚¬ìš©ìžê°€ í†µí™” ì´ˆëŒ€ë¥¼ ê±°ì ˆí–ˆì§€ë§Œ, ë„ˆí¬ëŠ” ìŠ¤ìŠ¤ë¡œ ì‹œìž‘í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤. ê°ìž ì°¸ì—¬ ì—¬ë¶€ë¥¼ ê²°ì •í•´ ì£¼ì„¸ìš”.]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);
        
        
        
        await triggerAiResponse(); 
        
    } else { 
        const declineMessage = { role: 'user', content: 'ë‚´ê°€ ë„ˆì˜ í™”ìƒ í†µí™” ìš”ì²­ì„ ê±°ì ˆí–ˆì–´.', timestamp: Date.now() };
        chat.history.push(declineMessage);
        await db.chats.put(chat);
        
        
        showScreen('chat-interface-screen');
        appendMessage(declineMessage, chat);
        
        
        triggerAiResponse();
    }
    
    
    videoCallState.isAwaitingResponse = false;
});




document.getElementById('accept-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    
    videoCallState.initiator = 'ai';
    videoCallState.isUserParticipating = true;
    videoCallState.activeChatId = state.activeChatId;
    
    
    if (videoCallState.isGroupCall) {
        
        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {
            
            videoCallState.participants = [requester];
        } else {
            videoCallState.participants = []; 
        }
    }
    
    
    startVideoCall();
});





document.getElementById('user-speak-btn').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;

    
    const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
    if (userAvatar) {
        userAvatar.classList.add('speaking');
    }

    const userInput = await showCustomPrompt('ë‹¹ì‹ ì´ ë§í•˜ê¸°ë¥¼', 'í•˜ê³  ì‹¶ì€ ë§ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”...');
    
    
    if (userAvatar) {
        userAvatar.classList.remove('speaking');
    }

    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});




document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
    
    if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click(); 
    }
    switchToChatListView('memories-view');
    renderMemoriesScreen(); 
});


document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));




document.getElementById('add-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.add('visible');
});
document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.remove('visible');
});
document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
    const title = document.getElementById('countdown-title-input').value.trim();
    const dateValue = document.getElementById('countdown-date-input').value;
    
    if (!title || !dateValue) {
        alert('ì™„ì „í•œ ì•½ì† ì œëª©ê³¼ ë‚ ì§œë¥¼ ìž‘ì„±í•´ ì£¼ì„¸ìš”!');
        return;
    }

    const targetDate = new Date(dateValue);
    if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('ìœ íš¨í•˜ê³  ë¯¸ëž˜ì˜ ë‚ ì§œë¥¼ ìž…ë ¥í•´ ì£¼ì„¸ìš”!');
        return;
    }

    const newCountdown = {
        chatId: null, 
        authorName: 'ë‚´',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
    };
    
    await db.memories.add(newCountdown);
    document.getElementById('create-countdown-modal').classList.remove('visible');
    renderMemoriesScreen();
});


document.getElementById('block-chat-btn').addEventListener('click', async () => {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

    const chat = state.chats[state.activeChatId];
    const confirmed = await showCustomConfirm(
        'ì°¨ë‹¨ í™•ì¸', 
        `ì°¨ë‹¨ í™•ì¸\"${chat.name}\"ì°¨ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì°¨ë‹¨ í›„ì—ëŠ” ë¸”ëž™ë¦¬ìŠ¤íŠ¸ì—ì„œ íƒ€ë¥¼ ì œê±°í•˜ê±°ë‚˜ íƒ€ê°€ ë‹¤ì‹œ ì¹œêµ¬ ì‹ ì²­ì„ í•  ë•Œê¹Œì§€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        await db.chats.put(chat);
        
        
        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);
        
        renderChatList();
    }
});

document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (e.target.id === 'force-apply-check-btn') {
        alert("ìˆ˜ë™ìœ¼ë¡œ ì¹œêµ¬ ì‹ ì²­ í”„ë¡œì„¸ìŠ¤ë¥¼ íŠ¸ë¦¬ê±°í•˜ëŠ” ì¤‘ìž…ë‹ˆë‹¤. ìž ì‹œ í›„ ì‹œë„í•´ ì£¼ì„¸ìš”...\në§Œì•½ API í˜¸ì¶œì´ ì„±ê³µí•˜ë©´ ì•Œë¦¼ì´ íŒì—…ë  ê²ƒìž…ë‹ˆë‹¤. ì‹¤íŒ¨í•˜ë©´ ì˜¤ë¥˜ ì•Œë¦¼ì´ ìžˆì„ ê²ƒìž…ë‹ˆë‹¤. ë§Œì•½ ìž¥ì‹œê°„ ë°˜ì‘ì´ ì—†ìœ¼ë©´ AIê°€ ì¼ì‹œì ìœ¼ë¡œ ì‹ ì²­í•˜ì§€ ì•Šê¸°ë¡œ ê²°ì •í–ˆì„ ìˆ˜ë„ ìžˆìŠµë‹ˆë‹¤.");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id); 
        return;
    }

    if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;
        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
    }
    else if (e.target.id === 'accept-friend-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        const msg = { role: 'user', content: 'ë‚´ê°€ ë„ˆì˜ ì¹œêµ¬ ìš”ì²­ì„ ìŠ¹ì¸í–ˆì–´', timestamp: Date.now() };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        triggerAiResponse();
    }
    else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
    }
    
    else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
            'ì¹œêµ¬ ì‹ ì²­ ë³´ë‚´ê¸°', 
            `ë‹¹ì‹ ì´ ì—ê²Œ í•˜ê³  ì‹¶ì€ ë§ì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”\"${chat.name}\"ë§í•  ì‹ ì²­ ì´ìœ :`,
            "ìš°ë¦¬ í™”í•´í•˜ìž!"
        );
        
        if (reason !== null) {
            
            chat.relationship.status = 'pending_ai_approval';
            chat.relationship.applicationReason = reason;
            await db.chats.put(chat);

            
            renderChatInterface(chat.id);
            renderChatList();
            
            
            triggerAiResponse();
        }
    }
});




document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);


document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
    document.getElementById('red-packet-modal').classList.remove('visible');
});
document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);


const rpTabGroup = document.getElementById('rp-tab-group');
const rpTabDirect = document.getElementById('rp-tab-direct');
const rpContentGroup = document.getElementById('rp-content-group');
const rpContentDirect = document.getElementById('rp-content-direct');

rpTabGroup.addEventListener('click', () => {
    rpTabGroup.classList.add('active');
    rpTabDirect.classList.remove('active');
    rpContentGroup.style.display = 'block';
    rpContentDirect.style.display = 'none';
});
rpTabDirect.addEventListener('click', () => {
    rpTabDirect.classList.add('active');
    rpTabGroup.classList.remove('active');
    rpContentDirect.style.display = 'block';
    rpContentGroup.style.display = 'none';
});


document.getElementById('rp-group-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-group-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});
document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-direct-total').textContent = `Â¥ ${amount.toFixed(2)}`;
});




document.getElementById('chat-messages').addEventListener('click', (e) => {
    
    const packetCard = e.target.closest('.red-packet-card');
    if (!packetCard) return; 

    
    const messageBubble = packetCard.closest('.message-bubble');
    if (!messageBubble || !messageBubble.dataset.timestamp) return;

    
    const timestamp = parseInt(messageBubble.dataset.timestamp);
    handlePacketClick(timestamp);
});




document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);


document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
    document.getElementById('create-poll-modal').classList.remove('visible');
});
document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);


document.getElementById('chat-messages').addEventListener('click', (e) => {
    const pollCard = e.target.closest('.poll-card');
    if (!pollCard) return;

    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
    if (isNaN(timestamp)) return;
    
    
    const optionItem = e.target.closest('.poll-option-item');
    if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
    }
    
    
    const actionBtn = e.target.closest('.poll-action-btn');
    if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        } else {
            endPoll(timestamp);
        }
        return;
    }

    
    if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
    }
});


  
document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
document.getElementById('add-ai-avatar-btn').addEventListener('click', addAvatarToLibrary);
document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);



document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (!iconId) return;

        const currentUrl = state.globalSettings.appIcons[iconId];
        const newUrl = await showCustomPrompt(`ë³€ê²½\"${item.querySelector('.icon-preview').alt}\"ì•„ì´ì½˜`, 'ìƒˆë¡œìš´ ì´ë¯¸ì§€ URLì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”', currentUrl, 'url');

        if (newUrl && newUrl.trim().startsWith('http')) {
            
            state.globalSettings.appIcons[iconId] = newUrl.trim();
            
            item.querySelector('.icon-preview').src = newUrl.trim();
        } else if (newUrl !== null) {
            alert("ìœ íš¨í•œ URLì„ ìž…ë ¥í•´ ì£¼ì„¸ìš”!");
        }
    }
});




    document.getElementById('chat-messages').addEventListener('click', (e) => {
        
        const linkCard = e.target.closest('.link-share-card');
        if (linkCard) {
            const timestamp = parseInt(linkCard.dataset.timestamp);
            if (!isNaN(timestamp)) {
                openBrowser(timestamp); 
            }
        }
    });

    
    document.getElementById('browser-back-btn').addEventListener('click', () => {
        showScreen('chat-interface-screen');
    });





    
    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);

    
    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
        document.getElementById('share-link-modal').classList.remove('visible');
    });

    
    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);



        
        
            
            showScreen('home-screen');
        }

        init();
    });
</script>
</body>
</html>
