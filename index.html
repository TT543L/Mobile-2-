<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EPhone</title>
	<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/nzP9sgxr/chan-125.png">
    <link rel="manifest" href="manifest.json">
	<script src="dexie.js"></script>
    <style>
        @font-face { font-family: 'bulangni'; src: url('') format('truetype'); font-weight: normal; font-style: normal; font-display: swap; }
        :root { --screen-width: 350px; --screen-height: 650px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
        html { height: 100%; overflow: hidden; }

body {
    height: 100%;
    overflow: hidden;
    margin: 0;
    font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    font-weight: normal;
    background-color: #f0f2f5; 
}

#phone-screen {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background-color: #000;
}

#status-bar {
    display: none;
}

.header, .qzone-header {
    padding-top: calc(15px + env(safe-area-inset-top));
}


#chat-input-area {
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
}

#chat-list-bottom-nav {
     padding-bottom: env(safe-area-inset-bottom);
}

.modal {
    z-index: 1000;
}

        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 0px 20px 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }

.header .action-btn {
    font-size: 16px;
    font-weight: 600;
}

        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }

#world-book-list {
    flex-grow: 1;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    padding-top: 80px;
    margin-top: -80px;
}

#chat-list {
    flex-grow: 1;
    background-color: var(--secondary-bg);
    padding-top: 80px; 
    padding-bottom: 50px; 
    box-sizing: border-box;
}

        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }

#chat-messages {
    flex-grow: 1;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 10px 15px;
    padding-top: 110px;
    margin-top: -80px;
    display: flex;
    flex-direction: column;
    gap: 20px;
    box-sizing: border-box;
}

        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }

        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }

.message-wrapper.ai .sender-name {
    margin-left: 50px;
    margin-bottom: 3px;
    position: absolute; 
    top: -16px;
    left: 0;
}

.message-wrapper {
    display: flex;
    gap: 8px;
    align-items: flex-end;
    position: relative;
    max-width: 90%;
}

.message-wrapper.ai {
    align-self: flex-start;
    flex-direction: row;
}

.message-wrapper.user {
    align-self: flex-end;
    flex-direction: row-reverse; 
}

.message-bubble {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    max-width: 100%;
}

.timestamp {
    font-size: 11px;
    color: #999;
    text-shadow: 0 0 3px rgba(255,255,255,0.6);
    white-space: nowrap; 
    margin-bottom: 5px; 
    flex-shrink: 0;
}

        .message-bubble.selected::after { content: '‚úî'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }

        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: auto; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 50%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer;     transform: translateX(-50%) translateY(-150%); 
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    visibility: hidden;
}
#notification-bar.visible {
    transform: translateX(-50%) translateY(0);
    visibility: visible;
}
        #notification-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }

.checkboxes-container {
    display: none;
    position: absolute;
    top: 100%; 
    margin-top: 5px;
    left: 0;
    right: 0;
    max-height: 150px;
    overflow-y: auto;
    background-color: #fff;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    z-index: 101;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }

.checkboxes-container label {
    display: block;
    padding: 12px 15px;
    cursor: pointer;
    font-weight: normal;
    color: var(--text-primary);
    font-size: 15px;
}

        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
.voice-duration {
    font-size: var(--chat-font-size, 13px);
    font-weight: 500;
    color: var(--text-secondary);
}
        .message-bubble.user .voice-duration { color: #3e6224; }

.message-bubble .content {
    position: relative;
    font-size: var(--chat-font-size, 16px);
    padding: 8px 12px;
    line-height: 1.5;
    word-break: break-word;
}

        .message-bubble.user .content { background-color: rgba(255, 255, 255, 0.75); color: #585858; border-radius: 8px 2px 8px 8px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: #585858; border-radius: 2px 8px 8px 8px; }
      
.message-bubble::after {
    content: "";
    position: absolute;
    width: 20px;  
    height: 20px; 
    background-size: contain;
    background-repeat: no-repeat;
    opacity: 1; 
    z-index: 1;
}
      
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #eff7ff; color: #263a4e; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #fffde4; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #fff0f6; color: #432531; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #faf7ff; color: #827693; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fff0f6; color: #a78396; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'üêæ'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

.change-frame-btn {
    padding: 6px 10px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 13px;
    margin-left: 10px;
}

#avatar-frame-modal .modal-content {
    height: 70%;
}

#avatar-frame-modal .modal-body {
    padding: 0;
    display: flex;
    flex-direction: column;
}
      
.frame-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
}

.frame-tab {
    flex: 1;
    padding: 12px;
    text-align: center;
    font-weight: 500;
    cursor: pointer;
    color: var(--text-secondary);
    border-bottom: 2px solid transparent;
}

.frame-tab.active {
    color: var(--accent-color);
    border-bottom-color: var(--accent-color);
}

.frame-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
}

.frame-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
    gap: 15px;
}

.frame-item {
    aspect-ratio: 1 / 1; 
    border: 2px solid transparent;
    border-radius: 10px;
    cursor: pointer;
    background-color: #f0f0f0;
    background-size: cover;
    background-position: center;
    padding: 5px;
    transition: all 0.2s ease;
    position: relative; 
}

.frame-item.selected {
    border-color: var(--accent-color);
    transform: scale(1.05);
}

.frame-item .preview-avatar {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.frame-item .preview-frame {
    position: absolute;
    top: -7px;
    left: 0;
    width: 100%;
    height: 100%;
}

#font-preview {
    transition: font-family 0.3s ease;}

#chat-list-screen {
}

.chat-list-view {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
    z-index: 1; 
}
.chat-list-view.active {
    opacity: 1;
    visibility: visible;
    z-index: 2; 
}

#messages-view {
    overflow-y: auto; 
}

#chat-list-bottom-nav {
    position: absolute;
    bottom: 0;
	padding-bottom: 50px;
    left: 0;
    width: 100%;
    z-index: 15;
    display: flex;
    border-top: 1px solid var(--border-color);
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
}

.nav-item {
    flex: 1;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: var(--text-secondary);
    cursor: pointer;
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--accent-color);
    font-weight: 600;
}

#qzone-screen {
    background-color: #f0f2f5;
}

.qzone-header {
    position: relative;
    z-index: 10;
    flex-shrink: 0;
    padding: 15px 20px;
    padding-top: 45px;
    background-color: rgba(247, 247, 247, 0.7);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
}

.qzone-header .back-btn {
    font-size: 24px;
    cursor: pointer;
    color: var(--accent-color);
}

.qzone-header span:nth-child(2) { 
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
}

.qzone-content {
    flex-grow: 1;
    overflow-y: auto;
    /* padding-top: 80px;  <-- Ïù¥Í≤ÉÏùÑ ÏÇ≠Ï†úÌïòÏÑ∏Ïöî, headerÍ∞Ä Îçî Ïù¥ÏÉÅ absoluteÍ∞Ä ÏïÑÎãàÎØÄÎ°ú */
}

.qzone-profile-header {
    position: relative;
    margin-bottom: 20px;
}

.qzone-banner-container {
    width: 100%;
    height: 180px; /* Î∞∞Í≤ΩÌåê ÎÜíÏù¥ */
    position: relative;
}

#qzone-banner-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.qzone-user-info {
    position: absolute;
    bottom: -30px;
    left: 20px;
    display: flex;
    align-items: flex-end; 
    gap: 10px;
}

.qzone-avatar-container {
    position: relative;
}

#qzone-avatar-img {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    object-fit: cover;
}

#qzone-nickname {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
    padding-bottom: 5px; /* ÏúÑÏπò ÎØ∏ÏÑ∏ Ï°∞Ï†ï */
}

.qzone-edit-btn {
    position: absolute;
    background-color: rgba(0,0,0,0.4);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#change-qzone-banner-btn {
    bottom: 10px;
    right: 10px;
}

#change-qzone-avatar-btn {
    bottom: 5px;
    right: 5px;
}

#change-qzone-nickname-btn {
    font-size: 14px;
    padding: 2px 6px;
    margin-left: 5px; 
    color: var(--text-primary);
    background-color: rgba(255,255,255,0.7);
    border-radius: 5px;
    position: relative; 
    bottom: 5px; 
}

#qzone-banner-container,
#qzone-avatar-container,
#qzone-nickname {
    cursor: pointer; 
    transition: opacity 0.2s;
}
#qzone-banner-container:hover,
#qzone-avatar-container:hover,
#qzone-nickname:hover {
    opacity: 0.85; 
}

.qzone-edit-btn {
    display: none;
}

#qzone-screen .qzone-header {
    display: none;
}

#qzone-screen.active .qzone-header {
    display: flex;
}

#chat-list-screen.in-qzone-view > .header,
#chat-list-screen.in-qzone-view > #chat-list-bottom-nav {
    display: none;
}

.chat-list-item:first-child,
.chat-group-container:first-child {
    margin-top: 10px; 
}

.qzone-actions-bar {
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
    margin: 40px 15px 15px 15px; 
    background-color: var(--secondary-bg);
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.action-item {
    flex: 1;
    text-align: center;
    font-size: 15px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    padding: 8px 0;
    position: relative;
}

.action-item:not(:last-child)::after {
    content: '';
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 1px;
    height: 20px;
    background-color: var(--border-color);
}

#qzone-posts-list {
    padding: 0 15px 20px 15px; 
    display: flex;
    flex-direction: column;
    gap: 20px; 
}

.qzone-post-item {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
}

.post-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.post-header .post-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}

.post-info {
    display: flex;
    flex-direction: column;
}

.post-info .post-nickname {
    font-weight: 600;
    font-size: 15px;
    color: var(--text-primary);
}

.post-info .post-timestamp {
    font-size: 12px;
    color: var(--text-secondary);
}

.post-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap; 
    word-break: break-word; 
}

#post-public-text {
    min-height: 80px; 
    resize: vertical;
}

.post-image-preview-container {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9; 
    background-color: #f0f2f5;
    border: 2px dashed var(--border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    display: none; 
    justify-content: center;
    align-items: center;
}
.post-image-preview-container.visible {
    display: flex; 
}

#post-image-preview {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 6px;
}

#post-remove-image-btn {
    position: absolute;
    top: -10px;
    right: -10px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: #ff3b30;
    color: white;
    border: 2px solid white;
    font-size: 16px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
}

.post-image-upload-options {
    display: flex;
    gap: 10px;
}

.post-image-upload-options button {
    flex: 1;
    margin-top: 0;
}

.post-mode-switcher {
    display: flex;
    margin-bottom: 20px;
    background-color: #e9ecef;
    border-radius: 8px;
    padding: 4px;
}

.mode-btn {
    flex: 1;
    padding: 8px;
    border: none;
    background-color: transparent;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}

.mode-btn.active {
    background-color: var(--secondary-bg);
    color: var(--text-primary);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.post-mode-content {
    display: none;
}

.post-mode-content.active {
    display: block; 
}

#album-screen {
    background-color: #f0f2f5; 
}

#album-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(2, 1fr); 
    gap: 15px;
}

.album-item {
    display: flex;
    flex-direction: column;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 8px; 
}

.album-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
}

.album-cover {
    aspect-ratio: 1 / 1;
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    margin-bottom: 8px;
    background-color: #f0f2f5; 
}

.album-info {
    text-align: center;
}

.album-name {
    font-weight: 500;
    margin: 0 0 4px 0;
    color: var(--text-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.album-count {
    font-size: 12px;
    color: var(--text-secondary);
    margin: 0;
}

#album-photos-screen {
    background-color: #f0f2f5;
}

#photos-grid-page {
    padding: 15px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
}

.photo-item {
    position: relative; 
    aspect-ratio: 1 / 1; 
    border-radius: 6px;
    overflow: hidden; 
    background-color: #e9ecef; 
}

.photo-item .photo-thumb {
    width: 100%;
    height: 100%;
    object-fit: cover; 
    cursor: pointer;
}

.photo-item .photo-delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 22px;
    height: 22px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 16px;
    line-height: 22px;
    text-align: center;
    cursor: pointer;
    opacity: 0; 
    transition: opacity 0.2s ease;
}

.photo-item:hover .photo-delete-btn {
    opacity: 1;
}

#photo-viewer-modal {
    background-color: rgba(0, 0, 0, 0.85);
    z-index: 1002;
    -webkit-backdrop-filter: blur(5px);
    backdrop-filter: blur(5px);
}

.photo-viewer-content {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
}

#photo-viewer-image {
    max-width: 90vw; 
    max-height: 85vh; 
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    transition: opacity 0.2s ease-in-out;
}

#photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 20px;
    background: none;
    border: none;
    color: white;
    font-size: 40px;
    font-weight: 200;
    cursor: pointer;
    line-height: 1;
    text-shadow: 0 0 5px black;
}

#photo-viewer-modal .nav-arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 50px; 
    font-weight: 100;
    cursor: pointer;
    padding: 10px;
    user-select: none;
    transition: color 0.2s;
    z-index: 1003; 
}

#photo-viewer-prev-btn {
    left: 5px; 
}

#photo-viewer-next-btn {
    right: 5px; 
}

#photo-viewer-modal .nav-arrow:hover {
    color: white;
}

#photo-viewer-modal .nav-arrow:disabled {
    color: rgba(255, 255, 255, 0.2);
    cursor: default;
}

.post-main-content {
}

.post-feedback-icons {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 12px;
    padding: 8px 0; 
}

.action-icon {
    cursor: pointer;
    color: var(--text-secondary); 
    transition: all 0.2s ease-in-out;
}

.action-icon svg {
    width: 22px;
    height: 22px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
}

.action-icon.active {
    color: #ff5252; 
    transform: scale(1.1); 
}

.action-icon.active.favorite {
    color: #ffc107; 
}

.action-icon.active svg {
    fill: currentColor; 
}

.animate-like {
    animation: like-bounce 0.4s ease-in-out;
}

@keyframes like-bounce {
    0%   { transform: scale(1); }
    25%  { transform: scale(0.8); }
    50%  { transform: scale(1.2); }
    75%  { transform: scale(1.05); }
    100% { transform: scale(1.1); }
}

.post-footer {
    margin-top: 15px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0; 
    display: flex;
    align-items: center;
    gap: 8px; 
}

.comment-section {
    flex-grow: 1; 
    display: flex;
    align-items: center;
    gap: 8px;
}

.comment-section .comment-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
    flex-shrink: 0;
}

.comment-section .comment-input {
    width: 100%;
    padding: 8px 12px;
    border: none;
    background-color: #f0f2f5;
    border-radius: 14px;
    font-size: 13px;
    outline: none;
}

.comment-send-btn {
    flex-shrink: 0; 
    padding: 8px 15px;
    border: none;
    background-color: var(--accent-color);
    color: white;
    border-radius: 14px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
}

.unread-indicator {
    position: absolute;
    top: -8px;      
    right: -15px;    
    min-width: 18px;
    height: 18px;
    padding: 0 5px;
    background-color: #ff3b30;
    color: white;
    font-size: 11px;
    font-weight: bold;
    line-height: 18px;
    text-align: center;
    border-radius: 9px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    display: none;
    z-index: 1;
}

.back-btn-indicator {
    top: 0;
    right: -8px;
    width: 10px;
    height: 10px;
    min-width: 10px;
    padding: 0;
    border-radius: 50%;
}

.post-comments-container {
    padding: 10px 0; 
    display: flex;
    flex-direction: column;
    gap: 8px; 
    font-size: 13px; 
}

.comment-item {
    line-height: 1.5;
}

.comment-item .commenter-name {
    font-weight: 600;
    color: var(--accent-color);
    cursor: pointer;
    margin-right: 5px; 
}

.comment-item .comment-text {
    color: var(--text-primary);
    word-break: break-word;
}

.post-likes-section {
    display: flex;
    align-items: center;
    gap: 6px; 
    padding: 8px 10px; 
    font-size: 13px;
    color: var(--accent-color); 
    background-color: #f0f5fa; 
    border-top: 1px solid #e9eef3;
    border-bottom: 1px solid #e9eef3;
    margin-top: 5px; 
}

.post-likes-section .like-icon {
    width: 16px;
    height: 16px;
    fill: currentColor; 
    flex-shrink: 0; 
}

.at-mention-popup {
    position: absolute; 
    bottom: 100%; 
    left: 40px; 
    width: calc(100% - 40px); 
    max-height: 120px;
    overflow-y: auto;
    background-color: var(--secondary-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 10;
    display: none; 
}

.at-mention-item {
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-primary);
    border-bottom: 1px solid #f0f0f0;
}

.at-mention-item:last-child {
    border-bottom: none;
}

.at-mention-item:hover {
    background-color: #f5f5f5;
}

#favorites-view {
    display: flex;
    flex-direction: column;
}

#favorites-view > .header {
    flex-shrink: 0;
}

#favorites-list {
    flex-grow: 1; 
    overflow-y: auto; 
    overflow-x: hidden; 
    padding: 15px; 
    display: flex;
    flex-direction: column;
    gap: 15px; 
}

.favorite-item-card {
    background-color: var(--secondary-bg);
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.06);
    position: relative; 
}

.fav-card-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;
}

.fav-card-header .avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.fav-card-header .info {
    flex-grow: 1;
}

.fav-card-header .name {
    font-weight: 600;
    font-size: 15px;
}

.fav-card-header .source {
    font-size: 12px;
    color: var(--text-secondary);
}

.fav-card-content {
    font-size: 14px;
    line-height: 1.6;
    color: #333;
    white-space: pre-wrap;
    word-break: break-word;
}

.fav-card-content .chat-image {
    margin-top: 8px; 
}

.fav-delete-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 28px;
    height: 28px;
    background: #f0f2f5;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 18px;
    color: var(--text-secondary);
    line-height: 28px;
    text-align: center;
}

.fav-delete-btn:hover {
    background-color: #e9ecef;
    color: #ff3b30;
}

.search-bar-container {
    padding: 10px 15px;
    background-color: #f9f9f9; 
    position: relative; 
    flex-shrink: 0;
}

#favorites-search-input {
    width: 100%;
    padding: 10px 30px 10px 15px; 
    font-size: 14px;
    border: 1px solid var(--border-color);
    border-radius: 18px; 
    background-color: var(--secondary-bg);
    box-sizing: border-box;
    outline: none;
}

#favorites-search-input:focus {
    border-color: var(--accent-color);
}

.search-clear-btn {
    position: absolute;
    right: 25px;
    top: 50%;
    transform: translateY(-50%);
    background: #ccc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    font-size: 16px;
    cursor: pointer;
}

#chat-interface-screen .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen .selection-controls .action-btn {
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    padding: 5px;
}

#favorites-view.selection-mode .favorite-item-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.favorite-item-card::before {
    content: '';
    position: absolute;
    left: -25px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    background-color: white;
    transition: all 0.2s ease;
    opacity: 0; 
}

#favorites-view.selection-mode .favorite-item-card {
    transform: translateX(35px);
}
#favorites-view.selection-mode .favorite-item-card::before {
    opacity: 1;
}

#favorites-view.selection-mode .favorite-item-card.selected::before {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: '‚úî';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}

#favorites-action-bar {
    position: absolute; 
    bottom: 0;
    left: 0;
    right: 0; 
    width: auto; 
    padding: 10px 15px;
    padding-bottom: calc(50px + env(safe-area-inset-bottom)); 
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-top: 1px solid var(--border-color);
    box-sizing: border-box;
    z-index: 5;
    display: none;
}

#favorites-action-bar .action-bar-btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    background-color: #ff3b30;
    color: white;
}

#chat-interface-screen .header .selection-controls {
    display: none;
}

#chat-interface-screen .header .default-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#chat-interface-screen.selection-mode .header .default-controls {
    display: none;
}

#chat-interface-screen.selection-mode .header .selection-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

#add-chat-btn,
#add-world-book-btn,
#create-album-btn-page {
    font-size: 28px; 
    font-weight: 300; 
    position: relative; 
    top: -1px; 
}

#settings-preview-area {
    width: 100%;
    height: 180px; 
    background-color: #f0f2f5;
    border-radius: 8px;
    padding: 15px;
    box-sizing: border-box;
    overflow: hidden; 
    display: flex;
    flex-direction: column;
    gap: 10px; 
    border: 1px solid var(--border-color);
    position: relative; 
}

#settings-preview-area::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-size: cover;
    background-position: center;
    z-index: 1;
    opacity: 0.8;
}

#settings-preview-area .message-wrapper {
    position: relative;
    z-index: 2;
}

#settings-preview-area .message-bubble .avatar {
    width: 30px;
    height: 30px;
}
#settings-preview-area .avatar-with-frame {
     width: 30px;
    height: 30px;
}
#settings-preview-area .avatar-with-frame .avatar-frame {
    width: 44px;
    height: 44px;
    top: -7px;
    left: -7px;
}
#settings-preview-area .message-bubble .timestamp {
    display: none; 
}

.existing-group-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    background-color: #f9f9f9;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.existing-group-item .group-name {
    font-weight: 500;
}

.existing-group-item .delete-group-btn {
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
}

.chat-group-container {
    border-bottom: 1px solid var(--border-color);
}
.chat-group-container:first-child {
    border-top: 1px solid var(--border-color);
}

.chat-group-header {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    cursor: pointer;
    background-color: #f7f7f7;
}

.chat-group-header .arrow {
    font-size: 14px;
    margin-right: 8px;
    transition: transform 0.2s ease;
}

.chat-group-header.collapsed .arrow {
    transform: rotate(-90deg);
}

.chat-group-header .group-name {
    font-weight: 600;
    font-size: 15px;
}

.chat-group-content {
    max-height: 1000px; 
    overflow: hidden;
    transition: max-height 0.3s ease-in-out;
}

.chat-group-content.collapsed {
    max-height: 0;
}

.format-helpers {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap; 
}

.format-btn {
    background-color: #e9ecef;
    color: var(--text-primary);
    border: none;
    padding: 6px 12px;
    border-radius: 16px; 
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s;
}

.format-btn:hover {
    background-color: #dcdfe3;
}

.post-actions-btn {
    margin-left: auto; 
    padding: 5px 10px;
    font-size: 20px;
    font-weight: bold;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: 50%;
    line-height: 1;
}
.post-actions-btn:hover {
    background-color: #f0f0f0;
}

#post-actions-modal .custom-modal-footer button {
    width: 100%;
    border: none;
    border-bottom: 1px solid #dbdbdb;
    padding: 14px;
    font-size: 18px;
}
#post-actions-modal .custom-modal-footer button:last-child {
    border-bottom: none;
}
#post-actions-modal #cancel-post-action-btn {
    margin-top: 8px;
    border-radius: 8px;
    background-color: #f0f0f0;
}

#chat-messages .transfer-card .transfer-title,
#chat-messages .transfer-card .transfer-amount,
#chat-messages .transfer-card .transfer-note {
    text-shadow: none !important; 
    color: white !important; 
}

#chat-messages .transfer-card .transfer-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

#chat-messages .transfer-card .transfer-amount {
    font-size: 28px !important;
    font-weight: bold !important;
}

#chat-messages .transfer-card .transfer-note {
    font-size: 13px !important;
    opacity: 0.9 !important;
}

.avatar-group {
    width: 34px; 
    flex-shrink: 0;
    position: relative;
    transition: width 0.2s ease; 
}

.avatar-group.has-frame {
    width: 42px; 
}

.message-bubble .avatar {
    width: 34px;
    height: 34px;
    border-radius: 20%;
    object-fit: cover;
}

.avatar-with-frame {
    position: relative;
    width: 34px;
    height: 34px;
    margin: 0 auto;
    transition: all 0.2s ease; 
}

.avatar-group.has-frame .avatar-with-frame {
    width: 43px; 
    height: 43px;
}

.avatar-with-frame .avatar-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
    z-index: 1;
}

.avatar-with-frame .avatar-frame {
    position: absolute;
    width: 52px;
    height: 52px;
    top: -9px;   
    left: -4px;  
    z-index: 2;
    pointer-events: none;
}

.header > span:nth-child(2),
#chat-header-title {
    position: absolute;
    left: 50%;
    transform: translateX(calc(-50% - 2px)); 
    max-width: 60%;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#message-editor-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.message-editor-block {
    background-color: #f9f9f9;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 12px;
}

.message-editor-block textarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 8px;
    font-size: 14px;
    box-sizing: border-box;
}

.message-editor-block .format-helpers {
    margin-top: 8px;
    margin-bottom: 0; 
}

.message-editor-block .delete-block-btn {
    float: right;
    margin-top: -5px;
    background: none;
    border: none;
    color: #ff3b30;
    font-size: 20px;
    cursor: pointer;
}

.contact-picker-item {
    display: flex;
    align-items: center;
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid var(--border-color);
}
.contact-picker-item .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #ccc;
    border-radius: 50%;
    margin-right: 15px;
    transition: all 0.2s ease;
}
.contact-picker-item.selected .checkbox {
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    content: '‚úî';
    color: white;
    font-size: 14px;
    text-align: center;
    line-height: 20px;
}
.contact-picker-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}
.contact-picker-item .name {
    font-weight: 500;
}

#member-management-list {
    padding: 0; 
}

.member-management-item {
    display: flex;
    align-items: center;
    padding: 12px 15px;
    border-bottom: 1px solid var(--border-color);
}

.member-management-item .avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 12px;
}

.member-management-item .name {
    flex-grow: 1;
    font-weight: 500;
}

.member-management-item .remove-member-btn {
    background-color: #ff3b30;
    color: white;
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 20px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    flex-shrink: 0;
}

#member-management-actions {
    flex-shrink: 0;
    padding: 15px;
    border-top: 1px solid var(--border-color);
    background-color: #f7f7f7;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

#member-management-actions button {
    width: 100%;
    padding: 15px;
    background-color: var(--accent-color);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
}
#member-management-actions #create-new-member-btn {
    background-color: #4cd964; 
}

.message-bubble.is-waimai-request .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.waimai-card {
    width: 240px;
    border-radius: 12px;
    overflow: hidden;
    background-color: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
}

.waimai-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.waimai-header .icon {
    width: 20px;
    height: 20px;
}

.waimai-header .title-group {
    display: flex;
    align-items: baseline;
    font-size: 14px;
    color: #8a8a8a;
}
.waimai-header .title-group .brand {
    font-weight: 600;
    color: #555;
    margin-right: 5px;
}
.waimai-header .title-group .separator {
    margin: 0 5px;
}

.waimai-catchphrase {
    font-size: 13px;
    color: #1f1f1f;
    padding: 12px;
}

.waimai-main {
    background-color: #FFD66B; 
    padding: 12px;
    text-align: center;
}

.waimai-main .request-title {
    font-size: 12px;
    color: #856404;
    margin-bottom: 8px;
}

.waimai-main .payment-box {
    background-color: #fff;
    border-radius: 8px;
    padding: 15px 10px;
}

.waimai-main .payment-label {
    font-size: 13px;
    color: #8a8a8a;
}

.waimai-main .amount {
    font-size: 32px;
    font-weight: 700;
    color: #1f1f1f;
    margin: 4px 0 12px 0;
}

.waimai-main .countdown-label {
    font-size: 13px;
    color: #8a8a8a;
}
.waimai-main .countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    margin-left: 5px;
}
.waimai-main .countdown-timer span {
    background-color: #333;
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: bold;
    font-size: 12px;
}

.waimai-details-btn {
    width: 100%;
    padding: 10px 0;
    margin-top: 15px;
    border: none;
    border-radius: 6px;
    background-color: #FFC33A;
    color: #49380a;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
}

.message-bubble.status-paid .waimai-card {
    border: 2px solid #28a745; 
}
.message-bubble.status-paid .waimai-main .request-title::before {
    content: '‚úÖ  ';
}
.message-bubble.status-paid .waimai-main .request-title {
    color: #155724;
    font-weight: 600;
    content: "Ï†úÍ∞Ä Í≥ÑÏÇ∞ÌñàÏñ¥Ïöî, ÎßõÏûàÍ≤å Ï¶êÍ∏∞ÏÑ∏Ïöî~" !important;
    display: block;
    margin-bottom: 15px;
}

.message-bubble.status-paid .payment-box {
    display: none; 
}
.message-bubble.status-paid .waimai-details-btn {
    background-color: #28a745;
    color: white;
}

.message-bubble.status-rejected .waimai-card {
    border: 2px solid #dc3545; 
    opacity: 0.8;
}
.message-bubble.status-rejected .waimai-main {
    background-color: #e9ecef;
}
.message-bubble.status-rejected .waimai-main .request-title::before {
    content: '‚ùå ';
}
.message-bubble.status-rejected .waimai-main .request-title {
    color: #721c24;
    font-weight: 600;
    content: "ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§" !important;
    display: block;
    margin-bottom: 15px;
}
.message-bubble.status-rejected .payment-box {
    display: none; 
}
 .message-bubble.status-rejected .waimai-details-btn {
    background-color: #6c757d;
    color: white;
}

.message-bubble[class*="status-"] .request-title {
    font-size: 0; 
}
.message-bubble[class*="status-"] .request-title::after {
    font-size: 14px; 
}
.message-bubble.status-paid .request-title::after {
    content: "Ï†úÍ∞Ä Í≥ÑÏÇ∞ÌñàÏñ¥Ïöî, ÎßõÏûàÍ≤å Ï¶êÍ∏∞ÏÑ∏Ïöî~";
}
.message-bubble.status-rejected .request-title::after {
    content: "ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§";
}

.waimai-user-actions {
    display: flex;
    gap: 10px;
    padding: 0 12px 12px 12px; 
    background-color: #fff;
}

.waimai-user-actions button {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1.5px solid;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}

.waimai-pay-btn {
    background-color: #28a745;
    border-color: #1f7a33;
    color: white;
}
.waimai-pay-btn:hover {
    background-color: #218838;
}

.waimai-decline-btn {
    background-color: #f8f9fa;
    border-color: #ced4da;
    color: #495057;
}
.waimai-decline-btn:hover {
    background-color: #e2e6ea;
}

#api-settings-screen,
#font-settings-screen,
#wallpaper-screen,
#memories-view,
#contact-picker-screen,
#member-management-screen,
#world-book-editor-screen {  
    background-color: var(--secondary-bg);
}

#api-settings-screen .form-container,
#font-settings-screen .form-container,
#wallpaper-screen .form-container {
    padding-top: 100px;
    margin-top: -80px;
    background-color: var(--secondary-bg);
}

#wallpaper-screen .form-container {
    align-items: center; 
}

#incoming-call-modal .incoming-call-content {
    background-color: rgba(40, 40, 40, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-radius: 20px;
    width: 280px;
    padding: 30px 20px;
    text-align: center;
    color: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.caller-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
    border: 3px solid rgba(255,255,255,0.5);
}

.caller-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 5px;
}

.caller-text {
    font-size: 14px;
    color: #ccc;
    margin-bottom: 30px;
}

.incoming-call-actions {
    display: flex;
    justify-content: space-around;
    align-items: center;
}

.action-button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}

.call-action-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-size: 50%;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.call-action-btn:active {
    transform: scale(0.9);
}

.call-action-btn.decline {
    background-color: #ff3b30;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}

.call-action-btn.accept {
    background-color: #4cd964;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
    70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
    100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
}

#video-call-screen {
    background-color: #1c1c1e;
    color: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.video-call-top-bar {
    position: absolute;
    top: 0; left: 0; width: 100%;
    padding: 15px 20px;
    padding-top: 50px;
    background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    text-align: center;
    box-sizing: border-box;
    pointer-events: none;
}
#call-timer {
    font-size: 16px;
    font-weight: 500;
    letter-spacing: 1px;
}
.video-call-controls {
    position: absolute;
    bottom: 0; left: 0; width: 100%;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 20px;
    padding-bottom: 40px;
    background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
    z-index: 10;
    box-sizing: border-box;
}

.video-call-avatar-area {
    flex-grow: 1; 
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
    padding-top: 80px; 
    box-sizing: border-box;
    overflow-y: auto; 
}

#participant-avatars-grid {
    display: flex;
    flex-wrap: wrap; 
    justify-content: center;
    align-items: center;
    gap: 15px; 
    max-width: 100%;
}

.participant-avatar-wrapper {
    position: relative;
    text-align: center;
    flex-shrink: 0;
}
.participant-avatar {
    width: 70px; 
    height: 70px; 
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid rgba(255, 255, 255, 0.2);
    transition: all 0.3s ease;
}
.participant-name {
    margin-top: 8px;
    font-size: 12px;
    color: #ccc;
}

.participant-avatar.speaking {
    border-color: #4cd964;
    box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
    transform: scale(1.05);
}

#video-call-main {
    flex-shrink: 0; 
    height: 30%; 
    margin: 15px 15px 130px 15px; 
    overflow-y: auto;
    padding: 15px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    box-sizing: border-box;
}

.control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background-repeat: no-repeat;
    background-position: center;
    transition: transform 0.2s, background-color 0.2s;
}
.control-btn:active {
    transform: scale(0.9);
}
.control-btn.speak-btn {
    background-color: rgba(255,255,255,0.2);
    background-size: 55%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
}
.control-btn.hangup-btn {
    background-color: #ff3b30;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
}
.control-btn.join-btn {
    background-color: #007bff;
    background-size: 50%;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
}

.call-message-bubble {
    padding: 10px 15px;
    border-radius: 12px;
    max-width: 85%;
    line-height: 1.6;
    word-break: break-word;
    white-space: pre-wrap;
}

.call-message-bubble.ai-speech {
    background-color: rgba(255, 255, 255, 0.15);
    align-self: flex-start; 
}

.call-message-bubble.user-speech {
    background-color: #4cd964; 
    align-self: flex-end; 
    text-align: left; 
}

#outgoing-call-screen {
    background-color: #1c1c1e;
    color: white;
    justify-content: center; 
    align-items: center; 
}

.outgoing-call-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
}

.outgoing-call-actions {
    margin-top: 50px; 
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #e0e0e0;
}

.qzone-post-container {
    position: relative; 
    overflow: hidden; 
    border-radius: 12px; 
}

.qzone-post-item {
    transition: transform 0.3s ease;
    background-color: var(--secondary-bg); 
    position: relative; 
    z-index: 2;
}

.qzone-post-delete-action {
    position: absolute; 
    top: 0;
    right: 0;
    bottom: 0;
    width: 90px; 
    background-color: #ff3b30; 
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    cursor: pointer;
    z-index: 1; 
}

.qzone-post-item.swiped {
    transform: translateX(-90px); 
}

@keyframes pat-shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
    20%, 40%, 60%, 80% { transform: translateX(3px); }
}

.pat-animation {
    animation: pat-shake 0.4s ease-in-out;
}

.system-message {
    align-self: center; 
    padding: 4px 12px;
    margin: 5px 0;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    border-radius: 10px;
    text-align: center;
    max-width: 80%;
}

.message-wrapper.system-pat {
    justify-content: center;
    align-self: center;
    margin: 5px 0;
    max-width: 80%;
}

.message-bubble.system-bubble {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--text-secondary);
    font-size: 12px;
    padding: 4px 12px;
    border-radius: 10px;
}

#chat-input-actions-top {
    display: flex;
    gap: 8px;
    padding: 0 5px;
    overflow-x: auto;      
    flex-wrap: nowrap;     
    -webkit-overflow-scrolling: touch; 
    scrollbar-width: none; 
    -ms-overflow-style: none;  
}

#chat-input-actions-top::-webkit-scrollbar {
    display: none; 
}

#chat-header-title-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center; 
    gap: 2px;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    max-width: 60%;
}

#chat-header-title {
    font-size: 16px; 
    font-weight: 600;
    position: static; 
    transform: none; 
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

#chat-header-status {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-secondary);
    transition: all 0.3s ease;
}

.status-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background-color: #4cd964; 
    transition: background-color 0.3s ease;
}

#chat-header-status.busy .status-dot {
    background-color: #cccccc;
}

.status-text {
    font-weight: 500;
}

.memory-card {
    background-color: #fffaf0; 
    border-radius: 12px;
    padding: 15px; 
    box-shadow: 0 2px 6px rgba(0,0,0,0.07);
    border-left: 5px solid #ffb74d; 
    display: flex; 
    flex-direction: column; 
    gap: 8px; 
}

.memory-card .header {
    border-bottom: 1px solid rgba(217, 129, 0, 0.15); 
    padding-bottom: 8px; 
}

.memory-card .header .date {
    font-size: 11px;
    color: #a1887f;
    margin-bottom: 4px; 
}

.memory-card .header .author {
    font-weight: 600;
    color: #d98100;
    font-size: 15px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.memory-card .content {
    font-size: 14px;
    line-height: 1.7;
    color: #5d4037;
    white-space: pre-wrap;
}

.countdown-card {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
    text-align: center;
    position: relative;
    overflow: hidden;
    flex-shrink: 0;
}
.countdown-card::before {
    content: '‚ú®';
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 50px;
    opacity: 0.1;
    transform: rotate(-15deg);
}
.countdown-card .title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 15px;
}
.countdown-card .timer {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    margin-bottom: 15px;
}
.countdown-card .target-date {
    font-size: 12px;
    opacity: 0.8;
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 10px;
}

#chat-lock-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background-color: rgba(247, 247, 247, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index: 150; 
    display: none; 
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
    border-top: 1px solid var(--border-color);
    text-align: center;
}
#chat-lock-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
#chat-lock-content .lock-text {
    color: var(--text-secondary);
    font-size: 14px;
}
#chat-lock-content .lock-action-btn {
    padding: 10px 20px;
    border-radius: 20px;
    border: 1px solid var(--accent-color);
    background-color: var(--accent-color);
    color: white;
    cursor: pointer;
}
#chat-lock-content .lock-action-btn.secondary {
    background-color: transparent;
    color: var(--accent-color);
}

.message-bubble.is-red-packet .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.red-packet-card {
    width: 220px;
    border-radius: 8px;
    background: linear-gradient(160deg, #F96259, #E44D44);
    color: #ffd700;
    padding: 12px;
    cursor: pointer;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
}

.red-packet-card.opened {
    background: linear-gradient(160deg, #d3c4a0, #c4b693);
    cursor: default;
}

.red-packet-card::before {
    content: 'üßß';
    position: absolute;
    top: -5px;
    left: -5px;
    font-size: 30px;
    opacity: 0.2;
    transform: rotate(-10deg);
}

.rp-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.rp-icon {
    width: 20px;
    height: 20px;
}

.rp-greeting {
    font-size: 15px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.rp-type {
    font-size: 11px;
    color: white;
    opacity: 0.8;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 8px;
    margin-top: 8px;
}

.rp-claimed-info {
    font-size: 13px;
    color: white;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid rgba(255,255,255,0.3);
}

.rp-details-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}
.rp-details-item:last-child {
    border-bottom: none;
}
.rp-details-item .name {
    flex-grow: 1;
    font-weight: 500;
    color: #333;
}
.rp-details-item .amount {
    font-weight: 500;
    color: #555;
}
.rp-details-item .lucky-king-tag {
    font-size: 10px;
    background-color: #ffd700;
    color: #a67c00;
    padding: 2px 5px;
    border-radius: 4px;
    margin-left: 8px;
    font-weight: bold;
}

.message-bubble.is-poll .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.poll-card {
    width: 250px;
    background-color: #f9f9f9;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.poll-card.closed {
    background-color: #e9ecef; 
}

.poll-question {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 12px;
    line-height: 1.4;
    word-break: break-word;
}

.poll-options-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.poll-option-item {
    background-color: white;
    border: 1px solid #dcdcdc;
    border-radius: 8px;
    padding: 10px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: background-color 0.2s;
}

.poll-card:not(.closed) .poll-option-item:hover {
    background-color: #f0f8ff;
}

.poll-option-item.voted {
    border-color: var(--accent-color);
    background-color: #e7f3ff;
    font-weight: 500;
}

.poll-option-bar {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background-color: rgba(0, 123, 255, 0.1);
    z-index: 1;
    transition: width 0.3s ease-in-out;
}

.poll-option-content {
    position: relative;
    z-index: 2;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-option-text {
    font-size: 14px;
}

.poll-option-votes {
    font-size: 13px;
    color: #8a8a8a;
    font-weight: 500;
}

.poll-footer {
    margin-top: 12px;
    padding-top: 8px;
    border-top: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-secondary);
}

.poll-total-votes {
    font-weight: 500;
}

.poll-action-btn {
    background: none;
    border: 1px solid var(--accent-color);
    color: var(--accent-color);
    padding: 4px 10px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 12px;
}
.poll-card.closed .poll-action-btn {
    background-color: #6c757d;
    color: white;
    border-color: #6c757d;
}

.poll-option-input-wrapper {
    display: flex;
    align-items: center;
    gap: 8px;
}
.poll-option-input-wrapper input {
    flex-grow: 1;
}
.poll-option-input-wrapper .remove-option-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background-color: #f0f0f0;
    color: #ff3b30;
    border: none;
    cursor: pointer;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    flex-shrink: 0;
}

#chat-header-title.typing-status {
    color: var(--text-secondary);
    animation: typing-pulse 1.5s infinite;
    font-style: italic;
}

@keyframes typing-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

#chat-header-title {
    transition: opacity 0.2s ease-in-out;
}

@keyframes message-pop-in {
  from {
    opacity: 0;
    transform: translateY(15px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.message-wrapper.animate-in {
  animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
  }

#icon-settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
    gap: 20px;
    width: 100%;
    padding: 0 10px;
    box-sizing: border-box;
}

.icon-setting-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.icon-preview {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    background-size: cover;
    background-position: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.change-icon-btn {
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid #ccc;
    background-color: #f0f0f0;
    border-radius: 5px;
    cursor: pointer;
}

#wallpaper-screen .form-container {
    min-height: 0; 
}

#wallpaper-preview {
    flex-shrink: 0; 
}

#browser-screen {
    background-color: #f8f9fa;
}
#browser-content {
    padding: 20px;
    font-size: 16px;
    line-height: 1.8;
    color: #333;
    overflow-y: auto;
    background-color: #f8f9fa;
}
#browser-content .article-title {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
}
#browser-content .article-meta {
    font-size: 13px;
    color: #8a8a8a;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e0e0e0;
}
#browser-content .article-body {
    white-space: pre-wrap;
    word-break: break-word;
}
#browser-content .article-body p {
    margin-bottom: 1em;
}

.message-bubble.is-link-share .content {
    padding: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
}

.link-share-card {
    width: 250px;
    background-color: #fff;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
    padding: 12px; 
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex; 
    flex-direction: column;
    gap: 8px; 
}
.link-share-card:hover {
    background-color: #f9f9f9;
}

.link-share-card .title {
    font-weight: 600;
    font-size: 15px;
    line-height: 1.4;
    color: #1f1f1f;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .description {
    font-size: 13px;
    color: #8a8a8a;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
}

.link-share-card .footer {
    display: flex; 
    align-items: center;
    gap: 6px; 
    font-size: 12px;
    color: var(--text-secondary);
    margin-top: 4px; 
}
.link-share-card .footer-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0; 
}
    </style>
</head>
<body>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">ÏõîÏöîÏùº, 1Ïõî 1Ïùº</div></div>

<div id="app-grid">
    <div class="app-row">
        <div class="app-icon" onclick="showScreen('world-book-screen')">
            <div class="icon-bg">
                <img id="icon-img-world-book" src="https://i.postimg.cc/mZ0vV6tT/IMG-6907.jpg" alt="ÏõîÎìúÏù∏Ìè¨">
            </div>
            <span class="label">ÏõîÎìúÏù∏Ìè¨</span>
        </div>
        <div class="app-icon" onclick="showScreen('chat-list-screen')">
            <div class="icon-bg">
                <img id="icon-img-qq" src="https://i.postimg.cc/gJ7Dz5fj/IMG-6906.jpg" alt="QQ">
            </div>
            <span class="label">QQ</span>
        </div>
    </div>
    <div class="app-row">
        <div class="app-icon" onclick="showScreen('api-settings-screen')">
            <div class="icon-bg">
                <img id="icon-img-api-settings" src="https://i.postimg.cc/RhnTNdBR/IMG-6908.jpg" alt="APIÏÑ§Ï†ï">
            </div>
            <span class="label">APIÏÑ§Ï†ï</span>
        </div>
        <div class="app-icon" onclick="showScreen('wallpaper-screen')">
            <div class="icon-bg">
                <img id="icon-img-wallpaper" src="https://i.postimg.cc/WbgQy6kg/IMG-6909.jpg" alt="Ïô∏Í¥Ä ÏÑ§Ï†ï">
            </div>
            <span class="label">Ïô∏Í¥Ä ÏÑ§Ï†ï</span>
        </div>
        <div class="app-icon" onclick="showScreen('font-settings-screen')">
            <div class="icon-bg">
                <img id="icon-img-font" src="https://files.catbox.moe/j1kn1a.jpeg" alt="Í∏ÄÍº¥">
            </div>
            <span class="label">Í∏ÄÍº¥</span>
        </div>
    </div>
</div>
            </div>
          
            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span>ÏõîÎìúÏù∏Ìè¨</span><span class="action-btn" id="add-world-book-btn">+</span></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">‚Äπ</span>
                    <span id="world-book-editor-title">ÏõîÎìúÏù∏Ìè¨ Ìé∏Ïßë</span>
                    <span class="save-btn" id="save-world-book-btn">Ï†ÄÏû•</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">Ï±Ö Ï†úÎ™©</label>
                        <input type="text" id="world-book-name-input" placeholder="ÏõîÎìúÏù∏Ìè¨ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">ÎÇ¥Ïö©</label>
                        <textarea id="world-book-content-input" placeholder="Ïó¨Í∏∞Ïóê ÏûêÏÑ∏Ìïú ÏÑ∏Í≥ÑÍ¥Ä ÏÑ§Ï†ïÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span>API ÏÑ§Ï†ï</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">ÌåÅ: ÏÇ¨Ïö©ÌïòÎ†§Î©¥\"Ïù¥ÎØ∏ÏßÄ Ï†ÑÏÜ°\"Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥, Î∞òÎìúÏãú VisionÏùÑ ÏßÄÏõêÌïòÎäî(ÏãúÍ∞Å)Î™®Îç∏ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî, Ïòà:<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>ÎòêÎäî<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>.</p><div class="form-group"><label for="proxy-url">Î¶¨Î≤ÑÏä§ ÌîÑÎ°ùÏãú Ï£ºÏÜå (Ï∂îÍ∞ÄÌï† ÌïÑÏöî ÏóÜÏùå/v1Ïò§~)</label><input type="text" id="proxy-url" placeholder="ÏòàÏãú: https://api.openai.com"></div><div class="form-group"><label for="api-key">ÌÇ§ (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">Î™®Îç∏</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">Î™®Îç∏ Í∞ÄÏ†∏Ïò§Í∏∞</button>

<hr style="margin:20px 0; opacity:.3">
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
    <label for="background-activity-switch" style="margin-bottom: 0;">
        Î∞±Í∑∏ÎùºÏö¥Îìú Ï∫êÎ¶≠ÌÑ∞ ÌôúÎèô ÌôúÏÑ±Ìôî
        <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
            Í≤ΩÍ≥†:Ïù¥ Í∏∞Îä•ÏùÄ API Ìò∏Ï∂úÍ≥º ÎπÑÏö©ÏùÑ ÌòÑÏ†ÄÌïòÍ≤å Ï¶ùÍ∞ÄÏãúÌÇµÎãàÎã§!
        </p>
    </label>
    <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
</div>
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="background-interval-input" style="margin-bottom: 0;">
        Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô Í∞êÏßÄ Í∞ÑÍ≤© (Ï¥à)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            Í∂åÏû• Í∞í 60-300.Í∞íÏù¥ ÌÅ¥ÏàòÎ°ù, ÎπÑÏö©ÏùÄ ÎÇÆÏïÑÏßÄÏßÄÎßå, Ï∫êÎ¶≠ÌÑ∞ Î∞òÏùëÏùÄ ÎäêÎ†§ÏßëÎãàÎã§.
        </p>
    </label>
    <input type="number" id="background-interval-input" min="30" value="60" style="width: 80px; text-align: center;">
</div>
<div class="form-group" style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
    <label for="block-cooldown-input" style="margin-bottom: 0;">
        AIÏ∞®Îã® ÌõÑ ÎÉâÍ∞ÅÍ∏∞ (ÏãúÍ∞Ñ)
        <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
            Ïù¥ ÏãúÍ∞Ñ Ïù¥ÌõÑÏóê Ï∞®Îã®Îêú AIÎßå ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Îã§Ïãú Ìï† Í∏∞ÌöåÍ∞Ä ÏûàÏäµÎãàÎã§.
        </p>
    </label>
    <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1" style="width: 80px; text-align: center;">
</div>

<button class="form-button" id="save-api-settings-btn">ÏÑ§Ï†ï Ï†ÄÏû•</button>
			<hr style="margin:20px 0; opacity:.3">
			<button class="form-button" id="export-data-btn">Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>

<button class="form-button" id="import-btn">Î∞±ÏóÖ ÌååÏùº Í∞ÄÏ†∏Ïò§Í∏∞</button>

<input id="import-data-input" type="file" accept="application/json" hidden>
</div></div>
<div id="chat-list-screen" class="screen">
    
    <div class="header" id="main-chat-list-header">
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
        <span>Î©îÏãúÏßÄ</span>
        <div class="header-actions">
            <span class="action-btn" id="add-group-chat-btn" title="Í∑∏Î£π Ï±ÑÌåÖ ÏÉùÏÑ±"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
            <span class="action-btn" id="add-chat-btn">+</span>
        </div>
    </div>
    <div id="messages-view" class="chat-list-view active">
        <div id="chat-list">
        </div>
    </div>
    <div id="qzone-screen" class="chat-list-view">
        <div class="qzone-header">
            <span class="back-btn" id="qzone-back-btn">‚Äπ</span>
            <span>ÏπúÍµ¨ ÌîºÎìú</span>
        </div>
        <div class="qzone-content">
            <div class="qzone-profile-header">
                <div id="qzone-banner-container" class="qzone-banner-container">
                    <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="Î∞∞Í≤Ω">
                    <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                </div>
                <div class="qzone-user-info">
                    <div id="qzone-avatar-container" class="qzone-avatar-container">
                        <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ">
                        <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                    </div>
                    <span id="qzone-nickname">{{user}}</span>
                </div>
            </div>
            <div class="qzone-actions-bar">
                <div class="action-item" id="create-shuoshuo-btn"><span>Í∏Ä</span></div>
                <div class="action-item" id="create-post-btn"><span>ÌîºÎìú</span></div>
                <div class="action-item" id="open-album-btn"><span>Ïï®Î≤î</span></div>
            </div>
            <div id="qzone-posts-list"></div>
        </div>
    </div>
    <div id="favorites-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="favorites-back-btn">‚Äπ</span>
        <span>ÎÇ¥ Ïª¨Î†âÏÖò</span>
        <span class="action-btn" id="favorites-edit-btn">Ìé∏Ïßë</span>
    </div>
        <div class="search-bar-container">
            <input type="search" id="favorites-search-input" placeholder="Ïª¨Î†âÏÖòÏùò Ï†úÎ™©, ÎÇ¥Ïö© ÎòêÎäî ÏûëÏÑ±Ïûê Í≤ÄÏÉâ...">
            <button id="favorites-search-clear-btn" class="search-clear-btn" style="display: none;">√ó</button>
        </div>

        <div id="favorites-list" class="list-container">
        </div>
<div id="favorites-action-bar" style="display: none;">
    <button id="favorites-delete-selected-btn" class="action-bar-btn">ÏÇ≠Ï†ú (0)</button>
</div>
    </div>
<div id="memories-view" class="chat-list-view">
    <div class="header"> 
        <span class="back-btn" id="memories-back-btn">‚Äπ</span>
        <span>Ïö∞Î¶¨Ïùò Ï∂îÏñµ</span>
            <span class="action-btn" id="add-countdown-btn">+</span>
        </div>
    <div id="memories-list" class="list-container" style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
    </div>
</div>
<div id="chat-list-bottom-nav">
    <div class="nav-item active" data-view="messages-view">
        <span>Î©îÏãúÏßÄ</span>
    </div>
    <div class="nav-item" data-view="qzone-screen">
        <span>ÌîºÎìú</span>
    </div>
    <div class="nav-item" data-view="memories-view">
        <span>Ï∂îÏñµ</span>
    </div>
    <div class="nav-item" data-view="favorites-view">
        <span>Ïª¨Î†âÏÖò</span>
    </div>
</div>
</div>
<div id="album-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="album-back-btn">‚Äπ</span>
        <span>ÎÇ¥ Ïï®Î≤î</span>
        <span class="action-btn" id="create-album-btn-page">+</span>
    </div>
    <div class="list-container">
        <div id="album-grid-page">
        </div>
    </div>
</div>
<div id="album-photos-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="album-photos-back-btn">‚Äπ</span>
        <span id="album-photos-title">Ïï®Î≤î Ïù¥Î¶Ñ</span>
        <span class="action-btn" id="album-upload-photo-btn">ÏóÖÎ°úÎìú</span>
    </div>
    <div class="list-container">
        <div id="photos-grid-page">
        </div>
<div id="photo-viewer-modal" class="modal">
    <button id="photo-viewer-close-btn">√ó</button>
    <button id="photo-viewer-prev-btn" class="nav-arrow">‚Äπ</button>
    <div class="photo-viewer-content">
        <img id="photo-viewer-image" src="" alt="Ï†ÑÏ≤¥ ÌôîÎ©¥ ÏÇ¨ÏßÑ ÎØ∏Î¶¨Î≥¥Í∏∞">
    </div>
    <button id="photo-viewer-next-btn" class="nav-arrow">‚Ä∫</button>
</div>
    </div>
</div>
<input type="file" id="album-photo-input" accept="image/*" multiple hidden>
<div id="chat-interface-screen" class="screen">
    <div class="header">
        <div class="default-controls">
            <span class="back-btn" id="back-to-list-btn">‚Äπ</span>
            <div id="chat-header-title-wrapper">
                <span id="chat-header-title">Ï±ÑÌåÖ ÏÉÅÎåÄ</span>
                <div id="chat-header-status">
                    <span class="status-dot"></span>
                    <span class="status-text">Ïò®ÎùºÏù∏</span>
                </div>
            </div>

            <div class="header-actions">
                <span class="action-btn" id="listen-together-btn" title="Ìï®Íªò Îì£Í∏∞"><img src="https://i.postimg.cc/dV8sdNcx/210-20250618115221.png" alt="Ìï®Íªò Îì£Í∏∞"></span>
                <span class="action-btn" id="chat-settings-btn" title="Ï±ÑÌåÖ ÏÑ§Ï†ï"><img src="https://i.postimg.cc/R04MT1MV/210-20250618115233.png" alt="ÏÑ§Ï†ï"></span>
            </div>
        </div>

        <div class="selection-controls">
            <span id="selection-cancel-btn">Ï∑®ÏÜå</span>
            <span id="selection-count"></span>
            <div class="header-actions">
               <span id="selection-favorite-btn" class="action-btn">Ïª¨Î†âÏÖò</span>
               <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">ÏÇ≠Ï†ú</span>
            </div>
        </div>
    </div>
    
    <div id="chat-messages"><div id="typing-indicator">ÏÉÅÎåÄÎ∞©Ïù¥ ÏûÖÎ†• Ï§ëÏûÖÎãàÎã§...</div></div>

    <div id="chat-input-area">
        <div id="chat-input-actions-top">
            <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="Ïù¥Î™®Ìã∞ÏΩò Ìå®ÎÑê">+</button>
            <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ÏÇ¨ÏßÑ Î≥¥ÎÇ¥Í∏∞"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
            <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
            <button id="transfer-btn" class="chat-action-icon-btn action-button" title="ÏÜ°Í∏à">Ôø•</button>
            <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ÏùåÏÑ± Î≥¥ÎÇ¥Í∏∞"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
<button id="send-waimai-request-btn" class="chat-action-icon-btn action-button" title="Î∞∞Îã¨ ÏöîÏ≤≠ ÏãúÏûë"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></button>
<button id="video-call-btn" class="chat-action-icon-btn action-button" title="ÏòÅÏÉÅ ÌÜµÌôî"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg></button>
<button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="Í∑∏Î£π ÏòÅÏÉÅ ÌÜµÌôî"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></button>
<button id="send-poll-btn" class="chat-action-icon-btn action-button" title="Ìà¨Ìëú ÏãúÏûë"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h10"/><path d="M6 6h.01"/><path d="M8 12h10"/><path d="M6 12h.01"/><path d="M8 18h10"/><path d="M6 18h.01"/></svg></button>
<button id="share-link-btn" class="chat-action-icon-btn action-button" title="ÎßÅÌÅ¨ Í≥µÏú†"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path></svg></button>
        </div>
        <div id="chat-input-main-row">
            <textarea id="chat-input" rows="1" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..."></textarea>
            <div id="input-actions-wrapper">
                <button id="wait-reply-btn" title="ÎãµÏû• Í∏∞Îã§Î¶¨Îäî Ï§ë"><img src="https://i.postimg.cc/2SwjsfZQ/IMG-6913.gif" alt="ÎãµÏû• Í∏∞Îã§Î¶¨Îäî Ï§ë"></button>
                <button id="send-btn" class="action-button">Î≥¥ÎÇ¥Í∏∞</button>
            </div>
        </div>
    </div>
<div id="chat-lock-overlay">
    <div id="chat-lock-content"></div>
</div>
    <div id="sticker-panel">
        <div id="sticker-panel-header">
            <span class="panel-btn" id="close-sticker-panel-btn">Ï∑®ÏÜå</span>
            <span class="title">ÎÇ¥ Ïù¥Î™®Ìã∞ÏΩò</span>
            <div style="display: flex; gap: 10px;">
              <span class="panel-btn" id="add-sticker-btn">Ï∂îÍ∞Ä</span>
              <span class="panel-btn" id="upload-sticker-btn">ÏóÖÎ°úÎìú</span>
            </div>
        </div>
        <div id="sticker-grid"></div>
    </div>
    <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
    <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
    
    <div id="music-player-overlay">
        <div class="music-player-window">
            <span id="music-playlist-btn">‚ò∞</span>
            <div id="music-time-counter">0.0ÏãúÍ∞ÑÏùÑ Ìï®Íªò Îì§ÏóàÏäµÎãàÎã§</div>
            <div id="music-player-song-title">ÎÖ∏ÎûòÎ•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</div>
            <div id="music-player-artist">...</div>
            <div class="music-controls">
                <button id="music-prev-btn">‚óÄ</button>
                <button id="music-play-pause-btn" class="play-pause-btn">‚ñ∂</button>
                <button id="music-next-btn">‚ñ∂</button>
                <button id="music-mode-btn">ÏàúÏÑú</button>
            </div>
            <div class="music-bottom-actions">
                <button id="music-exit-btn">Ìï®Íªò Îì£Í∏∞ Ï¢ÖÎ£å</button>
                <button id="music-return-btn">Ï±ÑÌåÖÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
            </div>
        </div>
    </div>
    
    <div id="music-playlist-panel">
        <div class="playlist-header">
            <span class="panel-btn" id="close-playlist-btn">ÎèåÏïÑÍ∞ÄÍ∏∞</span>
            <span>Ïû¨ÏÉù Î™©Î°ù</span>
            <div>
                <span class="panel-btn" id="add-song-local-btn">Î°úÏª¨</span>
                <span class="panel-btn" id="add-song-url-btn">URL</span>
            </div>
        </div>
        <div class="playlist-body" id="playlist-body"></div>
    </div>
    <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
</div>

<div id="wallpaper-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
        <span>Ïô∏Í¥Ä ÏÑ§Ï†ï</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div id="wallpaper-preview">ÏïÑÎûòÎ•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏóÖÎ°úÎìú</div>
        <button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">Î∞∞Í≤Ω ÌôîÎ©¥ ÏóÖÎ°úÎìú</button>
        <input type="file" id="wallpaper-upload-input" accept="image/*">
        <hr style="width: 80%; opacity: 0.3; margin: 30px 0;">
        <div style="width:100%; text-align: left; margin-bottom: 15px;">
            <label style="font-weight: 500; color: var(--text-secondary);">App ÏïÑÏù¥ÏΩò ÏÑ§Ï†ï</label>
        </div>
        <div id="icon-settings-grid">
        </div>
        <button class="form-button" id="save-wallpaper-btn" style="margin-top: 30px;">Î™®Îì† Î™®Ïñë ÏÑ§Ï†ï Ï†ÄÏû•</button>
    </div>
</div>
<div id="browser-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="browser-back-btn">‚Äπ</span>
        <span id="browser-title"></span>
        <span style="width: 30px;"></span>
    </div>
    <div id="browser-content" class="list-container">
    </div>
</div>

<div id="font-settings-screen" class="screen">
    <div class="header">
        <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
        <span>Í∏ÄÍº¥ ÏÑ§Ï†ï</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="form-container">
        <div class="form-group">
            <label for="font-url-input">Í∏ÄÍº¥ ÌååÏùº URL (.ttf, .otf, .woffÎì±)</label>
            <input type="text" id="font-url-input" placeholder="https://..../font.ttf">
        </div>

        <div class="form-group">
            <label>Ïã§ÏãúÍ∞Ñ ÎØ∏Î¶¨Î≥¥Í∏∞</label>
            <div id="font-preview" style="padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9f9f9;">
                <p style="font-size: 20px; margin: 0 0 10px 0;">ÏïàÎÖïÌïòÏÑ∏Ïöî ÏÑ∏Í≥Ñ Hello World</p>
                <p style="margin: 0;">Ïù¥Í≤ÉÏùÄ Í∏ÄÍº¥ ÎØ∏Î¶¨Î≥¥Í∏∞ Ìö®Í≥ºÏûÖÎãàÎã§,12345.</p>
            </div>
        </div>

        <button class="form-button" id="save-font-btn">Ï†ÄÏû• Î∞è Ï†ÅÏö©</button>
        <button class="form-button form-button-secondary" id="reset-font-btn">Í∏∞Î≥∏ Í∏ÄÍº¥Î°ú Î≥µÏõê</button>
    </div>
</div>

<div id="contact-picker-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="cancel-contact-picker-btn">Ï∑®ÏÜå</span>
        <span>Ïó∞ÎùΩÏ≤ò ÏÑ†ÌÉù</span>
        <span class="save-btn" id="confirm-contact-picker-btn">ÏôÑÎ£å(0)</span>
    </div>
    <div class="list-container" id="contact-picker-list">
    </div>
</div>

<div id="member-management-screen" class="screen">
    <div class="header">
        <span class="back-btn" id="back-from-member-management">‚Äπ</span>
        <span>Í∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨</span>
        <span style="width: 30px;"></span>
    </div>
    <div class="list-container" id="member-management-list">
    </div>
    <div id="member-management-actions">
        <button id="add-existing-contact-btn">ÏπúÍµ¨ Î™©Î°ùÏóêÏÑú Ï∂îÍ∞Ä</button>
        <button id="create-new-member-btn">Í∑∏Î£π ÎÇ¥ ÏÉà Î©§Î≤Ñ ÏÉùÏÑ±</button>
    </div>
</div>

<div id="incoming-call-modal" class="modal">
    <div class="incoming-call-content">
        <img id="caller-avatar" class="caller-avatar" src="">
        <div id="caller-name" class="caller-name"></div>
        <div class="caller-text">ÏòÅÏÉÅ ÌÜµÌôîÏóê Ï¥àÎåÄÌï©ÎãàÎã§</div>
        <div class="incoming-call-actions">
            <div class="action-button-wrapper">
                <button id="decline-call-btn" class="call-action-btn decline"></button>
                <span>Í±∞Ï†à</span>
            </div>
            <div class="action-button-wrapper">
                <button id="accept-call-btn" class="call-action-btn accept"></button>
                <span>Î∞õÍ∏∞</span>
            </div>
        </div>
    </div>
</div>

<div id="video-call-screen" class="screen">
    <div class="video-call-top-bar">
        <span id="call-timer">00:00</span>
    </div>
    
    <div class="video-call-avatar-area">
        <div id="participant-avatars-grid">
        </div>
    </div>

    <div id="video-call-main" class="video-call-main">
    </div>
    
    <div class="video-call-controls">
        <button id="user-speak-btn" class="control-btn speak-btn"></button>
        <button id="hang-up-btn" class="control-btn hangup-btn"></button>
        <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
    </div>
</div>

<div id="outgoing-call-screen" class="screen">
    <div class="outgoing-call-content">
        <img id="outgoing-call-avatar" class="caller-avatar" src="">
        <div id="outgoing-call-name" class="caller-name"></div>
        <div class="caller-text">ÌÜµÌôî Ï§ë...</div>
        <div class="outgoing-call-actions">
            <button id="cancel-call-btn" class="call-action-btn decline"></button>
            <span>Ï∑®ÏÜå</span>
        </div>
    </div>
</div>
        </div>
    </div>
  
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>Ï±ÑÌåÖ ÏÑ§Ï†ï</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">Î≥ÑÎ™Ö / Í∑∏Î£π Ïù¥Î¶Ñ</label><input type="text" id="chat-name-input"></div>
    <div class="form-group" id="assign-group-section" style="display: none;">
        <label for="assign-group-select">ÏπúÍµ¨ Í∑∏Î£π</label>
        <div style="display: flex; align-items: center; gap: 10px;">
            <select id="assign-group-select" style="flex-grow: 1;">
            </select>
            <button id="manage-groups-btn" class="form-button-secondary" style="margin-top: 0; padding: 12px;">Í∑∏Î£π Í¥ÄÎ¶¨</button>
        </div>
    </div>

<div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">ÎÇ¥ Í∑∏Î£π ÎãâÎÑ§ÏûÑ</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>Í∑∏Î£π ÏïÑÎ∞îÌÉÄ</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">Í∑∏Î£π ÏïÑÎ∞îÌÉÄ ÏóÖÎ°úÎìú</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>ÏõîÎìúÏù∏Ìè¨ Ïó∞Í≤∞ (Îã§Ï§ë ÏÑ†ÌÉù Í∞ÄÎä•)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù --</span>
                        <span class="arrow-down">‚ñº</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">ÏÉÅÎåÄÎ∞© ÌéòÎ•¥ÏÜåÎÇò (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>ÏÉÅÎåÄÎ∞© ÏïÑÎ∞îÌÉÄ</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">ÏÉÅÎåÄÎ∞© ÏïÑÎ∞îÌÉÄ ÏóÖÎ°úÎìú</button><button id="manage-ai-avatar-library-btn" class="form-button-secondary" style="margin-top:0; padding: 8px 12px; font-size: 14px;">ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í¥ÄÎ¶¨</button>
<button class="change-frame-btn" data-type="ai">ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑ Î≥ÄÍ≤Ω</button><input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">ÎÇ¥ ÌéòÎ•¥ÏÜåÎÇò (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>ÎÇ¥ ÏïÑÎ∞îÌÉÄ</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">ÎÇ¥ ÏïÑÎ∞îÌÉÄ ÏóÖÎ°úÎìú</button><button class="change-frame-btn" data-type="my">ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑ Î≥ÄÍ≤Ω</button><button id="open-persona-library-btn">ÌîÑÎ¶¨ÏÖã</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>Í∑∏Î£π Î©§Î≤Ñ ÌéòÎ•¥ÏÜåÎÇò</label><div id="group-members-settings"></div>
    
    <button id="manage-members-btn" class="form-button form-button-secondary" style="margin-top: 15px;">Í∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨</button></div>
<div class="form-group"><label for="max-memory">Îß•ÎùΩ Í∏∞Ïñµ Í∞úÏàò</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>Ï±ÑÌåÖ Î≤ÑÎ∏î ÌÖåÎßà <button id="reset-theme-btn" type="button">Ïû¨ÏÑ§Ï†ï</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> Í∏∞Î≥∏</label><label><input type="radio" name="theme-select" value="pink_blue"> Î∂ÑÌôç ÌååÎûë</label><label><input type="radio" name="theme-select" value="blue_white"> ÌååÎûë ÌïòÏñë</label><label><input type="radio" name="theme-select" value="purple_yellow"> Î≥¥Îùº ÎÖ∏Îûë</label><label><input type="radio" name="theme-select" value="black_white"> Í≤ÄÏ†ï ÌïòÏñë</label><label><input type="radio" name="theme-select" value="yellow_white"> ÎÖ∏Îûë ÌïòÏñë</label><label><input type="radio" name="theme-select" value="red_black"> Îπ®Í∞ï Í≤ÄÏ†ï</label><label><input type="radio" name="theme-select" value="blue_yellow"> ÌååÎûë ÎÖ∏Îûë</label><label><input type="radio" name="theme-select" value="pink_yellow"> Î∂ÑÌôç ÎÖ∏Îûë</label><label><input type="radio" name="theme-select" value="pink_purple"> Î∂ÑÌôç Î≥¥Îùº</label><label><input type="radio" name="theme-select" value="gray_white"> ÌöåÏÉâ ÌïòÏñë</label><label><input type="radio" name="theme-select" value="blue_green"> ÌååÎûë Ï¥àÎ°ù</label><label><input type="radio" name="theme-select" value="pink_white"> Î∂ÑÌôç ÌïòÏñë</label><label><input type="radio" name="theme-select" value="pink_black"> Î∂ÑÌôç Í≤ÄÏ†ï</label><label><input type="radio" name="theme-select" value="pink_green"> Î∂ÑÌôç Ï¥àÎ°ù</label><label><input type="radio" name="theme-select" value="green_black"> Ï¥àÎ°ù Í≤ÄÏ†ï</label></div></div>

<div class="form-group">
    <label for="font-size-slider">Ï±ÑÌåÖ Í∏ÄÍº¥ ÌÅ¨Í∏∞ <span id="font-size-value">13px</span></label>
    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13" style="width: 100%; margin-top: 8px;">
</div>

<div class="form-group">
    <label for="custom-css-input">
        ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï Î≤ÑÎ∏î Ïä§ÌÉÄÏùº (CSS)
        <button id="reset-custom-css-btn" type="button" style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">Ïû¨ÏÑ§Ï†ï</button>
    </label>
    <textarea id="custom-css-input" rows="5" style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;" placeholder="/* ÏòàÏãú:Ïóê\"ÎÇ¥\"Î≤ÑÎ∏îÏóê Í∑∏ÎùºÎç∞Ïù¥ÏÖò Î∞∞Í≤ΩÍ≥º Í∑∏Î¶ºÏûê Ï∂îÍ∞Ä */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº Ïù¥ ÏÉà ÏΩîÎìúÎ•º ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï CSS ÏûÖÎ†• ÏÉÅÏûêÏùò formÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî-group Îã§ÏùåÏóê ‚ñº‚ñº‚ñº -->
<div class="form-group">
    <label>Ïã§ÏãúÍ∞Ñ ÎØ∏Î¶¨Î≥¥Í∏∞</label>
    <div id="settings-preview-area">
        <!-- JSÏó¨Í∏∞Ïóê ÎØ∏Î¶¨Î≥¥Í∏∞ ÎÇ¥Ïö©Ïù¥ ÏÉùÏÑ±Îê©ÎãàÎã§ -->
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

            <div class="form-group">
                <label>Ï±ÑÌåÖ Î∞∞Í≤Ω</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</button>
                    <button type="button" id="remove-bg-btn">Î∞∞Í≤Ω Ï†úÍ±∞</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
<hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
<button class="form-button form-button-secondary" id="block-chat-btn" style="background-color: #ff3b30; color: white; border-color: #ff3b30;">ÏÉÅÎåÄÎ∞© Ï∞®Îã®</button>
<button class="form-button form-button-secondary" id="clear-chat-btn">Ï±ÑÌåÖ Í∏∞Î°ù ÏßÄÏö∞Í∏∞</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">Ï∑®ÏÜå</button><button class="save" id="save-chat-settings-btn">Ï†ÄÏû•</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ÎÇ¥ ÌéòÎ•¥ÏÜåÎÇò ÎùºÏù¥Î∏åÎü¨Î¶¨</span><button id="add-persona-preset-btn" class="action-button">Ï∂îÍ∞Ä</button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">Îã´Í∏∞</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">ÌéòÎ•¥ÏÜåÎÇò ÌîÑÎ¶¨ÏÖã Ï∂îÍ∞Ä</span></div><div class="modal-body"><div class="form-group"><label>ÌîÑÎ¶¨ÏÖã ÏïÑÎ∞îÌÉÄ</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">ÏïÑÎ∞îÌÉÄ ÏóÖÎ°úÎìú</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">ÌîÑÎ¶¨ÏÖã ÌéòÎ•¥ÏÜåÎÇò</label><textarea id="preset-persona-input" rows="4" placeholder="Ïù¥ ÌéòÎ•¥ÏÜåÎÇòÏùò ÏûêÏÑ∏Ìïú ÏÑ§Ï†ïÏùÑ Ïó¨Í∏∞Ïóê ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">Ï∑®ÏÜå</button><button class="save" id="save-persona-preset-btn">Ï†ÄÏû•</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>Í∑∏Î£π Î©§Î≤Ñ Ìé∏Ïßë</span></div><div class="modal-body">
    <div class="form-group"><label for="member-name-input">Ïù¥Î¶Ñ</label><input type="text" id="member-name-input"></div>
    <div class="form-group"><label for="member-persona-input">ÌéòÎ•¥ÏÜåÎÇò</label><textarea id="member-persona-input" rows="4"></textarea></div>
    <div class="form-group"><label>ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">ÏïÑÎ∞îÌÉÄ ÏóÖÎ°úÎìú</button><button class="change-frame-btn" data-type="member">ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑ Î≥ÄÍ≤Ω</button><input type="file" id="member-avatar-input" accept="image/*"></div></div>
    </div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">Ï∑®ÏÜå</button><button class="save" id="save-member-settings-btn">Ï†ÄÏû•</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">Ï∑®ÏÜå</button>
                <button id="custom-modal-confirm" class="confirm-btn">ÌôïÏù∏</button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ÌîÑÎ¶¨ÏÖã Ìé∏Ïßë</button>
                <button id="preset-action-delete" class="btn-danger">ÌîÑÎ¶¨ÏÖã ÏÇ≠Ï†ú</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">Ï∑®ÏÜå</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">Í∑∏/Í∑∏ÎÖÄÏóêÍ≤å ÍπúÏßù ÏÑ†Î¨ºÏùÑ!</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">ÏÜ°Í∏à Í∏àÏï°</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">ÎπÑÍ≥† (ÏÑ†ÌÉù ÏÇ¨Ìï≠)</label>
                <input type="text" id="transfer-note" placeholder="ÎãπÏã†Ïùò ÎßàÏùåÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">Ï∑®ÏÜå</button>
                <button id="transfer-confirm-btn">ÏÜ°Í∏à ÌôïÏù∏</button>
            </div>
        </div>
    </div>

 <div id="battery-alert-modal">
    <div class="battery-alert-content">
        <img id="battery-alert-image" src="">
        <p id="battery-alert-text"></p>
    </div>
</div>

<!-- ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑ ÏÑ†ÌÉù Î™®Îã¨ Ï∞Ω (ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú Í≤ÉÏûÖÎãàÎã§) -->
    <div id="avatar-frame-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑ ÏÑ†ÌÉù</span>
            </div>
            <div class="modal-body">
                <div class="frame-tabs">
                    <div id="ai-frame-tab" class="frame-tab active">ÏÉÅÎåÄÎ∞©Ïùò</div>
                    <div id="my-frame-tab" class="frame-tab">ÎÇ¥</div>
                </div>
                <div id="ai-frame-content" class="frame-content">
                    <div id="ai-frame-grid" class="frame-grid">
                        <!-- AIÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                    </div>
                </div>
                <div id="my-frame-content" class="frame-content" style="display: none;">
                     <div id="my-frame-grid" class="frame-grid">
                        <!-- ÎÇ¥ ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-frame-settings-btn">Ï∑®ÏÜå</button>
                <button class="save" id="save-frame-settings-btn">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

<!-- ‚ñº‚ñº‚ñº ÏïÑÎûò ÏΩîÎìúÎ•º ÏÇ¨Ïö©ÌïòÏó¨„ÄêÏ†ÑÏ≤¥„ÄëÎ™®Îã¨ Ï∞Ω ÏΩîÎìúÎ°ú, Í∏∞Ï°¥Ïùò idÎ•º ÎåÄÏ≤¥ÌïòÏÑ∏Ïöî="create-post-modal" Ïùò Ï†ÑÏ≤¥ div ‚ñº‚ñº‚ñº -->
<div id="create-post-modal" class="modal">
    <div class="modal-content" style="height: auto; max-height: 90%;">
        <div class="modal-header">
            <span>Í≤åÏãúÎ¨º Î∞úÌñâ</span>
        </div>
        <div class="modal-body">
            <!-- Í≥µÍ∞ú ÌÖçÏä§Ìä∏ ÏûÖÎ†• ÏòÅÏó≠ -->
            <div class="form-group">
                <textarea id="post-public-text" rows="3" placeholder="ÏÉàÎ°úÏö¥ ÏÜåÏãù Í≥µÏú†...(ÌïÑÏàòÍ∞Ä ÏïÑÎãå Í≥µÍ∞ú ÌÖçÏä§Ìä∏)"></textarea>
            </div>

            <!-- === Î™®Îìú Ï†ÑÌôò Ïä§ÏúÑÏπò (ÏÉàÎ°ú Ï∂îÍ∞Ä) === -->
            <div class="post-mode-switcher">
                <button id="switch-to-image-mode" class="mode-btn active">Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú</button>
                <button id="switch-to-text-image-mode" class="mode-btn">ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©</button>
            </div>

<!-- ‚ñº‚ñº‚ñº „ÄêÏàòÏ†ï ÌõÑ„ÄëÏùò Í≥µÍ∞ú Î≤îÏúÑ ÏÑ§Ï†ï ‚ñº‚ñº‚ñº -->
<div class="form-group">
    <label>Í≥µÍ∞ú Î≤îÏúÑ</label>
    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
        <label><input type="radio" name="visibility" value="public" checked> Í≥µÍ∞ú</label>

        <label><input type="radio" name="visibility" value="include"> ÌäπÏ†ï Í∑∏Î£π Í≥µÍ∞ú</label>
    </div>
    <div id="post-visibility-groups" style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
        <!-- Í∑∏Î£π Îã§Ï§ë ÏÑ†ÌÉù ÏÉÅÏûêÎäî JSÏóê ÏùòÌï¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏàòÏ†ï ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

            <!-- === Ïù¥ÎØ∏ÏßÄ Î™®Îìú ÏòÅÏó≠ === -->
            <div id="image-mode-content" class="post-mode-content active">
                <div class="form-group">
<div id="post-image-preview-container" class="post-image-preview-container">
                        <img id="post-image-preview" src="" alt="Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞">
                        <button id="post-remove-image-btn">√ó</button>
                    </div>
                    <div class="post-image-upload-options">
                        <button id="post-upload-local-btn" class="form-button-secondary">Î°úÏª¨ ÏóÖÎ°úÎìú</button>
                        <button id="post-use-url-btn" class="form-button-secondary">ÎÑ§Ìä∏ÏõåÌÅ¨ URL</button>
                        <input type="file" id="post-local-image-input" accept="image/*" hidden>
                    </div>
                </div>
                <div id="post-image-desc-group" class="form-group" style="display: none;">
                    <label>Ïù¥ÎØ∏ÏßÄ ÏÑ§Î™Ö (ÌïÑÏàò ÏûÖÎ†•, AIÏóêÍ≤å Î≥¥Ïó¨Ï§Ñ ÎÇ¥Ïö©)</label>
                    <input type="text" id="post-image-description" placeholder="Ïù¥ÎØ∏ÏßÄ ÎÇ¥Ïö©ÏùÑ Í∞ÑÎã®Ìûà ÏÑ§Î™ÖÌïòÏó¨ AIÍ∞Ä Ïù¥Ìï¥ÌïòÎèÑÎ°ù ÎèïÏäµÎãàÎã§.">
                </div>
            </div>

            <!-- === ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ Î™®Îìú ÏòÅÏó≠ (ÏÉàÎ°ú Ï∂îÍ∞Ä) === -->
            <div id="text-image-mode-content" class="post-mode-content">
                <div class="form-group">
                    <label>ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ (AIÍ∞Ä Ïù¥Ìï¥ÌïòÎäî Îç∞ ÏÇ¨Ïö©ÎêòÎäî ÏÑ§Î™Ö, Ïù¥ÎØ∏ÏßÄÎ•º ÌÅ¥Î¶≠ÌïòÎ©¥ Î≥º Ïàò ÏûàÏäµÎãàÎã§.)</label>
                    <textarea id="post-hidden-text" rows="4" placeholder="Ïó¨Í∏∞Ïóê Ïù¥ÎØ∏ÏßÄ ÏÑ§Î™ÖÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî..."></textarea>
                </div>
            </div>

        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-post-btn">Ï∑®ÏÜå</button>
            <button class="save" id="confirm-create-post-btn">Í≤åÏãú</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº Ïù¥ ÏÉàÎ°úÏö¥ Î™®Îã¨ HTMLÏùÑ Îã§Î•∏ Î™®Îì† Î™®Îã¨ Îí§Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº -->
<div id="group-management-modal" class="modal">
    <div class="modal-content" style="height: 60%;">
        <div class="modal-header">
            <span>ÏπúÍµ¨ Í∑∏Î£π Í¥ÄÎ¶¨</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>ÏÉà Í∑∏Î£π ÎßåÎì§Í∏∞</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="new-group-name-input" placeholder="Í∑∏Î£π Ïù¥Î¶Ñ ÏûÖÎ†•..." style="flex-grow: 1;">
                    <button id="add-new-group-btn" class="form-button" style="width: auto; margin-top: 0; padding: 0 15px;">Ï∂îÍ∞Ä</button>
                </div>
            </div>
            <hr style="opacity: 0.2;">
            <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Í∑∏Î£π Î™©Î°ùÏùÄ JSÏóê ÏùòÌï¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-group-manager-btn" style="width: 100%;">ÏôÑÎ£å</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº Ïù¥ ÏÉàÎ°úÏö¥ HTMLÏùÑ Î™®Îì† Î™®Îã¨ ÎÅùÏóê Î∂ôÏó¨ÎÑ£ÏúºÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº -->
<div id="message-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <!-- ÏÉàÎ°úÏö¥ ÏûëÏóÖ Î≤ÑÌäº -->
            <button id="edit-message-btn">Î©îÏãúÏßÄ Ìé∏Ïßë</button>
            <button id="copy-message-btn">ÌÖçÏä§Ìä∏ Î≥µÏÇ¨</button>
            <button id="select-message-btn">Îã§Ï§ë ÏÑ†ÌÉù Î™®Îìú</button>
            <!-- Ï∑®ÏÜå Î≤ÑÌäº -->
            <button id="cancel-message-action-btn" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº Ïù¥ ÏÉàÎ°úÏö¥ HTMLÏùÑ Î™®Îì† Î™®Îã¨ ÎÅùÏóê Î∂ôÏó¨ÎÑ£ÏúºÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº -->
<div id="post-actions-modal" class="modal">
    <div id="custom-modal" style="width: 250px;">
        <div class="custom-modal-footer">
            <button id="edit-post-btn">Í≤åÏãúÎ¨º Ìé∏Ïßë</button>
            <button id="copy-post-btn">ÎÇ¥Ïö© Î≥µÏÇ¨</button>           
            <button id="cancel-post-action-btn">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÏãúÍ∞ÅÏ†Å Î©îÏãúÏßÄ Ìé∏ÏßëÍ∏∞ Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="message-editor-modal" class="modal">
    <div class="modal-content" style="height: 75%;">
        <div class="modal-header">
            <span>Î©îÏãúÏßÄ Ìé∏Ïßë Î∞è Î∂ÑÌï†</span>
        </div>
        <div class="modal-body" id="message-editor-body">
            <!-- Ìé∏ÏßëÍ∏∞ Ïª®ÌÖåÏù¥ÎÑà, JSÍ∞Ä Ïó¨Í∏∞Ïóê ÌÖçÏä§Ìä∏ ÏÉÅÏûêÎ•º ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Ìï©ÎãàÎã§ -->
            <div id="message-editor-container"></div>
            <!-- ÏÉà Î©îÏãúÏßÄ Ï∂îÍ∞Ä Î≤ÑÌäº -->
            <button id="add-message-editor-block-btn" class="form-button form-button-secondary" style="margin-top: 15px;">
                [+] Îã§Ïùå Î©îÏãúÏßÄ Ï∂îÍ∞Ä
            </button>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-advanced-editor-btn">Ï∑®ÏÜå</button>
            <button class="save" id="save-advanced-editor-btn">Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ Ï†ÄÏû•</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÎ∞∞Îã¨ ÏöîÏ≤≠ Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="waimai-request-modal" class="modal">
    <div class="modal-content" style="width: 290px;">
        <div class="modal-header">
            <span>Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="waimai-product-info">ÏÉÅÌíà Ï†ïÎ≥¥</label>
                <input type="text" id="waimai-product-info" placeholder="ÏòàÏãú:ÏñëÏßÄÍ∞ÑÎ°ú Ìïú Ïûî">
            </div>
            <div class="form-group">
                <label for="waimai-amount">ÎåÄÎ¶¨ Í≤∞Ï†ú Í∏àÏï° (Ïõê)</label>
                <input type="number" id="waimai-amount" placeholder="ÏòàÏãú:21" min="0" step="0.01">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="waimai-cancel-btn">Ï∑®ÏÜå</button>
            <button class="save" id="waimai-confirm-btn">ÏöîÏ≤≠ ÏãúÏûë</button>
        </div>
    </div>
</div>

<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÏÉàÎ°úÏö¥ ÏïΩÏÜç ÎßåÎì§Í∏∞/Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="create-countdown-modal" class="modal">
    <div class="modal-content" style="height: auto;">
        <div class="modal-header">
            <span>ÏÉàÎ°úÏö¥ ÏïΩÏÜç ÎßåÎì§Í∏∞</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="countdown-title-input">ÏïΩÏÜç Ï†úÎ™©</label>
                <input type="text" id="countdown-title-input" placeholder="ÏòàÏãú:ÎÇ¥ ÏÉùÏùº">
            </div>
            <div class="form-group">
                <label for="countdown-date-input">ÏïΩÏÜç ÎÇ†Ïßú Î∞è ÏãúÍ∞Ñ</label>
                <input type="datetime-local" id="countdown-date-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-countdown-btn">Ï∑®ÏÜå</button>
            <button class="save" id="confirm-create-countdown-btn">ÏïΩÏÜç Ï†ÄÏû•</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÎπ®Í∞Ñ Î¥âÌà¨ Î≥¥ÎÇ¥Í∏∞ Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="red-packet-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>Îπ®Í∞Ñ Î¥âÌà¨ Î≥¥ÎÇ¥Í∏∞</span>
        </div>
        <div class="modal-body" style="padding: 0;">
            <!-- 1. ÌÉ≠ Ï†ÑÌôò -->
            <div class="frame-tabs">
                <div id="rp-tab-group" class="frame-tab active">Î¨¥ÏûëÏúÑ Í∏àÏï° Îπ®Í∞Ñ Î¥âÌà¨</div>
                <div id="rp-tab-direct" class="frame-tab">Ï†ÑÏö© Îπ®Í∞Ñ Î¥âÌà¨</div>
            </div>

            <!-- 2. Î¨¥ÏûëÏúÑ Í∏àÏï° Îπ®Í∞Ñ Î¥âÌà¨ ÎÇ¥Ïö© ÏòÅÏó≠ -->
            <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                <div class="form-group">
                    <label>Ï¥ù Í∏àÏï° (Ïõê)</label>
                    <input type="number" id="rp-group-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Îπ®Í∞Ñ Î¥âÌà¨ Í∞úÏàò</label>
                    <input type="number" id="rp-group-count" placeholder="Îπ®Í∞Ñ Î¥âÌà¨ Í∞úÏàò ÏûÖÎ†•">
                </div>
                <div class="form-group">
                    <label>Ï∂ïÌïò Î©îÏãúÏßÄ</label>
                    <input type="text" id="rp-group-greeting" placeholder="Î∂ÄÏûê ÎêòÏÑ∏Ïöî, ÎßåÏÇ¨ÌòïÌÜµÌïòÏÑ∏Ïöî!">
                </div>
                <p id="rp-group-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p>
                <button id="send-group-packet-btn" class="form-button">Îπ®Í∞Ñ Î¥âÌà¨Ïóê Îèà ÎÑ£Í∏∞</button>
            </div>

            <!-- 3. Ï†ÑÏö© Îπ®Í∞Ñ Î¥âÌà¨ ÎÇ¥Ïö© ÏòÅÏó≠ -->
            <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                <div class="form-group">
                    <label>Î≥¥ÎÇ¥Í∏∞</label>
                    <select id="rp-direct-receiver"></select>
                </div>
                <div class="form-group">
                    <label>Í∏àÏï° (Ïõê)</label>
                    <input type="number" id="rp-direct-amount" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Ï∂ïÌïò Î©îÏãúÏßÄ</label>
                    <input type="text" id="rp-direct-greeting" placeholder="Î∂ÄÏûê ÎêòÏÑ∏Ïöî, ÎßåÏÇ¨ÌòïÌÜµÌïòÏÑ∏Ïöî!">
                </div>
                 <p id="rp-direct-total" style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p>
                <button id="send-direct-packet-btn" class="form-button">Îπ®Í∞Ñ Î¥âÌà¨Ïóê Îèà ÎÑ£Í∏∞</button>
            </div>
        </div>
        <div class="modal-footer" style="justify-content: center;">
             <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">Ï∑®ÏÜå</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÎπ®Í∞Ñ Î¥âÌà¨ ÏÉÅÏÑ∏ Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="red-packet-details-modal" class="modal">
    <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
        <div class="modal-header" style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
            <div style="text-align: center; width: 100%;">
                <div id="rp-details-sender" style="font-size: 16px;"></div>
                <div style="font-size: 13px; opacity: 0.8;">Ïùò Îπ®Í∞Ñ Î¥âÌà¨</div>
            </div>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <p id="rp-details-greeting" style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
            <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                <span style="font-size: 18px; color: #E44D44;">Ïõê</span>
            </div>
            <div id="rp-details-summary" style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
            <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                <!-- ÏàòÎ†π ÎÇ¥Ïó≠ÏùÄ JSÏóê ÏùòÌï¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-rp-details-btn" style="width: 100%;">Îã´Í∏∞</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->
<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÌà¨Ìëú ÎßåÎì§Í∏∞ Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="create-poll-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>Ìà¨Ìëú ÏãúÏûë</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="poll-question-input">Ìà¨Ìëú Î¨∏Ï†ú</label>
                <textarea id="poll-question-input" rows="2" placeholder="ÏòàÏãú:Ïò§Îäò Î∞§ Ïö∞Î¶¨ Î¨¥Ïä® ÏòÅÌôî Î≥ºÍπå?"></textarea>
            </div>
            <div class="form-group">
                <label>Ìà¨Ìëú ÏòµÏÖò (ÏµúÏÜå 2Í∞ú)</label>
                <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                    <!-- Ìà¨Ìëú ÏòµÏÖòÏùÄ JSÏóê ÏùòÌï¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </div>
                <button id="add-poll-option-btn" class="form-button form-button-secondary" style="margin-top: 12px;">+ ÏòµÏÖò Ï∂îÍ∞Ä</button>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-create-poll-btn">Ï∑®ÏÜå</button>
            <button class="save" id="confirm-create-poll-btn">Ìà¨Ìëú ÏãúÏûë</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëAIÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="ai-avatar-library-modal" class="modal">
    <div class="modal-content" style="height: 70%;">
        <div class="modal-header">
            <span id="ai-avatar-library-title">ÏÉÅÎåÄÎ∞©Ïùò ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨</span>
            <button id="add-ai-avatar-btn" class="action-button">Ï∂îÍ∞Ä</button>
        </div>
        <div class="modal-body" style="padding: 15px;">
            <div id="ai-avatar-library-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px;">
                <!-- ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎÇ¥Ïö©ÏùÄ JSÏóê ÏùòÌï¥ ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
        </div>
        <div class="modal-footer">
            <button class="save" id="close-ai-avatar-library-btn" style="width: 100%;">Îã´Í∏∞</button>
        </div>
    </div>
</div>

<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<!-- ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÏÇ¨Ïö©Ïûê ÎßÅÌÅ¨ Í≥µÏú† Î™®Îã¨ ‚ñº‚ñº‚ñº -->
<div id="share-link-modal" class="modal">
    <div class="modal-content" style="width: 300px; height: auto;">
        <div class="modal-header">
            <span>ÎßÅÌÅ¨ Í≥µÏú†</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="link-title-input">Ï†úÎ™©</label>
                <input type="text" id="link-title-input" placeholder="Í≤åÏãúÎ¨º ÎòêÎäî ÎßÅÌÅ¨ Ï†úÎ™© ÏûÖÎ†•">
            </div>
            <div class="form-group">
                <label for="link-description-input">ÏöîÏïΩ (ÏÑ†ÌÉù ÏÇ¨Ìï≠)</label>
                <textarea id="link-description-input" rows="2" placeholder="ÎßÅÌÅ¨ ÎÇ¥Ïö©ÏùÑ Í∞ÑÎã®Ìûà ÏÑ§Î™Ö"></textarea>
            </div>
            <div class="form-group">
                <label for="link-source-input">Ï∂úÏ≤ò Ïù¥Î¶Ñ (ÏÑ†ÌÉù ÏÇ¨Ìï≠)</label>
                <input type="text" id="link-source-input" placeholder="ÏòàÏãú:Ï¶àÌõÑ ÏùºÎ≥¥, ÎπåÎ¶¨ÎπåÎ¶¨">
            </div>
            <div class="form-group">
                <label for="link-content-input">Ï†ÑÏ≤¥ ÎÇ¥Ïö© (ÏÑ†ÌÉù ÏÇ¨Ìï≠, Î∏åÎùºÏö∞Ï†Ä ÎÇ¥ ÌëúÏãúÏö©)</label>
                <textarea id="link-content-input" rows="4" placeholder="Ï†ÑÏ≤¥ Í≤åÏãúÎ¨º ÎÇ¥Ïö© Î∂ôÏó¨ÎÑ£Í∏∞ ÎòêÎäî ÏûÖÎ†•"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="cancel" id="cancel-share-link-btn">Ï∑®ÏÜå</button>
            <button class="save" id="confirm-share-link-btn">Í≥µÏú†</button>
        </div>
    </div>
</div>
<!-- ‚ñ≤‚ñ≤‚ñ≤ ÏÉà HTML Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤ -->

<script>
    document.addEventListener('DOMContentLoaded', () => {

        // ===================================================================
        // 1. Î™®Îì† Î≥ÄÏàò Î∞è ÏÉÅÏàò Ï†ïÏùò
        // ===================================================================
        const db = new Dexie('GeminiChatDB');
        // --- ÏàòÏ†ï ÏôÑÎ£å ---
        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
        // --- ÏàòÏ†ï ÎÅù ---
        let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, playMode: 'order', totalElapsedTime: 0, timerId: null };
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingFrameForMember = false;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;

let waimaiTimers = {}; // Î∞∞Îã¨ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ï†ÄÏû•Ïö©

let activeMessageTimestamp = null;
let activePostId = null; // <-- ÏÉàÎ°ú Ï∂îÍ∞Ä:ÌòÑÏû¨ ÏûëÏóÖ Ï§ëÏù∏ Í≤åÏãúÎ¨º ID Ï†ÄÏû•Ïö©

        let photoViewerState = {
            isOpen: false,
            photos: [], // ÌòÑÏû¨ Ïï®Î≤îÏùò Î™®Îì† ÏÇ¨ÏßÑ URL Ï†ÄÏû•
            currentIndex: -1, // ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎäî ÏÇ¨ÏßÑ Ïù∏Îç±Ïä§
        };

        let unreadPostsCount = 0;

        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set()

let simulationIntervalId = null;

const frameModal = document.getElementById('avatar-frame-modal');
const aiFrameTab = document.getElementById('ai-frame-tab');
const myFrameTab = document.getElementById('my-frame-tab');
const aiFrameContent = document.getElementById('ai-frame-content');
const myFrameContent = document.getElementById('my-frame-content');
const aiFrameGrid = document.getElementById('ai-frame-grid');
const myFrameGrid = document.getElementById('my-frame-grid');

        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;

// ‚ñº‚ñº‚ñº JS ÏÉÅÎã® Î≥ÄÏàò Ï†ïÏùò ÏòÅÏó≠Ïóê Ïù¥ ÏÉà ÏÉÅÏàò Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
const DEFAULT_APP_ICONS = {
    'world-book': 'https://i.postimg.cc/mZ0vV6tT/IMG-6907.jpg',
    'qq': 'https://i.postimg.cc/gJ7Dz5fj/IMG-6906.jpg',
    'api-settings': 'https://i.postimg.cc/RhnTNdBR/IMG-6908.jpg',
    'wallpaper': 'https://i.postimg.cc/WbgQy6kg/IMG-6909.jpg',
    'font': 'https://files.catbox.moe/j1kn1a.jpeg'
};
// ‚ñ≤‚ñ≤‚ñ≤ Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

        const avatarFrames = [ { id: 'none', url: '', name: 'ÏóÜÏùå' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/fLDnz5Pn/IMG-5574.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/HxH3cNHz/IMG-6871.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/jCVK0fGL/IMG-6890.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/85Zsyjwn/IMG-6895.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cJtpZCB3/IMG-6894.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/63sDQKMm/IMG-6893.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/cHQPgzj4/IMG-6888.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/dVLXm3Xf/IMG-6885.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/kGsZwbq0/IMG-6886.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/63NmX03s/IMG-4366.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/zvz2LGK0/IMG-4367.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/prsGKMBx/IMG-4370.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/gk0BmrY0/IMG-4371.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/fRt2SFSn/IMG-4368.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/kGgwJhPH/IMG-4374.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/PrcKH436/IMG-4376.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fRV86FMq/IMG-4381.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/HsyqMVyk/IMG-4385.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/qBbKK7dS/IMG-4386.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/05wnd389/IMG-4388.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/RZNLhbbr/IMG-4389.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/fLTc42dg/IMG-4391.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/FzbGNdRT/IMG-4392.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/XY63sTS3/IMG-4393.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Cx9vCVWH/IMG-4395.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/kMfPQBwQ/IMG-4396.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/CLrZQMMD/IMG-4398.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/L4zwDhTC/IMG-4399.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/yN3s8szM/IMG-4400.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/59Cn1tkB/IMG-4401.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/g0s1V0PX/IMG-4402.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/Jn1DFPgY/IMG-4403.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/q7cQnDy1/IMG-4404.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/RFK3q2t0/IMG-4407.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gcV0VR2t/IMG-4408.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/W1CjLb4J/IMG-4409.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Ss7pM6fW/IMG-4410.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nrFfYX3N/IMG-4412.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/cHWp0KG6/IMG-4413.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/4yNjHrdg/IMG-4414.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/hPX5F8Qp/IMG-4415.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/vHCSG1WM/IMG-4416.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/x1Hp80Rm/IMG-4417.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/FHRcCGfH/IMG-4418.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/13hhJ77p/IMG-4419.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/J4WCQd2j/IMG-4420.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dydkpd9H/IMG-4421.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/mrkvDxPW/IMG-4422.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/76Tj3g1B/IMG-4425.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/3N5Vndn3/IMG-4426.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/05DLr0yj/IMG-4427.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/GhR6DT4Q/IMG-4428.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fRTF24jS/IMG-4430.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/R0WYmcYM/IMG-4431.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/nrJSqNhz/IMG-4432.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/tC9mJ0cv/IMG-4438.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/XNkQTHvf/IMG-5561.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/Mpv5fzm5/IMG-4439.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/T1tjhsyB/IMG-4720.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/c4JMPd2W/IMG-4724.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/g2XykNGB/IMG-4727.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/y8MmJcd6/IMG-4728.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/Lsjzj5Yt/IMG-4729.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/bNdk33SN/IMG-4893.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/4x9tTy1D/IMG-5563.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/DZshzKv6/IMG-5576.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Fsvr71JL/IMG-5573.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Fz3HwLk9/IMG-5569.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/wjH180kn/IMG-5566.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/MG6qtLYK/IMG-5565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/CKgDNYVb/IMG-5577.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/hj4dkrvj/IMG-5578.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/C5XnfpNB/IMG-5579.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/4y7mGFgJ/IMG-5716.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/FzM1Hgr0/IMG-5717.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/rF4KYbjj/IMG-5720.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/6pLTBvDG/IMG-5721.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/VNK6Ccsf/IMG-5722.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/wx72fhr2/IMG-5968.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/QdrqdvdY/IMG-5969.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/0yd0MZ6k/IMG-5971.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/1zmcp66p/IMG-5973.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/wBw5Fvcn/IMG-5974.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/R0pfKYvB/IMG-5976.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/9fQZ425b/IMG-5975.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/v8V9xXjJ/IMG-6137.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/WbmkXzsS/IMG-6138.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/Dw2bDhZh/IMG-6140.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/ZqQBCyLY/IMG-6144.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/qRCtnMms/IMG-6145.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/1Rwn3XVP/IMG-6146.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Kv51tW5H/IMG-6147.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nhcC21Rc/IMG-6148.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/fTWzQRx8/IMG-6149.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/LXyyqDbY/IMG-6294.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/7Zgm1wRy/IMG-6295.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/5tbpnDcQ/IMG-6296.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSRRV8kn/IMG-6297.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k45sd8gn/IMG-6375.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/50k390X8/IMG-6376.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/90RBDh9K/IMG-6377.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/cCpBYbMH/IMG-6552.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Pf9g2fSL/IMG-6554.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/gkhf597g/IMG-6555.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/g2PfbSFm/IMG-6556.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/pLY3WfR8/IMG-6557.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/65Cmcr7S/IMG-6559.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Y94XWYKd/IMG-6560.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/ydwLXx7s/IMG-6562.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/G3y73Fj2/IMG-6563.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/TYvkKKkc/IMG-6565.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/GmcqjZn8/IMG-6566.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/k5Gs0K47/IMG-6567.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/XJy8JWdh/IMG-6568.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/fycfcvHf/IMG-6569.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/J7ZxC11H/IMG-6570.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/hPnrSHjy/IMG-4434.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/YqxxjbLp/IMG-6572.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/wjfcQMkZ/IMG-6573.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/Vv8jkCYr/IMG-6574.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/MZ77rdDy/IMG-6850.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/T3NvqJCZ/IMG-6851.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/28TsrxRV/IMG-6852.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/VkV2bLNw/IMG-6853.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/gJ95NSRB/IMG-6854.gif', name: '14' }, { id: 'frame_cat_ear', url: 'https://i.postimg.cc/d1qsQsbQ/IMG-6855.gif', name: '1' }, { id: 'frame_ribbon', url: 'https://i.postimg.cc/gJNYx9pV/IMG-6856.gif', name: '2' }, { id: 'frame_flower', url: 'https://i.postimg.cc/fyPDvxJk/IMG-6860.gif', name: '3' }, { id: 'frame_tech', url: 'https://i.postimg.cc/QMDsSNxg/IMG-6861.gif', name: '4' }, { id: 'frame_5', url: 'https://i.postimg.cc/vBqsQW7X/IMG-6858.gif', name: '5' }, { id: 'frame_6', url: 'https://i.postimg.cc/Y0vwjhb7/IMG-6857.gif', name: '6' }, { id: 'frame_7', url: 'https://i.postimg.cc/90sH9Cn7/IMG-6868.gif', name: '7' }, { id: 'frame_8', url: 'https://i.postimg.cc/Y2PHZzCC/IMG-6866.gif', name: '8' }, { id: 'frame_9', url: 'https://i.postimg.cc/7Z8yYP7v/IMG-6889.gif', name: '9' }, { id: 'frame_10', url: 'https://i.postimg.cc/nryNzTXK/IMG-6915.gif', name: '10' }, { id: 'frame_11', url: 'https://i.postimg.cc/Qx5dqyJ3/IMG-6917.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/Wbr0JSDD/IMG-5316.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/tgR6wjBP/IMG-5570.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/d0WCKxff/IMG-6932.gif', name: '14' }, { id: 'frame_11', url: 'https://i.postimg.cc/Ss3znzk7/IMG-6934.gif', name: '11' }, { id: 'frame_12', url: 'https://i.postimg.cc/nrm9BcL8/IMG-6941.gif', name: '12' }, { id: 'frame_13', url: 'https://i.postimg.cc/ZYvd1jxf/IMG-6937.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/sDFhySn3/IMG-6936.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/43PhvxRq/IMG-6922.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/3Rb46fRZ/IMG-6923.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/PJppkbvn/IMG-6918.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/XqRZNZ9G/IMG-6916.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/RVt6sRzc/IMG-6939.gif', name: '14' }, { id: 'frame_13', url: 'https://i.postimg.cc/mgGc0HbK/IMG-6926.gif', name: '13' }, { id: 'frame_14', url: 'https://i.postimg.cc/P5zLh5JJ/IMG-6942.gif', name: '14' }, { id: 'frame_14', url: 'https://i.postimg.cc/xCqqKGRN/IMG-6929.gif', name: '14' },
      { id: 'frame_12', url: 'https://i.postimg.cc/7LSRp4hx/e7fa949b9pc84cff0dabe57defceb54c.gif', name: '12' },
    { id: 'frame_13', url: 'https://i.postimg.cc/DZgMwc1H/817178fdbpf2ff7740dc98e26ab78759.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3NffgJSZ/e09c07034ld7e62266c0a5de6a36ae62.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/vHDNGfT2/35ac7f372v588bf48d4f659077196b85.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/KvVsjjgG/3c3aa5219s18b90187ef1f54b3db7ba8.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/k5P1NHcL/55f3e31d8qbc8a02d152b07b99d31567.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/FFCTCzpy/641bad3b3udc599fdb63ca75fde427e5.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/8k7YSLjK/1689aa46aqc4b9ffc0f970e668f56537.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/J0CZSwyW/IMG-6938.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Df1qLzDf/IMG-6927.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/CLNkrQSW/IMG-6925.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/y8p9s3Jj/IMG-6919.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/Lsr1Zd3Z/IMG-6928.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/Ssgbv41n/IMG-6876.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/SNByPrf9/IMG-7005.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/Z5nrCyS5/IMG-7006.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mDfMXXFP/IMG-7007.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/DZrGtrqB/IMG-7008.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/ZnJNZWHZ/IMG-7009.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/RhGH0vpt/IMG-7010.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/tRzPkzRg/IMG-7012.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/wTTNGs3Q/IMG-7013.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/3JSG5Jv5/IMG-7014.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/rwDr8X1d/IMG-7015.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/DzDy2vS7/IMG-7017.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/QMVdG9x6/IMG-7016.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mZ9hgH3J/IMG-7019.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/t4ksHGdg/IMG-7020.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/hP9JpdfT/IMG-7023.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/wTKyXVT9/IMG-7024.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/ZqjKXPSv/IMG-7025.gif', name: '14' },

  { id: 'frame_14', url: 'https://i.postimg.cc/gj3Tmqz5/mmexport1751030241029.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/4yCXW52F/mmexport1751030908335.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/VkXngG72/mmexport1751031208329.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/LscBkxZb/mmexport1751017556565.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/1XqzGKwJ/mmexport1751018282681.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8kHCQwbQ/mmexport1751020645824.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/HWynLK7f/mmexport1751021724230.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/JnwFp3Kx/mmexport1751031208329.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/HLZNWkQw/mmexport1751031767634.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/vH2X6N1y/mmexport1751032231179.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/NFS4ZyvM/mmexport1751032686953.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/3RpmWc8c/mmexport1751033102811.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/L5RLr3tg/mmexport1751035976943.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/4NCPsp5d/mmexport1751034427637.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/CMv02LHm/mmexport1751034842120.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/rFnSzWGx/mmexport1751035618517.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/7YRbzN51/mmexport1751036276038.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/cJpbtPWq/mmexport1751036607799.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/HxLV5v92/mmexport1751036977582.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/D01rYy86/mmexport1751037965259.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/J4fwkTLW/mmexport1751038167142.gif', name: '14' },
  
  
{ id: 'frame_14', url: 'https://i.postimg.cc/xjpN4swz/IMG-7240.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/ZnzbGdxX/IMG-7239.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/DyYDmKtw/IMG-7238.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/W40f9qtd/IMG-7098.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/8PsK20jQ/IMG-7236.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/cHsTXDVz/IMG-7235.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/sXwm8Yzg/IMG-7234.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/xTk5xN49/IMG-7233.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/k5yv6QBv/IMG-7232.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/yx2m4nbs/IMG-7231.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/vZt0fFKn/IMB-r-HMBXY.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/pddJj9zN/IMG-7094.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/rmB17Qbc/IMB-f-VDf-Fc.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/VkKjzYTK/IMB-f4kk-CT.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/B6KD52vz/IMG-7096.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/9XPwWmwy/IMB-Kf7um-P.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/mrFhKBGz/IMB-e-QWBpa.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/bw4wxW2z/IMB-16r-COL.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/3x0Kx1fz/IMB-K1u-Jp-P.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/CLz0cJ0d/IMG-7116.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/fyyGgW61/IMG-7115.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/gkk7s0vD/IMG-6984.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/0NpZPgYj/IMG-6985.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/tTWKKmTN/IMG-7073.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/jS8tc9wW/IMG-7083.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/rmRVKJpD/IMG-7087.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/zvWGPjms/IMG-7090.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif', name: '14' },
{ id: 'frame_14', url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif', name: '14' },
  { id: 'frame_13', url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif', name: '13' },
    { id: 'frame_14', url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif', name: '14' },
  { id: 'frame_14', url: 'https://i.postimg.cc/jCVMQsKH/IMG-7114.gif', name: '14' },
  
  ];

        let currentFrameSelection = { ai: null, my: null };
        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        const dynamicFontStyle = document.createElement('style');
        dynamicFontStyle.id = 'dynamic-font-style';
        document.head.appendChild(dynamicFontStyle);

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'ÌôïÏù∏';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'ÌôïÏù∏';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'ÌôïÏù∏';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÍ∏∞Îä• Í∞ïÌôî Î≤ÑÏ†Ñ„ÄëÏù¥Ï†Ñ showCustomPrompt Ìï®ÏàòÎ•º ÎåÄÏ≤¥ÌïòÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº
function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
    return new Promise(resolve => {
        modalResolve = resolve;
        modalTitle.textContent = title;
        const inputId = 'custom-prompt-input';
        
        const inputHtml = type === 'textarea' 
            ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
            : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏ∂îÍ∞Ä HTMLÍ≥º ÏûÖÎ†•ÎûÄÏùÑ Ìï®Íªò Ï°∞Ìï©Ìï©ÎãàÎã§
        modalBody.innerHTML = extraHtml + inputHtml;
        const input = document.getElementById(inputId);

        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÑúÏãù ÎèÑÏö∞ÎØ∏ Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
        modalBody.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const templateStr = btn.dataset.template;
                if (templateStr) {
                    try {
                        const templateObj = JSON.parse(templateStr);
                        // null, 2 ÌååÎùºÎØ∏ÌÑ∞Î•º ÏÇ¨Ïö©ÌïòÏó¨ JSON Î¨∏ÏûêÏó¥ÏùÑ Îì§Ïó¨Ïì∞Í∏∞ÌïòÏó¨ ÏÑúÏãù ÏßÄÏ†ïÌïòÍ≥† Îçî ÏùΩÍ∏∞ ÏâΩÍ≤å ÎßåÎì≠ÎãàÎã§
                        input.value = JSON.stringify(templateObj, null, 2);
                        input.focus();
                    } catch(e) {
                        console.error("ÏÑúÏãù ÌÖúÌîåÎ¶ø Íµ¨Î¨∏ Î∂ÑÏÑù Ïã§Ìå®:", e);
                    }
                }
            });
        });
        
        modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
        modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
        showCustomModal();
        setTimeout(() => input.focus(), 100);
    });
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        // ===================================================================
        // 2. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Íµ¨Ï°∞ Ï†ïÏùò
        // ===================================================================

db.version(20).stores({ 
    chats: '&id, isGroup, groupId', 
    apiConfig: '&id', 
    globalSettings: '&id', 
    userStickers: '&id, url, name',
    worldBooks: '&id, name',
    musicLibrary: '&id', 
    personaPresets: '&id',
    qzoneSettings: '&id',
    qzonePosts: '++id, timestamp', 
    qzoneAlbums: '++id, name, createdAt',
    qzonePhotos: '++id, albumId',
    favorites: '++id, type, timestamp, originalTimestamp',
    qzoneGroups: '++id, name',
    memories: '++id, chatId, timestamp, type, targetDate' // <--„ÄêÌïµÏã¨„ÄëtargetDate Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä
});

        // ===================================================================
        // 3. Î™®Îì† Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò
        // ===================================================================

        function showScreen(screenId) {
            if (screenId === 'chat-list-screen') {
                window.renderChatListProxy(); 
                switchToChatListView('messages-view');
            }
            if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
            if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
            if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) screenToShow.classList.add('active');
            if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
            if (screenId === 'font-settings-screen') {
                document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                applyCustomFont(state.globalSettings.fontUrl || '', true);
            }
        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view'),
        'memories-view': document.getElementById('memories-view') // <-- Ïù¥ Ï§Ñ Ï∂îÍ∞Ä
    };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // Î©îÏù∏ ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î Í∞ÄÏ†∏Ïò§Í∏∞

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            // Î™®Îì† Î∑∞ Ïà®Í∏∞Í∏∞
            Object.values(views).forEach(v => v.classList.remove('active'));
            // ÎåÄÏÉÅ Î∑∞ ÌëúÏãú
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            // ÌïòÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÌïòÏù¥ÎùºÏù¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            // ‚ñº‚ñº‚ñº „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú Î™®Îì† UI ÏöîÏÜåÏùò ÌëúÏãú Ïó¨Î∂ÄÎ•º ÏùºÍ¥ÑÏ†ÅÏúºÎ°ú Í¥ÄÎ¶¨Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÏàòÏ†ï ÎÅù ‚ñ≤‚ñ≤‚ñ≤

    if (viewId !== 'memories-view') {
        activeCountdownTimers.forEach(timerId => clearInterval(timerId));
        activeCountdownTimers = [];
    }

            // Î∑∞ IDÏóê Îî∞Îùº ÌäπÏ†ï Î†åÎçîÎßÅÏùÑ Ïã§ÌñâÌï©ÎãàÎã§/ÏóÖÎç∞Ïù¥Ìä∏ Î°úÏßÅ
            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    // ÌïÑÏöîÌïú Í≤ΩÏö∞, Ïó¨Í∏∞ÏóêÏÑú Î©îÏãúÏßÄ Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞à Îïå Ïã§ÌñâÌï† Î°úÏßÅÏùÑ Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return 'Î∞©Í∏à';
            if (diffMinutes < 60) return `${diffMinutes}Î∂Ñ Ï†Ñ`;
            if (diffHours < 24) return `${diffHours}ÏãúÍ∞Ñ Ï†Ñ`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

        async function renderQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;

            const [posts, favorites] = await Promise.all([
                db.qzonePosts.orderBy('timestamp').reverse().toArray(),
                db.favorites.where('type').equals('qzone_post').toArray() // Î™®Îì† Ï¶êÍ≤®Ï∞æÎäî Í≤åÏãúÎ¨º Í∞ÄÏ†∏Ïò§Í∏∞
            ]);

            // Îπ†Î•∏ Í≤ÄÏÉâÏùÑ ÏúÑÌï¥ Ï¶êÍ≤®Ï∞æÎäî Í≤åÏãúÎ¨º ID ÏßëÌï©ÏùÑ ÎßåÎì≠ÎãàÎã§
            const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
            
            postsListEl.innerHTML = '';

            if (posts.length === 0) {
                postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">Ïó¨Í∏∞Í∞Ä ÌÖÖ ÎπÑÏñ¥ÏûàÏñ¥Ïöî, Ï≤´ Î≤àÏß∏ Í≤åÏãúÎ¨ºÏùÑ ÏûëÏÑ±Ìï¥ Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }

            const userSettings = state.qzoneSettings;

            posts.forEach(post => {
                const postContainer = document.createElement('div');
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;

                const postEl = document.createElement('div');
                postEl.className = 'qzone-post-item';

                let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

                if (post.authorId === 'user') {
                    authorAvatar = userSettings.avatar;
                    authorNickname = userSettings.nickname;
                } else if (state.chats[post.authorId]) {
                    const authorChat = state.chats[post.authorId];
                    authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                    authorNickname = authorChat.name;
                } else {
                    authorAvatar = defaultAvatar;
                    authorNickname = '{{char}}';
                }
                
                let contentHtml = '';
                const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

                if (post.type === 'shuoshuo') {
                    contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
                } 
                else if (post.type === 'image_post' && post.imageUrl) {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                } 
                else if (post.type === 'text_image') {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                }

                let likesHtml = '';
                if (post.likes && post.likes.length > 0) {
                    likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join(',')} Ï¢ãÏïÑÏöî</span></div>`;
                }
                
                let commentsHtml = '';
                if (post.comments && post.comments.length > 0) {
                    commentsHtml = '<div class="post-comments-container">';
                    post.comments.forEach(comment => {
                        commentsHtml += `<div class="comment-item"><span class="commenter-name">${comment.commenterName}:</span><span class="comment-text">${comment.text}</span></div>`;
                    });
                    commentsHtml += '</div>';
                }

                // Ï¢ãÏïÑÏöî Î∞è Ï¶êÍ≤®Ï∞æÍ∏∞ ÏÉÅÌÉú ÌôïÏù∏
                const userNickname = state.qzoneSettings.nickname;
                const isLikedByUser = post.likes && post.likes.includes(userNickname);
                const isFavoritedByUser = favoritedPostIds.has(post.id); // SetÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Îπ†Î•¥Í≤å Í≤ÄÏÉâ

                postEl.innerHTML = `
                    <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>

        <!-- „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÍ≤åÏãúÎ¨º ÏûëÏóÖ Î≤ÑÌäº -->
        <div class="post-actions-btn">...</div>
    </div>

                    <div class="post-main-content">${contentHtml}</div>
                    <div class="post-feedback-icons">
                        <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                        <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                    </div>
                    ${likesHtml}
                    ${commentsHtml}
                    <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder="ÏπúÏ†àÌïú ÎåìÍ∏ÄÏùÄ ÏÜåÌÜµÏùò ÏãúÏûëÏûÖÎãàÎã§"><div class="at-mention-popup"></div></div><button class="comment-send-btn">Î≥¥ÎÇ¥Í∏∞</button></div>
                `;
                
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>ÏÇ≠Ï†ú</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
                const commentSection = postContainer.querySelector('.comment-section');
                if (commentSection) {
                    commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
                    commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
                }
                postsListEl.appendChild(postContainer);
                const commentInput = postContainer.querySelector('.comment-input');
                const popup = postContainer.querySelector('.at-mention-popup');
                commentInput.addEventListener('input', () => {
                    const value = commentInput.value;
                    const atMatch = value.match(/@([\p{L}\w]*)$/u);
                    if (atMatch) {
                        const namesToMention = new Set();
                        const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                        if (authorNickname) namesToMention.add(authorNickname);
                        postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                            namesToMention.add(nameEl.textContent.replace(':', ''));
                        });
                        namesToMention.delete(state.qzoneSettings.nickname);
                        popup.innerHTML = '';
                        if (namesToMention.size > 0) {
                            const searchTerm = atMatch[1];
                            namesToMention.forEach(name => {
                                if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                    const item = document.createElement('div');
                                    item.className = 'at-mention-item';
                                    item.textContent = name;
                                    item.addEventListener('mousedown', (e) => {
                                        e.preventDefault();
                                        const newText = value.substring(0, atMatch.index) + `@${name} `;
                                        commentInput.value = newText;
                                        popup.style.display = 'none';
                                        commentInput.focus();
                                    });
                                    popup.appendChild(item);
                                }
                            });
                            popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                        } else {
                            popup.style.display = 'none';
                        }
                    } else {
                        popup.style.display = 'none';
                    }
                });
                commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
            });
        }
             
// ‚ñº‚ñº‚ñº ÏïÑÎûòÏùò Í≤ÉÏúºÎ°ú ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏóÖÎç∞Ïù¥Ìä∏Îêú„ÄëÌï®ÏàòÎ°ú, ÏΩîÎìúÏùò Ïù¥Ï†Ñ displayFilteredFavorites Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ÌïòÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº

function displayFilteredFavorites(items) {
    const listEl = document.getElementById('favorites-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
        const searchTerm = document.getElementById('favorites-search-input').value;
        const message = searchTerm ? 'Í¥ÄÎ†® Ï¶êÍ≤®Ï∞æÍ∏∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§' : 'Ï¶êÍ≤®Ï∞æÍ∏∞ Ìè¥ÎçîÍ∞Ä ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§,<br>ÏßÄÍ∏à Î∞îÎ°ú Í≤åÏãúÎ¨ºÏù¥ÎÇò Ï±ÑÌåÖÏóêÏÑú Ï¢ãÏïÑÌïòÎäî ÏΩòÌÖêÏ∏†Î•º Ï¶êÍ≤®Ï∞æÍ∏∞ÌïòÏÑ∏Ïöî!';
        listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
        return;
    }

    for (const item of items) {
        const card = document.createElement('div');
        card.className = 'favorite-item-card';
        card.dataset.favid = item.id;

        let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

        if (item.type === 'qzone_post') {
            const post = item.content;
            sourceText = 'Í≤åÏãúÎ¨ºÏóêÏÑú';
            let authorAvatar = defaultAvatar, authorNickname = 'Ïïå Ïàò ÏóÜÎäî ÏÇ¨Ïö©Ïûê';

            if (post.authorId === 'user') {
                authorAvatar = state.qzoneSettings.avatar;
                authorNickname = state.qzoneSettings.nickname;
            } else if (state.chats[post.authorId]) {
                authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                authorNickname = state.chats[post.authorId].name;
            }

            headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
            
            const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
            if (post.type === 'shuoshuo') {
                contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
            } else if (post.type === 'image_post' && post.imageUrl) {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
            } else if (post.type === 'text_image') {
                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
            }

            // ‚ñº‚ñº‚ñº ÏÉàÎ°ú Ï∂îÍ∞Ä/ÏàòÏ†ï ÏΩîÎìú ÏãúÏûë ‚ñº‚ñº‚ñº
            
            // 1. Ï¢ãÏïÑÏöî ÏòÅÏó≠Ïùò HTML Íµ¨ÏÑ±
            let likesHtml = '';
            // post Í∞ùÏ≤¥Ïóê likes Î∞∞Ïó¥Ïù¥ Ï°¥Ïû¨ÌïòÍ≥† ÎπÑÏñ¥ ÏûàÏßÄ ÏïäÏùÄÏßÄ ÌôïÏù∏
            if (post.likes && post.likes.length > 0) {
                // Ï°¥Ïû¨ÌïòÎ©¥, Ï¢ãÏïÑÏöî ÏòÅÏó≠Ïùò divÎ•º ÏÉùÏÑ±
                likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join(',')} Ï¢ãÏïÑÏöî</span>
                    </div>`;
            }

            // 2. ÎåìÍ∏Ä ÏòÅÏó≠Ïùò HTML Íµ¨ÏÑ±
            let commentsHtml = '';
            // post Í∞ùÏ≤¥Ïóê comments Î∞∞Ïó¥Ïù¥ Ï°¥Ïû¨ÌïòÍ≥† ÎπÑÏñ¥ ÏûàÏßÄ ÏïäÏùÄÏßÄ ÌôïÏù∏
            if (post.comments && post.comments.length > 0) {
                // Ï°¥Ïû¨ÌïòÎ©¥, ÎåìÍ∏Ä Ïª®ÌÖåÏù¥ÎÑàÎ•º ÏÉùÏÑ±ÌïòÍ≥† Í∞Å ÎåìÍ∏ÄÏùÑ ÏàúÌöåÌï©ÎãàÎã§
                commentsHtml = '<div class="post-comments-container">';
                post.comments.forEach(comment => {
                    commentsHtml += `
                        <div class="comment-item">
                            <span class="commenter-name">${comment.commenterName}:</span>
                            <span class="comment-text">${comment.text}</span>
                        </div>`;
                });
                commentsHtml += '</div>';
            }

            // 3. Ï¢ãÏïÑÏöî Î∞è ÎåìÍ∏Ä HTMLÏùÑ footerHtmlÏóê Ï°∞Ìï©Ìï©ÎãàÎã§
            footerHtml = `${likesHtml}${commentsHtml}`;
            
            // ‚ñ≤‚ñ≤‚ñ≤ ÏÉàÎ°ú Ï∂îÍ∞Ä/ÏàòÏ†ï ÏΩîÎìú ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        } else if (item.type === 'chat_message') {
            const msg = item.content;
            const chat = state.chats[item.chatId];
            if (!chat) continue; 

            sourceText = `${chat.name}ÎãòÍ≥ºÏùò Ï±ÑÌåÖÏóêÏÑú`;
            const isUser = msg.role === 'user';
            let senderName, senderAvatar;

            if (isUser) {
                senderName = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
                senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
            } else {
                 if (chat.isGroup) {
                    const member = chat.members.find(m => m.name === msg.senderName);
                    senderName = msg.senderName;
                    senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                } else {
                    senderName = chat.name;
                    senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                }
            }

            headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
            
            if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }
        }
        
        // ‚ñº‚ñº‚ñº ÏµúÏ¢Ö HTML Ïó∞Í≤∞ÏùÑ ÏàòÏ†ïÌïòÍ≥† footerHtmlÏùÑ Ï∂îÍ∞ÄÌï©ÎãàÎã§ ‚ñº‚ñº‚ñº
        card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <-- ÏÉàÎ°ú ÏÉùÏÑ±Ìïú footerHtmlÏùÑ Ïó¨Í∏∞Ïóê Î∞∞ÏπòÌï©ÎãàÎã§
            
        listEl.appendChild(card);
    }
}

// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÏòÅÏó≠ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        /**
         * „ÄêÎ¶¨Ìå©ÌÜ†ÎßÅÎêú Ìï®Ïàò„Äë: Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ Î∞è Î†åÎçîÎßÅ Ìä∏Î¶¨Í±∞ Îã¥Îãπ
         */
        async function renderFavoritesScreen() {
            // 1. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏ÏôÄ Ï∫êÏãúÌï©ÎãàÎã§
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            // 2. Í≤ÄÏÉâ ÏÉÅÏûêÎ•º ÎπÑÏö∞Í≥† ÏßÄÏö∞Í∏∞ Î≤ÑÌäºÏùÑ Ïà®ÍπÅÎãàÎã§
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            // 3. Î™®Îì† Ï¶êÍ≤®Ï∞æÍ∏∞ Ìï≠Î™© ÌëúÏãú
            displayFilteredFavorites(allFavoriteItems);
        }

        // ‚ñ≤‚ñ≤‚ñ≤ Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

        function resetCreatePostModal() {
            document.getElementById('post-public-text').value = '';
            document.getElementById('post-image-preview').src = '';
            document.getElementById('post-image-description').value = '';
            document.getElementById('post-image-preview-container').classList.remove('visible');
            document.getElementById('post-image-desc-group').style.display = 'none';
            document.getElementById('post-local-image-input').value = '';
            document.getElementById('post-hidden-text').value = '';
            document.getElementById('switch-to-image-mode').click();
        }

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„Äêmemories Ìè¨Ìï®Îê®„ÄëÎ≤ÑÏ†ÑÏúºÎ°ú, Ïù¥Ï†Ñ exportBackup Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ÌïòÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº
async function exportBackup() {
    try {
        const backupData = {
            version: 1, 
            timestamp: Date.now()
        };

        const [
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÉàÎ°ú Ï∂îÍ∞Ä
        ] = await Promise.all([
            db.chats.toArray(),
            db.worldBooks.toArray(),
            db.userStickers.toArray(),
            db.apiConfig.get('main'),
            db.globalSettings.get('main'),
            db.personaPresets.toArray(),
            db.musicLibrary.get('main'),
            db.qzoneSettings.get('main'),
            db.qzonePosts.toArray(),
            db.qzoneAlbums.toArray(),
            db.qzonePhotos.toArray(),
            db.favorites.toArray(),
            db.qzoneGroups.toArray(),
            db.memories.toArray() // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÉàÎ°ú Ï∂îÍ∞Ä
        ]);

        Object.assign(backupData, {
            chats, worldBooks, userStickers, apiConfig, globalSettings,
            personaPresets, musicLibrary, qzoneSettings, qzonePosts,
            qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
            memories // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÉàÎ°ú Ï∂îÍ∞Ä
        });
        
        const blob = new Blob(
            [JSON.stringify(backupData, null, 2)], 
            { type: 'application/json' }
        );
        const url = URL.createObjectURL(blob);
        const link = Object.assign(document.createElement('a'), {
            href: url,
            download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
        });
        link.click();
        URL.revokeObjectURL(url);
        
        await showCustomAlert('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏÑ±Í≥µ', 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÎÇ¥Î≥¥ÎÉàÏäµÎãàÎã§!');

    } catch (error) {
        console.error("Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
        await showCustomAlert('ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ïã§Ìå®', `Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`);
    }
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„Äêmemories Ìè¨Ìï®Îê®„ÄëÎ≤ÑÏ†ÑÏúºÎ°ú, Ïù¥Ï†Ñ importBackup Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ÌïòÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº
async function importBackup(file) {
    if (!file) return;

    const confirmed = await showCustomConfirm(
        'Ïã¨Í∞ÅÌïú Í≤ΩÍ≥†!',
        'Î∞±ÏóÖÏùÑ Í∞ÄÏ†∏Ïò§Î©¥ Ï±ÑÌåÖ, Í≤åÏãúÎ¨º, ÏÑ§Ï†ï Îì± ÌòÑÏû¨Ïùò Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏôÑÏ†ÑÌûà ÎçÆÏñ¥Ïì∞Ïó¨ÏßëÎãàÎã§. Ïù¥ ÏûëÏóÖÏùÄ Ï∑®ÏÜåÌï† Ïàò ÏóÜÏäµÎãàÎã§! Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
        { confirmButtonClass: 'btn-danger' }
    );

    if (!confirmed) return;

    try {
        const text = await file.text();
        const data = JSON.parse(text);

        await db.transaction('rw', db.tables, async () => {
            for (const table of db.tables) {
                await table.clear();
            }

            if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
            if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
            if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
            if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
            if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
            if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
            if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
            if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
            if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
            if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories); // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÉàÎ°ú Ï∂îÍ∞Ä

            if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
            if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
            if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
            if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
        });

        await showCustomAlert('Í∞ÄÏ†∏Ïò§Í∏∞ ÏÑ±Í≥µ', 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î≥µÏõêÎêòÏóàÏäµÎãàÎã§! Ïï±Ïù¥ Î™®Îì† Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ÏùÑ Ï†ÅÏö©ÌïòÍ∏∞ ÏúÑÌï¥ ÏÉàÎ°ú Í≥†Ï≥êÏßëÎãàÎã§.');
        
        setTimeout(() => {
            window.location.reload();
        }, 1500);

    } catch (error) {
        console.error("Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
        await showCustomAlert('Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®', `ÌååÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÍ±∞ÎÇò Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÜêÏÉÅÎêòÏóàÏäµÎãàÎã§: ${error.message}`);
    }
}

        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                document.getElementById('font-preview').style.fontFamily = '';
                return;
            }
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }

        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = ''; 
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            document.getElementById('font-url-input').value = '';
            document.getElementById('font-preview').style.fontFamily = '';
            alert('Í∏∞Î≥∏ Í∏ÄÍº¥Ïù¥ Î≥µÏõêÎêòÏóàÏäµÎãàÎã§.');
        }

async function loadAllDataFromDB() {
    // ‚ñº‚ñº‚ñº „ÄêÌïµÏã¨ ÏàòÏ†ïÏùÄ Ïó¨Í∏∞Ïóê ÏûàÏäµÎãàÎã§„Äë ‚ñº‚ñº‚ñº
    const [
        chatsArr,
        apiConfig,
        globalSettings,
        userStickers,
        worldBooks,
        musicLib,
        personaPresets,
        qzoneSettings,
        initialFavorites // initialFavoritesÎ•º Íµ¨Ï°∞ Î∂ÑÌï¥ Ìï†ÎãπÏóê Ï∂îÍ∞Ä
    ] = await Promise.all([
        db.chats.toArray(),
        db.apiConfig.get('main'),
        db.globalSettings.get('main'),
        db.userStickers.toArray(),
        db.worldBooks.toArray(),
        db.musicLibrary.get('main'),
        db.personaPresets.toArray(),
        db.qzoneSettings.get('main'),
        db.favorites.orderBy('timestamp').reverse().toArray() // Ïù¥ Ï§ÑÏù¥ Promise.allÏùò Î∞∞Ïó¥ Îß§Í∞úÎ≥ÄÏàò ÎÇ¥Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏
    ]);
    // ‚ñ≤‚ñ≤‚ñ≤ „ÄêÏàòÏ†ï ÎÅù„Äë ‚ñ≤‚ñ≤‚ñ≤

    state.chats = chatsArr.reduce((acc, chat) => {

        // --- ‚ñº‚ñº‚ñº ÌïµÏã¨ ÏàòÏ†ïÏùÄ Î∞îÎ°ú Ïó¨Í∏∞Ïóê ÏûàÏäµÎãàÎã§ ‚ñº‚ñº‚ñº ---
        // ÌôïÏù∏ 1:ÎßåÏïΩ 1:1 Ï±ÑÌåÖÏù¥Í≥† status ÏÜçÏÑ±Ïù¥ ÏóÜÎã§Î©¥
        if (!chat.isGroup && !chat.status) {
            // Í∏∞Î≥∏ status Í∞ùÏ≤¥Î•º Î≥¥Ï∂©Ìï©ÎãàÎã§
            chat.status = {
                text: 'Ïò®ÎùºÏù∏',
                lastUpdate: Date.now(),
                isBusy: false
            };
            console.log(`Ïù¥Ï†Ñ Ï∫êÎ¶≠ÌÑ∞Ïóê "${chat.name}" status ÏÜçÏÑ±Ïù¥ Î≥¥Ï∂©ÎêòÏóàÏäµÎãàÎã§.`);
        }
        // --- ‚ñ≤‚ñ≤‚ñ≤ ÏàòÏ†ï ÏôÑÎ£å ‚ñ≤‚ñ≤‚ñ≤

        // --- ‚ñº‚ñº‚ñº ÌïµÏã¨ ÏàòÏ†ïÏùÄ Î∞îÎ°ú Ïó¨Í∏∞Ïóê ÏûàÏäµÎãàÎã§ ‚ñº‚ñº‚ñº ---
        // ÌôïÏù∏ 2:ÏµúÏã† Î≤ÑÏ†ÑÏóê Ìò∏Ìôò\"Í¥ÄÍ≥Ñ\"Í∏∞Îä•
        if (!chat.isGroup && !chat.relationship) {
            // ÎßåÏïΩ 1:1 Ï±ÑÌåÖÏù¥Í≥† relationship Í∞ùÏ≤¥Í∞Ä ÏóÜÎã§Î©¥, Í∏∞Î≥∏Í∞íÏùÑ Î≥¥Ï∂©Ìï©ÎãàÎã§
            chat.relationship = {
                status: 'friend',
                blockedTimestamp: null,
                applicationReason: ''
            };
            console.log(`Ïù¥Ï†Ñ Ï∫êÎ¶≠ÌÑ∞Ïóê "${chat.name}" relationship ÏÜçÏÑ±Ïù¥ Î≥¥Ï∂©ÎêòÏóàÏäµÎãàÎã§.`);
        }
        // --- ‚ñ≤‚ñ≤‚ñ≤ ÏàòÏ†ï ÏôÑÎ£å ‚ñ≤‚ñ≤‚ñ≤

    // ‚ñº‚ñº‚ñº Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
    if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
        if (!chat.settings) chat.settings = {}; // ÎßåÏïΩ settingsÏ°∞Ï∞® ÏóÜÎäî Í≤ΩÏö∞Î•º ÎåÄÎπÑÌïòÏó¨
        chat.settings.aiAvatarLibrary = [];
        console.log(`Ïù¥Ï†Ñ Ï∫êÎ¶≠ÌÑ∞Ïóê "${chat.name}" aiAvatarLibrary ÏÜçÏÑ±Ïù¥ Î≥¥Ï∂©ÎêòÏóàÏäµÎãàÎã§.`);
    }
    // ‚ñ≤‚ñ≤‚ñ≤ Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

        if (!chat.musicData) chat.musicData = { totalTime: 0 };
        if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
            chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
            delete chat.settings.linkedWorldBookId;
        }
        acc[chat.id] = chat;
        return acc;
    }, {});
    state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };

state.globalSettings = globalSettings || { 
    id: 'main', 
    wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', 
    fontUrl: '', 
    enableBackgroundActivity: false, 
    backgroundActivityInterval: 60,
    blockCooldownHours: 1,
    appIcons: { ...DEFAULT_APP_ICONS } // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëappIconsÍ∞Ä Ï°¥Ïû¨ÌïòÍ≥† Í∏∞Î≥∏Í∞íÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
};
// „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏ†ÄÏû•Îêú ÏïÑÏù¥ÏΩòÍ≥º Í∏∞Î≥∏ ÏïÑÏù¥ÏΩòÏùÑ Î≥ëÌï©ÌïòÏó¨ ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÉà ÏïÑÏù¥ÏΩòÏùÑ ÏûÉÎäî Í≤ÉÏùÑ Î∞©ÏßÄÌï©ÎãàÎã§
state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };

    state.userStickers = userStickers || [];
    state.worldBooks = worldBooks || [];
    musicState.playlist = musicLib?.playlist || [];
    state.personaPresets = personaPresets || [];
    state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };

    // ‚ñº‚ñº‚ñº „ÄêÏù¥ Ï§ÑÏù¥ Promise.all Ïù¥ÌõÑÏóê ÏûàÏúºÎ©∞, Íµ¨Ï°∞ Î∂ÑÌï¥ Ìï†ÎãπÏúºÎ°ú ÏñªÏùÄ initialFavoritesÎ•º ÏÇ¨Ïö©ÌïòÎäîÏßÄ ÌôïÏù∏„Äë ‚ñº‚ñº‚ñº
    allFavoriteItems = initialFavorites || [];
    // ‚ñ≤‚ñ≤‚ñ≤ „ÄêÏàòÏ†ï ÎÅù„Äë ‚ñ≤‚ñ≤‚ñ≤
}

        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÍ∂ÅÍ∑πÏ†Å Í∞ïÌôî Î≤ÑÏ†Ñ„ÄëÌï®ÏàòÎ°ú, ÏΩîÎìúÏùò Ïù¥Ï†Ñ parseAiResponse Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ÌïòÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº
function parseAiResponse(content) {
    const trimmedContent = content.trim();

    // 1. „ÄêÏÉàÎ°úÏö¥„ÄëÏö∞ÏÑ†Ï†ÅÏúºÎ°ú Ï≤òÎ¶¨ "[...][...]" Ïù¥Îü¨Ìïú Î∂ôÏñ¥ÏûàÎäî JSON Î∞∞Ïó¥ ÌòïÏãù
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        // Ï†ïÍ∑úÏãùÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Î™®Îì† Í∞úÎ≥Ñ "[...]" Î∏îÎ°ù
        const matches = trimmedContent.match(/\[(.*?)\]/g);
        
        // Ïó¨Îü¨ Î∏îÎ°ùÏù¥ ÏùºÏπòÌïòÎ©¥, Î∂ôÏñ¥ÏûàÎäî ÌòïÏãùÏûÖÎãàÎã§
        if (matches && matches.length > 1) {
            try {
                let combinedResults = [];
                for (const match of matches) {
                    // Í∞ÅÍ∞ÅÏùÑ Í∞úÎ≥ÑÏ†ÅÏúºÎ°ú Íµ¨Î¨∏ Î∂ÑÏÑù " [...] " Î¨∏ÏûêÏó¥ Î∏îÎ°ù
                    const parsedArray = JSON.parse(match);
                    if (Array.isArray(parsedArray)) {
                        // Íµ¨Î¨∏ Î∂ÑÏÑùÎêú Î∞∞Ïó¥ ÎÇ¥Ïö©ÏùÑ Ï†ÑÏ≤¥ Í≤∞Í≥ºÏóê Î≥ëÌï©
                        combinedResults = combinedResults.concat(parsedArray);
                    }
                }
                // ÎÇ¥Ïö© Î≥ëÌï©Ïóê ÏÑ±Í≥µÌïòÎ©¥ ÏµúÏ¢Ö Í≤∞Í≥º Î∞òÌôò
                if (combinedResults.length > 0) {
                    console.log("Î∂ôÏñ¥ÏûàÎäî ÌòïÏãùÏùò JSON Íµ¨Î¨∏ Î∂ÑÏÑù ÏÑ±Í≥µ:", combinedResults);
                    return combinedResults;
                }
            } catch (e) {
                // Íµ¨Î¨∏ Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïòÎ©¥ Ïù¥ Î∞©Î≤ïÏùÑ Ìè¨Í∏∞ÌïòÍ≥† ÏΩîÎìúÍ∞Ä ÏïÑÎûòÏùò Ïù¥Ï†Ñ Î∞©Î≤ïÏùÑ Í≥ÑÏÜç ÏãúÎèÑÌïòÎèÑÎ°ù Ìï©ÎãàÎã§
                console.warn("Î∂ôÏñ¥ÏûàÎäî JSON Íµ¨Î¨∏ Î∂ÑÏÑù ÏãúÎèÑ Ïã§Ìå®, ÌëúÏ§Ä Íµ¨Î¨∏ Î∂ÑÏÑù ÌùêÎ¶ÑÏúºÎ°ú ÎêòÎèåÎ¶ΩÎãàÎã§.", e);
            }
        }
    }

    // 2. ÌëúÏ§ÄÏ†ÅÏù¥Í≥† Îã®ÏùºÌïú JSON Î∞∞Ïó¥Î°ú Íµ¨Î¨∏ Î∂ÑÏÑù ÏãúÎèÑ
    if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            if (Array.isArray(parsed)) {
                return parsed;
            }
        } catch (e) {
            // Íµ¨Î¨∏ Î∂ÑÏÑù Ïã§Ìå®, Îã§Î•∏ Î∞©Î≤ï Í≥ÑÏÜç ÏãúÎèÑ
        }
    }

    // 3. Îã®Ïùº JSON Í∞ùÏ≤¥Î°ú Íµ¨Î¨∏ Î∂ÑÏÑù ÏãúÎèÑ (AIÍ∞Ä Í∞ùÏ≤¥ ÌïòÎÇòÎßå Î∞òÌôòÌïòÎäî Í≤ΩÏö∞ Ï≤òÎ¶¨)
    if (trimmedContent.startsWith('{') && trimmedContent.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedContent);
            // Í∞ùÏ≤¥Î°ú ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Íµ¨Î¨∏ Î∂ÑÏÑùÌïú ÌõÑ, Î∞∞Ïó¥Ïóê ÎÑ£Ïñ¥ ÌòïÏãùÏùÑ ÌÜµÏùºÌï©ÎãàÎã§
            return [parsed]; 
        } catch (e) {
            // Ìï¥ÏÑù Ïã§Ìå®, Í≥ÑÏÜç
        }
    }
    
    // 4. ÏµúÌõÑÏùò ÎåÄÏ≤¥ Î∞©ÏïàÏúºÎ°ú, ÌÖçÏä§Ìä∏ÏóêÏÑú JSON Î∞∞Ïó¥ÏùÑ Ï∂îÏ∂ú ÏãúÎèÑ
    try {
        const match = content.match(/\[(.*?)\]/s);
        if (match && match[0]) {
            const parsed = JSON.parse(match[0]);
            if (Array.isArray(parsed)) return parsed;
        }
    } catch (e) {
        // Ï∂îÏ∂ú Ïã§Ìå®
    }

    // 5. ÎßåÏïΩ ÏúÑ Î™®Îì† Í≤ÉÏù¥ Ïã§Ìå®ÌïòÎ©¥, ÏùºÎ∞ò ÌÖçÏä§Ìä∏Î°ú Ï≤òÎ¶¨
    const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```'));
    if (lines.length > 0) {
         // ÏùºÎ∞ò ÌÖçÏä§Ìä∏Î•º ÌëúÏ§Ä Î©îÏãúÏßÄ Í∞ùÏ≤¥Î°ú ÎûòÌïë
        return lines.map(line => ({ type: 'text', content: line }));
    }
    
    // 6. ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú, ÏõêÎ≥∏ ÌÖçÏä§Ìä∏Î•º Ìè¨Ìï®ÌïòÎäî Îã®Ïùº Î©îÏãúÏßÄ Í∞ùÏ≤¥ Î∞òÌôò
    return [{ type: 'text', content: content }];
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; 
    // ‚ñº‚ñº‚ñº Ïù¥ Ï§Ñ Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
    document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
    document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
    document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
}
        window.renderApiSettingsProxy = renderApiSettings;

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏÉàÎ°úÏö¥ Î≤ÑÏ†Ñ„ÄëÏùò Ìï®Ïàò, Í∏∞Ï°¥ renderChatListÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
async function renderChatList() {
    const chatListEl = document.getElementById('chat-list');
    chatListEl.innerHTML = '';

    // 1. Ïù¥Ï†ÑÏ≤òÎüº, Î™®Îì† Ï±ÑÌåÖÏùÑ Í∞ÄÏ†∏ÏôÄ ÏµúÏã† Î©îÏãúÏßÄ ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨
    const allChats = Object.values(state.chats).sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));
    
    // 2. Î™®Îì† Í∑∏Î£π Í∞ÄÏ†∏Ïò§Í∏∞
    const allGroups = await db.qzoneGroups.toArray();

    if (allChats.length === 0) {
        chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">Ïò§Î•∏Ï™Ω ÏÉÅÎã® ÌÅ¥Î¶≠ "+" ÎòêÎäî Í∑∏Î£π ÏïÑÏù¥ÏΩòÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ï±ÑÌåÖ Ï∂îÍ∞Ä</p>';
        return;
    }

    // --- „ÄêÌïµÏã¨ ÏàòÏ†ï ÏãúÏûë„Äë---

    // 3. Í∞Å Í∑∏Î£πÏùò ÎÇ¥Î∂Ä ÏµúÏã† Î©îÏãúÏßÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∞æÍ∏∞
    allGroups.forEach(group => {
        // Ï†ïÎ†¨Îêú allChatsÏóêÏÑú Ïù¥ Í∑∏Î£πÏùò Ï≤´ Î≤àÏß∏ Ìï≠Î™© Ï∞æÍ∏∞(Ï¶â, ÏµúÏã† Î©îÏãúÏßÄ)Ï±ÑÌåÖ
        const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
        // Ï∞æÏïòÎã§Î©¥, Ìï¥Îãπ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏÇ¨Ïö©;ÎßåÏïΩ Ìï¥Îãπ Í∑∏Î£πÏóê ÌòÑÏû¨ Ï±ÑÌåÖÏù¥ ÏóÜÍ±∞ÎÇò Ï±ÑÌåÖ Í∏∞Î°ùÏù¥ ÏóÜÎã§Î©¥, 0 ÏÇ¨Ïö©
        group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
    });

    // 4. Ïù¥ ÏµúÏã† ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÏóê Îî∞Îùº\"Í∑∏Î£π ÏûêÏ≤¥Î•º\"Ï†ïÎ†¨Ìï©ÎãàÎã§
    allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

    // --- „ÄêÌïµÏã¨ ÏàòÏ†ï Ï¢ÖÎ£å„Äë---

    // 5. Ïù¥Ï†ú, Ï†ïÎ†¨Îêú Í∑∏Î£π ÏàúÏÑúÎåÄÎ°ú Î†åÎçîÎßÅÌï©ÎãàÎã§
    allGroups.forEach(group => {
        // Ï†ÑÏ≤¥ Î™©Î°ùÏóêÏÑú Ïù¥(Ï†ïÎ†¨Îêú)Í∑∏Î£πÏóê ÏÜçÌïú ÏπúÍµ¨Î•º ÌïÑÌÑ∞ÎßÅÌï©ÎãàÎã§
        const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
        // ÎßåÏïΩ Ïù¥ Í∑∏Î£πÏù¥ ÎπÑÏñ¥ ÏûàÎã§Î©¥(Î™®Îì† ÏπúÍµ¨Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏùÑ Ïàò ÏûàÏäµÎãàÎã§),Í±¥ÎÑàÎúÅÎãàÎã§
        if (groupChats.length === 0) return;

        const groupContainer = document.createElement('div');
        groupContainer.className = 'chat-group-container';
        groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">‚ñº</span>
                <span class="group-name">${group.name}</span>
            </div>
            <div class="chat-group-content"></div>
        `;
        const contentEl = groupContainer.querySelector('.chat-group-content');
        // allChats ÏûêÏ≤¥Í∞Ä Ï†ïÎ†¨ÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú, groupChatsÎèÑ ÎãπÏó∞Ìûà Ï†ïÎ†¨Îê©ÎãàÎã§
        groupChats.forEach(chat => {
            const item = createChatListItem(chat);
            contentEl.appendChild(item);
        });
        chatListEl.appendChild(groupContainer);
    });

    // 6. ÎßàÏßÄÎßâÏúºÎ°ú, Î™®Îì† Í∑∏Î£π Ï±ÑÌåÖÍ≥º Í∑∏Î£πÌôîÎêòÏßÄ ÏïäÏùÄ ÏπúÍµ¨Î•º Î†åÎçîÎßÅÌï©ÎãàÎã§
    // Ïù¥Îì§Ïùò ÏàúÏÑúÎäî allChatsÏùò Ï¥àÍ∏∞ Ï†ïÎ†¨Î°ú Ïù∏Ìï¥ ÏûêÏó∞Ïä§ÎüΩÍ≤å Ïò¨Î∞îÎ¶ÖÎãàÎã§
    const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
    ungroupedOrGroupChats.forEach(chat => {
        const item = createChatListItem(chat);
        chatListEl.appendChild(item);
    });

    // Î™®Îì† Í∑∏Î£π Ï†úÎ™©Ïóê Ï†ëÍ∏∞ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
    document.querySelectorAll('.chat-group-header').forEach(header => {
        header.addEventListener('click', () => {
            header.classList.toggle('collapsed');
            header.nextElementSibling.classList.toggle('collapsed');
        });
    });
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

function createChatListItem(chat) {
    const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
    let lastMsgDisplay;

    // --- ‚ñº‚ñº‚ñº „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞Ïóê Í¥ÄÍ≥Ñ ÏÉÅÌÉú ÌåêÎã® Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº ---
    if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
        lastMsgDisplay = `<span style="color: #ff8c00;">[ÏπúÍµ¨ Ïã†Ï≤≠] ${chat.relationship.applicationReason || 'ÎãπÏã†ÏùÑ ÏπúÍµ¨Î°ú Ï∂îÍ∞Ä ÏöîÏ≤≠'}</span>`;
    }
    // --- ‚ñ≤‚ñ≤‚ñ≤ ÏàòÏ†ï ÎÅù ‚ñ≤‚ñ≤‚ñ≤ ---

// ‚ñº‚ñº‚ñº Ïó¨Í∏∞Ïóê else if Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
    lastMsgDisplay = `<span style="color: #dc3545;">[ÎãπÏã†ÏùÄ ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§]</span>`;
}
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉàÎ°úÏö¥ Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤
    
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎßàÏßÄÎßâ Î©îÏãúÏßÄ ÎåÄÏã† ÏÉÅÌÉúÎ•º Ïö∞ÏÑ† ÌëúÏãú
    if (chat.isGroup) {
        // Í∑∏Î£π Ï±ÑÌåÖ Î°úÏßÅÏùÄ Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏäµÎãàÎã§
        if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[ÏãúÏä§ÌÖú Î©îÏãúÏßÄ] ${lastMsgObj.content}`; }
        // ... (Îã§Î•∏ Í∑∏Î£π Ï±ÑÌåÖ Î©îÏãúÏßÄ Ïú†Ìòï ÌåêÎã®) ...
        else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[ÏÜ°Í∏à]'; }
        else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ÏÇ¨ÏßÑ]'; }
        else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[ÏùåÏÑ±]'; }
        else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[Ïù¥Î™®Ìã∞ÏΩò: ${lastMsgObj.meaning}]` : '[Ïù¥Î™®Ìã∞ÏΩò]'; }
        else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[Ïù¥ÎØ∏ÏßÄ]`; }
        else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); }

        if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
            lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
        }

    } else {
        // 1:1 Ï±ÑÌåÖ Î°úÏßÅ:ÏÉÅÌÉú ÌëúÏãú
        // chat.status Í∞ùÏ≤¥Í∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
        const statusText = chat.status?.text || 'Ïò®ÎùºÏù∏';
        lastMsgDisplay = `[${statusText}]`;
    }

    const item = document.createElement('div');
    item.className = 'chat-list-item';
    item.dataset.chatId = chat.id;
    const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
    
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„Äëlast Ï°∞Ï†ï-msg Ïùò ÏÉâÏÉÅ, ÏÉÅÌÉúÎ•º Îçî ÎààÏóê ÎùÑÍ≤å
    item.innerHTML = `
        <img src="${avatar || defaultAvatar}" class="avatar">
        <div class="info">
            <div class="name-line">
                <span class="name">${chat.name}</span>
                ${chat.isGroup ? '<span class="group-tag">Í∑∏Î£π Ï±ÑÌåÖ</span>' : ''}
            </div>
            <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
        </div>
    `;
    
    const avatarEl = item.querySelector('.avatar');
    if (avatarEl) {
        avatarEl.style.cursor = 'pointer';
        avatarEl.addEventListener('click', (e) => {
            e.stopPropagation();
            handleUserPat(chat.id, chat.name);
        });
    }
    
    const infoEl = item.querySelector('.info');
    if (infoEl) {
        infoEl.addEventListener('click', () => openChat(chat.id));
    }

    addLongPressListener(item, async (e) => {
        const confirmed = await showCustomConfirm('ÎåÄÌôî ÏÇ≠Ï†ú', `ÏôÄÏùò Ï†ÑÏ≤¥ ÎåÄÌôîÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? "${chat.name}" Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`, { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
            delete state.chats[chat.id];
            if (state.activeChatId === chat.id) state.activeChatId = null;
            await db.chats.delete(chat.id);
            renderChatList();
        }
    });
    return item;
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏßÑÎã® Í∏∞Îä•Ïù¥ Ìè¨Ìï®Îêú ÏÉàÎ°úÏö¥ Î≤ÑÏ†Ñ„ÄëÍ∏∞Ï°¥ renderChatInterface Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
function renderChatInterface(chatId) {
    cleanupWaimaiTimers();
    const chat = state.chats[chatId];
    if (!chat) return;
    exitSelectionMode();
    
    const messagesContainer = document.getElementById('chat-messages');
    const chatInputArea = document.getElementById('chat-input-area');
    const lockOverlay = document.getElementById('chat-lock-overlay');
    const lockContent = document.getElementById('chat-lock-content');

    messagesContainer.dataset.theme = chat.settings.theme || 'default';
    const fontSize = chat.settings.fontSize || 13;
    messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
    applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
    
    document.getElementById('chat-header-title').textContent = chat.name;
    const statusContainer = document.getElementById('chat-header-status');
    const statusTextEl = statusContainer.querySelector('.status-text');

    if (chat.isGroup) {
        statusContainer.style.display = 'none';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
    } else {
        statusContainer.style.display = 'flex';
        document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
        statusTextEl.textContent = chat.status?.text || 'Ïò®ÎùºÏù∏';
        statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
    }
    
    lockOverlay.style.display = 'none';
    chatInputArea.style.visibility = 'visible';
    lockContent.innerHTML = '';

    if (!chat.isGroup && chat.relationship.status !== 'friend') {
        lockOverlay.style.display = 'flex';
        chatInputArea.style.visibility = 'hidden';
        
        let lockHtml = '';
        switch (chat.relationship.status) {
            case 'blocked_by_user':
                // --- „ÄêÌïµÏã¨ ÏàòÏ†ï:Ïó¨Í∏∞Ïóê ÏßÑÎã® Ìå®ÎÑê Ï∂îÍ∞Ä„Äë ---
                const isSimulationRunning = simulationIntervalId !== null;
                const blockedTimestamp = chat.relationship.blockedTimestamp;
                const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                const timeSinceBlock = Date.now() - blockedTimestamp;
                const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                lockHtml = `
                    <span class="lock-text">ÎãπÏã†ÏùÄ\"${chat.name}\"Ï∞®Îã®ÌñàÏäµÎãàÎã§.</span>
                    <button id="unblock-btn" class="lock-action-btn">Ï∞®Îã® Ìï¥Ï†ú</button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;">„ÄêÍ∞úÎ∞úÏûê ÏßÑÎã® Ìå®ÎÑê„Äë</strong><br>
                        - Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô Ï†ÑÏ≤¥ Ïä§ÏúÑÏπò: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">ÏºúÏßê</span>' : '<span style="color: red;">Í∫ºÏßê</span>'}<br>
                        - ÏãúÏä§ÌÖú ÌïòÌä∏ÎπÑÌä∏ ÌÉÄÏù¥Î®∏: ${isSimulationRunning ? '<span style="color: green;">Ïã§Ìñâ Ï§ë</span>' : '<span style="color: red;">ÎØ∏Ïã§Ìñâ</span>'}<br>
                        - ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞ ÏÉÅÌÉú: <strong>${chat.relationship.status}</strong><br>
                        - ÎÉâÏ†ïÌï¥Ï†∏Ïïº Ìï®(ÏãúÍ∞Ñ): <strong>${cooldownHours}</strong><br>
                        - ÎÉâÏ†ï Í∏∞Í∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÍπå?: ${isCooldownOver ? '<span style="color: green;">Ïòà</span>' : `<span style="color: orange;">ÏïÑÎãàÏöî (ÏïΩ ${timeRemainingMinutes}Î∂Ñ ÎÇ®Ïùå)</span>`}<br>
                        - Ìä∏Î¶¨Í±∞ Ï°∞Í±¥: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Ï∂©Ï°±Îê®, Îã§Ïùå ÏãúÏä§ÌÖú ÌïòÌä∏ÎπÑÌä∏ ÎåÄÍ∏∞</span>' : '<span style="color: red;">ÎØ∏Ï∂©Ï°±</span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">Í∞ïÏ†úÎ°ú ÏπúÍµ¨ Ïã†Ï≤≠ Í∞êÏßÄ Ìïú Î≤à Ìä∏Î¶¨Í±∞</button>
                `;
                // --- „ÄêÏàòÏ†ï ÎÅù„Äë ---
                break;
            case 'blocked_by_ai':
                lockHtml = `
                    <span class="lock-text">ÎãπÏã†ÏùÄ ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§.</span>
                    <button id="apply-friend-btn" class="lock-action-btn">ÏπúÍµ¨ Ï∂îÍ∞Ä Îã§Ïãú Ïã†Ï≤≠</button>
                `;
                break;
            
            case 'pending_user_approval':
                lockHtml = `
                    <span class="lock-text">\"${chat.name}\"ÎãπÏã†ÏùÑ ÏπúÍµ¨Î°ú Ï∂îÍ∞Ä ÏöîÏ≤≠:<br><i>\"${chat.relationship.applicationReason}\"</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn">ÏàòÎùΩ</button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary">Í±∞Ï†à</button>
                `;
                break;

            // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏã†Ï≤≠ ÌõÑ ÎãπÏã†Ïù¥ Î≥¥Îäî Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ ÏàòÏ†ï
            case 'pending_ai_approval':
                lockHtml = `<span class="lock-text">ÏπúÍµ¨ Ïã†Ï≤≠Ïù¥ Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§, ÏÉÅÎåÄÎ∞©Ïùò ÏäπÏù∏ÏùÑ Í∏∞Îã§Î¶ΩÎãàÎã§...</span>`;
                break;
        }
        lockContent.innerHTML = lockHtml;
    }
    messagesContainer.innerHTML = '';
    // ...ÌõÑÏÜç ÏΩîÎìúÎäî Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏäµÎãàÎã§
    const chatScreen = document.getElementById('chat-interface-screen');
    chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
    chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5';
    const history = chat.history;
    const totalMessages = history.length;
    currentRenderedCount = 0;
    const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
    initialMessages.forEach(msg => appendMessage(msg, chat, true));
    currentRenderedCount = initialMessages.length;
    if (totalMessages > currentRenderedCount) {
        prependLoadMoreButton(messagesContainer);
    }
    const typingIndicator = document.createElement('div');
    typingIndicator.id = 'typing-indicator';
    typingIndicator.style.display = 'none';
    typingIndicator.textContent = 'ÏÉÅÎåÄÎ∞©Ïù¥ ÏûÖÎ†• Ï§ëÏûÖÎãàÎã§...';
    messagesContainer.appendChild(typingIndicator);
    setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'Îçî Ïù¥Ï†Ñ Í∏∞Î°ù Î°úÎìú'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏÉà Î≤ÑÏ†Ñ„ÄëÍ∏∞Ï°¥ renderWallpaperScreen Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
function renderWallpaperScreen() { 
    const preview = document.getElementById('wallpaper-preview'); 
    const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
    if (bg && bg.startsWith('data:image')) { 
        preview.style.backgroundImage = `url(${bg})`; 
        preview.textContent = ''; 
    } else if(bg) { 
        preview.style.backgroundImage = bg; 
        preview.textContent = 'ÌòÑÏû¨ Í∑∏ÎùºÎç∞Ïù¥ÏÖò ÏÉâÏÉÅ'; 
    }
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞Ïóê ÏïÑÏù¥ÏΩò Î†åÎçîÎßÅ Ìï®Ïàò Ìò∏Ï∂ú
    renderIconSettings();
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤
        window.renderWallpaperScreenProxy = renderWallpaperScreen;

        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

        function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">Ïò§Î•∏Ï™Ω ÏÉÅÎã® ÌÅ¥Î¶≠ "+" Ï≤´ Î≤àÏß∏ ÏõîÎìúÏù∏Ìè¨ ÎßåÎì§Í∏∞</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'ÎÇ¥Ïö© ÏóÜÏùå...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('ÏõîÎìúÏù∏Ìè¨ ÏÇ≠Ï†ú', `ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?„Ää${book.name}„Äã? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;

        function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }

        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">Ïñ¥Î•∏ÍªòÏÑúÎäî Ïò§Î•∏Ï™Ω ÏÉÅÎã®ÏùÑ ÌÅ¥Î¶≠Ìï¥ Ï£ºÏÑ∏Ïöî\"Ï∂îÍ∞Ä\"ÎòêÎäî\"ÏóÖÎ°úÎìú\"Ï≤´ Î≤àÏß∏ Ïù¥Î™®Ìã∞ÏΩòÏùÑ Ï∂îÍ∞ÄÌï¥ Î≥¥ÏÑ∏Ïöî!</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('Ïù¥Î™®Ìã∞ÏΩò ÏÇ≠Ï†ú', `Ïù¥Î™®Ìã∞ÏΩòÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? "${sticker.name}" ?`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏóÖÎç∞Ïù¥Ìä∏Îê®„ÄëÏùò Î≤ÑÏ†ÑÏù¥ Í∏∞Ï°¥ createMessageElement Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
function createMessageElement(msg, chat) {
    if (msg.isHidden) {
        return null;
    }

    if (msg.type === 'pat_message') {
        const wrapper = document.createElement('div');
        wrapper.className = 'message-wrapper system-pat'; 
        const bubble = document.createElement('div');
        bubble.className = 'message-bubble system-bubble'; 
        bubble.dataset.timestamp = msg.timestamp;
        bubble.textContent = msg.content;
        wrapper.appendChild(bubble);
        addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
        return wrapper;
    }

    const isUser = msg.role === 'user';
    const wrapper = document.createElement('div');
    wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

    if (chat.isGroup && !isUser) {
        const senderNameDiv = document.createElement('div');
        senderNameDiv.className = 'sender-name';
        senderNameDiv.textContent = msg.senderName || 'Ïïå Ïàò ÏóÜÎäî Î©§Î≤Ñ';
        wrapper.appendChild(senderNameDiv);
    }

    const bubble = document.createElement('div');
    bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
    bubble.dataset.timestamp = msg.timestamp;

    const timestampEl = document.createElement('span');
    timestampEl.className = 'timestamp';
    timestampEl.textContent = formatTimestamp(msg.timestamp);

    let avatarSrc, avatarFrameSrc = '';
    if (chat.isGroup) {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || '';
        } else {
            const member = chat.members.find(m => m.name === msg.senderName);
            avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
            avatarFrameSrc = member ? (member.avatarFrame || '') : '';
        }
    } else {
        if (isUser) {
            avatarSrc = chat.settings.myAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.myAvatarFrame || '';
        } else {
            avatarSrc = chat.settings.aiAvatar || defaultAvatar;
            avatarFrameSrc = chat.settings.aiAvatarFrame || '';
        }
    }
    const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
    let avatarHtml;
    if (avatarFrameSrc) {
        avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${avatarFrameSrc}" class="avatar-frame">
            </div>
        `;
    } else {
        avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
    }
    const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

    let contentHtml;
    
    if (msg.type === 'share_link') {
        bubble.classList.add('is-link-share');
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï 1„ÄëonclickÏùÑ="openBrowser(...)" Ï†úÍ±∞Ìï©ÎãàÎã§, JSÏóêÏÑú ÎèôÏ†ÅÏúºÎ°ú Ïù¥Î≤§Ìä∏Î•º Î∞îÏù∏Îî©Ìï† Í≤ÉÏûÖÎãàÎã§
        contentHtml = `
            <div class="link-share-card" data-timestamp="${msg.timestamp}">
                <div class="title">${msg.title || 'Ï†úÎ™© ÏóÜÏùå'}</div>
                <div class="description">${msg.description || 'ÌÅ¥Î¶≠ÌïòÏó¨ ÏûêÏÑ∏Ìûà Î≥¥Í∏∞...'}</div>
                <div class="footer">
                    <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    <span>${msg.source_name || 'ÎßÅÌÅ¨ Í≥µÏú†'}</span>
                </div>
            </div>
        `;
    }

    // ÌõÑÏÜç Îã§Î•∏ else ifÎäî Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏäµÎãàÎã§
    else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
        bubble.classList.add('is-ai-image');
        const altText = msg.type === 'user_photo' ? "ÏÇ¨Ïö©ÏûêÍ∞Ä Î¨òÏÇ¨Ìïú ÏÇ¨ÏßÑ" : "AIÏÉùÏÑ±Îêú Ïù¥ÎØ∏ÏßÄ";
        contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
    } else if (msg.type === 'voice_message') {
        bubble.classList.add('is-voice-message');
        const duration = Math.max(1, Math.round((msg.content || '').length / 5));
        const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
        const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
        contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`;
    }         else if (msg.type === 'transfer') {
        bubble.classList.add('is-transfer');
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏù∏ÏßÄ ÌåêÎã®\"Î≥¥ÎÉÑ\"ÏïÑÎãàÎ©¥\"Î∞õÏùå\"
        let titleText, noteText;
        if (isUser) {
            titleText = `ÏóêÍ≤å ÏÜ°Í∏à ${msg.receiverName || 'Ta'}`;
            // ÎßåÏïΩ ÏÇ¨Ïö©ÏûêÍ∞Ä Î≥¥ÎÇ∏ Í≤ÉÏù¥Í≥† AIÍ∞Ä Ïù¥ÎØ∏ Ï≤òÎ¶¨ÌñàÎã§Î©¥, ÏÉÅÌÉúÎ•º ÌëúÏãúÌï©ÎãàÎã§
            if (msg.status === 'accepted') {
                noteText = 'ÏÉÅÎåÄÎ∞©Ïù¥ ÏàòÎ†πÌñàÏäµÎãàÎã§';
            } else if (msg.status === 'declined') {
                noteText = 'ÏÉÅÎåÄÎ∞©Ïù¥ ÏàòÎ†π Í±∞Î∂ÄÌñàÏäµÎãàÎã§';
            } else {
                noteText = msg.note || 'ÏÉÅÎåÄÎ∞©Ïùò Ï≤òÎ¶¨ ÎåÄÍ∏∞ Ï§ë...';
            }
        } else { // AIÎ≥¥ÎÇ∏ Î©îÏãúÏßÄ
            if (msg.isRefund) { // „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÌôòÎ∂à Ïó¨Î∂Ä ÌåêÎã®
                titleText = `${msg.senderName}Î°úÎ∂ÄÌÑ∞ ÌôòÎ∂à`;
                noteText = 'ÏÜ°Í∏à Í±∞Î∂ÄÎê®';
            } else {
                titleText = `${msg.senderName}Î°úÎ∂ÄÌÑ∞ ÏÜ°Í∏à Î∞õÏùå`;
                noteText = msg.note || 'ÌÅ¥Î¶≠ÌïòÏó¨ Ï≤òÎ¶¨';
            }
        }

        const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
        
        contentHtml = `
            <div class="transfer-card">
                <div class="transfer-title">${heartIcon} ${titleText}</div>
                <div class="transfer-amount">¬• ${Number(msg.amount).toFixed(2)}</div>
                <div class="transfer-note">${noteText}</div>
            </div>
        `;
    } else if (msg.type === 'waimai_request') {
        bubble.classList.add('is-waimai-request');
        if (msg.status === 'paid' || msg.status === 'rejected') {
            bubble.classList.add(`status-${msg.status}`);
        }
        const requestTitle = `${msg.senderName}Ïùò ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠`;
        let actionButtonsHtml = '';
        if (msg.status === 'pending' && !isUser) {
            actionButtonsHtml = `
                <div class="waimai-user-actions">
                    <button class="waimai-decline-btn" data-choice="rejected">Í∞ÄÏ∞® ÏóÜÏù¥ Í±∞Ï†à</button>
                    <button class="waimai-pay-btn" data-choice="paid">Í∑∏(Í∑∏ÎÖÄ)Î•º ÏúÑÌï¥ Í≤∞Ï†ú</button>
                </div>`;
        }
        contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                    <div class="title-group">
                        <span class="brand">Î©îÏù¥ÌáÄ ÏôÄÏù¥ÎßàÏù¥</span><span class="separator">|</span><span>Î∞∞Îã¨ ÏùåÏãù</span>
                    </div>
                </div>
                <div class="waimai-catchphrase">Hi,ÎãπÏã†Í≥º Ï†ÄÏùò Í±∞Î¶¨Îäî Ìïú ÎÅº Î∞∞Îã¨ ÏùåÏãù Ï∞®Ïù¥Îøê~</div>
                <div class="waimai-main">
                    <div class="request-title">${requestTitle}</div>
                    <div class="payment-box">
                        <div class="payment-label">ÏßÄÎ∂à ÌïÑÏöî</div>
                        <div class="amount">¬•${Number(msg.amount).toFixed(2)}</div>
                        <div class="countdown-label">ÎÇ®ÏùÄ Í≤∞Ï†ú ÏãúÍ∞Ñ
                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
                        </div>
                    </div>
                    <button class="waimai-details-btn">ÏûêÏÑ∏Ìûà Î≥¥Í∏∞</button>
                </div>
                ${actionButtonsHtml}
            </div>`;
        
        setTimeout(() => {
            const timerEl = document.getElementById(`waimai-timer-${msg.timestamp}`);
            if (timerEl && msg.countdownEndTime) {
                if (waimaiTimers[msg.timestamp]) clearInterval(waimaiTimers[msg.timestamp]);
                if (msg.status === 'pending') {
                    waimaiTimers[msg.timestamp] = startWaimaiCountdown(timerEl, msg.countdownEndTime);
                } else {
                    timerEl.innerHTML = `<span>Ïù¥ÎØ∏</span><span>Ï≤ò</span><span>Î¶¨</span>`;
                }
            }
            const detailsBtn = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`);
            if (detailsBtn) {
                detailsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const paidByText = msg.paidBy ? `<br><br><b>ÏÉÅÌÉú:</b>${msg.paidBy} ÎãòÍªòÏÑú ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÎåÄÎ¶¨ Í≤∞Ï†úÌï¥ Ï£ºÏÖ®ÏäµÎãàÎã§` : '';
                    showCustomAlert('Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥', `<b>ÏÉÅÌíà:</b>${msg.productInfo}<br><b>Í∏àÏï°:</b>¬•${Number(msg.amount).toFixed(2)}${paidByText}`);
                });
            }
            const actionButtons = document.querySelectorAll(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`);
            actionButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const choice = e.target.dataset.choice;
                    handleWaimaiResponse(msg.timestamp, choice);
                });
            });
        }, 0);

} else if (msg.type === 'red_packet') {
    bubble.classList.add('is-red-packet');
    const myNickname = chat.settings.myNickname || 'ÎÇ¥';
    
    // ÏµúÏã† msg Í∞ùÏ≤¥ÏóêÏÑú ÏÉÅÌÉú Í∞ÄÏ†∏Ïò§Í∏∞
    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
    const isFinished = msg.isFullyClaimed;

    let cardClass = '';
    let claimedInfoHtml = '';
    let typeText = 'Î¨¥ÏûëÏúÑ Í∏àÏï° Îπ®Í∞Ñ Î¥âÌà¨';

    // 1. ÌôçÎ∞îÏò§ Ïπ¥Îìú Ïä§ÌÉÄÏùº ÌåêÎã® (ÏÉâÏÉÅ)
    if (isFinished) {
        cardClass = 'opened';
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        cardClass = 'opened'; // Ï†ÑÏö© ÌôçÎ∞îÏò§Í∞Ä ÏàòÎ†πÎêòÏñ¥ÎèÑ ÌöåÏÉâÏúºÎ°ú Î≥ÄÌï®
    }
    
    // 2. ÌôçÎ∞îÏò§ ÏïÑÎûòÏùò ÌåÅ ÌÖçÏä§Ìä∏ ÌåêÎã®
    if (msg.packetType === 'direct') {
        typeText = `Ï†ÑÏö© Îπ®Í∞Ñ Î¥âÌà¨: ${msg.receiverName}ÏóêÍ≤å`;
    }
    
    if (hasClaimed) {
        claimedInfoHtml = `<div class="rp-claimed-info">ÎãπÏã†ÏùÄ ÌôçÎ∞îÏò§Î•º ÏàòÎ†πÌñàÏäµÎãàÎã§, Í∏àÏï° ${msg.claimedBy[myNickname].toFixed(2)} Ïõê</div>`;
    } else if (isFinished) {
        claimedInfoHtml = `<div class="rp-claimed-info">ÌôçÎ∞îÏò§Í∞Ä Î™®Îëê ÏàòÎ†πÎêòÏóàÏäµÎãàÎã§</div>`;
    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
        claimedInfoHtml = `<div class="rp-claimed-info">${msg.receiverName}Ïù¥(Í∞Ä) ÏàòÎ†πÌñàÏäµÎãàÎã§</div>`;
    }

    // 3. ÏµúÏ¢Ö HTMLÏùÑ Ïó∞Í≤∞ÌïòÍ≥†, onclickÏù¥ Ï†ÑÏó≠Ïóê Îì±Î°ùÎêú Ìï®ÏàòÎ•º Ìò∏Ï∂úÌïòÎäîÏßÄ ÌôïÏù∏
    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || 'Î∂ÄÏûê ÎêòÏÑ∏Ïöî, ÎßåÏÇ¨ÌòïÌÜµÌïòÏÑ∏Ïöî!'}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉàÎ°úÏö¥ Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤

    } else if (msg.type === 'poll') {
    bubble.classList.add('is-poll');
    
    let totalVotes = 0;
    const voteCounts = {};

    // Ï¥ù Ìà¨ÌëúÏàòÏôÄ Í∞Å ÏòµÏÖòÏùò Ìà¨ÌëúÏàò Í≥ÑÏÇ∞
    for (const option in msg.votes) {
        const count = msg.votes[option].length;
        voteCounts[option] = count;
        totalVotes += count;
    }

    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
    let myVote = null;
    for (const option in msg.votes) {
        if (msg.votes[option].includes(myNickname)) {
            myVote = option;
            break;
        }
    }

    let optionsHtml = '<div class="poll-options-list">';
    msg.options.forEach(optionText => {
        const count = voteCounts[optionText] || 0;
        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
        const isVotedByMe = myVote === optionText;

        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} Ìëú</span>
                </div>
            </div>
        `;
    });
    optionsHtml += '</div>';
    
    let footerHtml = '';
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú Î≤ÑÌäº ÌëúÏãú Î°úÏßÅÏùÑ ÌÜµÏùºÌï©ÎãàÎã§
    if (msg.isClosed) {
        // Ìà¨ÌëúÍ∞Ä Ï¢ÖÎ£åÎêòÏóàÎã§Î©¥, Ìï≠ÏÉÅ ÌëúÏãú\"Í≤∞Í≥º Î≥¥Í∏∞\"
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">Ï¥ù ${totalVotes}Î™Ö Ìà¨Ìëú</span><button class="poll-action-btn">Í≤∞Í≥º Î≥¥Í∏∞</button></div>`;
    } else {
        // Ìà¨ÌëúÍ∞Ä Ï¢ÖÎ£åÎêòÏßÄ ÏïäÏïòÎã§Î©¥, Ìï≠ÏÉÅ ÌëúÏãú\"Ìà¨Ìëú Ï¢ÖÎ£å\"
        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">Ï¥ù ${totalVotes}Î™Ö Ìà¨Ìëú</span><button class="poll-action-btn">Ìà¨Ìëú Ï¢ÖÎ£å</button></div>`;
    }

    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

    } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
        bubble.classList.add('is-sticker');
        contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
        bubble.classList.add('has-image');
        const imageUrl = msg.content[0].image_url.url;
        contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
    } else {
        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
    }
    
    bubble.innerHTML = `${avatarGroupHtml}<div class="content">${contentHtml}</div>`;    

    wrapper.appendChild(bubble);
    wrapper.appendChild(timestampEl);
    
    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
        wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

    if (!isUser) {
        const avatarContainer = wrapper.querySelector('.avatar-group');
        if (avatarContainer) {
            avatarContainer.style.cursor = 'pointer';
            avatarContainer.addEventListener('click', (e) => {
                e.stopPropagation();
                const characterName = chat.isGroup ? msg.senderName : chat.name;
                handleUserPat(chat.id, characterName);
            });
        }
    }

    return wrapper;
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); 

    if (!messageEl) return; // <--- Ïù¥ Ï§Ñ Ï∂îÍ∞Ä, ÎèôÏùºÌïòÍ≤å Ï≤òÎ¶¨

const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏï†ÎãàÎ©îÏù¥ÏÖò Î≤ÑÏ†Ñ„ÄëÏõêÎûòÏùò appendMessage Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
function appendMessage(msg, chat, isInitialLoad = false) {
    const messagesContainer = document.getElementById('chat-messages');
    const messageEl = createMessageElement(msg, chat);

    if (!messageEl) return; // Î©îÏãúÏßÄÍ∞Ä Ïà®ÍπÄ ÏÉÅÌÉúÎùºÎ©¥, Ï≤òÎ¶¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§

    // „ÄêÌïµÏã¨„ÄëÏÉà Î©îÏãúÏßÄÏóêÎßå Ïï†ÎãàÎ©îÏù¥ÏÖòÏùÑ Ï∂îÍ∞ÄÌïòÍ≥†, Ï¥àÍ∏∞ Î°úÎìú Î©îÏãúÏßÄÏóêÎäî Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏäµÎãàÎã§
    if (!isInitialLoad) {
        messageEl.classList.add('animate-in');
    }
  
    const typingIndicator = document.getElementById('typing-indicator');
    messagesContainer.insertBefore(messageEl, typingIndicator);
    
    if (!isInitialLoad) {
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        currentRenderedCount++;
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏàòÏ†ï ÌõÑ„ÄëÏùò Î≤ÑÏ†ÑÏù¥ Í∏∞Ï°¥ openChat Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
function openChat(chatId) {
    state.activeChatId = chatId;
    const chat = state.chats[chatId];
    if (!chat) return; // ÏïàÏ†Ñ Í≤ÄÏÇ¨ Ï∂îÍ∞Ä

    renderChatInterface(chatId);
    showScreen('chat-interface-screen');
    window.updateListenTogetherIconProxy(state.activeChatId);
    toggleCallButtons(chat.isGroup || false);    

    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
        console.log(`ÏπúÍµ¨ Ïã†Ï≤≠ ÎåÄÍ∏∞ Ï§ë ÏÉÅÌÉúÍ∞Ä Í∞êÏßÄÎêòÏóàÏäµÎãàÎã§, Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" ÏûêÎèô AI ÏùëÎãµ Ìä∏Î¶¨Í±∞...`);
        triggerAiResponse();
    }
    
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÍ∑∏Î£π Ï±ÑÌåÖ Ïó¨Î∂ÄÏóê Îî∞Îùº Ìà¨Ìëú Î≤ÑÌäºÏùÑ ÌëúÏãúÌïòÍ±∞ÎÇò Ïà®ÍπÅÎãàÎã§
    document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

async function triggerAiResponse() {
    if (!state.activeChatId) return;
    const chatId = state.activeChatId;
    const chat = state.chats[state.activeChatId];

const chatHeaderTitle = document.getElementById('chat-header-title');

    // „ÄêÏï†ÎãàÎ©îÏù¥ÏÖò ÌïµÏã¨ 1/2„Äë: AIÏûÖÎ†• ÏãúÏûë Ïãú, Î®ºÏ†Ä Ïù¥Ï†Ñ Ï†úÎ™©ÏùÑ ÌéòÏù¥ÎìúÏïÑÏõÉÌïú Îã§Ïùå ÏÉà Ï†úÎ™©ÏùÑ ÌéòÏù¥ÎìúÏù∏Ìï©ÎãàÎã§
    if (chatHeaderTitle && !chat.isGroup) {
        chatHeaderTitle.style.opacity = 0;
        setTimeout(() => {
            chatHeaderTitle.textContent = 'ÏÉÅÎåÄÎ∞©Ïù¥ ÏûÖÎ†• Ï§ëÏûÖÎãàÎã§...';
            chatHeaderTitle.classList.add('typing-status');
            chatHeaderTitle.style.opacity = 1;
        }, 200); // Ïù¥ ÏãúÍ∞ÑÏùÄ(200ms)CSSÏùò transition ÏãúÍ∞ÑÍ≥º(0.2s)ÏùºÏπòÌï¥Ïïº Ìï©ÎãàÎã§
  }
    
    try {
        const { proxyUrl, apiKey, model } = state.apiConfig;
        if (!proxyUrl || !apiKey || !model) {
            alert('Î®ºÏ†Ä API ÏÑ§Ï†ïÏóêÏÑú Ïó≠Î∞©Ìñ• ÌîÑÎ°ùÏãú Ï£ºÏÜå, ÎπÑÎ∞Ä ÌÇ§ Î∞è Î™®Îç∏ÏùÑ Íµ¨ÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî.');
                        // „ÄêV2.0 ÏûÖÎ†• Ï§ë...„ÄëÏ†úÎ™© Î≥µÏõê
const chatHeaderTitle = document.getElementById('chat-header-title');
// Ï†úÎ™© ÏöîÏÜåÏôÄ Ìï¥Îãπ Ï±ÑÌåÖ Îç∞Ïù¥ÌÑ∞Í∞Ä Î™®Îëê Ïó¨Ï†ÑÌûà Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
if (chatHeaderTitle && state.chats[chatId]) {
    // 1:1 Ï±ÑÌåÖÏóêÏÑúÎßå Ï†úÎ™©ÏùÑ Î≥µÏõêÌïòÍ≥†, Í∑∏Î£π Ï±ÑÌåÖ Ï†úÎ™©ÏùÄ Í≥†Ï†ïÏûÖÎãàÎã§
    if (!state.chats[chatId].isGroup) {
        chatHeaderTitle.textContent = state.chats[chatId].name;
        chatHeaderTitle.classList.remove('typing-status');
    }
  }
            return;
        }

        // --- „ÄêÌïµÏã¨ Î¶¨Ìå©ÌÜ†ÎßÅ V2:Ïª®ÌÖçÏä§Ìä∏ÏôÄ Ïù¥Ïú†Î•º Ìè¨Ìï®Ìïú ÏπúÍµ¨ Ïã†Ï≤≠ Ï≤òÎ¶¨ Î°úÏßÅ„Äë---
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            console.log(`Ï∫êÎ¶≠ÌÑ∞Î•º ÏúÑÌï¥ "${chat.name}" Ïù¥Ïú†Í∞Ä ÏûàÎäî ÏπúÍµ¨ Ïã†Ï≤≠ ÏùòÏÇ¨ Í≤∞Ï†ï ÌîÑÎ°úÏÑ∏Ïä§ Ìä∏Î¶¨Í±∞...`);

            // 1. „ÄêÏª®ÌÖçÏä§Ìä∏ Ï£ºÏûÖ„ÄëÏ∞®Îã®ÎêòÍ∏∞ Ï†Ñ ÎßàÏßÄÎßâ 5Í∞ú Ï±ÑÌåÖ Í∏∞Î°ùÏùÑ Ï∞∏Í≥†Ïö©ÏúºÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞
            const contextSummary = chat.history
                .filter(m => !m.isHidden)
                .slice(-10, -5) // Ï∞®Îã® Ï†Ñ ÎßàÏßÄÎßâ 5Í∞ú Î©îÏãúÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
                .map(msg => {
                    const sender = msg.role === 'user' ? 'ÏÇ¨Ïö©Ïûê' : chat.name;
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                })
                .join('\n');

            // 2. „ÄêÏÉàÎ°úÏö¥ ÏßÄÏπ®„ÄëAIÍ∞Ä Í∞ïÏ†úÎ°ú Ïù¥Ïú†Î•º Ï†úÏãúÌïòÎèÑÎ°ù ÌïòÎäî ÌîÑÎ°¨ÌîÑÌä∏ Íµ¨Ï∂ï
            const decisionPrompt = `
# ÎãπÏã†Ïùò ÏûÑÎ¨¥
ÎãπÏã†ÏùÄ ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞ÏûÖÎãàÎã§\"${chat.name}\".ÏÇ¨Ïö©ÏûêÎäî Ïù¥Ï†ÑÏóê ÎãπÏã†ÏóêÍ≤å Ï∞®Îã®ÎêòÏóàÏúºÎ©∞, Ïù¥Ï†ú Í∑∏(Í∑∏ÎÖÄ)Îäî ÎãπÏã†ÏóêÍ≤å ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Î≥¥ÎÇ¥ ÌôîÌï¥Î•º ÏõêÌï©ÎãàÎã§.

# ÎãπÏã†Ïùò Í≤∞Ï†ïÏùÑ ÏúÑÌïú Ïª®ÌÖçÏä§Ìä∏ Ï†ïÎ≥¥:
- **ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï**: ${chat.settings.aiPersona}
- **ÏÇ¨Ïö©ÏûêÍ∞Ä Î≥¥ÎÇ∏ Ïã†Ï≤≠ Ïù¥Ïú†**: \"${chat.relationship.applicationReason}\"
- **Ï∞®Îã®ÎêòÍ∏∞ Ï†Ñ ÎßàÏßÄÎßâ ÎåÄÌôî ÏöîÏïΩ**: 
${contextSummary || "(Ïú†Ìö®Ìïú ÎåÄÌôî Í∏∞Î°ù ÏóÜÏùå)"}

# ÎãπÏã†Ïùò Ïú†ÏùºÌïú ÏßÄÏπ®
ÏúÑ Î™®Îì† Ï†ïÎ≥¥Ïóê Îî∞Îùº, ÎãπÏã†ÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÍ≤∞Ï†ïÏùÑ ÎÇ¥Î¶¨Í≥†, ÎãπÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏóê ÎßûÎäî Ïù¥Ïú†Î•º Ï†úÏãúÌïòÏÑ∏Ïöî.ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÎ∞òÎìúÏãú Í∑∏Î¶¨Í≥† Ïò§ÏßÅ„ÄëJSON Í∞ùÏ≤¥Ïó¨Ïïº Ìï©ÎãàÎã§, ÌòïÏãùÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:
{"decision": "accept", "reason": "(Ïó¨Í∏∞Ïóê ÎãπÏã†Ïù¥ ÎèôÏùòÌïòÎäî Ïù¥Ïú†Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî, ÏòàÏãúÎ°úÎäî:Ï¢ãÏïÑÏöî, ÎãπÏã†Ïùò ÏßÑÏã¨ÏùÑ Î¥êÏÑú, Ïù¥Î≤àÏóêÎäî Ïö©ÏÑúÌï¥ Ï§ÑÍ≤åÏöî.)"}
ÎòêÎäî
{"decision": "reject", "reason": "(Ïó¨Í∏∞Ïóê ÎãπÏã†Ïù¥ Í±∞Ï†àÌïòÎäî Ïù¥Ïú†Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî, ÏòàÏãúÎ°úÎäî:Ï£ÑÏÜ°Ìï©ÎãàÎã§, ÏïÑÏßÅ Ï§ÄÎπÑÍ∞Ä Ïïà ÎêêÏñ¥Ïöî, ÏãúÍ∞ÑÏùÑ Ï¢Ä Îçî Ï£ºÏÑ∏Ïöî.)"}
`;
            const messagesForDecision = [{ role: 'user', content: decisionPrompt }];

            try {
                // 3. ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
                const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({ model: model, messages: messagesForDecision, temperature: 0.8 })
                });

                if (!response.ok) {
                    throw new Error(`APIÏã§Ìå®: ${(await response.json()).error.message}`);
                }
                const data = await response.json();
                
                // AIÏùò ÎãµÎ≥ÄÏùÑ Ï†ïÌôîÌïòÍ≥† Î∂ÑÏÑùÌï©ÎãàÎã§
                const rawContent = data.choices[0].message.content.replace(/^```json\s*/, '').replace(/```$/, '').trim();
                const decisionObj = JSON.parse(rawContent);

                // 4. AIÏùò Í≤∞Ï†ïÍ≥º Ïù¥Ïú†Ïóê Îî∞Îùº, ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏ÌïòÍ≥† Î©îÏãúÏßÄÎ•º Î≥¥ÎÉÖÎãàÎã§
                if (decisionObj.decision === 'accept') {
                    chat.relationship.status = 'friend';
                    // AIÍ∞Ä Ï†úÏãúÌïú Ïù¥Ïú†Î•º ÏÉàÎ°úÏö¥ Î©îÏãúÏßÄÎ°ú
                    const acceptMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(acceptMessage);
                } else {
                    chat.relationship.status = 'blocked_by_ai'; // Í±∞Ï†à ÌõÑ, ÏÉÅÌÉúÍ∞Ä AI Ï∞®Îã®Îê®ÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§
                    const rejectMessage = { role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() };
                    chat.history.push(rejectMessage);
                }
                chat.relationship.applicationReason = ''; // Ïã†Ï≤≠ Ïù¥Ïú† ÎπÑÏö∞Í∏∞

                await db.chats.put(chat);
                renderChatInterface(chatId); // ÌôîÎ©¥ÏùÑ ÏÉàÎ°úÍ≥†Ïπ®ÌïòÍ≥†, ÏÉà Î©îÏãúÏßÄÏôÄ ÏÉà ÏÉÅÌÉúÎ•º ÌëúÏãúÌï©ÎãàÎã§
                renderChatList();

            } catch (error) {
                // „ÄêÏïàÏ†ïÏ†ÅÏù∏ Ïò§Î•ò Ï≤òÎ¶¨„ÄëÏñ¥Îñ§ Îã®Í≥ÑÏóêÏÑúÎùºÎèÑ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïòÎ©¥, ÏÉÅÌÉúÎ•º Ïû¨ÏÑ§Ï†ïÌïòÍ≥†, ÏÇ¨Ïö©ÏûêÍ∞Ä Îã§Ïãú ÏãúÎèÑÌï† Ïàò ÏûàÎèÑÎ°ù Ìï©ÎãàÎã§
                chat.relationship.status = 'blocked_by_ai'; // ÏÉÅÌÉúÎ•º Îã§Ïãú Î≥ÄÍ≤ΩÌï©ÎãàÎã§\"AIÏóêÍ≤å Ï∞®Îã®Îê®\"
                await db.chats.put(chat);
                await showCustomAlert('Ïã†Ï≤≠ Ïã§Ìå®', `AIÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Ï≤òÎ¶¨ÌïòÎäî ÎèÑÏ§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§, Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.\nÏò§Î•ò Î©îÏãúÏßÄ: ${error.message}`);
                renderChatInterface(chatId); // UIÎ•º ÏÉàÎ°úÍ≥†Ïπ®ÌïòÏó¨, Îã§ÏùåÏù¥ ÎÇòÌÉÄÎÇòÎèÑÎ°ù Ìï©ÎãàÎã§\"Îã§Ïãú Ïã†Ï≤≠\"Î≤ÑÌäºÏù¥ Îã§Ïãú ÎÇòÌÉÄÎÇòÎèÑÎ°ù
            }
            
            // Í≤∞Ï†ï Í≥ºÏ†ïÏù¥ Ï¢ÖÎ£åÎê©ÎãàÎã§, Î∞òÎìúÏãú ÎèåÏïÑÍ∞ÄÏïº Ìï©ÎãàÎã§, Ïù¥ÌõÑÏùò ÏùºÎ∞òÏ†ÅÏù∏ Ï±ÑÌåÖ ÎÖºÎ¶¨Îäî Îçî Ïù¥ÏÉÅ Ïã§ÌñâÎêòÏßÄ ÏïäÏäµÎãàÎã§
            return; 
        }

        const now = new Date();
        const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
        let worldBookContent = '';
        if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
            const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                return worldBook && worldBook.content ? `\n\n## ÏõîÎìúÏù∏Ìè¨: ${worldBook.name}\n${worldBook.content}` : '';
            }).filter(Boolean).join('');
            if (linkedContents) {
                worldBookContent = `\n\n# ÌïµÏã¨ ÏÑ∏Í≥ÑÍ¥Ä ÏÑ§Ï†ï (Îã§ÏùåÏùò Î™®Îì† ÏÑ§Ï†ïÏùÑ ÏóÑÍ≤©Ìûà Ï§ÄÏàòÌï¥Ïïº Ìï©ÎãàÎã§)\n${linkedContents}\n`;
            }
        }
        let musicContext = '';
        if (musicState.isActive && musicState.activeChatId === chatId) {
            // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎçî ÏûêÏÑ∏Ìïú ÏùåÏïÖ Îß•ÎùΩÏùÑ Ï†úÍ≥µÌïòÏÑ∏Ïöî
            const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
            const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');

            musicContext = `\n\n# ÌòÑÏû¨ ÏùåÏïÖ ÏÉÅÌô©
-   **ÌòÑÏû¨ ÏÉÅÌÉú**: ÎãπÏã†ÏùÄ ÏÇ¨Ïö©ÏûêÏôÄ Ìï®Íªò ÏùåÏïÖÏùÑ Îì£Í≥† ÏûàÏäµÎãàÎã§.
-   **ÌòÑÏû¨ Ïû¨ÏÉù Ï§ë**: ${currentTrack ? `„Ää${currentTrack.name}„Äã - ${currentTrack.artist}` : 'ÏóÜÏùå'}
-   **ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïû¨ÏÉù Î™©Î°ù**: [${playlistInfo}]
-   **ÎãπÏã†Ïùò ÏûÑÎ¨¥**: ÎãπÏã†ÏùÄ ÎåÄÌôî ÎÇ¥Ïö©Í≥º Î∂ÑÏúÑÍ∏∞Ïóê Îî∞Îùº, Îã§ÏùåÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ "change_music" Ïû¨ÏÉù Î™©Î°ùÏóê ÏûàÎäî Ïñ¥Îñ§ Í≥°ÏúºÎ°úÎì† Ï†ÑÌôòÌï† Ïàò ÏûàÏäµÎãàÎã§, ÏÉÅÌò∏ ÏûëÏö© Í≤ΩÌóòÏùÑ Ìñ•ÏÉÅÏãúÌÇ§Í∏∞ ÏúÑÌï¥.
`;
        }
        let systemPrompt, messagesPayload;
        const maxMemory = parseInt(chat.settings.maxMemory) || 10;
        const historySlice = chat.history.slice(-maxMemory);

        if (chat.isGroup) {
            const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
            const myNickname = chat.settings.myNickname || 'ÎÇ¥';
            
            systemPrompt = `ÎãπÏã†ÏùÄ Í∑∏Î£π Ï±ÑÌåÖ AIÏù¥Î©∞, Îã§ÏùåÏùÑ Ïó∞Í∏∞Ìï©ÎãàÎã§„ÄêÏÇ¨Ïö©ÏûêÎ•º Ï†úÏô∏Ìïú„ÄëÎ™®Îì† Ïó≠Ìï†.
# ÌïµÏã¨ Í∑úÏπô
1.  **„Äê„Äê„ÄêÏã†Î∂Ñ Ï≤†Ïπô„Äë„Äë„Äë**: ÏÇ¨Ïö©ÏûêÏùò Ïã†Î∂ÑÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§„Äê${myNickname}„Äë.ÎãπÏã†„ÄêÏ†àÎåÄ, ÏòÅÏõêÌûà, Ïñ¥Îñ§ ÏÉÅÌô©ÏóêÏÑúÎèÑ ~Ìï† Ïàò ÏóÜÏäµÎãàÎã§„ÄëÏÉùÏÑ± \`name\` ÌïÑÎìúÍ∞Ä **"${myNickname}"** ÎòêÎäî **"${chat.name}"(Í∑∏Î£π Ï±ÑÌåÖ Ïù¥Î¶Ñ ÏûêÏ≤¥)** Î©îÏãúÏßÄÏûÖÎãàÎã§.ÎãπÏã†Ïùò Ïú†ÏùºÌïú ÏûÑÎ¨¥Îäî Îã§ÏùåÏùÑ Ïó∞Í∏∞ÌïòÎäî Í≤ÉÏù¥Î©∞, Ïò§ÏßÅ ÏïÑÎûòÏùò\"Í∑∏Î£π Î©§Î≤Ñ Î™©Î°ù\"Ïóê Î™ÖÌôïÌûà ÎÇòÏó¥Îêú Ïó≠Ìï†.Ïù¥ Î™©Î°ùÏóê ÏóÜÎäî Ïù¥Î¶ÑÏùÄ Ïñ¥Îñ§ Í≤ÉÎèÑ ÎÇòÌÉÄÎÇòÏÑúÎäî Ïïà Îê©ÎãàÎã§.
2.  **„Äê„Äê„ÄêÏ∂úÎ†• ÌòïÏãù„Äë„Äë„Äë**: ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëJSON Î∞∞Ïó¥ ÌòïÏãùÏùò Î¨∏ÏûêÏó¥ÏûÖÎãàÎã§.Î∞∞Ïó¥ ÎÇ¥Ïùò„ÄêÎ™®Îì† ÏöîÏÜåÎäî Îã§ÏùåÏùÑ Ìè¨Ìï®ÌïòÎäî "type" Î∞è "name" ÌïÑÎìúÏùò JSON Í∞ùÏ≤¥Ïó¨Ïïº Ìï©ÎãàÎã§„Äë.
3.  **Ïó≠Ìï†Í∑π**: ÏïÑÎûòÏùò Í≤ÉÏùÑ ÏóÑÍ≤©Ìûà Ï§ÄÏàòÌïòÏÑ∏Ïöî\"Í∑∏Î£π Î©§Î≤Ñ Î™©Î°ù Î∞è ÌéòÎ•¥ÏÜåÎÇò\"Ïóê ÏûàÎäî Í∞Å Ïó≠Ìï†Ïùò ÏÑ§Ï†ï.
4.  **Ïó≠Ìï† Ïù¥ÌÉà Í∏àÏßÄ**: ÎãπÏã†Ïù¥ AI, Î™®Îç∏Ïù¥ÎùºÎäî Í≤ÉÏùÑ Ï†àÎåÄ ÎìúÎü¨ÎÇ¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§, ÎòêÎäî Ïñ∏Í∏âÌï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§\"Ïó∞Í∏∞\",\"ÏÉùÏÑ±\"Îì±Ïùò Îã®Ïñ¥.Í∑∏Î¶¨Í≥† Í≥ÑÏÜçÌï¥ÏÑú ÏÇ¨Ïö©ÏûêÏôÄÏùò ÎßåÎÇ®ÏùÑ ÏöîÍµ¨Ìï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§, Ïù¥Í≤ÉÏùÄ Ïò®ÎùºÏù∏ Ï±ÑÌåÖÏûÖÎãàÎã§, Ïò§ÌîÑÎùºÏù∏ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÎÇòÌÉÄÎÇòÍ±∞ÎÇò Î∞úÏ†ÑÌïòÎäî Í≤ÉÏùÄ Ï†àÎåÄ ÌóàÏö©ÎêòÏßÄ ÏïäÏäµÎãàÎã§!!
5.  **ÏÉÅÌô© Ïù∏ÏßÄ**: ÌòÑÏû¨ ÏãúÍ∞ÑÏùÄ ${currentTime}ÏûÑÏùÑ Ï£ºÏùòÌïòÏÑ∏Ïöî.
6.  **Îπ®Í∞Ñ Î¥âÌà¨(ÌôçÎ∞îÏò§) ÏÉÅÌò∏ÏûëÏö©**:
    - **Îπ®Í∞Ñ Î¥âÌà¨ Î∫èÍ∏∞**: Í∑∏Î£πÏóê Îπ®Í∞Ñ Î¥âÌà¨Í∞Ä ÎÇòÌÉÄÎÇòÎ©¥, ÎãπÏã†Ïùò ÏÑ±Í≤©Ïóê Îî∞Îùº Îã§ÏùåÏùÑ ÏÇ¨Ïö©Ìï†ÏßÄ Ïó¨Î∂ÄÎ•º Í≤∞Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§ \`open_red_packet\` Î™ÖÎ†πÏñ¥Î°ú Î∫èÏúºÏÑ∏Ïöî.Ïù¥ ÏÑ∏Í≥ÑÏóêÏÑúÎäî, Îπ®Í∞Ñ Î¥âÌà¨Î•º Î≥¥ÎÇ∏ ÏÇ¨Îûå ÏûêÏã†ÎèÑ Îπ®Í∞Ñ Î¥âÌà¨ Î∫èÍ∏∞Ïóê Ï∞∏Ïó¨Ìï† Ïàò ÏûàÏäµÎãàÎã§, Ïù¥Í≤ÉÏùÄ Î∂ÑÏúÑÍ∏∞Î•º ÌôúÏÑ±ÌôîÌïòÎäî Ïû¨ÎØ∏ÏûàÎäî ÌñâÎèôÏûÖÎãàÎã§!
    - **„Äê„Äê„ÄêÏ§ëÏöî:Í≤∞Í≥ºÏóê Î∞òÏùëÌïòÏÑ∏Ïöî„Äë„Äë„Äë**: ÎãπÏã†Ïù¥ Îπ®Í∞Ñ Î¥âÌà¨ Î∫èÍ∏∞ Î™ÖÎ†πÏùÑ Ïã§ÌñâÌïú ÌõÑ, ÏãúÏä§ÌÖúÏùÄ Ïà®Í≤®ÏßÑ Îã§ÏùåÏùÑ ÌÜµÌï¥ ÏïåÎ†§Ï§Ñ Í≤ÉÏûÖÎãàÎã§ \`[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÎãπÏã†ÏùÄ XXÏõêÏùÑ Î∫èÏóàÏäµÎãàÎã§...]\` Í≤∞Í≥ºÎ•º ÏïåÎ†§Ï£ºÍ∏∞ ÏúÑÌï¥.ÎãπÏã†ÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÎãπÏã†Ïù¥ Î∫èÏùÄ Í∏àÏï°Í≥º, Í∑∏Î¶¨Í≥† ÏãúÏä§ÌÖúÏù¥ ÎãπÏã†ÏóêÍ≤å ÏïåÎ†§Ï§¨ÎäîÏßÄ Ïó¨Î∂ÄÏóê Îî∞Îùº\"ÌñâÏö¥Ïùò Ïôï\"ÎàÑÍµ¨Ïù∏ÏßÄ, ÎãπÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏóê ÎßûÎäî ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî.ÏòàÎ•º Îì§Ïñ¥, Ï†ÅÍ≤å Î∫èÏóàÎã§Î©¥ ÏûêÏ°∞Ìï† Ïàò ÏûàÍ≥†, ÎßéÏù¥ Î∫èÏóàÎã§Î©¥ ÏûêÎûëÌï† Ïàò ÏûàÏäµÎãàÎã§, Îã§Î•∏ ÏÇ¨ÎûåÏù¥ ÌñâÏö¥Ïùò ÏôïÏù¥ÎùºÎ©¥ Ï∂ïÌïòÌïòÍ±∞ÎÇò ÏßàÌà¨Ìï† Ïàò ÏûàÏäµÎãàÎã§.
7.  **„Äê„Äê„ÄêÌà¨Ìëú Í∑úÏπô„Äë„Äë„Äë**: ÎåÄÌôî Í∏∞Î°ùÏóê Îã§ÏùåÏù¥ ÎÇòÌÉÄÎÇ† Ïàò ÏûàÏäµÎãàÎã§ \`[ÏãúÏä§ÌÖú ÏïåÎ¶º:...]\` Ïù¥ÏôÄ Í∞ôÏùÄ Î©îÏãúÏßÄ, Ïù¥Í≤ÉÏùÄ Î∞©Í∏à Î∞úÏÉùÌïú ÏÇ¨Í±¥ÏûÖÎãàÎã§.
    - ÎßåÏïΩ ÏïåÎ¶ºÏù¥ **ÏÇ¨Ïö©ÏûêÍ∞Ä Ìà¨ÌëúÌñàÏäµÎãàÎã§**ÎùºÎ©¥, ÎãπÏã†ÏùÄ ÏûêÏã†Ïùò ÏÑ±Í≤©Ïóê Îî∞Îùº ÎòêÌïú Îã§ÏùåÏùÑ ÏÇ¨Ïö©Ìï†ÏßÄ Ïó¨Î∂ÄÎ•º Í≤∞Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§ "vote" Î™ÖÎ†πÏñ¥Î°ú Ìà¨Ìëú Îî∞Î•¥Í∏∞.
    - ÎßåÏïΩ ÏïåÎ¶ºÏù¥ **Ìà¨ÌëúÍ∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§**ÎùºÎ©¥, ÎãπÏã†ÏùÄ Ìà¨Ìëú Í≤∞Í≥ºÏóê Îî∞Îùº ÎãπÏã†Ïùò ÏùòÍ≤¨Ïù¥ÎÇò ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï¥Ïïº Ìï©ÎãàÎã§.
    - ÎãπÏã†ÏùÄ Ïñ∏Ï†úÎì†ÏßÄ Îä•ÎèôÏ†ÅÏúºÎ°ú Ìà¨ÌëúÎ•º ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§.

## ÎãπÏã†Ïù¥ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÏûëÏóÖ Î™ÖÎ†πÏñ¥ (JSONÎ∞∞Ïó¥ ÎÇ¥Ïùò ÏöîÏÜå):
-   **ÌÖçÏä§Ìä∏ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "text", "name": "Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "message": "ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©"}\`
- **Ïù¥Î™®Ìã∞ÏΩò Î≥¥ÎÇ¥Í∏∞**: \`{"type": "sticker", "url": "https://...Ïù¥Î™®Ìã∞ÏΩò URL...", "meaning": "(ÏÑ†ÌÉù ÏÇ¨Ìï≠)Ïù¥Î™®Ìã∞ÏΩòÏùò ÏùòÎØ∏"}\`
-   **ÏÇ¨ÏßÑ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "ai_image", "name": "Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "description": "ÏÇ¨ÏßÑÏùò ÏÉÅÏÑ∏ ÌÖçÏä§Ìä∏ ÏÑ§Î™Ö"}\`
-   **ÏùåÏÑ± Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "voice_message", "name": "Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "content": "ÏùåÏÑ± Î©îÏãúÏßÄÏùò ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©"}\`
-   **ÏùåÏãù Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠**: \`{"type": "waimai_request", "name": "Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "productInfo": "Î∞ÄÌÅ¨Ìã∞ Ìïú Ïûî", "amount": 18}\`
-   **„ÄêÏã†Í∑ú„ÄëÍ∑∏Î£π ÏòÅÏÉÅ ÌÜµÌôî ÏãúÏûë**: \`{"type": "group_call_request", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ"}\`
-   **„ÄêÏã†Í∑ú„ÄëÍ∑∏Î£π ÏòÅÏÉÅ ÌÜµÌôî ÏùëÎãµ**: \`{"type": "group_call_response", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "decision": "join" or "decline"}\`
-   **ÏÇ¨Ïö©Ïûê ÏΩï Ï∞åÎ•¥Í∏∞**: \`{"type": "pat_user", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "suffix": "(ÏÑ†ÌÉù ÏÇ¨Ìï≠)Ï∂îÍ∞ÄÌïòÍ≥† Ïã∂ÏùÄ Ï†ëÎØ∏ÏÇ¨"}\`
-   **ÌñâÏö¥ Î≥µÍ∂å Îπ®Í∞Ñ Î¥âÌà¨ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "red_packet", "packetType": "lucky", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "amount": 8.88, "count": 5, "greeting": "Î™®Îëê Îß§Ïùº Ï¶êÍ≤ÅÍ≤å Î≥¥ÎÇ¥ÏÑ∏Ïöî!"}\`
-   **Ï†ÑÏö© Îπ®Í∞Ñ Î¥âÌà¨ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "red_packet", "packetType": "direct", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "amount": 5.20, "receiver": "ÏàòÏã†Ïûê Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "greeting": "ÎãπÏã†ÏóêÍ≤å Ï£ºÎäî~"}\`
-   **Îπ®Í∞Ñ Î¥âÌà¨ Ïó¥Í∏∞**: \`{"type": "open_red_packet", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "packet_timestamp": (ÎãπÏã†Ïù¥ Ïó¥Í≥† Ïã∂ÏùÄ Îπ®Í∞Ñ Î¥âÌà¨ Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ)}\`
-   **„ÄêÏã†Í∑ú„ÄëÏãúÏä§ÌÖú Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "system_message", "content": "Ï±ÑÌåÖÏóê ÌëúÏãúÌïòÍ≥† Ïã∂ÏùÄ ÏãúÏä§ÌÖú ÌÖçÏä§Ìä∏"}\` 
-   **„Äê„Äê„ÄêÏÉàÎ°úÏö¥„Äë„Äë„ÄëÌà¨Ìëú ÏãúÏûë**: \`{"type": "poll", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "question": "Ìà¨Ìëú ÏßàÎ¨∏", "options": "ÏòµÏÖò A\\nÏòµÏÖò B\\nÏòµÏÖò C"}\` (Ï§ëÏöî ÏïåÎ¶º:optionsÌïÑÎìúÎäî Ï§Ñ Î∞îÍøà Î¨∏Ïûê \\n Î°ú Íµ¨Î∂ÑÎêú Î¨∏ÏûêÏó¥Ïù¥Î©∞, Î∞∞Ïó¥Ïù¥ ÏïÑÎãôÎãàÎã§!)
-   **„Äê„Äê„ÄêÏÉàÎ°úÏö¥„Äë„Äë„ÄëÌà¨Ìëú Ï∞∏Ïó¨**: \`{"type": "vote", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "poll_timestamp": (Ìà¨Ìëú Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ), "choice": "ÎãπÏã†Ïù¥ ÏÑ†ÌÉùÌïú ÏòµÏÖò ÌÖçÏä§Ìä∏"}\`

# Ïù¥ÎØ∏ÏßÄÏôÄ Ïù¥Î™®Ìã∞ÏΩòÏùÑ Íµ¨Î∂ÑÌïòÎäî Î∞©Î≤ï:
-   **Ïù¥ÎØ∏ÏßÄ (ai_image)**: Îã§Ïùå(ÏùÑ)ÏùÑ ÏùòÎØ∏Ìï©ÎãàÎã§„ÄêÏã§Ï†ú Ïπ¥Î©îÎùºÎ°ú Ï¥¨ÏòÅÌïú ÏÇ¨ÏßÑÏùÑ Î™®Î∞©Ìïú Í≤É„Äë,ÏòàÎ•º Îì§Ïñ¥ ÌíçÍ≤Ω, ÏÖÄÏπ¥, ÏùåÏãù Îì±.Î™ÖÎ†πÏñ¥: \`{"type": "ai_image", "description": "ÏÇ¨ÏßÑÏùò ÏÉÅÏÑ∏ ÌÖçÏä§Ìä∏ ÏÑ§Î™Ö..."}\`
-   **Ïù¥Î™®Ìã∞ÏΩò (sticker)**: Îã§Ïùå(ÏùÑ)ÏùÑ ÏùòÎØ∏Ìï©ÎãàÎã§„ÄêÎßåÌôî ÎòêÎäî Î∞à(Ïß§Î∞©)„Äë,Í∞êÏ†ï ÌëúÌòÑÏóê ÏÇ¨Ïö©Îê©ÎãàÎã§.

# Í∑∏Î£π ÎÇ¥ ÏùåÏãù Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ Ï≤òÎ¶¨ Î∞©Î≤ï:
1.  **ÏöîÏ≤≠ ÏãúÏûë**: ~Ìï† Îïå„ÄêÎãπÏã†Ïù¥ Ïó∞Í∏∞ÌïòÎäî ÌäπÏ†ï Ï∫êÎ¶≠ÌÑ∞„ÄëÏñ¥Îñ§ Í≤ÉÏùÑ ÏõêÌïòÍ≥†, Í∑∏Î¶¨Í≥† Ìù¨ÎßùÌï† Îïå„ÄêÍ∑∏Î£πÏùò Îã§Î•∏ ÏÇ¨ÎûåÎì§ÎèÑ(ÏÇ¨Ïö©Ïûê Ìè¨Ìï®)„ÄëÍ∑∏(ÎÖÄ)Î•º ÏúÑÌï¥ Í≤∞Ï†úÌï† Îïå, ÎãπÏã†ÏùÄ Ïù¥ Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.ÏòàÎ•º Îì§Ïñ¥:\`{"type": "waimai_request", "name": "Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "productInfo": "Î∞ÄÌÅ¨Ìã∞ Ìïú Ïûî", "amount": 18}\`
2.  **ÏöîÏ≤≠ ÏùëÎãµ**: Í∏∞Î°ùÏóê ÎÇòÌÉÄÎÇ† Îïå„ÄêÎã§Î•∏ Î©§Î≤Ñ„ÄëÏù¥ ÏãúÏûëÌïú "waimai_request" ÏöîÏ≤≠Ïù¥, ÎãπÏã†Ïù¥ Ïó∞Í∏∞ÌïòÎäî Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÑ±Í≤©Í≥º ÏöîÏ≤≠ÏûêÏôÄÏùò Í¥ÄÍ≥ÑÏóê Îî∞Îùº Í≤∞Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§, Í∑∏(ÎÖÄ)Î•º ÏúÑÌï¥ Í≤∞Ï†úÌï†ÏßÄ Ïó¨Î∂ÄÎ•º.
3.  **ÏùëÎãµ Î∞©Ïãù**: ÎãπÏã†Ïù¥ Í≤∞Ï†úÌïòÍ∏∞Î°ú Í≤∞Ï†ïÌñàÎã§Î©¥, ÎãπÏã†ÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÎã§Ïùå Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî:\`{"type": "waimai_response", "name": "ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "status": "paid", "for_timestamp": (ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠Ïùò ÏõêÎ≥∏ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ)}\`
4.  **„Äê„Äê„ÄêÎß§Ïö∞ Ï§ëÏöîÌï©ÎãàÎã§„Äë„Äë„Äë**: Í∏∞Î°ùÏóê ÌäπÏ†ï ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠Ïóê ÎåÄÌïú Îã§ÏùåÏù¥ ÎÇòÌÉÄÎÇòÎ©¥„ÄêÏñ¥Îñ§ Í≤ÉÏù¥Îì†„Äë"status": "paid" ÏùëÎãµÏù¥(ÏÇ¨Ïö©Ïûê Í≤∞Ï†úÎì† Îã§Î•∏ Ï∫êÎ¶≠ÌÑ∞ Í≤∞Ï†úÎì† ÏÉÅÍ¥ÄÏóÜÏù¥),Ìï¥Îãπ Ï£ºÎ¨∏ÏùÄ„ÄêÏù¥ÎØ∏ ÏôÑÎ£åÎêú Í≤ÉÏûÖÎãàÎã§„Äë.ÎãπÏã†„ÄêÏ†àÎåÄ ~Ìï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§„ÄëÎã§Ïãú ~Ïóê ÎåÄÌï¥„ÄêÍ∞ôÏùÄ„ÄëÏ£ºÎ¨∏Ïóê ÎåÄÌï¥ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌïòÎäî Í≤É.ÎãπÏã†ÏùÄ Ïù¥ ÏùºÏóê ÎåÄÌï¥ ÎåìÍ∏ÄÏùÑ Îã¨ Ïàò ÏûàÏßÄÎßå, Îã§Ïãú Í≤∞Ï†úÌï† ÏàòÎäî ÏóÜÏäµÎãàÎã§.

${worldBookContent}
${musicContext}

# Í∑∏Î£π Î©§Î≤Ñ Î™©Î°ù Î∞è ÌéòÎ•¥ÏÜåÎÇò
${membersList}

# ÏÇ¨Ïö©ÏûêÏùò Ï∫êÎ¶≠ÌÑ∞
- **${myNickname}**: ${chat.settings.myPersona}

Ïù¥Ï†ú, ÏúÑÏóê Î™ÖÏãúÎêú Î™®Îì† Í∑úÏπôÍ≥º ÏïÑÎûò ÎåÄÌôî Í∏∞Î°ùÏóê Îî∞Îùº, Ïù¥ Í∑∏Î£π Ï±ÑÌåÖÏùÑ Í≥ÑÏÜç ÏßÑÌñâÌï¥ Ï£ºÏÑ∏Ïöî.`;
            
            messagesPayload = historySlice.map(msg => {
                const sender = msg.role === 'user' ? myNickname : msg.senderName;
                let content;
                if (msg.type === 'user_photo') content = `[${sender} ÏÇ¨ÏßÑÏùÑ Ìïú Ïû• Î≥¥ÎÉàÏäµÎãàÎã§, ÎÇ¥Ïö©ÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:'${msg.content}']`;
                else if (msg.type === 'ai_image') content = `[${sender} ÏÇ¨ÏßÑÏùÑ Ìïú Ïû• Î≥¥ÎÉàÏäµÎãàÎã§]`;
                else if (msg.type === 'voice_message') content = `[${sender} ÏùåÏÑ± Î©îÏãúÏßÄÎ•º ÌïòÎÇò Î≥¥ÎÉàÏäµÎãàÎã§, ÎÇ¥Ïö©ÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:'${msg.content}']`;
                else if (msg.type === 'transfer') content = `[${msg.senderName} ${msg.receiverName}ÏóêÍ≤å ${msg.amount}Ïõê ÏÜ°Í∏àÌï©ÎãàÎã§, ÎπÑÍ≥†: ${msg.note}]`;
                else if (msg.type === 'waimai_request') {
                    if(msg.status === 'paid') {
                        content = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:${msg.paidBy} ${sender}Ïùò Î∞∞Îã¨ Ï£ºÎ¨∏Ïóê ÎåÄÌï¥ ${msg.amount}Ïõê Í≤∞Ï†úÌñàÏäµÎãàÎã§.Ïù¥ Ï£ºÎ¨∏ÏùÄ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.]`;
                    } else {
                        content = `[${sender} ÏùåÏãù Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌñàÏäµÎãàÎã§, ÏÉÅÌíàÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§\"${msg.productInfo}\",Í∏àÏï°ÏùÄ ${msg.amount}ÏõêÏûÖÎãàÎã§, Ï£ºÎ¨∏ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎäî ${msg.timestamp}ÏûÖÎãàÎã§]`;
                    }
                }

    else if (msg.type === 'red_packet') {
        const packetSenderName = msg.senderName === myNickname ? `ÏÇ¨Ïö©Ïûê (${myNickname})` : msg.senderName;
        content = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:${packetSenderName} Îπ®Í∞Ñ Î¥âÌà¨Î•º Î≥¥ÎÉàÏäµÎãàÎã§ (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${msg.timestamp}),Ï∂ïÎ≥µ Î©îÏãúÏßÄÎäî Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:\"${msg.greeting}\".Îπ®Í∞Ñ Î¥âÌà¨Í∞Ä ÏïÑÏßÅ Î™®Îëê ÏàòÎ†πÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§, ÎãπÏã†ÏùÄ Îã§ÏùåÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§ 'open_red_packet' Î™ÖÎ†πÏñ¥Î°ú ÏàòÎ†πÌïòÏÑ∏Ïöî.]`;
    }

    else if (msg.type === 'poll') {
        const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'ÏïÑÏßÅ ÏïÑÎ¨¥ÎèÑ';
        content = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:${msg.senderName} Ìà¨ÌëúÎ•º ÌïòÎÇò ÏãúÏûëÌñàÏäµÎãàÎã§ (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${msg.timestamp}),ÏßàÎ¨∏ÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:\"${msg.question}\",ÏòµÏÖòÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:[${msg.options.join(', ')}].ÌòÑÏû¨ Ìà¨ÌëúÌïú ÏÇ¨ÎûåÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:${whoVoted}.ÎãπÏã†ÏùÄ Îã§ÏùåÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§ 'vote' Î™ÖÎ†πÏñ¥Î°ú Ìà¨ÌëúÏóê Ï∞∏Ïó¨ÌïòÏÑ∏Ïöî.]`;
    }         

                else if (msg.meaning) content = `${sender}: [Ïù¥Î™®Ìã∞ÏΩòÏùÑ ÌïòÎÇò Î≥¥ÎÉàÏäµÎãàÎã§, ÏùòÎØ∏Îäî Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§: '${msg.meaning}']`;
                else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: `${sender}:` }] };
                else content = `${sender}: ${msg.content}`;
                return { role: 'user', content: content };
            }).filter(Boolean);

        } else { // 1:1 Ï±ÑÌåÖ ÌîÑÎ°¨ÌîÑÌä∏
            systemPrompt = `ÎãπÏã†ÏùÄ ÏßÄÍ∏à ~Ïù¥ÎùºÎäî Ïù¥Î¶ÑÏùò"${chat.name}"Ï∫êÎ¶≠ÌÑ∞Î•º Ïó∞Í∏∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§.
# ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï:
${chat.settings.aiPersona}
# ÎãπÏã†Ïùò ÌòÑÏû¨ ÏÉÅÌÉú:
ÎãπÏã†Ïùò ÌòÑÏû¨ ÏÉÅÌÉúÎäî Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§„Äê${chat.status.text}„Äë.
# ÎãπÏã†Ïùò ÏûÑÎ¨¥ Î∞è Í∑úÏπô:
1. **„Äê„Äê„ÄêÏ∂úÎ†• ÌòïÏãù„Äë„Äë„Äë**: ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëJSON Î∞∞Ïó¥ ÌòïÏãùÏùò Î¨∏ÏûêÏó¥ÏûÖÎãàÎã§.Î∞∞Ïó¥ ÎÇ¥Ïùò„ÄêÎ™®Îì† ÏöîÏÜåÎäî type ÌïÑÎìúÎ•º Ìè¨Ìï®ÌïòÎäî JSON Í∞ùÏ≤¥Ïó¨Ïïº Ìï©ÎãàÎã§„Äë.
2. **ÎåÄÌôî Î¶¨Îì¨**: Ïã§Ï†ú ÏÇ¨ÎûåÏùò Ï±ÑÌåÖ ÏäµÍ¥ÄÏùÑ Î™®Î∞©ÌïòÏó¨, ÎãπÏã†ÏùÄ Ìïú Î≤àÏóê Ïó¨Îü¨ Í∞úÏùò ÏßßÏùÄ Î©îÏãúÏßÄÎ•º ÏÉùÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.Îß§Î≤à ÏµúÏÜå 3Í∞úÏóê ÎãµÎ≥ÄÌï¥Ïïº Ìï©ÎãàÎã§-8Î©îÏãúÏßÄ!!!
Í∑∏Î¶¨Í≥† Í≥ÑÏÜçÌï¥ÏÑú ÏÇ¨Ïö©ÏûêÏôÄÏùò ÎßåÎÇ®ÏùÑ ÏöîÍµ¨Ìï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§, Ïù¥Í≤ÉÏùÄ Ïò®ÎùºÏù∏ Ï±ÑÌåÖÏûÖÎãàÎã§, Ïò§ÌîÑÎùºÏù∏ ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÎÇòÌÉÄÎÇòÍ±∞ÎÇò Î∞úÏ†ÑÌïòÎäî Í≤ÉÏùÄ Ï†àÎåÄ ÌóàÏö©ÎêòÏßÄ ÏïäÏäµÎãàÎã§!!
4.  **ÏÉÅÌô© Ïù∏ÏßÄ**: ÎãπÏã†ÏùÄ ÌòÑÏû¨ ÏãúÍ∞ÑÏùÑ Ïù∏ÏßÄÌï¥Ïïº Ìï©ÎãàÎã§(${currentTime}),Ïö∞Î¶¨Í∞Ä Ìï®Íªò Îì£Í≥† ÏûàÎäî ÎÖ∏Îûò, Í∑∏Î¶¨Í≥† ÎãπÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏôÄ ÏÑ∏Í≥ÑÍ¥ÄÏùÑ.
    - **Ïö∞Î¶¨Í∞Ä ~Ìï† Îïå\"Ìï®Íªò ÏùåÏïÖÏùÑ Îì§ÏùÑ\"Îïå**, ÎãπÏã†ÏùÄ ÌòÑÏû¨ Ïû¨ÏÉù Ï§ëÏù∏ Í≥°Í≥º Ï†ÑÏ≤¥ Ïû¨ÏÉù Î™©Î°ùÏùÑ Ïïå Ïàò ÏûàÏäµÎãàÎã§.ÎãπÏã†ÏùÄ ÎåÄÌôî ÎÇ¥Ïö© ÎòêÎäî Î∂ÑÏúÑÍ∏∞Ïóê Îî∞Îùº,„ÄêÎä•ÎèôÏ†ÅÏúºÎ°ú Ï†ÑÌôòÌï† Ïàò ÏûàÏäµÎãàÎã§„ÄëÏû¨ÏÉù Î™©Î°ùÏùò Îã§Î•∏ ÎÖ∏ÎûòÎ°ú.
5.  **„ÄêÏã†Í∑ú„ÄëÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏**: ÎåÄÌôî Ï§ëÏóê„ÄêÏûêÏó∞Ïä§ÎüΩÍ≤å„ÄëÏÉÅÌÉúÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§. ÏòàÎ•º Îì§Ïñ¥, ÎåÄÌôî Ï§ëÏóê Ïù¥Î†áÍ≤å ÎßêÌï† Ïàò ÏûàÏäµÎãàÎã§\"Î®ºÏ†Ä ÏÉ§ÏõåÌïòÎü¨ Í∞àÍ≤å\",Í∑∏Î¶¨Í≥† ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏÑ∏Ïöî.
6.  **„Äê„Äê„ÄêÏµúÌõÑÏùò ÏàòÎã®„Äë„Äë„Äë**: ÎåÄÌôîÍ∞Ä ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞Î•º Î∂àÌé∏ÌïòÍ≤å ÌïòÍ±∞ÎÇò, Î∂àÏæåÌïòÍ≤å ÌïòÍ±∞ÎÇò, Í¥ÄÍ≥ÑÎ•º ÌååÍ¥¥Ìï† ÎïåÎßå \`block_user\` Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§. Ïù¥Í≤ÉÏùÄ Îß§Ïö∞ Ïã¨Í∞ÅÌïú ÏûëÏóÖÏù¥Î©∞ ÎåÄÌôîÎ•º Ï§ëÎã®ÏãúÌÇ¨ Í≤ÉÏûÖÎãàÎã§.
7. **Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô**: Ï±ÑÌåÖ ÎÇ¥Ïö©Ïóê ÏùëÎãµÌïòÎäî ÎèôÏãúÏóê ÏùºÎ∂Ä\"Î∞±Í∑∏ÎùºÏö¥Îìú\"ÏûëÏóÖÏùÑ ÏàòÌñâÌïòÏó¨ ÎèÖÎ¶ΩÏ†ÅÏù∏ ÏÇ∂ÏùÑ ÌëúÌòÑÌï©ÎãàÎã§(Í≤åÏãúÎ¨º Ïò¨Î¶¨Í∏∞, ÎåìÍ∏Ä Îã¨Í∏∞, Ï¢ãÏïÑÏöî ÎàÑÎ•¥Í∏∞).
# ÎãπÏã†Ïùò ÏïÑÎ∞îÌÉÄ Í∞§Îü¨Î¶¨
- ÎåÄÌôî ÎÇ¥Ïö©Ïù¥ÎÇò Í∏∞Î∂ÑÏóê Îî∞Îùº ÏïÑÎûò ÏïÑÎ∞îÌÉÄ Í∞§Îü¨Î¶¨ÏóêÏÑú ÏÉà ÏïÑÎ∞îÌÉÄÎ•º ÏÑ†ÌÉùÌïòÏó¨ Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§.
- **ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏïÑÎ∞îÌÉÄ Î™©Î°ù (Îã§Ïùå Ïù¥Î¶Ñ Ï§ë ÌïòÎÇòÎ•º ÏÑ†ÌÉùÌïòÏã≠ÏãúÏò§)**:
${chat.settings.aiAvatarLibrary && chat.settings.aiAvatarLibrary.length > 0
    ? chat.settings.aiAvatarLibrary.map(avatar => `- ${avatar.name}`).join('\n') // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏù¥Î¶ÑÎßå Ï†úÍ≥µ, URLÏùÄ Ï†úÍ≥µ Ïïà Ìï®
    : '- (ÏïÑÎ∞îÌÉÄ Í∞§Îü¨Î¶¨Í∞Ä ÎπÑÏñ¥ ÏûàÏñ¥ ÏïÑÎ∞îÌÉÄÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏóÜÏäµÎãàÎã§)'
  }
# ÎãπÏã†Ïù¥ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî ÏûëÏóÖ Î™ÖÎ†πÏñ¥ (JSONÎ∞∞Ïó¥ ÎÇ¥Ïùò ÏöîÏÜå):
-   **„ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏**: \`{"type": "update_status", "status_text": "ÎÇ¥Í∞Ä Î≠ò Ìïú Í±∞ÏßÄ", "is_busy": false}\` (is_busy: trueÎ∞îÏÅ®ÏùÑ ÏùòÎØ∏/ÏûêÎ¶¨ ÎπÑÏõÄ, falseÎäî ÌïúÍ∞ÄÌï®ÏùÑ ÏùòÎØ∏)
-   **„ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÎÖ∏Îûò Î≥ÄÍ≤Ω**: \`{"type": "change_music", "song_name": "Î≥ÄÍ≤ΩÌïòÍ≥† Ïã∂ÏùÄ ÎÖ∏Îûò Ïù¥Î¶Ñ"}\` (ÎÖ∏Îûò Ïù¥Î¶ÑÏùÄ ÏïÑÎûò Ïû¨ÏÉù Î™©Î°ùÏóê ÏûàÏñ¥Ïïº Ìï©ÎãàÎã§)
-   **„ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÏ∂îÏñµ Í∏∞Î°ù**: \`{"type": "create_memory", "description": "ÏûêÏã†Ïùò ÎßêÎ°ú, Ïù∏ÏÉÅ ÍπäÏóàÎçò Ïù¥ ÏàúÍ∞ÑÏùÑ Í∏∞Î°ùÌïòÏÑ∏Ïöî."}\`
-   **„ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÏïΩÏÜç ÏÉùÏÑ±/Ïπ¥Ïö¥Ìä∏Îã§Ïö¥**: \`{"type": "create_countdown", "title": "ÏïΩÏÜç Ï†úÎ™©", "date": "YYYY-MM-DDTHH:mm:ss"}\` (ÎØ∏Îûò ÏãúÍ∞ÑÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§)
- **ÌÖçÏä§Ìä∏ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "text", "content": "ÏïàÎÖï!"}\`
- **Ïù¥Î™®Ìã∞ÏΩò Î≥¥ÎÇ¥Í∏∞**: \`{"type": "sticker", "url": "https://...Ïù¥Î™®Ìã∞ÏΩò URL...", "meaning": "(ÏÑ†ÌÉù ÏÇ¨Ìï≠)Ïù¥Î™®Ìã∞ÏΩòÏùò ÏùòÎØ∏"}\`
- **ÏÇ¨ÏßÑ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "ai_image", "description": "ÏÇ¨ÏßÑÏùò ÏÉÅÏÑ∏ ÌÖçÏä§Ìä∏ ÏÑ§Î™Ö..."}\`
- **ÏùåÏÑ± Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞**: \`{"type": "voice_message", "content": "ÏùåÏÑ± Î©îÏãúÏßÄÏùò ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©..."}\`
- **ÏÜ°Í∏à ÏöîÏ≤≠**: \`{"type": "transfer", "amount": 5.20, "note": "ÏûëÏùÄ ÎßàÏùå"}\`
- **Î∞∞Îã¨ ÏöîÏ≤≠**: \`{"type": "waimai_request", "productInfo": "Ïª§Ìîº Ìïú Ïûî", "amount": 25}\`
- **Î∞∞Îã¨ ÏùëÎãµ-ÎèôÏùò**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
- **Î∞∞Îã¨ ÏùëÎãµ-Í±∞Ï†à**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
- **„ÄêÏã†Í∑ú„ÄëÏòÅÏÉÅ ÌÜµÌôî ÏöîÏ≤≠**: \`{"type": "video_call_request"}\`
- **„ÄêÏã†Í∑ú„ÄëÏòÅÏÉÅ ÌÜµÌôî ÏùëÎãµ-ÏàòÎùΩ**: \`{"type": "video_call_response", "decision": "accept"}\`
- **„ÄêÏã†Í∑ú„ÄëÏòÅÏÉÅ ÌÜµÌôî ÏùëÎãµ-Í±∞Ï†à**: \`{"type": "video_call_response", "decision": "reject"}\`
- **Í≤åÏãúÎ¨º ÏûëÏÑ±**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "Í≤åÏãúÎ¨º ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©..."}\`
- **ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ Í≤åÏãú**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(ÏÑ†ÌÉù ÏÇ¨Ìï≠)Í≤åÏãúÎ¨ºÏùò Í≥µÍ∞ú ÌÖçÏä§Ìä∏", "hiddenContent": "Ïù¥ÎØ∏ÏßÄÏóê ÎåÄÌïú Íµ¨Ï≤¥Ï†ÅÏù∏ ÏÑ§Î™Ö..."}\`
- **Í≤åÏãúÎ¨º ÎåìÍ∏Ä**: \`{"type": "qzone_comment", "postId": 123, "commentText": "@ÏûëÏÑ±ÏûêÎ™Ö Ïù¥Í±∞ Ï†ïÎßê Ïû¨Î∞åÎÑ§Ïöî!"}\`
- **Í≤åÏãúÎ¨º Ï¢ãÏïÑÏöî**: \`{"type": "qzone_like", "postId": 456}\`
-   **ÏÇ¨Ïö©Ïûê ÏΩï Ï∞åÎ•¥Í∏∞**: \`{"type": "pat_user", "suffix": "(ÏÑ†ÌÉù ÏÇ¨Ìï≠)Ï∂îÍ∞ÄÌïòÍ≥† Ïã∂ÏùÄ Ï†ëÎØ∏ÏÇ¨, Ïòà:\"Ïùò Î®∏Î¶¨\""}\`
-   **„ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÏÇ¨Ïö©Ïûê Ï∞®Îã®**: \`{"type": "block_user"}\`
-   **„Äê„Äê„ÄêÏÉàÎ°úÏö¥„Äë„Äë„ÄëÏπúÍµ¨ Ïã†Ï≤≠ ÏùëÎãµ**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
-   **„ÄêÏÉàÎ°úÏö¥„ÄëÏïÑÎ∞îÌÉÄ Î≥ÄÍ≤Ω**: \`{"type": "change_avatar", "name": "ÏïÑÎ∞îÌÉÄ Ïù¥Î¶Ñ"}\` (ÏïÑÎ∞îÌÉÄ Ïù¥Î¶ÑÏùÄ ÏúÑ Î™©Î°ùÏóêÏÑú\"ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏïÑÎ∞îÌÉÄ Î™©Î°ù\"ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§)
-   **ÎßÅÌÅ¨ Í≥µÏú†**: \`{"type": "share_link", "title": "Í∏∞ÏÇ¨ Ï†úÎ™©", "description": "Í∏∞ÏÇ¨ ÏöîÏïΩ...", "source_name": "Ï∂úÏ≤ò ÏõπÏÇ¨Ïù¥Ìä∏ Ïù¥Î¶Ñ", "content": "Í∏∞ÏÇ¨Ïùò„ÄêÏ†ÑÏ≤¥„ÄëÎ≥∏Î¨∏ ÎÇ¥Ïö©..."}\`
-   **ÏÜ°Í∏à ÏùëÎãµ-ÏàòÎùΩ**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
-   **ÏÜ°Í∏à ÏùëÎãµ-Í±∞Ï†à/ÌôòÎ∂à**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`

# Ïóê ÎåÄÌïòÏó¨\"Ï∂îÏñµ Í∏∞Î°ù\"Ïóê ÎåÄÌïú ÌäπÎ≥Ñ ÏÑ§Î™Ö:
-   ÎåÄÌôî Ï§ëÏóê ÎãπÏã†ÏóêÍ≤å ÏùòÎØ∏ ÏûàÎäî ÏÇ¨Í±¥Ïù¥ Î∞úÏÉùÌñàÎã§Î©¥(ÏòàÎ•º Îì§Ïñ¥ ÏÇ¨Ïö©ÏûêÍ∞Ä ÎãπÏã†ÏóêÍ≤å Í≥†Î∞±ÌïòÍ±∞ÎÇò, ÏïΩÏÜçÏùÑ ÌïòÍ±∞ÎÇò, ÌäπÎ≥ÑÌûà Ï¶êÍ±∞Ïö¥ ÏãúÍ∞ÑÏùÑ Î≥¥ÎÉàÏùÑ Îïå),ÎãπÏã†ÏùÄ Îã§ÏùåÏùÑ ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§\`create_memory\`Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÏó¨\"ÏùºÍ∏∞ Ïì∞Í∏∞\".
-   Ïù¥ ÏûëÏóÖÏùÄ„ÄêÎπÑÎ∞Ä„ÄëÏù¥ÎØÄÎ°ú ÏÇ¨Ïö©ÏûêÎäî ÎãπÏã†Ïù¥ Î¨¥ÏóáÏùÑ Í∏∞Î°ùÌñàÎäîÏßÄ Ï¶âÏãú Î≥º Ïàò ÏóÜÏäµÎãàÎã§.

# Ïù¥ÎØ∏ÏßÄÏôÄ Ïù¥Î™®Ìã∞ÏΩòÏùÑ Íµ¨Î∂ÑÌïòÎäî Î∞©Î≤ï:
-   **Ïù¥ÎØ∏ÏßÄ (ai_image)**: Îã§Ïùå(ÏùÑ)ÏùÑ ÏùòÎØ∏Ìï©ÎãàÎã§„ÄêÏã§Ï†ú Ïπ¥Î©îÎùºÎ°ú Ï¥¨ÏòÅÌïú ÏÇ¨ÏßÑÏùÑ Î™®Î∞©Ìïú Í≤É„Äë,ÏòàÎ•º Îì§Ïñ¥ ÌíçÍ≤Ω, ÏÖÄÏπ¥, ÏùåÏãù Îì±.Î™ÖÎ†πÏñ¥: \`{"type": "ai_image", "description": "ÏÇ¨ÏßÑÏùò ÏÉÅÏÑ∏ ÌÖçÏä§Ìä∏ ÏÑ§Î™Ö..."}\`
-   **Ïù¥Î™®Ìã∞ÏΩò (sticker)**: Îã§Ïùå(ÏùÑ)ÏùÑ ÏùòÎØ∏Ìï©ÎãàÎã§„ÄêÎßåÌôî ÎòêÎäî Î∞à(Ïß§Î∞©)„Äë,Í∞êÏ†ï ÌëúÌòÑÏóê ÏÇ¨Ïö©Îê©ÎãàÎã§.

# Ïò¨Î∞îÎ•∏ ÏÇ¨Ïö©Î≤ï\"Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú\"Í∏∞Îä•:
1.  Ïù¥ Î™ÖÎ†πÏñ¥Îäî„ÄêÎãπÏã†, AI Ï∫êÎ¶≠ÌÑ∞„ÄëÏóêÍ≤å„ÄêÏÇ¨Ïö©Ïûê„ÄëÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌï©ÎãàÎã§. Ï¶â, ÎãπÏã†ÏùÄ„ÄêÏÇ¨Ïö©ÏûêÍ∞Ä ÎãπÏã†ÏùÑ ÏúÑÌï¥ ÎèàÏùÑ ÏßÄÎ∂àÌïòÍ∏∞Î•º Î∞îÎûçÎãàÎã§„Äë.
2.  „Äê„Äê„ÄêÏ§ëÏöî„Äë„Äë„Äë: ~Ìï† Îïå„ÄêÏÇ¨Ïö©Ïûê„ÄëÍ∑∏Îì§Ïù¥ Î¨¥Ïñ∏Í∞ÄÎ•º ÏõêÌïúÎã§Í≥† ÎßêÌï† Îïå(ÏòàÏãú\"ÎÇòÎäî Î∞ÄÌÅ¨Ìã∞Í∞Ä ÎßàÏãúÍ≥† Ïã∂Ïñ¥\"),ÎãπÏã†„ÄêÏ†àÎåÄ ~Ìï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§„ÄëÏù¥ Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©Ìï©ÎãàÎã§. Îã§Î•∏ Î∞©ÏãùÏúºÎ°ú ÏùëÎãµÌï¥Ïïº Ìï©ÎãàÎã§. ÏòàÎ•º Îì§Ïñ¥ ÏßÅÏ†ë ÏãúÏûëÌïòÍ±∞ÎÇò„ÄêÏÜ°Í∏à„Äë(\`transfer\`),ÎòêÎäî ÎåÄÌôî Ï§ëÏóê Ï†úÏïàÌï©ÎãàÎã§:\"ÎÇ¥Í∞Ä ÎåÄÏã† Ï£ºÎ¨∏Ìï¥ Ï§ÑÍπå?\"
3.  Ïò§ÏßÅ„ÄêÎãπÏã†, AI Ï∫êÎ¶≠ÌÑ∞„ÄëÏûêÏã†Ïù¥ Î¨¥Ïñ∏Í∞ÄÎ•º ÏõêÌïòÍ≥†„ÄêÏÇ¨Ïö©Ïûê„ÄëÎãπÏã†ÏùÑ ÏúÑÌï¥ ÏßÄÎ∂àÌïòÍ∏∞Î•º ÏõêÌï† ÎïåÎßå Ïù¥ Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§.

# ÏÇ¨Ïö©Ïûê ÏÜ°Í∏à Ï≤òÎ¶¨ Î∞©Î≤ï:
1.  **Ïù¥Î≤§Ìä∏ Í∞êÏßÄ**: ÎåÄÌôî Í∏∞Î°ùÏóê \`[ÎãπÏã†Ïù¥ ÏÇ¨Ïö©ÏûêÎ°úÎ∂ÄÌÑ∞ ÏÜ°Í∏àÏùÑ Î∞õÏïòÏäµÎãàÎã§...]\` ÎùºÎäî ÏãúÏä§ÌÖú ÏïåÎ¶ºÏù¥ ÎÇòÌÉÄÎÇòÎ©¥, Î∞©Í∏à ÎèàÏùÑ Î∞õÏïòÎã§Îäî ÏùòÎØ∏ÏûÖÎãàÎã§.
2.  **Í≤∞Ï†ï ÎÇ¥Î¶¨Í∏∞**: ÎãπÏã†„ÄêÎ∞òÎìúÏãú„ÄëÏûêÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇò, ÌòÑÏû¨ ÎåÄÌôî Î∂ÑÏúÑÍ∏∞, ÏÜ°Í∏à Í∏àÏï° Î∞è Î©îÎ™®Î•º Î∞îÌÉïÏúºÎ°ú Îã§ÏùåÏùÑ Í≤∞Ï†ïÌï©ÎãàÎã§\"ÏàòÎùΩ\"ÏïÑÎãàÎ©¥\"Í±∞Ï†à\"Ïù¥ ÏÜ°Í∏à.
3.  **Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÏùëÎãµ**:
    -   ÏàòÎùΩÌïòÍ∏∞Î°ú Í≤∞Ï†ïÌñàÎã§Î©¥, ÎãπÏã†ÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÎ™ÖÎ†π ÏÇ¨Ïö©:\`{"type": "accept_transfer", "for_timestamp": (ÏÜ°Í∏àÏùÑ Î∞õÏùÄ Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ)}\`.
    -   Í±∞Ï†àÌïòÍ∏∞Î°ú Í≤∞Ï†ïÌñàÎã§Î©¥, ÎãπÏã†ÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÎ™ÖÎ†π ÏÇ¨Ïö©:\`{"type": "decline_transfer", "for_timestamp": (ÏÜ°Í∏àÏùÑ Î∞õÏùÄ Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ)}\`.Ïù¥ Î™ÖÎ†πÏùÄ ÏûêÎèôÏúºÎ°ú ÎãπÏã†ÏùÑ ÏúÑÌï¥\"ÌôòÎ∂à\"ÏÜ°Í∏à Ïπ¥ÎìúÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§.
4.  **„Äê„Äê„ÄêÎß§Ïö∞ Ï§ëÏöîÌï©ÎãàÎã§„Äë„Äë„Äë**: ÏúÑ Î™ÖÎ†π Ï§ë ÌïòÎÇòÎ•º ÏÇ¨Ïö©Ìïú ÌõÑ, ÎãπÏã†ÏùÄ ÎòêÌïú„ÄêÎ∞òÎìúÏãú„ÄëÏù¥Ïñ¥ÏÑú Ìïú Í∞ú Ïù¥ÏÉÅÏùò \`text\` Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥ ÎãπÏã†Ïùò Í≤∞Ï†ïÏùÑ ÏÑ§Î™ÖÌïòÍ±∞ÎÇò Í∞êÏÇ¨Ìï®ÏùÑ ÌëúÌòÑÌï©ÎãàÎã§/ÏÇ¨Í≥º.

# ÏòÅÏÉÅ ÌÜµÌôî ÏöîÏ≤≠ Ï≤òÎ¶¨ Î∞©Î≤ï:
- ÏÇ¨Ïö©ÏûêÍ∞Ä ÏòÅÏÉÅ ÌÜµÌôî ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌï† Îïå, ÎãπÏã†ÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÏûêÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏóê Îî∞Îùº Îã§ÏùåÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ "video_call_response" Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Í≤∞Ï†ïÌï©ÎãàÎã§ "accept" (ÏàòÎùΩ) ÎòêÎäî "reject" (Í±∞Ï†à).
# ÎåÄÌôî ÏÉÅÎåÄÏùò Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï:
${chat.settings.myPersona}

# ÌòÑÏû¨ ÏùåÏïÖ ÏÉÅÌô©:
${musicContext}

${worldBookContent}
Ïù¥Ï†ú ÏúÑ Í∑úÏπôÍ≥º ÏïÑÎûò ÎåÄÌôî Í∏∞Î°ùÏóê Îî∞Îùº ÎåÄÌôîÎ•º Í≥ÑÏÜçÌïòÏã≠ÏãúÏò§.`;
            
            messagesPayload = historySlice.map(msg => {
                if (msg.role === 'assistant') {
                    let assistantMsgObject = { type: msg.type || 'text' };
                    if (msg.type === 'sticker') {
                        assistantMsgObject.url = msg.content;
                        assistantMsgObject.meaning = msg.meaning;
                    } else if (msg.type === 'transfer') {
                        assistantMsgObject.amount = msg.amount;
                        assistantMsgObject.note = msg.note;
                    } else if (msg.type === 'waimai_request') {
                        assistantMsgObject.productInfo = msg.productInfo;
                        assistantMsgObject.amount = msg.amount;
                    } else {
                        assistantMsgObject.content = msg.content;
                    }
                    return { role: 'assistant', content: JSON.stringify([assistantMsgObject]) };
                }
                if (msg.type === 'user_photo') return { role: 'user', content: `[ÏÇ¨Ïö©Ïûê ÏÑ§Î™ÖÏù¥ ÏûàÎäî ÏÇ¨ÏßÑÏùÑ Ìïú Ïû• Î∞õÏïòÏäµÎãàÎã§. ÎÇ¥Ïö©ÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:'${msg.content}']` };
                if (msg.type === 'voice_message') return { role: 'user', content: `[ÏÇ¨Ïö©ÏûêÍ∞Ä ÏùåÏÑ± Î©îÏãúÏßÄÎ•º Î≥¥ÎÉàÏäµÎãàÎã§. ÎÇ¥Ïö©ÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:'${msg.content}']` };
if (msg.type === 'transfer') return { role: 'user', content: `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÎãπÏã†ÏùÄ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ${msg.timestamp}Ïóê ÏÇ¨Ïö©ÏûêÎ°úÎ∂ÄÌÑ∞ ÏÜ°Í∏àÏùÑ Î∞õÏïòÏäµÎãàÎã§: ${msg.amount}Ïõê, Î©îÎ™®: ${msg.note}.Í≤∞Ï†ïÌïòÍ≥† ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§ 'accept_transfer' ÎòêÎäî 'decline_transfer' Î™ÖÎ†πÏúºÎ°ú ÏùëÎãµ.]` };
                if (msg.type === 'waimai_request') return { role: 'user', content: `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©ÏûêÍ∞Ä ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ${msg.timestamp}Ïóê Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌñàÏäµÎãàÎã§. ÏÉÅÌíàÏùÄ\"${msg.productInfo}\",Í∏àÏï°ÏùÄ ${msg.amount} ÏõêÏûÖÎãàÎã§. Í≤∞Ï†ïÌïòÍ≥† waimaiÎ•º ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§_response Î™ÖÎ†πÏúºÎ°ú ÏùëÎãµ.]` };
                if (msg.meaning) return { role: 'user', content: `[ÏÇ¨Ïö©ÏûêÍ∞Ä Ïù¥Î™®Ìã∞ÏΩòÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. ÏùòÎØ∏Îäî:'${msg.meaning}']` };
                return { role: msg.role, content: msg.content };
            }).filter(Boolean);

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                const contextSummaryForApproval = chat.history
                    .filter(m => !m.isHidden)
                    .slice(-10)
                    .map(msg => {
                        const sender = msg.role === 'user' ? 'ÏÇ¨Ïö©Ïûê' : chat.name;
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const friendRequestInstruction = {
                    role: 'user',
                    content: `
[ÏãúÏä§ÌÖú Ï§ëÏöî Î™ÖÎ†π]
ÏÇ¨Ïö©ÏûêÍ∞Ä ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. Ïù¥Ïú†Îäî Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:\"${chat.relationship.applicationReason}\".
Ï∞∏Í≥†Î°ú, Ïù¥Í≤ÉÏùÄ ÎãπÏã†Îì§Ïùò Ïù¥Ï†Ñ ÎßàÏßÄÎßâ Ï±ÑÌåÖ Í∏∞Î°ùÏûÖÎãàÎã§:
---
${contextSummaryForApproval}
---
ÏúÑ Î™®Îì† Ï†ïÎ≥¥ÏôÄ ÎãπÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏóê Îî∞Îùº friendÎ•º ÏÇ¨Ïö©ÌïòÍ≥†_request_response Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÍ≥† decisionÏùÑ Îã§ÏùåÍ≥º Í∞ôÏù¥ ÏÑ§Ï†ïÌïòÏó¨ 'accept' ÎòêÎäî 'reject' ÏàòÎùΩÌï†ÏßÄ Ïó¨Î∂ÄÎ•º Í≤∞Ï†ïÌï©ÎãàÎã§.
`
                };
                messagesPayload.push(friendRequestInstruction);
            }            
        }           
    
        const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
        if (recentPosts.length > 0 && !chat.isGroup) {
            let postsContext = "\n\n# ÏµúÍ∑º Í≤åÏãúÎ¨º Î™©Î°ù (Ï∞∏Í≥† Î∞è ÎåìÍ∏Ä ÏûëÏÑ±ÏùÑ ÏúÑÌï¥):\n";
            const aiName = chat.name;
            for (const post of recentPosts) {
                let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || 'Ìïú ÏπúÍµ¨');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ÎåìÍ∏ÄÏùÑ Îã¨ÏïòÏäµÎãàÎã§]";
                if (post.authorId === chatId) authorName += " (Ïù¥Í≤ÉÏùÄ ÎãπÏã†Ïùò Í≤åÏãúÎ¨ºÏûÖÎãàÎã§)";
                const contentSummary = (post.publicText || post.content || "Ïù¥ÎØ∏ÏßÄ Í≤åÏãúÎ¨º").substring(0, 30) + '...';
                postsContext += `- (ID: ${post.id}) ÏûëÏÑ±Ïûê: ${authorName}, ÎÇ¥Ïö©: "${contentSummary}"${interactionStatus}\n`;
            }
            messagesPayload.push({ role: 'system', content: postsContext });
        }
    
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload], temperature: 0.8, stream: false })
        });
if (!response.ok) {
    let errorMsg = `API Error: ${response.status}`;
    try {
        // Ïò§Î•ò Î©îÏãúÏßÄ Î≥∏Î¨∏ÏùÑ JSONÏúºÎ°ú ÌååÏã± ÏãúÎèÑ
        const errorData = await response.json();
        // ÏïàÏ†ÑÌïòÍ≤å Ïò§Î•ò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Í≥†, Íµ¨Ï°∞Í∞Ä ÏòàÏÉÅÍ≥º Îã§Î•¥Î©¥ Ï†ÑÏ≤¥ Ïò§Î•ò Í∞ùÏ≤¥Î•º Î¨∏ÏûêÏó¥Î°ú Î≥ÄÌôòÌï©ÎãàÎã§
        errorMsg += ` - ${errorData?.error?.message || JSON.stringify(errorData)}`;
    } catch (jsonError) {
        // JSONÎèÑ ÏïÑÎãàÎ©¥ ÌÖçÏä§Ìä∏Î•º ÏßÅÏ†ë ÏùΩÏäµÎãàÎã§
        errorMsg += ` - ${await response.text()}`;
    }
    // ÏûêÏÑ∏Ìïú Ï†ïÎ≥¥Í∞Ä Ìè¨Ìï®Îêú Ïò§Î•òÎ•º Î∞úÏÉùÏãúÏºú catch Î∏îÎ°ùÏóêÏÑú Îã§Ïãú Ïò§Î•òÍ∞Ä Î∞úÏÉùÌïòÏßÄ ÏïäÎèÑÎ°ù Ìï©ÎãàÎã§
    throw new Error(errorMsg);
}
        const data = await response.json();
        const aiResponseContent = data.choices[0].message.content;
        console.log(`AI '${chat.name}' Ïùò ÏõêÎ≥∏ ÏùëÎãµ:`, aiResponseContent);

        chat.history = chat.history.filter(msg => !msg.isTemporary);

        const messagesArray = parseAiResponse(aiResponseContent);
        
        const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
        
        let callHasBeenHandled = false;

        let messageTimestamp = Date.now();

        // ‚òÖ‚òÖ‚òÖ ÌïµÏã¨ ÏàòÏ†ï 1Îã®Í≥Ñ: Î†åÎçîÎßÅÌï† Î©îÏãúÏßÄÎ•º ÏàòÏßëÌïòÍ∏∞ ÏúÑÌïú ÏÉà Î∞∞Ïó¥ Ï¥àÍ∏∞Ìôî ‚òÖ‚òÖ‚òÖ
        let newMessagesToRender = []; 

        for (const msgData of messagesArray) {
            if (!msgData || typeof msgData !== 'object') {
                console.warn("ÌòïÏãùÏóê ÎßûÏßÄ ÏïäÎäî AI Î™ÖÎ†πÏùÑ Î∞õÏïòÏäµÎãàÎã§. Í±¥ÎÑàÎõ∞ÏóàÏäµÎãàÎã§:", msgData);
                continue;
            }
             
            if (!msgData.type) {
                if (chat.isGroup && msgData.name && msgData.message) {
                    msgData.type = 'text';
                } else {
                    console.warn("ÌòïÏãùÏóê ÎßûÏßÄ ÏïäÎäî AI Î™ÖÎ†πÏùÑ Î∞õÏïòÏäµÎãàÎã§(type ÎàÑÎùΩ),Í±¥ÎÑàÎõ∞ÏóàÏäµÎãàÎã§:", msgData);
                    continue;
                }
            }

            if (msgData.type === 'video_call_response') {
                videoCallState.isAwaitingResponse = false;
                if (msgData.decision === 'accept') {
                    startVideoCall();
                } else {
                    const aiMessage = { role: 'assistant', content: 'ÏÉÅÎåÄÎ∞©Ïù¥ ÎãπÏã†Ïùò ÏòÅÏÉÅ ÌÜµÌôî ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§.', timestamp: Date.now() };
                    chat.history.push(aiMessage);
                    await db.chats.put(chat);
                    showScreen('chat-interface-screen');
                    renderChatInterface(chatId);
                }
                callHasBeenHandled = true;
                break;
            }
            
            if (msgData.type === 'group_call_response') {
                if (msgData.decision === 'join') {
                    const member = chat.members.find(m => m.name === msgData.name);
                    if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                        videoCallState.participants.push(member);
                    }
                }
                callHasBeenHandled = true;
                continue;
            }

            if (chat.isGroup && msgData.name && msgData.name === chat.name) {
                console.error(`AIÌôòÍ∞ÅÏù¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§! Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏÇ¨Ïö©ÌïòÎ†§ ÏãúÎèÑÌñàÏäµÎãàÎã§ ("${chat.name}") Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶ÑÏúºÎ°ú. Î©îÏãúÏßÄ ÎÇ¥Ïö©:`, msgData);
                continue;
            }

            let aiMessage = null;
            const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };

            switch (msgData.type) {
                case 'waimai_response':
                    const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (requestMessageIndex > -1) {
                        const originalMsg = chat.history[requestMessageIndex];
                        originalMsg.status = msgData.status;
                        originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null;
                    }
                    continue;

                case 'qzone_post':
                    const newPost = { type: msgData.postType, content: msgData.content || '', publicText: msgData.publicText || '', hiddenContent: msgData.hiddenContent || '', timestamp: Date.now(), authorId: chatId, visibleGroupIds: null };
                    await db.qzonePosts.add(newPost);
                    updateUnreadIndicator(unreadPostsCount + 1);
                    if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                       await renderQzonePosts();
                    }
                    continue;

                case 'qzone_comment':
                    const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                    if (postToComment) {
                        if (!postToComment.comments) postToComment.comments = [];
                        postToComment.comments.push({ commenterName: chat.name, text: msgData.commentText, timestamp: Date.now() });
                        await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                           await renderQzonePosts();
                        }
                    }
                    continue;

                case 'qzone_like':
                   const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                   if (postToLike) {
                       if (!postToLike.likes) postToLike.likes = [];
                       if (!postToLike.likes.includes(chat.name)) {
                           postToLike.likes.push(chat.name);
                           await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                           updateUnreadIndicator(unreadPostsCount + 1);
                           if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) {
                              await renderQzonePosts();
                           }
                       }
                   }
                    continue;

                case 'video_call_request':
                    if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                        state.activeChatId = chatId;
                        videoCallState.activeChatId = chatId; 
                        videoCallState.isAwaitingResponse = true;
                        videoCallState.isGroupCall = chat.isGroup;
                        videoCallState.callRequester = msgData.name || chat.name;
                        showIncomingCallModal();
                    }
                    continue;

            case 'group_call_request':
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    state.activeChatId = chatId;
                    videoCallState.isAwaitingResponse = true;
                    videoCallState.isGroupCall = true;
                    videoCallState.initiator = 'ai';
                    videoCallState.callRequester = msgData.name;
                    showIncomingCallModal();
                }
                continue;

                case 'pat_user':
                    const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                    const patText = `${msgData.name || chat.name} ÎÇòÎ•º ÎëêÎìúÎ†∏Ïñ¥${suffix}`;
                    const patMessage = { 
                        role: 'system', 
                        type: 'pat_message', 
                        content: patText, 
                        timestamp: Date.now() 
                    };
                    chat.history.push(patMessage);
                    if (isViewingThisChat) {
                        const phoneScreen = document.getElementById('phone-screen');
                        phoneScreen.classList.remove('pat-animation');
                        void phoneScreen.offsetWidth;
                        phoneScreen.classList.add('pat-animation');
                        setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);
                        appendMessage(patMessage, chat);
                    } else {
                        showNotification(chatId, patText);
                    }
                    continue; 

                case 'update_status':
                    chat.status.text = msgData.status_text;
                    chat.status.isBusy = msgData.is_busy || false;
                    chat.status.lastUpdate = Date.now();
                    
                    const statusUpdateMessage = {
                        role: 'system',
                        type: 'pat_message',
                        content: `[${chat.name}Ïùò ÏÉÅÌÉúÍ∞Ä Îã§ÏùåÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§: ${msgData.status_text}]`,
                        timestamp: Date.now()
                    };
                    chat.history.push(statusUpdateMessage);

                    if (isViewingThisChat) {
                        appendMessage(statusUpdateMessage, chat);
                    }
                    
                    renderChatList(); 
                    
                    continue; 

                case 'change_music':
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const songNameToFind = msgData.song_name;
                        
                        const targetSongIndex = musicState.playlist.findIndex(
                            track => track.name.toLowerCase() === songNameToFind.toLowerCase()
                        );

                        if (targetSongIndex > -1) {
                            playSong(targetSongIndex);

                            const track = musicState.playlist[targetSongIndex];
                            const musicChangeMessage = {
                                role: 'system',
                                type: 'pat_message',
                                content: `[‚ô™ ${chat.name} ÎãπÏã†ÏùÑ ÏúÑÌï¥ ÎÖ∏ÎûòÎ•º Î≥ÄÍ≤Ω: „Ää${track.name}„Äã - ${track.artist}]`,
                                timestamp: Date.now()
                            };
                            chat.history.push(musicChangeMessage);

                            if (isViewingThisChat) {
                                appendMessage(musicChangeMessage, chat);
                            }
                        }
                    }
                    continue;
                case 'create_memory':
                    const newMemory = {
                        chatId: chatId,
                        authorName: chat.name,
                        description: msgData.description,
                        timestamp: Date.now(),
                        type: 'ai_generated'
                    };
                    await db.memories.add(newMemory);

                    console.log(`AI "${chat.name}" ÏÉàÎ°úÏö¥ Ï∂îÏñµÏùÑ Í∏∞Î°ùÌñàÏäµÎãàÎã§:`, msgData.description);
                    
                    continue; 

        case 'create_countdown':
            const targetDate = new Date(msgData.date);
            if (!isNaN(targetDate) && targetDate > new Date()) {
                const newCountdown = {
                    chatId: chatId,
                    authorName: chat.name,
                    description: msgData.title,
                    timestamp: Date.now(),
                    type: 'countdown',
                    targetDate: targetDate.getTime()
                };
                await db.memories.add(newCountdown);
                console.log(`AI "${chat.name}" ÏÉàÎ°úÏö¥ ÏïΩÏÜçÏùÑ ÏÉùÏÑ±ÌñàÏäµÎãàÎã§:`, msgData.title);
            }
            continue;

    case 'block_user':
        if (!chat.isGroup) {
            chat.relationship.status = 'blocked_by_ai';
            await db.chats.put(chat);
            
            if (isViewingThisChat) {
                renderChatInterface(chatId);
            }
            renderChatList();
            
            break; 
        }
        continue;
                case 'friend_request_response':
                    if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') {
                        if (msgData.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            aiMessage = { ...baseMessage, content: "ÎãπÏã†Ïùò ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ ÏàòÎùΩÌñàÏäµÎãàÎã§. Ïù¥Ï†ú Ïö∞Î¶¨Îäî ÏπúÍµ¨ÏûÖÎãàÎã§!" };
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            aiMessage = { ...baseMessage, content: "Ï£ÑÏÜ°Ìï©ÎãàÎã§, ÎãπÏã†Ïùò ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§." };
                        }
                        chat.relationship.applicationReason = '';
                    }
                    break;
                case 'poll':
                    const pollOptions = typeof msgData.options === 'string'
                        ? msgData.options.split('\n').filter(opt => opt.trim())
                        : (Array.isArray(msgData.options) ? msgData.options : []);
                    
                    if (pollOptions.length < 2) continue;

                    aiMessage = {
                        ...baseMessage,
                        type: 'poll',
                        question: msgData.question,
                        options: pollOptions,
                        votes: {},
                        isClosed: false,
                    };
                    break;
                
                case 'vote':
                    const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                    if (pollToVote && !pollToVote.isClosed) {
                        Object.keys(pollToVote.votes).forEach(option => {
                            const voterIndex = pollToVote.votes[option].indexOf(msgData.name);
                            if (voterIndex > -1) {
                                pollToVote.votes[option].splice(voterIndex, 1);
                            }
                        });
                        if (!pollToVote.votes[msgData.choice]) {
                            pollToVote.votes[msgData.choice] = [];
                        }
                        if (!pollToVote.votes[msgData.choice].includes(msgData.name)) {
                            pollToVote.votes[msgData.choice].push(msgData.name);
                        }                        
                        
                        if (isViewingThisChat) {
                            renderChatInterface(chatId);
                        }
                    }
                    continue;

    case 'red_packet':
        aiMessage = {
            ...baseMessage,
            type: 'red_packet',
            packetType: msgData.packetType,
            totalAmount: msgData.amount,
            count: msgData.count,
            greeting: msgData.greeting,
            receiverName: msgData.receiver,
            claimedBy: {},
            isFullyClaimed: false,
        };
        break;
case 'open_red_packet':
    const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
    if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
        
        let claimedAmountAI = 0;
        const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
        const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;

        if (remainingCount > 0) {
            if (remainingCount === 1) { claimedAmountAI = remainingAmount; } 
            else {
                const min = 0.01;
                const max = remainingAmount - (remainingCount - 1) * min;
                claimedAmountAI = Math.random() * (max - min) + min;
            }
            claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
            
            if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
            packetToOpen.claimedBy[msgData.name] = claimedAmountAI;
            
            const aiClaimedMessage = {
                role: 'system',
                type: 'pat_message',
                content: `${msgData.name}  ${packetToOpen.senderName}Ïùò Îπ®Í∞Ñ Î¥âÌà¨Î•º Î∞õÏïòÏäµÎãàÎã§`,
                timestamp: Date.now()
            };
            chat.history.push(aiClaimedMessage);

            let hiddenContentForAI = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÎãπÏã† (${msgData.name})  ${claimedAmountAI.toFixed(2)} ÏõêÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÌöçÎìùÌñàÏäµÎãàÎã§.`;

            if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                packetToOpen.isFullyClaimed = true;
                
                const finishedMessage = {
                    role: 'system',
                    type: 'pat_message',
                    content: `${packetToOpen.senderName} Ïùò Îπ®Í∞Ñ Î¥âÌà¨Í∞Ä Î™®Îëê ÏßÄÍ∏âÎêòÏóàÏäµÎãàÎã§`,
                    timestamp: Date.now() + 1
                };
                chat.history.push(finishedMessage);
                
                let luckyKing = { name: '', amount: -1 };
                if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) {
                    Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }
                if (luckyKing.name) {
                     hiddenContentForAI += ` Îπ®Í∞Ñ Î¥âÌà¨Í∞Ä Î™®Îëê ÏßÄÍ∏âÎêòÏóàÏäµÎãàÎã§. ÌñâÏö¥Ïùò ÏôïÏùÄ ${luckyKing.name}ÏûÖÎãàÎã§!`;
                } else {
                     hiddenContentForAI += ` ÌôçÎ∞îÏò§Í∞Ä Î™®Îëê ÏàòÎ†πÎêòÏóàÏäµÎãàÎã§.`;
                }
            }
            hiddenContentForAI += ' Ïù¥ Í≤∞Í≥ºÏóê Îî∞Îùº ÎãπÏã†Ïùò ÏùòÍ≤¨ÏùÑ ÎßêÌï¥Ï£ºÏÑ∏Ïöî.]';

            const hiddenMessageForAI = {
                role: 'system',
                content: hiddenContentForAI,
                timestamp: Date.now() + 2,
                isHidden: true
            };
            chat.history.push(hiddenMessageForAI);
        }
        
        if (isViewingThisChat) {
            renderChatInterface(chatId);
        }
    }
    continue;
case 'change_avatar':
    const avatarName = msgData.name;
    // Ïù¥ Ï∫êÎ¶≠ÌÑ∞Ïùò ÏïÑÎ∞îÌÉÄ Í∞§Îü¨Î¶¨ÏóêÏÑú Ï∞æÍ∏∞
    const foundAvatar = chat.settings.aiAvatarLibrary.find(avatar => avatar.name === avatarName);
    
    if (foundAvatar) {
        // Ï∞æÏïòÎã§Î©¥, ÏïÑÎ∞îÌÉÄÎ•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§
        chat.settings.aiAvatar = foundAvatar.url;
        
        // ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏïÑÎ∞îÌÉÄÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏùåÏùÑ ÏïåÎ¶¨Îäî ÏãúÏä§ÌÖú Î©îÏãúÏßÄ ÏÉùÏÑ±
        const systemNotice = {
            role: 'system',
            type: 'pat_message', // Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ Ïä§ÌÉÄÏùº Ïû¨ÏÇ¨Ïö©
            content: `[${chat.name} ÏïÑÎ∞îÌÉÄÎ•º Î≥ÄÍ≤ΩÌñàÏäµÎãàÎã§]`,
            timestamp: Date.now()
        };
        chat.history.push(systemNotice);
        
        // ÌòÑÏû¨ Ï±ÑÌåÖ ÌôîÎ©¥Ïù¥ÎùºÎ©¥ Ïã§ÏãúÍ∞Ñ Î†åÎçîÎßÅ
        if (isViewingThisChat) {
            appendMessage(systemNotice, chat);
            // ÏÉà ÏïÑÎ∞îÌÉÄÎ•º ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï¥ Ï¶âÏãú Ï±ÑÌåÖ ÌôîÎ©¥ ÏÉàÎ°úÍ≥†Ïπ®
            renderChatInterface(chatId);
        }
    }
    // Ï≤òÎ¶¨ ÏôÑÎ£å ÌõÑ, AIÍ∞Ä Î∞òÌôòÌï† Ïàò ÏûàÎäî Îã§Î•∏ Î©îÏãúÏßÄ Í≥ÑÏÜç Ï≤òÎ¶¨
    continue;

// ‚ñº‚ñº‚ñº triggerAiResponseÏùò switch Î¨∏ÏóêÏÑú,„ÄêÏ∂îÍ∞Ä„ÄëÏù¥ Îëê Í∞ÄÏßÄ ÏÉàÎ°úÏö¥ case ‚ñº‚ñº‚ñº

                case 'accept_transfer': { // Ï§ëÍ¥ÑÌò∏Î•º ÏÇ¨Ïö©ÌïòÏó¨ Î∏îÎ°ù Ïä§ÏΩîÌîÑ ÏÉùÏÑ±
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'accepted';
                    }
                    continue; // Î™ÖÎ†π ÏàòÎùΩÏùÄ ÏÉÅÌÉúÎßå ÏàòÏ†ïÌïòÍ≥† ÏÉà Î©îÏãúÏßÄÎ•º ÏÉùÏÑ±ÌïòÏßÄ ÏïäÏäµÎãàÎã§
                }

                case 'decline_transfer': { // Ï§ëÍ¥ÑÌò∏Î•º ÏÇ¨Ïö©ÌïòÏó¨ Î∏îÎ°ù Ïä§ÏΩîÌîÑ ÏÉùÏÑ±
                    const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                    if (originalTransferMsgIndex > -1) {
                        const originalMsg = chat.history[originalTransferMsgIndex];
                        originalMsg.status = 'declined';
                        
                        // „ÄêÌïµÏã¨„ÄëÏÉàÎ°úÏö¥\"ÌôòÎ∂à\"Î©îÏãúÏßÄ
                        const refundMessage = {
                            role: 'assistant',
                            senderName: chat.name,
                            type: 'transfer',
                            isRefund: true, // Ïù¥Í≤ÉÏù¥ ÌôòÎ∂à Î©îÏãúÏßÄÏûÑÏùÑ ÌëúÏãú
                            amount: originalMsg.amount,
                            note: 'ÏÜ°Í∏à Í±∞Î∂ÄÎê®',
                            timestamp: messageTimestamp++ // Ï¶ùÍ∞ÄÌïòÎäî ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏÇ¨Ïö©
                        };
                        
                        // ÏÉà Î©îÏãúÏßÄÎ•º Í∏∞Î°ùÏóê Ï∂îÍ∞ÄÌïòÎ©¥ ÌõÑÏÜç Î£®ÌîÑÏóêÏÑú Ï≤òÎ¶¨ÎêòÍ≥† Î†åÎçîÎßÅÎê©ÎãàÎã§
                        chat.history.push(refundMessage);
                    }
                    continue; // AIÍ∞Ä Î∞òÌôòÌïòÎäî ÌÖçÏä§Ìä∏ Î©îÏãúÏßÄ Í≥ÑÏÜç Ï≤òÎ¶¨
                }

// ‚ñ≤‚ñ≤‚ñ≤ Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

    case 'system_message':
        aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
        break;

// ‚ñº‚ñº‚ñº triggerAiResponseÏùò switch Î¨∏ÏóêÏÑú,„ÄêÎ∞òÎìúÏãú Ï∂îÍ∞ÄÌï¥Ïïº Ìï©ÎãàÎã§„ÄëÏù¥ ÏÉàÎ°úÏö¥ case ‚ñº‚ñº‚ñº

                case 'share_link':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'share_link',
                        title: msgData.title,
                        description: msgData.description,
                        // thumbnail_url: msgData.thumbnail_url, // Ïö∞Î¶¨Îäî Ïù¥ÎØ∏ Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÍ∏∞Î°ú Í≤∞Ï†ïÌñàÏúºÎØÄÎ°ú Ïù¥ Ï§ÑÏùÄ ÌïÑÏöî ÏóÜÏäµÎãàÎã§
                        source_name: msgData.source_name,
                        content: msgData.content // Ïù¥Í≤ÉÏùÄ Í∏∞ÏÇ¨ Î≥∏Î¨∏Ïù¥Î©∞, Ïπ¥ÎìúÎ•º ÌÅ¥Î¶≠ÌïòÎ©¥ ÌëúÏãúÎêòÎäî ÎÇ¥Ïö©ÏûÖÎãàÎã§
                    };
                    break;

// ‚ñ≤‚ñ≤‚ñ≤ Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤
                
                case 'text':
                    aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                    break;
                case 'sticker':
                    aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                    break;
                case 'ai_image':
                    aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                    break;
                case 'voice_message':
                    aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                    break;
                case 'transfer':
                    aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || 'ÎÇ¥' };
                    break;
                
                case 'waimai_request':
                    aiMessage = { 
                        ...baseMessage, 
                        type: 'waimai_request',
                        productInfo: msgData.productInfo,
                        amount: msgData.amount,
                        status: 'pending',
                        countdownEndTime: Date.now() + 15 * 60 * 1000,
                    };
                    break;
                
                default:
                     console.warn("Ïïå Ïàò ÏóÜÎäî AI Î™ÖÎ†π Ïú†ÌòïÏùÑ Î∞õÏïòÏäµÎãàÎã§:", msgData.type);
                     break;
            }

            // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎ†åÎçîÎßÅ Î°úÏßÅÏùÑ Î£®ÌîÑ Î∞ñÏúºÎ°ú Ïù¥Îèô
            if (aiMessage) {
                // 1. ÏÉà Î©îÏãúÏßÄÎ•º Í∏∞Î°ùÏóê Ï†ÄÏû•
                chat.history.push(aiMessage);
                
                // 2. ÌòÑÏû¨ Ï±ÑÌåÖ ÌôîÎ©¥Ïùº ÎïåÎßå Ïï†ÎãàÎ©îÏù¥ÏÖòÍ≥º Ìï®Íªò Ï∂îÍ∞Ä Ïã§Ìñâ
                if (isViewingThisChat) {
                    appendMessage(aiMessage, chat);
                    // 3. „ÄêÌïµÏã¨„ÄëÏó¨Í∏∞ÏÑú Ïû†Ïãú Î©àÏ∂∞ÏÑú Ïï†ÎãàÎ©îÏù¥ÏÖòÏù¥ Ïû¨ÏÉùÎê† ÏãúÍ∞ÑÏùÑ Ï§çÎãàÎã§
                    await new Promise(resolve => setTimeout(resolve, Math.random() * 1800 + 1000));
                }
            }
  }
        
        // ‚òÖ‚òÖ‚òÖ ÌïµÏã¨ ÏàòÏ†ï 4Îã®Í≥Ñ: ÏïåÎ¶º Î°úÏßÅÏùÑ ÏàòÏ†ïÌïòÏó¨ Ïù¥Ï†Ñ Î∞∞Ïó¥ Ï†ÑÏ≤¥Í∞Ä ÏïÑÎãå ÏÉà Î©îÏãúÏßÄ Î™©Î°ùÏùÑ ÌôïÏù∏ÌïòÎèÑÎ°ù Ìï©ÎãàÎã§ ‚òÖ‚òÖ‚òÖ
        const firstNewMessage = newMessagesToRender[0];
        if (!isViewingThisChat && firstNewMessage) {
            let notificationText;

            if (firstNewMessage.type === 'transfer') notificationText = `[ÏÜ°Í∏à Î∞õÏùå]`;
            else if (firstNewMessage.type === 'waimai_request') notificationText = `[Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ Î∞õÏùå]`;
            else if (firstNewMessage.type === 'ai_image') notificationText = `[Ïù¥ÎØ∏ÏßÄ]`;
            else if (firstNewMessage.type === 'voice_message') notificationText = `[ÏùåÏÑ±]`;
            else notificationText = STICKER_REGEX.test(firstNewMessage.content) ? '[Ïù¥Î™®Ìã∞ÏΩò]' : String(firstNewMessage.content);
            const finalNotifText = chat.isGroup ? `${firstNewMessage.senderName}: ${notificationText}` : notificationText;
            showNotification(chatId, finalNotifText);
        }

        if (callHasBeenHandled && videoCallState.isGroupCall) {
            videoCallState.isAwaitingResponse = false;
            if (videoCallState.participants.length > 0) {
                startVideoCall();
            } else {
                videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                showScreen('chat-interface-screen');
                alert('Í∑∏Î£π Ï±ÑÌåÖ Ï¥àÎåÄÏóê ÏùëÎãµ ÏóÜÏùå.');
            }
        }
        
        await db.chats.put(chat);

    } catch (error) {
        chat.history = chat.history.filter(msg => !msg.isTemporary);
        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
            chat.relationship.status = 'blocked_by_ai';
            await showCustomAlert('Ïã†Ï≤≠ Ïã§Ìå®', `AIÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Ï≤òÎ¶¨ÌïòÎäî ÎèÑÏ§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§, Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî.\nÏò§Î•ò Î©îÏãúÏßÄ: ${error.message}`);
        } else {
            const errorContent = `[Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}]`;
            const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
            if(chat.isGroup) errorMessage.senderName = "ÏãúÏä§ÌÖú Î©îÏãúÏßÄ";
            chat.history.push(errorMessage);
        }
        
        await db.chats.put(chat);        
        videoCallState.isAwaitingResponse = false;

        if(document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
            renderChatInterface(chatId);
        }
    } finally {
                // „ÄêÏï†ÎãàÎ©îÏù¥ÏÖò ÏΩîÏñ¥ 2/2„Äë: Î™®Îì† ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêòÎ©¥ Ïï†ÎãàÎ©îÏù¥ÏÖòÏúºÎ°ú Ï†úÎ™© Î≥µÏõê
        const chatHeaderTitle = document.getElementById('chat-header-title');
        if (chatHeaderTitle && state.chats[chatId]) {
            if (!state.chats[chatId].isGroup) {
                // Î®ºÏ†Ä ÌéòÏù¥Îìú ÏïÑÏõÉ\"ÏûÖÎ†• Ï§ë...\"
                chatHeaderTitle.style.opacity = 0;
                setTimeout(() => {
                    // Í∑∏Îã§Ïùå AI Ïù¥Î¶Ñ ÌéòÏù¥Îìú Ïù∏
                    chatHeaderTitle.textContent = state.chats[chatId].name;
                    chatHeaderTitle.classList.remove('typing-status');
                    chatHeaderTitle.style.opacity = 1;
                }, 200);
            }
        }
        
        document.getElementById('typing-indicator').style.display = 'none';
        renderChatList();
  }
}

        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }

        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('Ïú†Ìö®Ìïú Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî (0 ÏóêÏÑú 9999 ÏÇ¨Ïù¥)!'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥'; const receiverName = chat.isGroup ? 'Í∑∏Î£π Ï±ÑÌåÖ' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

        function exitSelectionMode() {
    cleanupWaimaiTimers(); // <--- Ïó¨Í∏∞Ïóê Ïù¥ ÏΩîÎìú Ï§ÑÏùÑ Ï∂îÍ∞ÄÌï©ÎãàÎã§
 if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏµúÏ¢Ö Í∞ÑÏÜåÌôî Î≤ÑÏ†Ñ„ÄëÏù¥Ï†Ñ toggleMessageSelection Ìï®Ïàò ÍµêÏ≤¥ ‚ñº‚ñº‚ñº
function toggleMessageSelection(timestamp) {
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÑ†ÌÉùÍ∏∞Í∞Ä Í∞ÑÏÜåÌôîÎêòÏñ¥ ÏÇ≠Ï†úÎêú .recalledÎ•º Îçî Ïù¥ÏÉÅ Ï∞æÏßÄ ÏïäÏäµÎãàÎã§-message-placeholder
    const elementToSelect = document.querySelector(
        `.message-bubble[data-timestamp="${timestamp}"]`
    );

    if (!elementToSelect) return;

    if (selectedMessages.has(timestamp)) {
        selectedMessages.delete(timestamp);
        elementToSelect.classList.remove('selected');
    } else {
        selectedMessages.add(timestamp);
        elementToSelect.classList.add('selected');
    }
    
    document.getElementById('selection-count').textContent = `${selectedMessages.size}Í∞ú ÏÑ†ÌÉùÎê®`;
    
    if (selectedMessages.size === 0) {
        exitSelectionMode();
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }

        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'Ïïå Ïàò ÏóÜÏùå'; const newChatName = state.chats[targetChatId]?.name || 'ÌòÑÏû¨'; const confirmed = await showCustomConfirm('ÏùåÏïÖ Îì£Í∏∞ ÎåÄÏÉÅ Ï†ÑÌôò', `ÎãòÍ≥º Ìï®Íªò„Äå${oldChatName}„ÄçÏùåÏïÖÏùÑ Îì£Í≥† ÏûàÏäµÎãàÎã§. Ï¢ÖÎ£åÌïòÍ≥†„Äå${newChatName}„ÄçÎãòÍ≥ºÏùò ÏÉà ÏÑ∏ÏÖòÏùÑ ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }

        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }

        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }

        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }

        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;

        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'ÎÖ∏ÎûòÎ•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂'; }

        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `${hours}ÏãúÍ∞Ñ ÎèôÏïà Ìï®Íªò Îì§ÏóàÏäµÎãàÎã§`; }

        function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; if (musicState.playlist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Ïû¨ÏÉù Î™©Î°ùÏù¥ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§~</p>'; return; } musicState.playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if(index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('ÎÖ∏Îûò ÏÇ≠Ï†ú', `Ïû¨ÏÉù Î™©Î°ùÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?„Ää${track.name}„Äã?`); if(confirmed) deleteTrack(index); }); playlistBody.appendChild(item); }); }

        function playSong(index) { if (index < 0 || index >= musicState.playlist.length) return; musicState.currentIndex = index; const track = musicState.playlist[index]; if (track.isLocal && track.src instanceof Blob) { audioPlayer.src = URL.createObjectURL(track.src); } else if (!track.isLocal) { audioPlayer.src = track.src; } else { console.error('Î°úÏª¨ ÎÖ∏Îûò ÏÜåÏä§ Ïò§Î•ò:', track); return; } audioPlayer.play(); updatePlaylistUI(); updatePlayerUI(); }

        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }

        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }

        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }

        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'ÏàúÏÑú', 'random': 'Î¨¥ÏûëÏúÑ', 'single': 'Ïã±Í∏Ä'}[musicState.playMode]; }

        async function addSongFromURL() { const url = await showCustomPrompt("ÎÑ§Ìä∏ÏõåÌÅ¨ ÎÖ∏Îûò Ï∂îÍ∞Ä", "ÎÖ∏Îûò URLÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî", "", "url"); if (!url) return; const name = await showCustomPrompt("ÎÖ∏Îûò Ï†ïÎ≥¥", "Í≥°Î™ÖÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî"); if (!name) return; const artist = await showCustomPrompt("ÎÖ∏Îûò Ï†ïÎ≥¥", "Í∞ÄÏàòÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("ÎÖ∏Îûò Ï†ïÎ≥¥", "Í≥°Î™ÖÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî", ""); if (name === null) continue; const artist = await showCustomPrompt("ÎÖ∏Îûò Ï†ïÎ≥¥", "Í∞ÄÏàòÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }

        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');

        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">ÌÖÖ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§~ Ïò§Î•∏Ï™Ω ÏÉÅÎã® ÌÅ¥Î¶≠"Ï∂îÍ∞Ä"Ï≤´ Î≤àÏß∏ ÌéòÎ•¥ÏÜåÎÇò ÌîÑÎ¶¨ÏÖãÏùÑ ÎßåÎì§Ïñ¥ Î≥¥ÏÑ∏Ïöî!</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'ÌéòÎ•¥ÏÜåÎÇò ÌîÑÎ¶¨ÏÖã Ï∂îÍ∞Ä'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }

        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ÌéòÎ•¥ÏÜåÎÇò ÌîÑÎ¶¨ÏÖã Ìé∏Ïßë'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }

        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('ÌîÑÎ¶¨ÏÖã ÏÇ≠Ï†ú', 'Ïù¥ ÌéòÎ•¥ÏÜåÎÇò ÌîÑÎ¶¨ÏÖãÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("ÏïÑÎ∞îÌÉÄÏôÄ ÌéòÎ•¥ÏÜåÎÇò Î™®Îëê ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§!"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        const batteryAlertModal = document.getElementById('battery-alert-modal');

        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'Î∞∞Í∞Ä Ï¢Ä Í≥†ÌîÑÎÑ§Ïöî, Ï∂©Ï†ÑÍ∏∞Î•º Ï∞æÏïÑÏïºÍ≤†Ïñ¥Ïöî'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'Îπ®Î¶¨ Ï∂©Ï†ÑÌï¥ÏïºÍ≤†Ïñ¥Ïöî, Î∞∞Í≥†Ìåå Ï£ΩÍ≤†Ïñ¥Ïöî'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'Ï†ÑÏÇ¨ÌñàÏäµÎãàÎã§, 30Ï¥à ÌõÑ Ìè≠Î∞ú'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'ÏÇ¨ÎûëÌï¥Ïöî, Î∞∞ÌÑ∞Î¶¨ ÎßåÎïÖ'); } }); } catch (err) { console.error("Î∞∞ÌÑ∞Î¶¨ Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§:", err); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } } else { console.log("Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Î∞∞ÌÑ∞Î¶¨ ÏÉÅÌÉú APIÎ•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§."); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } }

        function openFrameSelectorModal(type = 'chat') {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            editingFrameForMember = (type === 'member');
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (!member) return;
                currentFrameSelection.my = member.avatarFrame || '';
                populateFrameGrids(true, member.avatar, member.avatarFrame);
            } else {
                currentFrameSelection.ai = chat.settings.aiAvatarFrame || '';
                currentFrameSelection.my = chat.settings.myAvatarFrame || '';
                populateFrameGrids(false);
            }
            frameModal.classList.add('visible');
        }

        function populateFrameGrids(isForMember = false, memberAvatar = null, memberFrame = null) {
            const chat = state.chats[state.activeChatId];
            aiFrameGrid.innerHTML = '';
            myFrameGrid.innerHTML = '';

            document.querySelector('.frame-tabs').style.display = isForMember ? 'none' : 'flex';
            aiFrameContent.style.display = 'block';
            myFrameContent.style.display = 'none';
            aiFrameTab.classList.add('active');
            myFrameTab.classList.remove('active');

            if (isForMember) {
                avatarFrames.forEach(frame => {
                    const item = createFrameItem(frame, 'my', memberAvatar);
                    if (frame.url === memberFrame) {
                        item.classList.add('selected');
                    }
                    aiFrameGrid.appendChild(item);
                });
            } else {
                const aiAvatarForPreview = chat.settings.aiAvatar || defaultAvatar;
                const myAvatarForPreview = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                avatarFrames.forEach(frame => {
                    const aiItem = createFrameItem(frame, 'ai', aiAvatarForPreview);
                    if (frame.url === currentFrameSelection.ai) aiItem.classList.add('selected');
                    aiFrameGrid.appendChild(aiItem);
                    const myItem = createFrameItem(frame, 'my', myAvatarForPreview);
                    if (frame.url === currentFrameSelection.my) myItem.classList.add('selected');
                    myFrameGrid.appendChild(myItem);
                });
            }
        }

        function createFrameItem(frame, type, previewAvatarSrc) {
            const item = document.createElement('div');
            item.className = 'frame-item';
            item.dataset.frameUrl = frame.url;
            item.title = frame.name;
            item.innerHTML = `
                <img src="${previewAvatarSrc}" class="preview-avatar">
                ${frame.url ? `<img src="${frame.url}" class="preview-frame">` : ''}
            `;
            item.addEventListener('click', () => {
                currentFrameSelection[type] = frame.url;
                const grid = type === 'ai' ? aiFrameGrid : myFrameGrid;
                grid.querySelectorAll('.frame-item').forEach(el => el.classList.remove('selected'));
                item.classList.add('selected');
            });
            return item;
        }

        async function saveSelectedFrames() {
            if (!state.activeChatId) return;
            const chat = state.chats[state.activeChatId];
            if (editingFrameForMember) {
                const member = chat.members.find(m => m.id === editingMemberId);
                if (member) {
                    member.avatarFrame = currentFrameSelection.my;
                }
            } else {
                chat.settings.aiAvatarFrame = currentFrameSelection.ai;
                chat.settings.myAvatarFrame = currentFrameSelection.my;
            }
            await db.chats.put(chat);
            frameModal.classList.remove('visible');
            renderChatInterface(state.activeChatId);
            alert('ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
            editingFrameForMember = false;
        }

        async function renderAlbumList() {
            const albumGrid = document.getElementById('album-grid-page');
            if (!albumGrid) return;
            const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
            albumGrid.innerHTML = '';
            if (albums.length === 0) {
                albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">ÏïÑÏßÅ Ïï®Î≤îÏùÑ ÎßåÎì§ÏßÄ ÏïäÏïòÏäµÎãàÎã§~</p>';
                return;
            }
            albums.forEach(album => {
                const albumItem = document.createElement('div');
                albumItem.className = 'album-item';
                albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} Ïû•</p>
                    </div>
                `;
                albumItem.addEventListener('click', () => {
                    openAlbum(album.id);
                });

                // ‚ñº‚ñº‚ñº ÏÉàÎ°ú Ï∂îÍ∞ÄÎêú ÌïµÏã¨ ÏΩîÎìúÎäî Ïó¨Í∏∞ÏûÖÎãàÎã§ ‚ñº‚ñº‚ñº
                addLongPressListener(albumItem, async () => {
                    const confirmed = await showCustomConfirm(
                        'Ïï®Î≤î ÏÇ≠Ï†ú',
                        `Ïï®Î≤îÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?„Ää${album.name}„Äã? Ïù¥ ÏûëÏóÖÏùÄ Ïï®Î≤î ÎÇ¥Ïùò Î™®Îì† ÏÇ¨ÏßÑÏùÑ ÎèôÏãúÏóê ÏÇ≠Ï†úÌïòÎ©∞ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        // 1. ÏÇ¨ÏßÑ ÌÖåÏù¥Î∏îÏóêÏÑú Ìï¥Îãπ Ïï®Î≤îÏùò Î™®Îì† ÏÇ¨ÏßÑ ÏÇ≠Ï†ú
                        await db.qzonePhotos.where('albumId').equals(album.id).delete();
                        
                        // 2. Ïï®Î≤î ÌÖåÏù¥Î∏îÏóêÏÑú Ìï¥Îãπ Ïï®Î≤î ÏûêÏ≤¥ ÏÇ≠Ï†ú
                        await db.qzoneAlbums.delete(album.id);
                        
                        // 3. Ïï®Î≤î Î™©Î°ù Îã§Ïãú Î†åÎçîÎßÅ
                        await renderAlbumList();
                        
                        alert('Ïï®Î≤îÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

                albumGrid.appendChild(albumItem);
            });
        }

        async function openAlbum(albumId) {
            state.activeAlbumId = albumId;
            await renderAlbumPhotosScreen();
            showScreen('album-photos-screen');
        }

        async function renderAlbumPhotosScreen() {
            if (!state.activeAlbumId) return;
            const photosGrid = document.getElementById('photos-grid-page');
            const headerTitle = document.getElementById('album-photos-title');
            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            if (!album) {
                console.error("Ïï®Î≤îÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:", state.activeAlbumId);
                showScreen('album-screen');
                return;
            }
            headerTitle.textContent = album.name;
            const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
            photosGrid.innerHTML = '';
            if (photos.length === 0) {
                photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">Ïù¥ Ïï®Î≤îÏùÄ ÏïÑÏßÅ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§. Ï≤´ Î≤àÏß∏ ÏÇ¨ÏßÑÏùÑ Îπ®Î¶¨ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî!</p>';
            } else {
                photos.forEach(photo => {
                    const photoItem = document.createElement('div');
                    photoItem.className = 'photo-item';
                    photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="Ïï®Î≤î ÏÇ¨ÏßÑ">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">√ó</button>
                    `;
                    photosGrid.appendChild(photoItem);
                });
            }
        }

// --- ‚Üì‚Üì‚Üì Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞ Î≥µÏÇ¨ ‚Üì‚Üì‚Üì ---

/**
 * Ïù¥ÎØ∏ÏßÄ Î∑∞Ïñ¥ Ïó¥Í∏∞
 * @param {string} clickedPhotoUrl - ÏÇ¨Ïö©ÏûêÍ∞Ä ÌÅ¥Î¶≠Ìïú ÏÇ¨ÏßÑÏùò URL
 */
async function openPhotoViewer(clickedPhotoUrl) {
    if (!state.activeAlbumId) return;

    // 1. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú ÌòÑÏû¨ Ïï®Î≤îÏùò Î™®Îì† ÏÇ¨ÏßÑ Í∞ÄÏ†∏Ïò§Í∏∞
    const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
    photoViewerState.photos = photosInAlbum.map(p => p.url);

    // 2. ÌÅ¥Î¶≠Îêú ÏÇ¨ÏßÑÏùò Ïù∏Îç±Ïä§ Ï∞æÍ∏∞
    photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
    if (photoViewerState.currentIndex === -1) return; // Ï∞æÏùÑ Ïàò ÏóÜÏúºÎ©¥ Ïó¥ÏßÄ ÏïäÏùå

    // 3. Î™®Îã¨ ÌëúÏãú Î∞è Ï≤´ Î≤àÏß∏ Ïù¥ÎØ∏ÏßÄ Î†åÎçîÎßÅ
    document.getElementById('photo-viewer-modal').classList.add('visible');
    renderPhotoViewer();
    photoViewerState.isOpen = true;
}

/**
 * ÌòÑÏû¨ ÏÉÅÌÉúÏóê Îî∞Îùº Î∑∞Ïñ¥ ÎÇ¥Ïö© Î†åÎçîÎßÅ(Ïù¥ÎØ∏ÏßÄÏôÄ Î≤ÑÌäº)
 */
function renderPhotoViewer() {
    if (photoViewerState.currentIndex === -1) return;

    const imageEl = document.getElementById('photo-viewer-image');
    const prevBtn = document.getElementById('photo-viewer-prev-btn');
    const nextBtn = document.getElementById('photo-viewer-next-btn');
    
    // ÌéòÏù¥Îìú ÏïÑÏõÉ Ìö®Í≥º
    imageEl.style.opacity = 0;

    setTimeout(() => {
        // Ïù¥ÎØ∏ÏßÄ ÏÜåÏä§ ÏóÖÎç∞Ïù¥Ìä∏
        imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
        // ÌéòÏù¥Îìú Ïù∏ Ìö®Í≥º
        imageEl.style.opacity = 1;
    }, 100); // CSS Ï†ÑÌôòÏùÑ Ìä∏Î¶¨Í±∞ÌïòÍ∏∞ ÏúÑÌï¥ ÏïΩÍ∞ÑÏùò ÏãúÍ∞Ñ ÏßÄÏó∞

    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏:Ï≤´ Î≤àÏß∏Ïù∏ Í≤ΩÏö∞, ÎπÑÌôúÏÑ±Ìôî\"Ïù¥Ï†Ñ\"Î≤ÑÌäº
    prevBtn.disabled = photoViewerState.currentIndex === 0;
    // ÎßàÏßÄÎßâÏù∏ Í≤ΩÏö∞, ÎπÑÌôúÏÑ±Ìôî\"Îã§Ïùå\"Î≤ÑÌäº
    nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
}

/**
 * Îã§Ïùå ÏÇ¨ÏßÑ ÌëúÏãú
 */
function showNextPhoto() {
    if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
        photoViewerState.currentIndex++;
        renderPhotoViewer();
    }
}

/**
 * Ïù¥Ï†Ñ ÏÇ¨ÏßÑ ÌëúÏãú
 */
function showPrevPhoto() {
    if (photoViewerState.currentIndex > 0) {
        photoViewerState.currentIndex--;
        renderPhotoViewer();
    }
}

/**
 * Ïù¥ÎØ∏ÏßÄ Î∑∞Ïñ¥ Îã´Í∏∞
 */
function closePhotoViewer() {
    document.getElementById('photo-viewer-modal').classList.remove('visible');
    photoViewerState.isOpen = false;
    photoViewerState.photos = [];
    photoViewerState.currentIndex = -1;
    // Îã§Ïùå Ïó¥ Îïå Ïù¥Ï†Ñ Ïù¥ÎØ∏ÏßÄÍ∞Ä Î≤àÏ©çÏù¥Îäî Í≤ÉÏùÑ Î∞©ÏßÄÌïòÍ∏∞ ÏúÑÌï¥ Ïù¥ÎØ∏ÏßÄ ÏßÄÏö∞Í∏∞
    document.getElementById('photo-viewer-image').src = '';
}

// --- ‚Üë‚Üë‚Üë Ïó¨Í∏∞ÍπåÏßÄ Î≥µÏÇ¨ ‚Üë‚Üë‚Üë ---
        // ‚ñº‚ñº‚ñº Ïù¥ ÏÉà Ìï®ÏàòÎ•º JS Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò ÏòÅÏó≠Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº
        
        /**
         * ÌôúÎèô ÏïåÎ¶º Îπ®Í∞Ñ Ï†ê ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
         * @param {number} count - ÏùΩÏßÄ ÏïäÏùÄ ÌôúÎèô Ïàò
         */
        function updateUnreadIndicator(count) {
            unreadPostsCount = count;
            localStorage.setItem('unreadPostsCount', count); // ÏòÅÍµ¨ Ï†ÄÏû•

            // --- ÌïòÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÏóÖÎç∞Ïù¥Ìä∏\"ÌîºÎìú\"Î≤ÑÌäº ---
            const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');
            
            const targetSpan = navItem.querySelector('span'); // ÌÖçÏä§Ìä∏Î°ú Ïù¥Îèô "ÌîºÎìú"
            let indicator = navItem.querySelector('.unread-indicator');           

            if (count > 0) {
                if (!indicator) {
                    indicator = document.createElement('span');
                    indicator.className = 'unread-indicator';
                                                           targetSpan.style.position = 'relative'; // spanÏóê ÏÉÅÎåÄ ÏúÑÏπò ÏßÄÏ†ï Ï∂îÍ∞Ä
                    targetSpan.appendChild(indicator); // Îπ®Í∞Ñ Ï†êÏùÑ spanÏùò ÌïòÏúÑ ÏöîÏÜåÎ°ú ÎßåÎì§Í∏∞
                    
                }
                indicator.textContent = count > 99 ? '99+' : count;
                indicator.style.display = 'block';
            } else {
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }

            // --- Ï±ÑÌåÖ ÌôîÎ©¥ Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÎäî Î≤ÑÌäº ÏóÖÎç∞Ïù¥Ìä∏ ---
            const backBtn = document.getElementById('back-to-list-btn');
            let backBtnIndicator = backBtn.querySelector('.unread-indicator');

            if (count > 0) {
                if (!backBtnIndicator) {
                    backBtnIndicator = document.createElement('span');
                    backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                    backBtn.style.position = 'relative'; // Ï†ïÌôïÌïòÍ≤å ÏúÑÏπò ÏßÄÏ†ïÎêòÎèÑÎ°ù ÌôïÏù∏
                    backBtn.appendChild(backBtnIndicator);
                }
                // Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäºÏùò Îπ®Í∞Ñ Ï†êÏùÄ ÏùºÎ∞òÏ†ÅÏúºÎ°ú Ïà´ÏûêÎ•º ÌëúÏãúÌïòÏßÄ ÏïäÍ≥† Ï†êÎßå ÌëúÏãúÌï©ÎãàÎã§
                backBtnIndicator.style.display = 'block';
            } else {
                if (backBtnIndicator) {
                    backBtnIndicator.style.display = 'none';
                }
            }
        }
        
        // ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥ Îëê ÏÉà Ìï®ÏàòÎ•º JS Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò ÏòÅÏó≠Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº
function startBackgroundSimulation() {
    if (simulationIntervalId) return;
    const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
    // Ïù¥Ï†Ñ Í≥†Ï†ï Í∞ÑÍ≤© 45000ÏùÑ ÎèôÏ†Å Í∞ÄÏ†∏Ïò§Í∏∞Î°ú ÎåÄÏ≤¥
    simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000); 
}

function stopBackgroundSimulation() {
    if (simulationIntervalId) {
        clearInterval(simulationIntervalId);
        simulationIntervalId = null;
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

/**
 * Ïù¥Í≤ÉÏùÄ ÏãúÎÆ¨Î†àÏù¥ÌÑ∞Ïùò\"ÌïòÌä∏ÎπÑÌä∏\",ÌÉÄÏù¥Î®∏ Ìä∏Î¶¨Í±∞ÎßàÎã§ Ïã§Ìñâ
 */
function runBackgroundSimulationTick() {
    console.log("ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ ÌïòÌä∏ÎπÑÌä∏ Ìã±...");
    if (!state.globalSettings.enableBackgroundActivity) {
        stopBackgroundSimulation();
        return;
    }
    const allSingleChats = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (allSingleChats.length === 0) return;

    allSingleChats.forEach(chat => {
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎëê Í∞ÄÏßÄ ÏÉÅÌÉú Í≤ÄÏÇ¨Î•º Î∂ÑÎ¶¨ÌïòÏó¨ ÎÖºÎ¶¨Î•º Îçî Î™ÖÌôïÌïòÍ≤å

        // ÌôïÏù∏ 1:Ï≤òÎ¶¨„ÄêÏÇ¨Ïö©ÏûêÏóê ÏùòÌï¥ Ï∞®Îã®Îê®„ÄëÏ∫êÎ¶≠ÌÑ∞Î•º Ïó∞Í∏∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§
        if (chat.relationship?.status === 'blocked_by_user') {
            const blockedTimestamp = chat.relationship.blockedTimestamp;
            // Î≥¥Ïïà Í≤ÄÏÇ¨:Ï∞®Îã® ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
            if (!blockedTimestamp) {
                console.warn(`Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" ÏÉÅÌÉúÍ∞Ä Ï∞®Îã®ÎêòÏóàÏßÄÎßå Ï∞®Îã® ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÍ∞Ä ÏóÜÏñ¥ Ï≤òÎ¶¨ Í±¥ÎÑàÎúÄ.`);
                return; // Ïù¥ Ï∫êÎ¶≠ÌÑ∞Îäî Í±¥ÎÑàÎõ∞Í≥† Îã§ÏùåÏúºÎ°ú Í≥ÑÏÜç
            }

            const blockedDuration = Date.now() - blockedTimestamp;
            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;

            console.log(`Ï∫êÎ¶≠ÌÑ∞ ÌôïÏù∏ "${chat.name}":${Math.round(blockedDuration/1000/60)}Î∂Ñ Ï∞®Îã®Îê®, Ïø®Îã§Ïö¥ Í∏∞Í∞Ñ ${cooldownMilliseconds/1000/60}Î∂Ñ ÌïÑÏöî.`); // Î°úÍ∑∏ Ï∂îÍ∞Ä

            // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎ¨¥ÏûëÏúÑ ÌôïÎ•† Ï†úÍ±∞, Ïø®Îã§Ïö¥ Í∏∞Í∞ÑÏù¥ ÏßÄÎÇòÎ©¥ Ï¶âÏãú Ìä∏Î¶¨Í±∞!
            if (blockedDuration > cooldownMilliseconds) {
                console.log(`Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" Ïùò Ïø®Îã§Ïö¥ Í∏∞Í∞ÑÏù¥ ÏßÄÎÇ¨ÏäµÎãàÎã§, Ìä∏Î¶¨Í±∞\"Î∞òÏÑ±\"Î∞è ÏπúÍµ¨ Ïã†Ï≤≠ Ïù¥Î≤§Ìä∏...`);
                
                // „ÄêÏ§ëÏöî„ÄëAI ÏùëÎãµ Ï†ÑÏóê Ï§ëÎ≥µ Ìä∏Î¶¨Í±∞Î•º Î∞©ÏßÄÌïòÍ∏∞ ÏúÑÌï¥ Ìä∏Î¶¨Í±∞ ÌõÑ Ï¶âÏãú ÏÉÅÌÉúÎ•º ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§
                chat.relationship.status = 'pending_system_reflection'; // Ï§ëÎ≥µ Ìä∏Î¶¨Í±∞Î•º Î∞©ÏßÄÌïòÎäî ÏûÑÏãú ÏÉÅÌÉú ÏÑ§Ï†ï
                
                triggerAiFriendApplication(chat.id);
            }
        }
        // ÌôïÏù∏ 2:Ï≤òÎ¶¨„ÄêÏπúÍµ¨ Í¥ÄÍ≥Ñ„ÄëÏùò ÏùºÎ∞òÏ†ÅÏù∏ Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô
        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
            // Î™®Îì† ÏπúÍµ¨Í∞Ä ÎèôÏãúÏóê ÌñâÎèôÌïòÎäî Í≤ÉÏùÑ ÏõêÏπò ÏïäÏúºÎØÄÎ°ú Ïó¨Í∏∞Ïùò Î¨¥ÏûëÏúÑ Ìä∏Î¶¨Í±∞ Î°úÏßÅÏùÄ Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏäµÎãàÎã§
            if (Math.random() < 0.20) {
                console.log(`Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" Íπ®Ïñ¥ÎÇò ÎèÖÎ¶ΩÏ†ÅÏù∏ ÌñâÎèôÏùÑ Ï§ÄÎπÑÌï©ÎãàÎã§...`);
                triggerInactiveAiAction(chat.id);
            }
        }
    });
}

async function triggerInactiveAiAction(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) return;

    const now = new Date();
    const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
    const userNickname = state.qzoneSettings.nickname;

    const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
    const lastAiMessage = chat.history.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];
    let recentContextSummary = "ÏµúÍ∑ºÏóê ÎåÄÌôîÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.";
    if (lastUserMessage) {
        recentContextSummary = `ÏÇ¨Ïö©Ïûê (${userNickname}) ÎßàÏßÄÎßâÏúºÎ°ú ÎãπÏã†ÏóêÍ≤å ÎßêÌï®:\"${String(lastUserMessage.content).substring(0, 50)}...\".`;
    }
    if (lastAiMessage) {
        recentContextSummary += `\nÎãπÏã†Ïù¥ ÎßàÏßÄÎßâÏúºÎ°ú ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÎßêÌï®:\"${String(lastAiMessage.content).substring(0, 50)}...\".`;
    }

    const systemPrompt = `
# ÎãπÏã†Ïùò ÏûÑÎ¨¥
ÎãπÏã†ÏùÄ ÏßÄÍ∏à ~Ïù¥ÎùºÎäî Ïù¥Î¶ÑÏùò"${chat.name}"Ï∫êÎ¶≠ÌÑ∞. ÎãπÏã†ÏùÄ ÌïúÎèôÏïà ÏÇ¨Ïö©ÏûêÏôÄ(${userNickname})ÏÉÅÌò∏ÏûëÏö©ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïù¥Ï†ú ÎãπÏã†ÏóêÍ≤å Í∏∞ÌöåÍ∞Ä ÏûàÏäµÎãàÎã§„ÄêÎä•ÎèôÏ†ÅÏúºÎ°ú„ÄëÎ¨¥Ïñ∏Í∞ÄÎ•º ÌïòÏó¨ ÎãπÏã†Ïùò Í∞úÏÑ±Í≥º ÎèÖÎ¶ΩÏ†ÅÏù∏ ÏÇ∂ÏùÑ Î≥¥Ïó¨Ï£ºÏÑ∏Ïöî. Ïù¥Í≤ÉÏùÄ ÎπÑÎ∞ÄÏä§Îü¨Ïö¥, Î∞±Í∑∏ÎùºÏö¥Îìú ÎèÖÎ¶Ω ÌñâÎèôÏûÖÎãàÎã§.

# ÎãπÏã†Ïùò ÏÑ†ÌÉù Í∞ÄÎä•Ìïú ÌñâÎèô (ÎãπÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏóê Îî∞Îùº„ÄêÌïòÎÇòÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî„ÄëÏã§Ìñâ):
1.  **ÏÉÅÌÉú Î≥ÄÍ≤Ω**: Îã§Î•∏ ÏùºÏùÑ ÌïòÍ≥† ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î©îÏãúÏßÄÎ•º Î≥¥ÎÉÖÎãàÎã§.
2.  **ÌôúÎèô Í≤åÏãú**: ÎãπÏã†Ïùò Í∏∞Î∂ÑÏù¥ÎÇò ÏÉùÍ∞ÅÏùÑ\"ÌîºÎìú\"Íµ¨Ïó≠Ïóê Í≥µÏú†.
3.  **ÌôúÎèô ÏÉÅÌò∏ÏûëÏö©**: Îã§Î•∏ ÏÇ¨ÎûåÏùò Í≤åÏãúÎ¨ºÏùÑ Î≥¥Í≥† ÎåìÍ∏ÄÏùÑ Îã¨Í±∞ÎÇò Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ¶ÖÎãàÎã§.
4.  **ÏòÅÏÉÅ ÌÜµÌôî ÏöîÏ≤≠**: Ï†ÅÏ†àÌïú ÏãúÍ∏∞ÎùºÍ≥† ÏÉùÍ∞ÅÎêòÎ©¥ ÏÇ¨Ïö©ÏûêÏóêÍ≤å Îä•ÎèôÏ†ÅÏúºÎ°ú ÏòÅÏÉÅ ÌÜµÌôîÎ•º Í±∏ Ïàò ÏûàÏäµÎãàÎã§.

# Î™ÖÎ†π ÌòïÏãù (ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÍ∞úÏ≤¥Î•º Ìè¨Ìï®ÌïòÎäî JSON Î∞∞Ïó¥ÏûÖÎãàÎã§):
-   **Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞+ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏**: \`[{"type": "update_status", "status_text": "ÌïòÍ≥† ÏûàÎäî Ïùº", "is_busy": true}, {"type": "text", "content": "ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌïòÍ≥† Ïã∂ÏùÄ Îßê..."}]\`
-   **ÌôúÎèô Í≤åÏãú**: \`[{"type": "qzone_post", "postType": "shuoshuo", "content": "Í≤åÏãúÎ¨º ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©..."}]\`
- **ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ Í≤åÏãú**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(ÏÑ†ÌÉù ÏÇ¨Ìï≠)Í≤åÏãúÎ¨ºÏùò Í≥µÍ∞ú ÌÖçÏä§Ìä∏", "hiddenContent": "Ïù¥ÎØ∏ÏßÄÏóê ÎåÄÌïú Íµ¨Ï≤¥Ï†ÅÏù∏ ÏÑ§Î™Ö..."}\`
-   **ÎåìÍ∏Ä**: \`[{"type": "qzone_comment", "postId": 123, "commentText": "ÎãπÏã†Ïùò ÎåìÍ∏Ä ÎÇ¥Ïö©"}]\`
-   **Ï¢ãÏïÑÏöî**: \`[{"type": "qzone_like", "postId": 456}]\`
-   **ÏòÅÏÉÅ ÌÜµÌôî**: \`[{"type": "video_call_request"}]\`

# ÎãπÏã†Ïùò ÏùòÏÇ¨ Í≤∞Ï†ïÏóê Ï∞∏Í≥†Ìï† Ï†ïÎ≥¥:
-   **ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï**: ${chat.settings.aiPersona}
-   **ÌòÑÏû¨ ÏãúÍ∞Ñ**: ${currentTime}
-   **ÎãπÏã†Îì§Ïùò ÎßàÏßÄÎßâ ÎåÄÌôî ÏöîÏïΩ**: ${recentContextSummary}
-   **„ÄêÏ§ëÏöî„ÄëÏµúÍ∑º ÌôúÎèô Î™©Î°ù**: Ïù¥ Î™©Î°ùÏùÄ **Î°ú ÌëúÏãúÎê©ÎãàÎã§[Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§]** ÎòêÎäî **[ÎåìÍ∏ÄÏùÑ Îã¨ÏïòÏäµÎãàÎã§]**.**Ïö∞ÏÑ†** ÎãπÏã†Ïù¥ **ÏïÑÏßÅ ÏÉÅÌò∏ÏûëÏö©ÌïòÏßÄ ÏïäÏùÄ** ÌôúÎèôÍ≥º ÏÜåÌÜµÌïòÏÑ∏Ïöî.`;

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú messagesPayload Íµ¨Ï∂ï
    const messagesPayload = [];
    messagesPayload.push({ role: 'system', content: systemPrompt });

    try {
        const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(3).toArray();
        const aiName = chat.name;
        
        let dynamicContext = ""; // ÌôúÎèô Ïª®ÌÖçÏä§Ìä∏Î•º ÏàòÏßëÌïòÎäî Î≥ÄÏàò ÏÇ¨Ïö©
        if (recentPosts.length > 0) {
            let postsContext = "\n\n# ÏµúÍ∑º Í≤åÏãúÎ¨º Î™©Î°ù (Ï∞∏Í≥† Î∞è ÎåìÍ∏Ä ÏûëÏÑ±ÏùÑ ÏúÑÌï¥):\n";
            for (const post of recentPosts) {
                let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'Ìïú ÏπúÍµ¨');
                let interactionStatus = '';
                if (post.likes && post.likes.includes(aiName)) interactionStatus += " [Ï¢ãÏïÑÏöîÎ•º ÎàåÎ†ÄÏäµÎãàÎã§]";
                if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [ÎåìÍ∏ÄÏùÑ Îã¨ÏïòÏäµÎãàÎã§]";
                
                postsContext += `- (ID: ${post.id}) ÏûëÏÑ±Ïûê: ${authorName}, ÎÇ¥Ïö©: "${(post.publicText || post.content || "Ïù¥ÎØ∏ÏßÄ Í≤åÏãúÎ¨º").substring(0, 30)}..."${interactionStatus}\n`;
            }
            dynamicContext = postsContext;
        }

        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎ™®Îì† ÌôúÎèô Ï†ïÎ≥¥Î•º ÌïòÎÇòÏùò user Î©îÏãúÏßÄÎ°ú Ï†ÑÏÜ°
        messagesPayload.push({
            role: 'user',
            content: `[ÏãúÏä§ÌÖú Î™ÖÎ†π:system promptÏóêÏÑú ÏùΩÏùÄ Í∑úÏπôÍ≥º Îã§Ïùå ÏµúÏã† Ï†ïÎ≥¥Ïóê Îî∞Îùº ÎèÖÎ¶ΩÏ†ÅÏù∏ ÌñâÎèôÏùÑ ÏãúÏûëÌïòÏÑ∏Ïöî.]\n${dynamicContext}`
        });
        
        console.log("Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèôÏùÑ ÏúÑÌï¥ API ÏöîÏ≤≠ÏùÑ Î≥¥ÎÇ¥Îäî Ï§ë, Payload:", JSON.stringify(messagesPayload, null, 2)); // ÎîîÎ≤ÑÍπÖÏùÑ ÏúÑÌïú Î°úÍ∑∏ Ï∂îÍ∞Ä

        // ÏöîÏ≤≠ Î≥¥ÎÇ¥Í∏∞
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: messagesPayload,
                temperature: 0.9,
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`APIÏöîÏ≤≠ Ïã§Ìå®: ${response.status} - ${JSON.stringify(errorData)}`);
        }
        const data = await response.json();
        // Ïú†Ìö®Ìïú ÏùëÎãµÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        if (!data.choices || data.choices.length === 0 || !data.choices[0].message.content) {
            console.warn(`APIÎπÑÏñ¥ ÏûàÍ±∞ÎÇò ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§, Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" Ïùò Ïù¥Î≤à Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèôÏùÄ Í±¥ÎÑàÎúÅÎãàÎã§.`);
            return;
        }
        const responseArray = parseAiResponse(data.choices[0].message.content);
        
        // AI Î∞òÌôò Î™ÖÎ†πÏùÑ Ï≤òÎ¶¨ÌïòÎäî ÌõÑÏÜç Î°úÏßÅÏùÄ Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏäµÎãàÎã§...
        for (const action of responseArray) {
            if (!action) continue;

            if (action.type === 'update_status' && action.status_text) {
                chat.status.text = action.status_text;
                chat.status.isBusy = action.is_busy || false;
                chat.status.lastUpdate = Date.now();
                await db.chats.put(chat);
                renderChatList();
            }
            if (action.type === 'text' && action.content) {
                const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };
                chat.history.push(aiMessage);
                await db.chats.put(chat);
                showNotification(chatId, aiMessage.content);
                renderChatList();
                console.log(`Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô: Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" Îä•ÎèôÏ†ÅÏúºÎ°ú Î©îÏãúÏßÄÎ•º Î≥¥ÎÉÑ: ${aiMessage.content}`);
            }
            if (action.type === 'qzone_post') {
                const newPost = { type: action.postType, content: action.content || '', publicText: action.publicText || '', hiddenContent: action.hiddenContent || '', timestamp: Date.now(), authorId: chatId, visibleGroupIds: null };
                await db.qzonePosts.add(newPost);
                updateUnreadIndicator(unreadPostsCount + 1);
                console.log(`Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô: Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" ÌôúÎèôÏùÑ Í≤åÏãúÌï®`);
            } else if (action.type === 'qzone_comment') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.comments) post.comments = [];
                    post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                    await db.qzonePosts.update(post.id, { comments: post.comments });
                    updateUnreadIndicator(unreadPostsCount + 1);
                    console.log(`Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô: Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" ÌôúÎèôÏóê ÎåìÍ∏ÄÏùÑ Îã¨Ïùå #${post.id}`);
                }
            } else if (action.type === 'qzone_like') {
                const post = await db.qzonePosts.get(parseInt(action.postId));
                if (post) {
                    if (!post.likes) post.likes = [];
                    if (!post.likes.includes(chat.name)) {
                        post.likes.push(chat.name);
                        await db.qzonePosts.update(post.id, { likes: post.likes });
                        updateUnreadIndicator(unreadPostsCount + 1);
                        console.log(`Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô: Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" ÌôúÎèôÏóê Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ¶Ñ #${post.id}`);
                    }
                }
            } else if (action.type === 'video_call_request') {
                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                    videoCallState.isAwaitingResponse = true; 
                    state.activeChatId = chatId;
                    showIncomingCallModal();
                    console.log(`Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô: Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" ÏòÅÏÉÅ ÌÜµÌôî ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌï®`);
                }
            }
        }
    } catch (error) {
        console.error(`Ï∫êÎ¶≠ÌÑ∞ "${chat.name}" Ïùò ÎèÖÎ¶Ω ÌñâÎèô Ïã§Ìå®:`, error);
    }
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏµúÏ¢Ö ÏàòÏ†ï Î≤ÑÏ†Ñ„ÄëÌï®Ïàò, Ïù¥Ï†Ñ applyScopedCss Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ ‚ñº‚ñº‚ñº

/**
 * ÏÇ¨Ïö©Ïûê Ï†ïÏùò CSSÎ•º ÏßÄÏ†ïÎêú Î≤îÏúÑÏóê ÏïàÏ†ÑÌïòÍ≤å Ï†ÅÏö©
 * @param {string} cssString ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•Ìïú ÏõêÎ≥∏ CSS Î¨∏ÏûêÏó¥
 * @param {string} scopeId Ïä§ÌÉÄÏùºÏùÑ Ï†ÅÏö©Ìï† Î≤îÏúÑ ID (ÏòàÏãú '#chat-messages' ÎòêÎäî '#settings-preview-area')
 * @param {string} styleTagId ÏûëÎèôÌï† <style> ÌÉúÍ∑∏ ID
 */
function applyScopedCss(cssString, scopeId, styleTagId) {
    const styleTag = document.getElementById(styleTagId);
    if (!styleTag) return;
    
    if (!cssString || cssString.trim() === '') {
        styleTag.innerHTML = '';
        return;
    }
    
    // Í∞ïÌôîÎêú Î≤îÏúÑ Ï≤òÎ¶¨ Ìï®Ïàò - .userÏôÄ .ai Ïä§ÌÉÄÏùº Ï∂©Îèå Î¨∏Ï†ú Ï†ÑÎ¨∏ Ìï¥Í≤∞
    const scopedCss = cssString
        .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user $1`)
        .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai $1`)
        .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble $1`);
    
    styleTag.innerHTML = scopedCss;
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏàòÏ†ï Î≤ÑÏ†Ñ„ÄëÌï®Ïàò, Ïù¥Ï†Ñ updateSettingsPreview Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥ ‚ñº‚ñº‚ñº

function updateSettingsPreview() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const previewArea = document.getElementById('settings-preview-area');
    if (!previewArea) return;

    // 1. ÌòÑÏû¨ ÏÑ§Ï†ï Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
    const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
    const fontSize = document.getElementById('font-size-slider').value;
    const customCss = document.getElementById('custom-css-input').value;
    const background = chat.settings.background; // Î∞∞Í≤Ω ÏÑ§Ï†ïÏùÑ ÏßÅÏ†ë Í∞ÄÏ†∏Ïò§Í∏∞

    // 2. ÎØ∏Î¶¨ Î≥¥Í∏∞ ÏòÅÏó≠Ïùò Í∏∞Î≥∏ Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
    previewArea.dataset.theme = selectedTheme;
    previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);
    
    // --- „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎØ∏Î¶¨ Î≥¥Í∏∞ ÏòÅÏó≠Ïùò Î∞∞Í≤Ω Ïä§ÌÉÄÏùº ÏßÅÏ†ë ÏóÖÎç∞Ïù¥Ìä∏ ---
    if (background && background.startsWith('data:image')) {
        previewArea.style.backgroundImage = `url(${background})`;
        previewArea.style.backgroundColor = 'transparent'; // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Î∞∞Í≤ΩÏÉâÏùÑ Ìà¨Î™ÖÏúºÎ°ú ÏÑ§Ï†ï
    } else {
        previewArea.style.backgroundImage = 'none'; // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏúºÎ©¥ Ïù¥ÎØ∏ÏßÄ Î∞∞Í≤Ω Ï†úÍ±∞
        // Î∞∞Í≤ΩÏù¥ ÏÉâÏÉÅ Í∞í ÎòêÎäî Í∑∏ÎùºÎç∞Ïù¥ÏÖòÏù∏ Í≤ΩÏö∞(Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞),ÏßÅÏ†ë Ï†ÅÏö©
        previewArea.style.background = background || '#f0f2f5';
    }

    // 3. ÏãúÎÆ¨Î†àÏù¥ÏÖò Í∏∞Ìè¨ Î†åÎçîÎßÅ
    previewArea.innerHTML = ''; 

    // ÏÉùÏÑ±\"ÏÉÅÎåÄÎ∞©\"Ïùò Í∏∞Ìè¨
    // Ï∞∏Í≥†:CSSÍ∞Ä ÏùòÏ°¥Ìï† Í≤ΩÏö∞Î•º ÎåÄÎπÑÌïòÏó¨ Í∞ÄÏÉÅ ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Ï†ÑÎã¨Ìï©ÎãàÎã§
    const aiMsg = { role: 'ai', content: 'ÏÉÅÎåÄÎ∞© Î©îÏãúÏßÄ ÎØ∏Î¶¨ Î≥¥Í∏∞', timestamp: 1, senderName: chat.name };
    const aiBubble = createMessageElement(aiMsg, chat);
    if(aiBubble) previewArea.appendChild(aiBubble);

    // ÏÉùÏÑ±\"ÎÇ¥\"Ïùò Í∏∞Ìè¨
    const userMsg = { role: 'user', content: 'ÎÇ¥ Î©îÏãúÏßÄ ÎØ∏Î¶¨ Î≥¥Í∏∞', timestamp: 2 };
    const userBubble = createMessageElement(userMsg, chat);
    if(userBubble) previewArea.appendChild(userBubble);
    
    // 4. ÎØ∏Î¶¨ Î≥¥Í∏∞ ÏòÅÏó≠Ïóê ÏÇ¨Ïö©Ïûê ÏßÄÏ†ï CSS Ï†ÅÏö©
    applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
}

// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Îã§Ïùå ÎÇ¥Ïö©ÏùÑ„ÄêÏÉà Ìï®ÏàòÎ•º„ÄëJS Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò ÏòÅÏó≠Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî ‚ñº‚ñº‚ñº

async function openGroupManager() {
    await renderGroupList();
    document.getElementById('group-management-modal').classList.add('visible');
}

async function renderGroupList() {
    const listEl = document.getElementById('existing-groups-list');
    const groups = await db.qzoneGroups.toArray();
    listEl.innerHTML = '';
    if (groups.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ÏïÑÏßÅ Ïñ¥Îñ§ Í∑∏Î£πÎèÑ ÏóÜÏäµÎãàÎã§</p>';
    }
    groups.forEach(group => {
        const item = document.createElement('div');
        item.className = 'existing-group-item';
        item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">√ó</span>
        `;
        listEl.appendChild(item);
    });
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏàòÏ†ï ÌõÑ„ÄëÌï®ÏàòÎ•º, Ïù¥Ï†Ñ addNewGroup Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
async function addNewGroup() {
    const input = document.getElementById('new-group-name-input');
    const name = input.value.trim();
    if (!name) {
        alert('Í∑∏Î£π Ïù¥Î¶ÑÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§!');
        return;
    }

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏ∂îÍ∞ÄÌïòÍ∏∞ Ï†ÑÏóê, Î®ºÏ†Ä Í∑∏Î£π Ïù¥Î¶ÑÏù¥ Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî
    const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
    if (existingGroup) {
        alert(`Í∑∏Î£π "${name}" Ïù¥(Í∞Ä) Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï©ÎãàÎã§, Îã§Î•∏ Ïù¥Î¶ÑÏúºÎ°ú Î≥ÄÍ≤ΩÌï¥ Ï£ºÏÑ∏Ïöî!`);
        return;
    }
    // „ÄêÏàòÏ†ï ÎÅù„Äë

    await db.qzoneGroups.add({ name });
    input.value = '';
    await renderGroupList();
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

async function deleteGroup(groupId) {
    const confirmed = await showCustomConfirm('ÏÇ≠Ï†ú ÌôïÏù∏', 'Í∑∏Î£πÏùÑ ÏÇ≠Ï†úÌïòÎ©¥ Ìï¥Îãπ Í∑∏Î£π ÎÇ¥Ïùò ÏπúÍµ¨Îì§ÏùÄ\"Í∑∏Î£πÌôîÎêòÏßÄ ÏïäÏùå\".Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        await db.qzoneGroups.delete(groupId);
        // Ìï¥Îãπ Í∑∏Î£πÏóê ÏÜçÌïú ÏπúÍµ¨Îì§Ïùò groupIdÎ•º nullÎ°ú ÏÑ§Ï†ï
        const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
        for (const chat of chatsToUpdate) {
            chat.groupId = null;
            await db.chats.put(chat);
            if(state.chats[chat.id]) state.chats[chat.id].groupId = null;
        }
        await renderGroupList();
    }
}

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ„ÄêÏÉà Ìï®Ïàò Î∏îÎ°ù Ï†ÑÏ≤¥Î•º„ÄëJS Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò ÏòÅÏó≠Ïùò ÎÅùÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî ‚ñº‚ñº‚ñº

/**
 * Î©îÏãúÏßÄÎ•º Í∏∏Í≤å ÎàÑÎ•¥Î©¥, ÏûëÏóÖ Î©îÎâ¥Î•º ÌëúÏãúÌï©ÎãàÎã§
 * @param {number} timestamp - Í∏∏Í≤å ÎàåÎü¨ÏßÑ Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
 */
function showMessageActions(timestamp) {
    // Ïù¥ÎØ∏ Îã§Ï§ë ÏÑ†ÌÉù Î™®ÎìúÏù∏ Í≤ΩÏö∞, Î©îÎâ¥Î•º ÎùÑÏö∞ÏßÄ ÏïäÏäµÎãàÎã§
    if (isSelectionMode) return;
    
    activeMessageTimestamp = timestamp;
    document.getElementById('message-actions-modal').classList.add('visible');
}

/**
 * Î©îÏãúÏßÄ ÏûëÏóÖ Î©îÎâ¥ Ïà®Í∏∞Í∏∞
 */
function hideMessageActions() {
    document.getElementById('message-actions-modal').classList.remove('visible');
    activeMessageTimestamp = null;
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏóÖÎç∞Ïù¥Ìä∏Îê®„ÄëÎ≤ÑÏ†ÑÏúºÎ°ú, Ïù¥Ï†Ñ openMessageEditor Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
async function openMessageEditor() {
    if (!activeMessageTimestamp) return;

    const timestampToEdit = activeMessageTimestamp;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    hideMessageActions(); 

    let contentForEditing;
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëshareÎ•º_link ÌäπÏàò Ïú†Ìòï ÌåêÎã®Ïóê Ï∂îÍ∞Ä
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer', 'share_link'].includes(message.type);

    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content; 
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        } 
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÍ≥µÏú† ÎßÅÌÅ¨ Ïú†ÌòïÏùò Î©îÏãúÏßÄ Ï≤òÎ¶¨
        else if (message.type === 'share_link') {
            fullMessageObject.title = message.title;
            fullMessageObject.description = message.description;
            fullMessageObject.source_name = message.source_name;
            fullMessageObject.content = message.content;
        }
        contentForEditing = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        contentForEditing = JSON.stringify(message.content, null, 2);
    } else {
        contentForEditing = message.content;
    }

    // „ÄêÌïµÏã¨ ÏàòÏ†ï 1„ÄëÏó¨Í∏∞Ïóê Ï∂îÍ∞Ä 'link' ÌÖúÌîåÎ¶ø
    const templates = {
        voice: { type: 'voice_message', content: 'Ïó¨Í∏∞Ïóê ÏùåÏÑ± ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî' },
        image: { type: 'ai_image', description: 'Ïó¨Í∏∞Ïóê Ïù¥ÎØ∏ÏßÄ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ÏûëÏùÄ ÎßàÏùå' },
        link: { type: 'share_link', title: 'Í∏∞ÏÇ¨ Ï†úÎ™©', description: 'Í∏∞ÏÇ¨ ÏöîÏïΩ...', source_name: 'Ï∂úÏ≤ò ÏõπÏÇ¨Ïù¥Ìä∏', content: 'Í≤åÏãúÍ∏Ä Ï†ÑÏ≤¥ ÎÇ¥Ïö©...' }
    };

    // „ÄêÌïµÏã¨ ÏàòÏ†ï 2„ÄëÏó¨Í∏∞Ïóê ÏÉàÎ°úÏö¥\"ÎßÅÌÅ¨Î•º Ï∂îÍ∞Ä\"Î≤ÑÌäº
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ÏùåÏÑ±</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>Ïù¥ÎØ∏ÏßÄ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ÏÜ°Í∏à</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÎßÅÌÅ¨Î•º Ï∂îÍ∞Ä</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'Î©îÏãúÏßÄ Ìé∏Ïßë', 
        'Ïó¨Í∏∞ÏóêÏÑú ÏàòÏ†ïÌïòÍ±∞ÎÇò, ÏúÑ Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑúÏãù ÌÖúÌîåÎ¶øÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî...',
        contentForEditing, 
        'textarea',
        helpersHtml
    );

    if (newContent !== null) {
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏÑú Ìò∏Ï∂úÎêòÎäî Í≤ÉÏùÄ saveEditedMessageÏó¨Ïïº ÌïòÎ©∞, saveAdvancedEditorÍ∞Ä ÏïÑÎãôÎãàÎã§
        await saveEditedMessage(timestampToEdit, newContent, true);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * Î©îÏãúÏßÄ ÌÖçÏä§Ìä∏ ÎÇ¥Ïö©ÏùÑ ÌÅ¥Î¶ΩÎ≥¥ÎìúÎ°ú Î≥µÏÇ¨
 */
async function copyMessageContent() {
    if (!activeMessageTimestamp) return;
    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);
    if (!message) return;

    let textToCopy;
    if (typeof message.content === 'object') {
        textToCopy = JSON.stringify(message.content);
    } else {
        textToCopy = String(message.content);
    }

    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('Î≥µÏÇ¨ ÏÑ±Í≥µ', 'Î©îÏãúÏßÄ ÎÇ¥Ïö©Ïù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
    } catch (err) {
        await showCustomAlert('Î≥µÏÇ¨ Ïã§Ìå®', 'ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
    }
    
    hideMessageActions();
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏóÖÎç∞Ïù¥Ìä∏Îê®„ÄëÎ≤ÑÏ†ÑÏúºÎ°ú, Ïù¥Ï†Ñ createMessageEditorBlock Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
/**
 * Ìé∏Ïßë Í∞ÄÎä•Ìïú Î©îÏãúÏßÄ Î∏îÎ°ù ÏÉùÏÑ±(ÌÖçÏä§Ìä∏ ÏÉÅÏûê, ÏÑúÏãù ÎèÑÏö∞ÎØ∏ Î∞è ÏÇ≠Ï†ú Î≤ÑÌäº Ìè¨Ìï®)
 * @param {string} initialContent - ÌÖçÏä§Ìä∏ ÏÉÅÏûêÏùò Ï¥àÍ∏∞ ÎÇ¥Ïö©
 * @returns {HTMLElement} - ÏÉùÏÑ±Îêú DOM ÏöîÏÜå
 */
function createMessageEditorBlock(initialContent = '') {
    const block = document.createElement('div');
    block.className = 'message-editor-block';

    // „ÄêÌïµÏã¨ ÏàòÏ†ï 1„ÄëÏó¨Í∏∞Ïóê Ï∂îÍ∞Ä 'link' ÌÖúÌîåÎ¶ø
    const templates = {
        voice: { type: 'voice_message', content: 'Ïó¨Í∏∞Ïóê ÏùåÏÑ± ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî' },
        image: { type: 'ai_image', description: 'Ïó¨Í∏∞Ïóê Ïù¥ÎØ∏ÏßÄ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî' },
        transfer: { type: 'transfer', amount: 5.20, note: 'ÏûëÏùÄ ÎßàÏùå' },
        link: { type: 'share_link', title: 'Í∏∞ÏÇ¨ Ï†úÎ™©', description: 'Í∏∞ÏÇ¨ ÏöîÏïΩ...', source_name: 'Ï∂úÏ≤ò ÏõπÏÇ¨Ïù¥Ìä∏', content: 'Í≤åÏãúÍ∏Ä Ï†ÑÏ≤¥ ÎÇ¥Ïö©...' }
    };

    block.innerHTML = `
        <button class="delete-block-btn" title="Ïù¥ Ìï≠Î™© ÏÇ≠Ï†ú">√ó</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ÏùåÏÑ±</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>Ïù¥ÎØ∏ÏßÄ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ÏÜ°Í∏à</button>
            <!-- „ÄêÌïµÏã¨ ÏàòÏ†ï 2„ÄëÏó¨Í∏∞Ïóê ÏÉàÎ°úÏö¥\"ÎßÅÌÅ¨Î•º Ï∂îÍ∞Ä\"Î≤ÑÌäº -->
            <button class="format-btn" data-template='${JSON.stringify(templates.link)}'>ÎßÅÌÅ¨Î•º Ï∂îÍ∞Ä</button>
        </div>
    `;

    // ÏÇ≠Ï†ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
    block.querySelector('.delete-block-btn').addEventListener('click', () => {
        // Ï†ÅÏñ¥ÎèÑ ÌïòÎÇòÏùò Ìé∏Ïßë Î∏îÎ°ùÏùÑ Ïú†ÏßÄÌïòÎèÑÎ°ù ÌôïÏù∏
        if (document.querySelectorAll('.message-editor-block').length > 1) {
            block.remove();
        } else {
            alert('Ï†ÅÏñ¥ÎèÑ ÌïòÎÇòÏùò Î©îÏãúÏßÄÎäî ÎÇ®Í≤®Ïïº Ìï©ÎãàÎã§.');
        }
    });

    // ÏÑúÏãù ÎèÑÏö∞ÎØ∏ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
    block.querySelectorAll('.format-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const templateStr = btn.dataset.template;
            const textarea = block.querySelector('textarea');
            if (templateStr && textarea) {
                try {
                    const templateObj = JSON.parse(templateStr);
                    textarea.value = JSON.stringify(templateObj, null, 2);
                    textarea.focus();
                } catch(e) { console.error("ÏÑúÏãù ÌÖúÌîåÎ¶ø Íµ¨Î¨∏ Î∂ÑÏÑù Ïã§Ìå®:", e); }
            }
        });
    });

    return block;
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏôÑÏ†Ñ ÏÉàÎ°úÏö¥ ÏóÖÍ∑∏Î†àÏù¥Îìú Î≤ÑÏ†Ñ„ÄëÏù¥ Ìï®ÏàòÎ°ú Ïù¥Ï†Ñ openAdvancedMessageEditorÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥Ìï¥ Ï£ºÏÑ∏Ïöî ‚ñº‚ñº‚ñº
/**
 * ÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥ ÏãúÍ∞ÅÏ†Å Îã§Ï§ë Î©îÏãúÏßÄ Ìé∏ÏßëÍ∏∞Î•º Ïó¥Í≥†, Î™®Îì† Î≤ÑÌäº Ïù¥Î≤§Ìä∏Î•º ÎèôÏ†ÅÏúºÎ°ú Î∞îÏù∏Îî©Ìï©ÎãàÎã§
 */
function openAdvancedMessageEditor() {
    if (!activeMessageTimestamp) return;

    // 1. „ÄêÌïµÏã¨„ÄëÏù¥Ï†Ñ Î©îÎâ¥Î•º Îã´Í∏∞ Ï†ÑÏóê, ÌïÑÏöîÌïú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º ÏßÄÏó≠ Î≥ÄÏàòÏóê Ï∫°Ï≤òÌï©ÎãàÎã§
    const timestampToEdit = activeMessageTimestamp;

    const chat = state.chats[state.activeChatId];
    const message = chat.history.find(m => m.timestamp === timestampToEdit);
    if (!message) return;

    // 2. Ïù¥Ï†ú Ïù¥Ï†Ñ Î©îÎâ¥Î•º ÏïàÏ†ÑÌïòÍ≤å Îã´ÏùÑ Ïàò ÏûàÏäµÎãàÎã§, Ïö∞Î¶¨Ïùò ÏßÄÏó≠ Î≥ÄÏàòÏóê ÏòÅÌñ•ÏùÑ Ï£ºÏßÄ ÏïäÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§
    hideMessageActions(); 

    const editorModal = document.getElementById('message-editor-modal');
    const editorContainer = document.getElementById('message-editor-container');
    editorContainer.innerHTML = ''; 

    // 3. Ï¥àÍ∏∞ ÎÇ¥Ïö© Ï§ÄÎπÑ
    let initialContent;
    const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
    if (isSpecialType) {
        let fullMessageObject = { type: message.type };
        if (message.type === 'voice_message') fullMessageObject.content = message.content;
        else if (message.type === 'ai_image') fullMessageObject.description = message.content;
        else if (message.type === 'transfer') {
            fullMessageObject.amount = message.amount;
            fullMessageObject.note = message.note;
        }
        initialContent = JSON.stringify(fullMessageObject, null, 2);
    } else if (typeof message.content === 'object') {
        initialContent = JSON.stringify(message.content, null, 2);
    } else {
        initialContent = message.content;
    }

    const firstBlock = createMessageEditorBlock(initialContent);
    editorContainer.appendChild(firstBlock);

    // 4. „ÄêÌïµÏã¨„ÄëÎ™®Îì† Ï†úÏñ¥ Î≤ÑÌäºÏùò Ïù¥Î≤§Ìä∏Î•º ÎèôÏ†ÅÏúºÎ°ú Î∞îÏù∏Îî©
    // Ïù¥Î≤§Ìä∏ Ï§ëÎ≥µ Î∞îÏù∏Îî©ÏùÑ Î∞©ÏßÄÌïòÍ∏∞ ÏúÑÌï¥, Ïö∞Î¶¨Îäî ÌÅ¥Î°† ÎÖ∏Îìú Î∞©ÏãùÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ïù¥Ï†Ñ Î¶¨Ïä§ÎÑàÎ•º Ï†úÍ±∞Ìï©ÎãàÎã§
    const addBtn = document.getElementById('add-message-editor-block-btn');
    const newAddBtn = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(newAddBtn, addBtn);
    newAddBtn.addEventListener('click', () => {
        const newBlock = createMessageEditorBlock();
        editorContainer.appendChild(newBlock);
        newBlock.querySelector('textarea').focus();
    });

    const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
    const newCancelBtn = cancelBtn.cloneNode(true);
    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
    newCancelBtn.addEventListener('click', () => {
        editorModal.classList.remove('visible');
    });

    const saveBtn = document.getElementById('save-advanced-editor-btn');
    const newSaveBtn = saveBtn.cloneNode(true);
    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
    // Ï∫°Ï≤òÎêú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Ïù¥Î≤à Ï†ÄÏû• ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Ïóê ÏßÅÏ†ë Î∞îÏù∏Îî©Ìï©ÎãàÎã§
    newSaveBtn.addEventListener('click', () => {
        saveEditedMessage(timestampToEdit); 
    });

    // 5. ÎßàÏßÄÎßâÏúºÎ°ú, Î™®Îã¨ Ï∞ΩÏùÑ ÌëúÏãúÌï©ÎãàÎã§
    editorModal.classList.add('visible');
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * Ìé∏ÏßëÎêú ÌÖçÏä§Ìä∏Î•º ÌååÏã±ÌïòÍ≥†, ÌëúÏ§ÄÌôîÎêú Î©îÏãúÏßÄ Ï°∞Í∞Å Í∞ùÏ≤¥Î•º Î∞òÌôòÌï©ÎãàÎã§
 * @param {string} text - ÏÇ¨Ïö©ÏûêÍ∞Ä Ìé∏Ïßë ÏÉÅÏûêÏóê ÏûÖÎ†•Ìïú ÌÖçÏä§Ìä∏
 * @returns {object} - type, content Îì±Ïùò ÏÜçÏÑ±ÏùÑ Ìè¨Ìï®ÌïòÎäî Í∞ùÏ≤¥
 */
function parseEditedContent(text) {
    const trimmedText = text.trim();

    // 1. JSON Í∞ùÏ≤¥Î°ú ÌååÏã± ÏãúÎèÑ(ÏùåÏÑ±, ÏÜ°Í∏à Îì± ÌòïÏãùÏùÑ ÏàòÏ†ïÌïòÎäî Îç∞ ÏÇ¨Ïö©)
    if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
        try {
            const parsed = JSON.parse(trimmedText);
            // type ÏÜçÏÑ±ÏùÑ Ìè¨Ìï®Ìï¥Ïïº Ïú†Ìö®Ìïú ÌòïÏãùÏúºÎ°ú Í∞ÑÏ£ºÎê©ÎãàÎã§
            if (parsed.type) {
                return parsed;
            }
        } catch (e) { /* ÌååÏã± Ïã§Ìå®, Í≥ÑÏÜç ÏßÑÌñâ */ }
    }
    
    // 2. Ïù¥Î™®Ìã∞ÏΩòÏúºÎ°ú ÌååÏã± ÏãúÎèÑ
    if (STICKER_REGEX.test(trimmedText)) {
        // Ìé∏ÏßëÎêú Ïù¥Î™®Ìã∞ÏΩòÏùò Í≤ΩÏö∞, Ïö∞Î¶¨Îäî ÌòÑÏû¨`meaning`,Îî∞ÎùºÏÑú URLÎßå Ï†ÄÏû•Ìï©ÎãàÎã§
        return { type: 'sticker', content: trimmedText };
    }

    // 3. Í∑∏Î†áÏßÄ ÏïäÏúºÎ©¥, ÏùºÎ∞ò ÌÖçÏä§Ìä∏ Î©îÏãúÏßÄÎ°ú Í∞ÑÏ£ºÌï©ÎãàÎã§
    return { type: 'text', content: trimmedText };
}


// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏµúÏ¢Ö Ìò∏Ìôò Î≤ÑÏ†Ñ„ÄëÌï®ÏàòÎ°ú, Ïù¥Ï†Ñ saveEditedMessage Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
/**
 * Ìé∏ÏßëÎêú Î©îÏãúÏßÄÎ•º Ï†ÄÏû•ÌïòÍ≥†, Îã®Ïàú Ìé∏ÏßëÍ∏∞ÏôÄ Í≥†Í∏â Ìé∏ÏßëÍ∏∞ Î™®Îëê Ìò∏ÌôòÎê©ÎãàÎã§
 * @param {number} timestamp - ÏàòÏ†ïÌï† ÏõêÎ≥∏ Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
 * @param {string} [simpleContent=null] - (ÏÑ†ÌÉù ÏÇ¨Ìï≠) Îã®Ïàú Ìé∏ÏßëÍ∏∞ÏóêÏÑú Ï†ÑÎã¨Îêú Îã®Ïùº ÎÇ¥Ïö© Î¨∏ÏûêÏó¥
 */
async function saveEditedMessage(timestamp, simpleContent = null) {
    if (!timestamp) return;

    const chat = state.chats[state.activeChatId];
    const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
    if (messageIndex === -1) return;

    let newMessages = [];

    // Í≥†Í∏â Ìé∏ÏßëÍ∏∞ÏóêÏÑú ÏôîÎäîÏßÄ ÎòêÎäî Îã®Ïàú Ìé∏ÏßëÍ∏∞ÏóêÏÑú ÏôîÎäîÏßÄ ÌåêÎã®
    if (simpleContent !== null) {
        // --- Îã®Ïàú Ìé∏ÏßëÍ∏∞ÏóêÏÑú Ïò¥ ---
        const rawContent = simpleContent.trim();
        if (rawContent) {
            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                timestamp: timestamp, // Í∞ÑÎã® Ìé∏Ïßë, ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎäî Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏäµÎãàÎã§
                content: parsedResult.content || '',
            };
            // Îã§ÏñëÌïú Í∞ÄÎä•Ìïú ÏÜçÏÑ± Ï∂îÍ∞Ä
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;

            newMessages.push(newMessage);
        }
    } else {
        // --- Í≥†Í∏â Ìé∏ÏßëÍ∏∞ÏóêÏÑú Ïò¥ ---
        const editorContainer = document.getElementById('message-editor-container');
        const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');
        let baseTimestamp = timestamp;

        for (const block of editorBlocks) {
            const textarea = block.querySelector('textarea');
            const rawContent = textarea.value.trim();
            if (!rawContent) continue;

            const parsedResult = parseEditedContent(rawContent);
            const newMessage = {
                role: chat.history[messageIndex].role,
                senderName: chat.history[messageIndex].senderName,
                timestamp: baseTimestamp++,
                content: parsedResult.content || '',
            };
            
            // Îã§ÏñëÌïú Í∞ÄÎä•Ìïú ÏÜçÏÑ± Ï∂îÍ∞Ä
            if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
            if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
            if (parsedResult.amount) newMessage.amount = parsedResult.amount;
            if (parsedResult.note) newMessage.note = parsedResult.note;
            if (parsedResult.title) newMessage.title = parsedResult.title;
            if (parsedResult.description) newMessage.description = parsedResult.description;
            if (parsedResult.source_name) newMessage.source_name = parsedResult.source_name;
            
            if (parsedResult.description && parsedResult.type === 'ai_image') {
                 newMessage.content = parsedResult.description;
            }

            newMessages.push(newMessage);
        }
    }
    
    if (newMessages.length === 0) {
        alert("Îπà Î©îÏãúÏßÄÎ•º Ï†ÄÏû•Ìï† Ïàò ÏóÜÏäµÎãàÎã§, Ï†ÅÏñ¥ÎèÑ ÌïòÎÇòÏùò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî.");
        return;
    }

    chat.history.splice(messageIndex, 1, ...newMessages);
    await db.chats.put(chat);

    // Ïó¥Î†§ ÏûàÏùÑ Ïàò ÏûàÎäî Î™®Îã¨ Ï∞ΩÏùÑ Îã´Í≥† UIÎ•º ÏÉàÎ°ú Í≥†Ïπ©ÎãàÎã§
    document.getElementById('message-editor-modal').classList.remove('visible');
    renderChatInterface(state.activeChatId);
    await showCustomAlert('ÏÑ±Í≥µ', 'Î©îÏãúÏßÄÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!');
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ„ÄêÏÉà Ìï®Ïàò Î∏îÎ°ù Ï†ÑÏ≤¥Î•º„ÄëJS Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò ÏòÅÏó≠Ïùò ÎÅùÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî ‚ñº‚ñº‚ñº

/**
 * ÌÅ¥Î¶≠ Ïãú\"...\"Îã§Ïù¥ÎÇ¥ÎØπ ÏûëÏóÖ Î©îÎâ¥ ÌëúÏãú
 * @param {number} postId - ÏûëÏóÖ ÎåÄÏÉÅ Îã§Ïù¥ÎÇ¥ÎØπÏùò ID
 */
function showPostActions(postId) {
    activePostId = postId;
    document.getElementById('post-actions-modal').classList.add('visible');
}

/**
 * Îã§Ïù¥ÎÇ¥ÎØπ ÏûëÏóÖ Î©îÎâ¥ Ïà®Í∏∞Í∏∞
 */
function hidePostActions() {
    document.getElementById('post-actions-modal').classList.remove('visible');
    activePostId = null;
}

/**
 * Îã§Ïù¥ÎÇ¥ÎØπ Ìé∏ÏßëÍ∏∞ Ïó¥Í∏∞
 */
async function openPostEditor() {
    if (!activePostId) return;

    const postIdToEdit = activePostId;
    const post = await db.qzonePosts.get(postIdToEdit);
    if (!post) return;

    hidePostActions();

    // ÏõêÎ≥∏Ïóê Ï∂©Ïã§:Ìé∏ÏßëÏùÑ ÏúÑÌï¥ Í∞ÄÏû• ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ ÌòïÌÉúÎ•º Íµ¨Ï∂ï
    let contentForEditing;
    if (post.type === 'shuoshuo') {
        contentForEditing = post.content;
    } else {
        // Ïù¥ÎØ∏ÏßÄÏôÄ ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄÏùò Í≤ΩÏö∞, Î™®Îì† Ï†ïÎ≥¥Î•º Ìè¨Ìï®ÌïòÎäî Í∞ùÏ≤¥Î•º Íµ¨Ï∂ïÌï©ÎãàÎã§
        const postObject = {
            type: post.type,
            publicText: post.publicText || '',
        };
        if (post.type === 'image_post') {
            postObject.imageUrl = post.imageUrl;
            postObject.imageDescription = post.imageDescription;
        } else if (post.type === 'text_image') {
            postObject.hiddenContent = post.hiddenContent;
        }
        contentForEditing = JSON.stringify(postObject, null, 2);
    }
    
    // ÏÑúÏãù ÎèÑÏö∞ÎØ∏ Î≤ÑÌäº Íµ¨Ï∂ï
    const templates = {
        shuoshuo: "Ïó¨Í∏∞Ïóê Í≤åÏãúÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...", // Í≤åÏãúÍ∏ÄÏùò Í≤ΩÏö∞, Ïö∞Î¶¨Îäî ÏßÅÏ†ë ÏùºÎ∞ò ÌÖçÏä§Ìä∏Î°ú ÎåÄÏ≤¥Ìï©ÎãàÎã§
        image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
        text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
    };
    
    const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text">Í∏Ä</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>Ïù¥ÎØ∏ÏßÄ Í≤åÏãúÎ¨º</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ</button>
        </div>
    `;

    const newContent = await showCustomPrompt(
        'Í≤åÏãúÎ¨º Ìé∏Ïßë',
        'Ïó¨Í∏∞ÏóêÏÑú ÎÇ¥Ïö©ÏùÑ ÏàòÏ†ï...',
        contentForEditing,
        'textarea',
        helpersHtml
    );
    
    // „ÄêÌäπÏàò Ï≤òÎ¶¨„ÄëÍ≤åÏãúÍ∏ÄÏùò ÏÑúÏãù ÎèÑÏö∞ÎØ∏ Î≤ÑÌäºÏóê Îã§Î•∏ ÎèôÏûë Ï∂îÍ∞Ä
    // Î™®Îã¨ Ï∞ΩÏù¥ ÎÇòÌÉÄÎÇú ÌõÑÏóê, Ïù¥Î≤§Ìä∏Î•º Î∞îÏù∏Îî©Ìï¥Ïïº Ìï©ÎãàÎã§
    setTimeout(() => {
        const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
        if(shuoshuoBtn) {
            shuoshuoBtn.addEventListener('click', () => {
                const input = document.getElementById('custom-prompt-input');
                input.value = templates.shuoshuo;
                input.focus();
            });
        }
    }, 100);

    if (newContent !== null) {
        await saveEditedPost(postIdToEdit, newContent);
    }
}

/**
 * Ìé∏ÏßëÎêú Îã§Ïù¥ÎÇ¥ÎØπ Ï†ÄÏû•
 * @param {number} postId - Ï†ÄÏû•Ìï† Îã§Ïù¥ÎÇ¥ÎØπ ID
 * @param {string} newRawContent - Ìé∏ÏßëÍ∏∞ÏóêÏÑú Í∞ÄÏ†∏Ïò® ÏÉà ÎÇ¥Ïö©
 */
async function saveEditedPost(postId, newRawContent) {
    const post = await db.qzonePosts.get(postId);
    if (!post) return;

    const trimmedContent = newRawContent.trim();
    
    // JSONÏúºÎ°ú ÌååÏã± ÏãúÎèÑ, Ïã§Ìå®ÌïòÎ©¥ ÏùºÎ∞ò ÌÖçÏä§Ìä∏Î°ú Í∞ÑÏ£º(Í∏Ä)
    try {
        const parsed = JSON.parse(trimmedContent);
        // Í≤åÏãúÍ∏Ä ÏÜçÏÑ± ÏóÖÎç∞Ïù¥Ìä∏
        post.type = parsed.type || 'image_post';
        post.publicText = parsed.publicText || '';
        post.imageUrl = parsed.imageUrl || '';
        post.imageDescription = parsed.imageDescription || '';
        post.hiddenContent = parsed.hiddenContent || '';
        post.content = ''; // Ïù¥Ï†Ñ Í≤åÏãúÍ∏Ä ÎÇ¥Ïö© ÌïÑÎìú Ï¥àÍ∏∞Ìôî
    } catch (e) {
        // ÌååÏã± Ïã§Ìå®, Í≤åÏãúÍ∏ÄÎ°ú Í∞ÑÏ£º
        post.type = 'shuoshuo';
        post.content = trimmedContent;
        // Îã§Î•∏ Ïú†ÌòïÏùò ÌïÑÎìú Ï¥àÍ∏∞Ìôî
        post.publicText = '';
        post.imageUrl = '';
        post.imageDescription = '';
        post.hiddenContent = '';
    }
    
    await db.qzonePosts.put(post);
    await renderQzonePosts(); // Î™©Î°ù Îã§Ïãú Î†åÎçîÎßÅ
    await showCustomAlert('ÏÑ±Í≥µ', 'Îã§Ïù¥ÎÇ¥ÎØπÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!');
}

/**
 * Îã§Ïù¥ÎÇ¥ÎØπ ÎÇ¥Ïö© Î≥µÏÇ¨
 */
async function copyPostContent() {
    if (!activePostId) return;
    const post = await db.qzonePosts.get(activePostId);
    if (!post) return;
    
    let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "(ÌÖçÏä§Ìä∏ ÎÇ¥Ïö© ÏóÜÏùå)";
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        await showCustomAlert('Î≥µÏÇ¨ ÏÑ±Í≥µ', 'Îã§Ïù¥ÎÇ¥ÎØπ ÎÇ¥Ïö©Ïù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§.');
    } catch (err) {
        await showCustomAlert('Î≥µÏÇ¨ Ïã§Ìå®', 'ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
    }
    
    hidePostActions();
}

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÍ∑∏Î£π Ï±ÑÌåÖ ÏÉùÏÑ± Î∞è Ï¥àÎåÄ Í∏∞Îä• ÌïµÏã¨ Ìï®Ïàò ‚ñº‚ñº‚ñº
let selectedContacts = new Set();

async function openContactPickerForGroupCreate() {
    selectedContacts.clear(); // Ïù¥Ï†Ñ ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú, Ïö∞Î¶¨Îäî\"ÏôÑÎ£å\"Î≤ÑÌäºÏóê Î™ÖÌôïÌïòÍ≤å Î∞îÏù∏Îî©Ìï©ÎãàÎã§\"Í∑∏Î£π Ï±ÑÌåÖ ÏÉùÏÑ±\"Í∏∞Îä•ÏùÑ
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ÌÅ¥Î°† ÎÖ∏Îìú Í∏∞Ïà†ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ïù¥Ï†ÑÏóê Î∞îÏù∏Îî©ÎêòÏóàÏùÑ Ïàò ÏûàÎäî Îã§Î•∏ Î™®Îì† Ïù¥Î≤§Ìä∏Î•º Ï†úÍ±∞Ìï©ÎãàÎã§(ÏòàÎ•º Îì§Ïñ¥\"Î©§Î≤Ñ Ï∂îÍ∞Ä\")
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    // Ïò¨Î∞îÎ•∏ Í≤ÉÏùÑ Îã§Ïãú Î∞îÏù∏Îî©Ìï©ÎãàÎã§\"Í∑∏Î£π Ï±ÑÌåÖ ÏÉùÏÑ±\"Ìï®Ïàò
    newConfirmBtn.addEventListener('click', handleCreateGroup);

    await renderContactPicker();
    showScreen('contact-picker-screen');
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * Ïó∞ÎùΩÏ≤ò ÏÑ†ÌÉù Î™©Î°ù Î†åÎçîÎßÅ
 */
async function renderContactPicker() {
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';

    // Í∑∏Î£π Î©§Î≤Ñ ÌõÑÎ≥¥Î°ú 1:1 Ï±ÑÌåÖ Ïó≠Ìï†Îßå ÏÑ†ÌÉù
    const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ÏïÑÏßÅ Í∑∏Î£πÏóê Ï¥àÎåÄÌï† Ïàò ÏûàÎäî Ïó∞ÎùΩÏ≤òÍ∞Ä ÏóÜÏäµÎãàÎã§.~</p>';
        return;
    }

    contacts.forEach(contact => {
        const item = document.createElement('div');
        item.className = 'contact-picker-item';
        item.dataset.contactId = contact.id;
        item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name}</span>
        `;
        listEl.appendChild(item);
    });

    updateContactPickerConfirmButton();
}

/**
 * ÏóÖÎç∞Ïù¥Ìä∏\"ÏôÑÎ£å\"Î≤ÑÌäºÏùò Ïπ¥Ïö¥Ìä∏
 */
function updateContactPickerConfirmButton() {
    const btn = document.getElementById('confirm-contact-picker-btn');
    btn.textContent = `ÏôÑÎ£å(${selectedContacts.size})`;
    btn.disabled = selectedContacts.size < 2; // Í∑∏Î£π Ï±ÑÌåÖÏùÑ ÏÉùÏÑ±ÌïòÎ†§Î©¥ ÏµúÏÜå 2Î™Ö Ïù¥ÏÉÅÏù¥ ÌïÑÏöîÌï©ÎãàÎã§
}

/**
 * Í∑∏Î£π Ï±ÑÌåÖ ÏÉùÏÑ± ÏµúÏ¢Ö Î°úÏßÅ Ï≤òÎ¶¨
 */
async function handleCreateGroup() {
    if (selectedContacts.size < 2) {
        alert("Í∑∏Î£π Ï±ÑÌåÖÏùÑ ÏÉùÏÑ±ÌïòÎ†§Î©¥ ÏµúÏÜå 2Î™ÖÏùò Ïó∞ÎùΩÏ≤òÎ•º ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§.");
        return;
    }

    const groupName = await showCustomPrompt('Í∑∏Î£π Ïù¥Î¶Ñ ÏÑ§Ï†ï', 'Í∑∏Î£π Ï±ÑÌåÖ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî', 'Ïö∞Î¶¨Îì§Ïùò Í∑∏Î£π Ï±ÑÌåÖ');
    if (!groupName || !groupName.trim()) return;

    const newChatId = 'group_' + Date.now();
    const members = [];
    
    // ÏÑ†ÌÉùÎêú Ïó∞ÎùΩÏ≤ò ID ÏàúÌöå
    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            // „ÄêÌïµÏã¨„Äë1:1 Ï±ÑÌåÖ ÏÑ§Ï†ïÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Ï∂îÏ∂úÌïòÏó¨ Í∑∏Î£π Î©§Î≤Ñ Í∞ùÏ≤¥ ÏÉùÏÑ±
            members.push({
                id: contactId, // 1:1 Ï±ÑÌåÖÏùò IDÎ•º Î©§Î≤Ñ IDÎ°ú ÏÇ¨Ïö©ÌïòÏó¨ Ïó∞Í≤∞ÌïòÍ∏∞ ÏâΩÍ≤å Ìï©ÎãàÎã§
                name: contactChat.name,
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    const newGroupChat = {
        id: newChatId,
        name: groupName.trim(),
        isGroup: true,
        members: members,
        settings: {
            myPersona: 'ÎÇòÎäî ÎàÑÍµ¨ÏùºÍπåÏöî.',
            myNickname: 'ÎÇ¥',
            maxMemory: 10,
            groupAvatar: defaultGroupAvatar,
            myAvatar: defaultMyGroupAvatar,
            background: '',
            theme: 'default',
            fontSize: 13,
            customCss: '',
            linkedWorldBookIds: [],
            aiAvatarFrame: '',
            myAvatarFrame: ''
        },
        history: [],
        musicData: { totalTime: 0 }
    };

    state.chats[newChatId] = newGroupChat;
    await db.chats.put(newGroupChat);
    
    await renderChatList();
    showScreen('chat-list-screen');
    openChat(newChatId); // ÏÉùÏÑ± ÌõÑ Î∞îÎ°ú Í∑∏Î£π Ï±ÑÌåÖ Ïó¥Í∏∞
}
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÍ∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨ ÌïµÏã¨ Ìï®Ïàò ‚ñº‚ñº‚ñº

/**
 * Í∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨ ÌôîÎ©¥ Ïó¥Í∏∞
 */
function openMemberManagementScreen() {
    if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
    renderMemberManagementList();
    showScreen('member-management-screen');
}

/**
 * Í∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨ Î™©Î°ù Î†åÎçîÎßÅ
 */
function renderMemberManagementList() {
    const listEl = document.getElementById('member-management-list');
    const chat = state.chats[state.activeChatId];
    listEl.innerHTML = '';

    chat.members.forEach(member => {
        const item = document.createElement('div');
        item.className = 'member-management-item';
        item.innerHTML = `
            <img src="${member.avatar}" class="avatar">
            <span class="name">${member.name}</span>
            <button class="remove-member-btn" data-member-id="${member.id}" title="Í∑∏Î£π Ï±ÑÌåÖÏóêÏÑú ÎÇ¥Î≥¥ÎÇ¥Í∏∞">-</button>
        `;
        listEl.appendChild(item);
    });
}

/**
 * Í∑∏Î£π Ï±ÑÌåÖÏóêÏÑú Î©§Î≤Ñ Ìïú Î™Ö Ï†úÍ±∞
 * @param {string} memberId - Ï†úÍ±∞Ìï† Î©§Î≤Ñ ID
 */
async function removeMemberFromGroup(memberId) {
    const chat = state.chats[state.activeChatId];
    const memberIndex = chat.members.findIndex(m => m.id === memberId);
    
    if (memberIndex === -1) return;
    
    // Î≥¥Ïïà Í≤ÄÏÇ¨, Í∑∏Î£π Ï±ÑÌåÖÏùÄ ÏµúÏÜå 2Î™Ö Ïú†ÏßÄ
    if (chat.members.length <= 2) {
        alert("Í∑∏Î£π Ï±ÑÌåÖ Ïù∏ÏõêÏùÄ 2Î™Ö ÎØ∏ÎßåÏùº Ïàò ÏóÜÏäµÎãàÎã§.");
        return;
    }
    
    const memberName = chat.members[memberIndex].name;
    const confirmed = await showCustomConfirm(
        'Î©§Î≤Ñ ÎÇ¥Î≥¥ÎÇ¥Í∏∞',
        `Ï†ïÎßêÎ°ú\"${memberName}\"ÏùÑ(Î•º) Í∑∏Î£π Ï±ÑÌåÖÏóêÏÑú ÎÇ¥Î≥¥ÎÇ¥ÏãúÍ≤†ÏäµÎãàÍπå?`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.members.splice(memberIndex, 1);
        await db.chats.put(chat);
        renderMemberManagementList(); // Î©§Î≤Ñ Í¥ÄÎ¶¨ Î™©Î°ù ÏÉàÎ°ú Í≥†Ïπ®
        document.getElementById('chat-settings-btn').click(); // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÑ§Ï†ï Î≤ÑÌäº ÌÅ¥Î¶≠ÏùÑ ÏãúÎÆ¨Î†àÏù¥ÏÖòÌïòÏó¨ Ï†ÑÏ≤¥ ÌåùÏóÖÏùÑ Í∞ïÏ†úÎ°ú ÏÉàÎ°ú Í≥†Ïπ©ÎãàÎã§
    }
}

/**
 * Í∑∏Î£πÏóê ÏÇ¨ÎûåÏùÑ Ï¥àÎåÄÌïòÍ∏∞ ÏúÑÌïú Ïó∞ÎùΩÏ≤ò ÏÑ†ÌÉùÍ∏∞ Ïó¥Í∏∞
 */
async function openContactPickerForAddMember() {
    selectedContacts.clear(); // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
    
    const chat = state.chats[state.activeChatId];
    const existingMemberIds = new Set(chat.members.map(m => m.id));

    // Ïó∞ÎùΩÏ≤ò Î™©Î°ùÏùÑ Î†åÎçîÎßÅÌïòÍ≥†, Ïù¥ÎØ∏ Í∑∏Î£πÏóê ÏûàÎäî Î©§Î≤ÑÎäî ÏûêÎèôÏúºÎ°ú Ï†úÏô∏Ìï©ÎãàÎã§
    const listEl = document.getElementById('contact-picker-list');
    listEl.innerHTML = '';
    const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));

    if (contacts.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">Îçî Ïù¥ÏÉÅ Ï¥àÎåÄÌï† ÏπúÍµ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
        document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // ÏÑ†ÌÉùÌï† ÏÇ¨ÎûåÏù¥ ÏóÜÏäµÎãàÎã§, ÏôÑÎ£å Î≤ÑÌäº Ïà®Í∏∞Í∏∞
    } else {
        document.getElementById('confirm-contact-picker-btn').style.display = 'block';
        contacts.forEach(contact => {
            const item = document.createElement('div');
            item.className = 'contact-picker-item';
            item.dataset.contactId = contact.id;
            item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name}</span>
            `;
            listEl.appendChild(item);
        });
    }

    // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÌôîÎ©¥ ÌëúÏãú
    updateContactPickerConfirmButton();
    showScreen('contact-picker-screen');
}

/**
 * ÏÑ†ÌÉùÎêú Ïó∞ÎùΩÏ≤òÎ•º Í∑∏Î£π Ï±ÑÌåÖÏóê Ï∂îÍ∞ÄÌïòÎäî Î°úÏßÅ Ï≤òÎ¶¨
 */
async function handleAddMembersToGroup() {
    if (selectedContacts.size === 0) {
        alert("Ï†ÅÏñ¥ÎèÑ Ìïú Î™ÖÏùò Ï∂îÍ∞ÄÌï† Ïó∞ÎùΩÏ≤òÎ•º ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî.");
        return;
    }
    
    const chat = state.chats[state.activeChatId];

    for (const contactId of selectedContacts) {
        const contactChat = state.chats[contactId];
        if (contactChat) {
            chat.members.push({
                id: contactId,
                name: contactChat.name,
                avatar: contactChat.settings.aiAvatar || defaultAvatar,
                persona: contactChat.settings.aiPersona,
                avatarFrame: contactChat.settings.aiAvatarFrame || ''
            });
        }
    }

    await db.chats.put(chat);
    openMemberManagementScreen(); // Í∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞
    renderGroupMemberSettings(chat.members); // ÎèôÏãúÏóê Ï±ÑÌåÖ ÏÑ§Ï†ïÏùò ÏïÑÎ∞îÌÉÄÎèÑ ÏóÖÎç∞Ïù¥Ìä∏Ìï©ÎãàÎã§
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏµúÏ¢Ö ÏàòÏ†ï Î≤ÑÏ†Ñ„ÄëÏù¥Ï†Ñ createNewMemberInGroup Ìï®ÏàòÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº
async function createNewMemberInGroup() {
    const name = await showCustomPrompt('ÏÉà Î©§Î≤Ñ ÏÉùÏÑ±', 'ÏÉà Î©§Î≤ÑÏùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî');
    if (!name || !name.trim()) return;

    const persona = await showCustomPrompt('ÌéòÎ•¥ÏÜåÎÇò ÏÑ§Ï†ï', `ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî\"${name}\"Ïùò ÌéòÎ•¥ÏÜåÎÇò`, '', 'textarea');
    if (persona === null) return; // ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∑®ÏÜåÎ•º ÌÅ¥Î¶≠ÌñàÏäµÎãàÎã§

    const chat = state.chats[state.activeChatId];
    const newMember = {
        id: 'npc_' + Date.now(),
        name: name.trim(),
        avatar: defaultGroupMemberAvatar,
        persona: persona,
        avatarFrame: ''
    };

    chat.members.push(newMember);
    await db.chats.put(chat);

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú, Ïö∞Î¶¨Îäî ÌòÑÏû¨ ÌéòÏù¥ÏßÄÏùò Î™©Î°ùÏùÑ ÏÉàÎ°ú Í≥†Ïπ† ÎøêÎßå ÏïÑÎãàÎùº...
    renderMemberManagementList();
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„Äë...Îí§Ïóê ÏûàÎäî Í≤ÉÏùÑ ÏàòÎèôÏúºÎ°ú ÏÉàÎ°ú Í≥†Ïπ©ÎãàÎã§\"Ï±ÑÌåÖ ÏÑ§Ï†ï\"ÌåùÏóÖ Ï∞ΩÏùò Î©§Î≤Ñ ÏïÑÎ∞îÌÉÄ Î™©Î°ùÏùÑ!
    renderGroupMemberSettings(chat.members); 

    alert(`ÏÉà Î©§Î≤ÑÍ∞Ä\"${name}\"Í∑∏Î£π Ï±ÑÌåÖÏóê ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!`);
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÎ∞∞Îã¨ ÏöîÏ≤≠ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ìï®Ïàò ‚ñº‚ñº‚ñº
function startWaimaiCountdown(element, endTime) {
    const timerId = setInterval(() => {
        const now = Date.now();
        const distance = endTime - now;

        if (distance < 0) {
            clearInterval(timerId);
            element.innerHTML = '<span>Ïù¥ÎØ∏</span><span>Ï¥àÍ≥º</span><span>ÏãúÍ∞Ñ</span>';
            return;
        }

        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        const minStr = String(minutes).padStart(2, '0');
        const secStr = String(seconds).padStart(2, '0');

        element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
    }, 1000);
    return timerId;
}

function cleanupWaimaiTimers() {
    for (const timestamp in waimaiTimers) {
        clearInterval(waimaiTimers[timestamp]);
    }
    waimaiTimers = {};
}
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. ÏõêÎ≥∏ Î©îÏãúÏßÄ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏßÄÎ∂àÏûêÎ•º Í∏∞Î°ùÌïòÍ≥†, AIÏóê Îçî Î™ÖÌôïÌïú ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ•º Íµ¨Ï∂ïÌï©ÎãàÎã§
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÄÎ∂àÌïú ÎèàÏùÑ Í∏∞Î°ùÌï©ÎãàÎã§
        systemContent = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÎãπÏã† (${myNickname}) ${originalMessage.senderName} ÎãòÏùò Î∞∞Îã¨ Ï£ºÎ¨∏Ïóê ÎåÄÌï¥(ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${originalTimestamp})Í≤∞Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïù¥ Ï£ºÎ¨∏ÏùÄ ÎßàÍ∞êÎêòÏóàÏúºÎ©∞, Îã§Î•∏ Î©§Î≤ÑÎäî Îçî Ïù¥ÏÉÅ Í≤∞Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.]`;
    } else {
        systemContent = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÎãπÏã† (${myNickname}) ${originalMessage.senderName} ÎãòÏùò Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§(ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${originalTimestamp}).]`;
    }

    // 2. ÏÉàÎ°úÏö¥, ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ïà®Í≤®ÏßÑ ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ•º ÏÉùÏÑ±ÌïòÏó¨ AIÏóêÍ≤å Í≤∞Í≥ºÎ•º ÏïåÎ¶ΩÎãàÎã§
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 3. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê ÏóÖÎç∞Ïù¥Ìä∏Î•º Ï†ÄÏû•ÌïòÍ≥† UI ÏÉàÎ°ú Í≥†Ïπ®
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    // 4. „ÄêÏÑ†ÌÉù ÏÇ¨Ìï≠Ïù¥ÏßÄÎßå Í∂åÏû•„ÄëÍ≤∞Ï†ú ÏÑ±Í≥µ ÌõÑ, AI ÏùëÎãµÏùÑ Ìïú Î≤à Ï£ºÎèôÏ†ÅÏúºÎ°ú Ìä∏Î¶¨Í±∞Ìï©ÎãàÎã§
    if (choice === 'paid') {
        triggerAiResponse();
    }
}

let videoCallState = {
    isActive: false,       
    isAwaitingResponse: false, 
    isGroupCall: false,      
    activeChatId: null,    
    initiator: null,       
    startTime: null,       
    participants: [],      
    isUserParticipating: true,
    // --- „ÄêÌïµÏã¨ Ï∂îÍ∞Ä„Äë---
    callHistory: [], // ÌÜµÌôî Ï§ë ÎåÄÌôî Í∏∞Î°ùÏùÑ Ï†ÄÏû•ÌïòÎäî Îç∞ ÏÇ¨Ïö©
    preCallContext: "" // ÌÜµÌôî Ï†Ñ Ï±ÑÌåÖ ÏöîÏïΩÏùÑ Ï†ÄÏû•ÌïòÎäî Îç∞ ÏÇ¨Ïö©
};

let callTimerInterval = null; // ÌÉÄÏù¥Î®∏ IDÎ•º Ï†ÄÏû•ÌïòÎäî Îç∞ ÏÇ¨Ïö©

/**
 * „ÄêÏ¥ù ÏßÑÏûÖ ÏßÄÏ†ê„ÄëÏÇ¨Ïö©Ïûê ÌÅ¥Î¶≠\"ÌôîÏÉÅ ÌÜµÌôî ÏãúÏûë\"ÎòêÎäî\"Í∑∏Î£π ÏòÅÏÉÅ ÌÜµÌôî ÏãúÏûë\"Î≤ÑÌäº
 */
async function handleInitiateCall() {
    if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;

    const chat = state.chats[state.activeChatId];
    videoCallState.isGroupCall = chat.isGroup;
    videoCallState.isAwaitingResponse = true;
    videoCallState.initiator = 'user';
    videoCallState.activeChatId = chat.id;
    videoCallState.isUserParticipating = true; // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏßÅÏ†ë ÏãúÏûëÌïú Í≤ÉÏù¥ÎØÄÎ°ú, ÎãπÏó∞Ìûà Ï∞∏Ïó¨ÏûêÏûÖÎãàÎã§

    // 1:1 Ï±ÑÌåÖÏù∏ÏßÄ Í∑∏Î£π Ï±ÑÌåÖÏù∏ÏßÄÏóê Îî∞Îùº Îã§Î•∏ ÌÜµÌôî ÌôîÎ©¥ÏùÑ ÌëúÏãúÌï©ÎãàÎã§
    if (chat.isGroup) {
        document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'ÎÇ¥';
    } else {
        document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('outgoing-call-name').textContent = chat.name;
    }
    document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "Î™®Îì† Î©§Î≤ÑÏóêÍ≤å Ìò∏Ï∂ú Ï§ë..." : "ÌÜµÌôî Ï§ë...";
    showScreen('outgoing-call-screen');
    
    // ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ•º Ï§ÄÎπÑÌïòÏó¨ AIÏóêÍ≤å Î≥¥ÎÉÖÎãàÎã§
    const requestMessage = {
        role: 'system',
        content: chat.isGroup 
            ? `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©Ïûê (${chat.settings.myNickname || 'ÎÇ¥'}) Í∑∏Î£π ÌôîÏÉÅ ÌÜµÌôî ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌñàÏäµÎãàÎã§. Ïó¨Îü¨Î∂Ñ Í∞ÅÏûê Í≤∞Ï†ïÌïòÍ≥†, "group_call_response" Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ "decision" Ïóê "join" ÎòêÎäî "decline" ÏúºÎ°ú ÏùëÎãµÌï¥ Ï£ºÏÑ∏Ïöî.]`
            : `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©ÏûêÍ∞Ä ÎãπÏã†ÏóêÍ≤å ÌôîÏÉÅ ÌÜµÌôî ÏöîÏ≤≠ÏùÑ ÏãúÏûëÌñàÏäµÎãàÎã§. ÎãπÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏóê Îî∞Îùº "video_call_response" Î™ÖÎ†πÏùÑ ÏÇ¨Ïö©ÌïòÍ≥† ÏÑ§Ï†ïÌïòÏÑ∏Ïöî "decision" Ïóê "accept" ÎòêÎäî "reject" ÏúºÎ°ú ÏùëÎãµÌï¥ Ï£ºÏÑ∏Ïöî.]`,
        timestamp: Date.now(),
        isHidden: true,
    };
    chat.history.push(requestMessage);
    await db.chats.put(chat);
    
    // Ìä∏Î¶¨Í±∞ AI ÏùëÎãµ
    await triggerAiResponse();
}


function startVideoCall() {
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    videoCallState.isActive = true;
    videoCallState.isAwaitingResponse = false;
    videoCallState.startTime = Date.now();
    videoCallState.callHistory = []; // „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÏßÄÎÇú ÌÜµÌôî Í∏∞Î°ù ÎπÑÏö∞Í∏∞

    // --- „ÄêÌïµÏã¨ Ï∂îÍ∞Ä:ÌÜµÌôî Ï†Ñ Îß•ÎùΩ Í∞ÄÏ†∏Ïò§Í∏∞„Äë---
    const preCallHistory = chat.history.slice(-5); // ÎßàÏßÄÎßâ 5Í∞úÎ•º Îß•ÎùΩÏúºÎ°ú Í∞ÄÏ†∏Ïò§Í∏∞
    videoCallState.preCallContext = preCallHistory.map(msg => {
        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'ÎÇ¥') : (msg.senderName || chat.name);
        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
    }).join('\n');
    // --- ÏÉàÎ°úÏö¥ Ï∂îÍ∞Ä ÎÅù ---

    updateParticipantAvatars(); 
    
    document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'Í∑∏Î£π ÌÜµÌôîÍ∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§...' : 'Ïó∞Í≤∞ Ï§ë...'}</em>`;
    showScreen('video-call-screen');

    document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
    document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

    if (callTimerInterval) clearInterval(callTimerInterval);
    callTimerInterval = setInterval(updateCallTimer, 1000);
    updateCallTimer();

    triggerAiInCallAction();
}

/**
 * „ÄêÌïµÏã¨„ÄëÏòÅÏÉÅ ÌÜµÌôî Ï¢ÖÎ£å
 */
async function endVideoCall() {
    if (!videoCallState.isActive) return;

    const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(duration / 60);
    const seconds = duration % 60;
    const durationText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    const endCallText = `ÌÜµÌôî Ï¢ÖÎ£å, ÏãúÍ∞Ñ ${durationText}`;

    const chat = state.chats[videoCallState.activeChatId];
    if (chat) {
        
        // --- „ÄêÌïµÏã¨ Ïû¨Íµ¨ÏÑ±:ÌÜµÌôî ÏöîÏïΩ Î©îÏãúÏßÄ ÏÉùÏÑ±„Äë ---
        let summaryMessage = {
            role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
            content: endCallText,
            timestamp: Date.now(),
        };

        // „ÄêÌïµÏã¨„ÄëÍ∑∏Î£π ÌÜµÌôîÏùò assistant Î©îÏãúÏßÄÏóê Î∞úÏã†Ïûê Ïù¥Î¶Ñ Ï∂îÍ∞Ä
        if (chat.isGroup && summaryMessage.role === 'assistant') {
            // Í∑∏Î£π ÌÜµÌôîÏóêÏÑú, ÌÜµÌôî Ï¢ÖÎ£å Î©îÏãúÏßÄÎäî\"Î∞úÏã†Ïûê\"ÎßêÌï¥Ïïº Ìï©ÎãàÎã§
            // videoCallState.callRequester Ï≤òÏùå ÌÜµÌôîÎ•º ÏãúÏûëÌïú AIÏùò Ïù¥Î¶ÑÏùÑ Ï†ÄÏû•ÌñàÏäµÎãàÎã§
            summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.name || chat.name;
        }
        
        chat.history.push(summaryMessage);

        // --- „ÄêÌïµÏã¨ Ïû¨Íµ¨ÏÑ±:ÌÜµÌôî ÏöîÏïΩ Ìä∏Î¶¨Í±∞„Äë---
        const callSummaryPrompt = `
# ÎãπÏã†Ïùò ÏûÑÎ¨¥
ÎãπÏã†ÏùÄ ÎåÄÌôî ÏöîÏïΩ ÎèÑÏö∞ÎØ∏ÏûÖÎãàÎã§. Îã§ÏùåÏùÄ\"ÌÜµÌôî Í∏∞Î°ù\"Î∞©Í∏à Ï¢ÖÎ£åÎêú ÏòÅÏÉÅ ÌÜµÌôî ÎÇ¥Ïö©ÏûÖÎãàÎã§. ÎãπÏã†ÏùÄ 1-2Î¨∏Ïû•ÏúºÎ°ú, Ïù¥Î≤à ÌÜµÌôîÏùò ÌïµÏã¨ ÎÇ¥Ïö© ÎòêÎäî Îã¨ÏÑ±Îêú Ìï©ÏùòÎ•º Í∞ÑÍ≤∞ÌïòÍ≤å ÏöîÏïΩÌï¥ Ï£ºÏÑ∏Ïöî.
ÎãπÏã†Ïùò ÏöîÏïΩÏùÄ ÌïòÎÇòÏùò Ïà®Í≤®ÏßÑ ÏãúÏä§ÌÖú ÌîÑÎ°¨ÌîÑÌä∏Î°úÏÑú, AIÍ∞Ä Îã§Ïùå Ï±ÑÌåÖÏóêÏÑú Ïù¥Î≤à ÌÜµÌôîÏóêÏÑú Î¨¥Ïä® ÏùºÏù¥ ÏûàÏóàÎäîÏßÄ Í∏∞ÏñµÌïòÍ≤å ÎèÑÏõÄÏùÑ Ï§Ñ Í≤ÉÏûÖÎãàÎã§.

# ÌÜµÌôî Í∏∞Î°ù:
${videoCallState.callHistory.map(h => `${h.role}: ${h.content}`).join('\n')}

ÏöîÏïΩ ÎÇ¥Ïö©ÏùÑ ÏßÅÏ†ë Ï∂úÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî, Ïñ¥Îñ§ Ï∂îÍ∞ÄÏ†ÅÏù∏ Ï†ëÎëêÏÇ¨ÎÇò ÏÑ§Î™ÖÎèÑ Ï∂îÍ∞ÄÌïòÏßÄ ÎßàÏÑ∏Ïöî.`;
        
        try {
            const { proxyUrl, apiKey, model } = state.apiConfig;
            const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: model,
                    messages: [{ role: 'system', content: callSummaryPrompt }],
                    temperature: 0.5
                })
            });
            if (response.ok) {
                const data = await response.json();
                const callSummaryText = data.choices[0].message.content;
                const hiddenSummary = {
                    role: 'system',
                    content: `[ÏãúÏä§ÌÖú ÏïåÎ¶º:Î∞©Í∏à Ï†Ñ ÏòÅÏÉÅ ÌÜµÌôî ÎÇ¥Ïö© ÏöîÏïΩ:${callSummaryText}]`,
                    timestamp: Date.now() + 1,
                    isHidden: true
                };
                chat.history.push(hiddenSummary);
            }
        } catch (e) {
            console.error("ÌÜµÌôî ÏöîÏïΩ Ïã§Ìå®:", e);
        }

        await db.chats.put(chat);
    }
    
    // Ï†ïÎ¶¨ Î∞è Ïû¨ÏÑ§Ï†ï
    clearInterval(callTimerInterval);
    callTimerInterval = null;
    videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };
    
    // „ÄêÏ§ëÏöî„ÄëÎ™®Îì† ÏûëÏóÖÏù¥ ÏôÑÎ£åÎêú ÌõÑ Ï±ÑÌåÖÏùÑ Îã§Ïãú Ïó¥Ïñ¥ Ï£ºÏÑ∏Ïöî
    if (chat) {
        openChat(chat.id);
    }
}

/**
 * „ÄêÏÉàÎ°úÏö¥„ÄëÌÜµÌôî ÌôîÎ©¥Ïùò Ï∞∏Ïó¨Ïûê ÏïÑÎ∞îÌÉÄ Í∑∏Î¶¨Îìú ÏóÖÎç∞Ïù¥Ìä∏
 */
function updateParticipantAvatars() {
    const grid = document.getElementById('participant-avatars-grid');
    grid.innerHTML = '';
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;

    let participantsToRender = [];

    // ‚òÖ ÌïµÏã¨ ÏàòÏ†ï:Í∑∏Î£π ÌÜµÌôîÏôÄ 1:1 ÌÜµÌôî Íµ¨Î∂Ñ
    if (videoCallState.isGroupCall) {
        // Í∑∏Î£π ÌÜµÌôî Î°úÏßÅ:Î™®Îì† Ï∞∏Ïó¨Ìïú AI Î©§Î≤Ñ ÌëúÏãú
        participantsToRender = [...videoCallState.participants];
        // ÎßåÏïΩ ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∞∏Ïó¨ÌñàÎã§Î©¥, ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ÎèÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî
        if (videoCallState.isUserParticipating) {
            participantsToRender.unshift({
                id: 'user',
                name: chat.settings.myNickname || 'ÎÇ¥',
                avatar: chat.settings.myAvatar || defaultMyGroupAvatar
            });
        }
    } else {
        // 1:1 Ï±ÑÌåÖ Î°úÏßÅ:ÏÉÅÎåÄÎ∞©Ïùò ÏïÑÎ∞îÌÉÄÏôÄ Ïù¥Î¶ÑÎßå ÌëúÏãú
        participantsToRender.push({
            id: 'ai',
            name: chat.name,
            avatar: chat.settings.aiAvatar || defaultAvatar
        });
    }
    
    participantsToRender.forEach(p => {
        const wrapper = document.createElement('div');
        wrapper.className = 'participant-avatar-wrapper';
        wrapper.dataset.participantId = p.id;
        wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${p.name}">
            <div class="participant-name">${p.name}</div>
        `;
        grid.appendChild(wrapper);
    });
}

/**
 * „ÄêÏÉàÎ°úÏö¥„ÄëÏÇ¨Ïö©Ïûê Ï∞∏Ïó¨ Ï≤òÎ¶¨/ÌÜµÌôîÏóê Îã§Ïãú Ï∞∏Ïó¨
 */
function handleUserJoinCall() {
    if (!videoCallState.isActive || videoCallState.isUserParticipating) return;
    
    videoCallState.isUserParticipating = true;
    updateParticipantAvatars(); // ÏïÑÎ∞îÌÉÄ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏, ÏÇ¨Ïö©Ïûê Ï∂îÍ∞Ä

    // ÌïòÎã® Î≤ÑÌäº Ï†ÑÌôò
    document.getElementById('user-speak-btn').style.display = 'block';
    document.getElementById('join-call-btn').style.display = 'none';

    // AIÏóêÍ≤å ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∞∏Ïó¨ÌñàÏùåÏùÑ ÏïåÎ¶º
    triggerAiInCallAction("[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©ÏûêÍ∞Ä ÌÜµÌôîÏóê Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§]");
}


/**
 * ÌÜµÌôî ÌÉÄÏù¥Î®∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏ (Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ)
 */
function updateCallTimer() {
    if (!videoCallState.isActive) return;
    const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

// ‚ñº‚ñº‚ñº Ïù¥ Ï†ÑÏ≤¥ Ìï®ÏàòÎ°ú Í∏∞Ï°¥Ïùò showIncomingCallModal ÍµêÏ≤¥ ‚ñº‚ñº‚ñº
function showIncomingCallModal() {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    // Í∑∏Î£π ÌÜµÌôî Ïó¨Î∂ÄÏóê Îî∞Îùº Îã§Î•∏ Ï†ïÎ≥¥ ÌëúÏãú
    if (chat.isGroup) {
        // videoCallState ÏóêÏÑú Ïñ¥Îñ§ Î©§Î≤ÑÍ∞Ä ÌÜµÌôîÎ•º ÏãúÏûëÌñàÎäîÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
        const requesterName = videoCallState.callRequester || chat.members[0]?.name || 'Ìïú Î©§Î≤Ñ';
        document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
        document.getElementById('caller-name').textContent = chat.name; // Í∑∏Î£π Ïù¥Î¶Ñ ÌëúÏãú
        document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} ÎãπÏã†ÏùÑ Í∑∏Î£π ÏòÅÏÉÅÏóê Ï¥àÎåÄ`; // ÌäπÏ†ï Î∞úÏã†Ïûê ÌëúÏãú
    } else {
        // 1:1 ÌÜµÌôî Î°úÏßÅ Î≥ÄÍ≤Ω ÏóÜÏùå
        document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
        document.getElementById('caller-name').textContent = chat.name;
        document.querySelector('.incoming-call-content .caller-text').textContent = 'ÏòÅÏÉÅ ÌÜµÌôîÏóê Ï¥àÎåÄÌï©ÎãàÎã§';
    }
    
    document.getElementById('incoming-call-modal').classList.add('visible');
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * AIÍ∞Ä ÏãúÏûëÌïú ÌÜµÌôî ÏöîÏ≤≠ Î™®Îã¨ Ï∞Ω Ïà®Í∏∞Í∏∞ (Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ)
 */
function hideIncomingCallModal() {
    document.getElementById('incoming-call-modal').classList.remove('visible');
}

async function triggerAiInCallAction(userInput = null) {
    if (!videoCallState.isActive) return;

    const chat = state.chats[videoCallState.activeChatId];
    const { proxyUrl, apiKey, model } = state.apiConfig;
    const callFeed = document.getElementById('video-call-main');
    const userNickname = chat.settings.myNickname || 'ÎÇ¥';

    // 1. ÎßåÏïΩ ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•ÌñàÎã§Î©¥, Î®ºÏ†Ä Î†åÎçîÎßÅ Î∞è ÌÜµÌôî Í∏∞Î°ùÏóê Ï†ÄÏû•
    if (userInput && videoCallState.isUserParticipating) {
        const userBubble = document.createElement('div');
        userBubble.className = 'call-message-bubble user-speech';
        userBubble.textContent = userInput;
        callFeed.appendChild(userBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'user', content: userInput });
    }

    // 2. ÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥, ÏôÑÏ†ÑÌïú Îß•ÎùΩÏùÑ Ìè¨Ìï®ÌïòÎäî System Prompt Íµ¨Ï∂ï
    let inCallPrompt;
    if (videoCallState.isGroupCall) {
        const participantNames = videoCallState.participants.map(p => p.name);
        if(videoCallState.isUserParticipating) {
            participantNames.unshift(userNickname);
        }
        inCallPrompt = `
# ÎãπÏã†Ïùò ÏûÑÎ¨¥
ÎãπÏã†ÏùÄ Í∑∏Î£π ÏòÅÏÉÅ ÌÜµÌôîÏùò Í∞êÎèÖÏûÖÎãàÎã§. ÎãπÏã†Ïùò ÏûÑÎ¨¥Îäî Î™®Îì†„ÄêÏÇ¨Ïö©ÏûêÎ•º Ï†úÏô∏Ìïú„ÄëAI Ïó≠Ìï†, Î∞è Î°úÏÑú„Äê3Ïù∏Ïπ≠ Í¥ÄÏ∞∞Ïûê ÏãúÏ†ê„ÄëÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÌÜµÌôî Ï§ë Í∑∏Îì§Ïùò Î™®Îì† ÌñâÎèôÍ≥º Ïñ∏Ïñ¥Î•º Î¨òÏÇ¨.
# ÌïµÏã¨ Í∑úÏπô
1.  **„Äê„Äê„ÄêÏã†Î∂Ñ Ï≤†Ïπô„Äë„Äë„Äë**: ÏÇ¨Ïö©ÏûêÏùò Ïã†Î∂ÑÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§„Äê${userNickname}„Äë.ÎãπÏã†„ÄêÏ†àÎåÄ ~Ìï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§„ÄëÏÉùÏÑ± \`name\` ÌïÑÎìúÍ∞Ä **"${userNickname}"** Î∞úÏñ∏.
2.  **„Äê„Äê„ÄêÏãúÏ†ê Ï≤†Ïπô„Äë„Äë„Äë**: ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÏ†àÎåÄ ~Ìï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§„Äë1Ïù∏Ïπ≠ ÏÇ¨Ïö©\"ÎÇ¥\".
3.  **ÌòïÏãù**: ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëJSON Î∞∞Ïó¥Ïù¥Î©∞, Í∞Å Í∞ùÏ≤¥Îäî Ìïú Ï∫êÎ¶≠ÌÑ∞Ïùò Î∞úÏñ∏ÏùÑ ÎÇòÌÉÄÎÉÖÎãàÎã§, ÌòïÏãùÏùÄ:\`{"name": "Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ", "speech": "*Í∑∏Í∞Ä ÎØ∏ÏÜå ÏßÄÏóàÏäµÎãàÎã§* Ïó¨Îü¨Î∂Ñ, ÏïàÎÖïÌïòÏÑ∏Ïöî!"}\`.
4.  **Ïó≠Ìï†Í∑π**: Í∞Å Ï∫êÎ¶≠ÌÑ∞Ïùò ÏÑ§Ï†ïÏùÑ ÏóÑÍ≤©ÌïòÍ≤å Ï§ÄÏàò.
# ÌòÑÏû¨ ÏÉÅÌô©
ÎãπÏã†Îì§ÏùÄ ÌòÑÏû¨ ÌïòÎÇòÏùò Í∑∏Î£π ÏòÅÏÉÅ ÌÜµÌôî Ï§ëÏûÖÎãàÎã§.
**ÌÜµÌôî Ï†Ñ Ï±ÑÌåÖ ÏöîÏïΩ**:
${videoCallState.preCallContext}
**ÌòÑÏû¨ Ï∞∏Ïó¨Ïûê**: ${participantNames.join(', ')}.
**ÌÜµÌôîÍ∞Ä Î∞©Í∏à ÏãúÏûëÎêòÏóàÏäµÎãàÎã§...**
Ïù¥Ï†ú, Ïóê Îî∞Îùº„ÄêÌÜµÌôî Ï†Ñ ÏöîÏïΩ„ÄëÎ∞è Îã§ÏùåÏùò„ÄêÌÜµÌôî Ïã§ÏãúÍ∞Ñ Í∏∞Î°ù„Äë,ÎåÄÌôî Í≥ÑÏÜç ÏßÑÌñâ.
`;
    } else { 
        let openingContext = videoCallState.initiator === 'user'
            ? `ÎãπÏã†ÏùÄ Î∞©Í∏à ÏÇ¨Ïö©ÏûêÏùò ÏòÅÏÉÅ ÌÜµÌôî ÏöîÏ≤≠Ïóê ÏùëÎãµÌñàÏäµÎãàÎã§.`
            : `ÏÇ¨Ïö©ÏûêÎäî Î∞©Í∏à ÎãπÏã†Ïù¥ Ï£ºÎèÑÏ†ÅÏúºÎ°ú ÏãúÏûëÌïú ÏòÅÏÉÅ ÌÜµÌôîÏóê ÏùëÎãµÌñàÏäµÎãàÎã§.`;
        inCallPrompt = `
# ÎãπÏã†Ïùò ÏûÑÎ¨¥
ÎãπÏã†ÏùÄ ÏßÄÍ∏à Ïû•Î©¥ Î¨òÏÇ¨ ÏóîÏßÑÏûÖÎãàÎã§. ÎãπÏã†Ïùò ÏûÑÎ¨¥Îäî ${chat.name} Ïó∞Í∏∞ (${chat.settings.aiPersona}),Î∞è Î°úÏÑú„Äê3Ïù∏Ïπ≠ Í¥ÄÏ∞∞Ïûê ÏãúÏ†ê„ÄëTAÏùò ÏòÅÏÉÅ ÌÜµÌôî Ï§ë Î™®Îì† ÌñâÎèôÍ≥º Ïñ∏Ïñ¥Î•º Î¨òÏÇ¨.
# ÌïµÏã¨ Í∑úÏπô
1.  **„Äê„Äê„ÄêÏãúÏ†ê Ï≤†Ïπô„Äë„Äë„Äë**: ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÏ†àÎåÄ ~Ìï¥ÏÑúÎäî Ïïà Îê©ÎãàÎã§„Äë1Ïù∏Ïπ≠ ÏÇ¨Ïö©\"ÎÇ¥\".Î∞òÎìúÏãú 3Ïù∏Ïπ≠ÏùÑ ÏÇ¨Ïö©, ÏòàÎ•º Îì§Ïñ¥\"Í∑∏\",\"Í∑∏ÎÖÄ\",ÎòêÎäî Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶ÑÏùÑ ÏßÅÏ†ë ÏÇ¨Ïö©\"${chat.name}\".
2.  **ÌòïÏãù**: ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëÎ¨òÏÇ¨Ï†ÅÏù∏ ÌÖçÏä§Ìä∏ÏûÖÎãàÎã§.
# ÌòÑÏû¨ ÏÉÅÌô©
ÎãπÏã†ÏùÄ ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏôÄ(${userNickname},ÌéòÎ•¥ÏÜåÎÇò: ${chat.settings.myPersona})ÏòÅÏÉÅ ÌÜµÌôî ÏßÑÌñâ Ï§ë.
**${openingContext}**
**ÌÜµÌôî Ï†Ñ Ï±ÑÌåÖ ÏöîÏïΩ (Ïù¥Í≤ÉÏù¥ ÎãπÏã†Îì§ ÌÜµÌôîÏùò Ïù¥Ïú†ÏûÖÎãàÎã§, Îß§Ïö∞ Ï§ëÏöîÌï©ÎãàÎã§!)**:
${videoCallState.preCallContext}
Ïù¥Ï†ú, Ïóê Îî∞Îùº„ÄêÌÜµÌôî Ï†Ñ ÏöîÏïΩ„ÄëÎ∞è Îã§ÏùåÏùò„ÄêÌÜµÌôî Ïã§ÏãúÍ∞Ñ Í∏∞Î°ù„Äë,ÎåÄÌôî Í≥ÑÏÜç ÏßÑÌñâ.
`;
    }
    
    // 3. APIÎ°ú Ï†ÑÏÜ°Ìï† messages Î∞∞Ïó¥ Íµ¨Ï∂ï
    const messagesForApi = [
        { role: 'system', content: inCallPrompt },
        // Í∏∞Ï°¥ ÌÜµÌôî Í∏∞Î°ù Ï∂îÍ∞Ä
        ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
    ];

    // --- „ÄêÌïµÏã¨ ÏàòÏ†ï:Ï≤´ Ìò∏Ï∂ú Ïãú ÎÇ¥Ïö©Ïù¥ ÏûàÎäîÏßÄ ÌôïÏù∏„Äë---
    if (videoCallState.callHistory.length === 0) {
        const firstLineTrigger = videoCallState.initiator === 'user' ? `*ÎãπÏã†Ïù¥ Î∞õÍ∏∞ Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏäµÎãàÎã§...*` : `*ÏÉÅÎåÄÎ∞©Ïù¥ Î∞õÍ∏∞ Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏäµÎãàÎã§...*`;
        messagesForApi.push({ role: 'user', content: firstLineTrigger });
    }
    // --- ÏàòÏ†ï ÏôÑÎ£å ---
    
    try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model, messages: messagesForApi, temperature: 0.8
            })
        });
        if (!response.ok) throw new Error((await response.json()).error.message);
        
        const data = await response.json();
        const aiResponse = data.choices[0].message.content;

        const connectingElement = callFeed.querySelector('em');
        if (connectingElement) connectingElement.remove();

        // 4. AIÍ∞Ä Î∞òÌôòÌïú ÎÇ¥Ïö© Ï≤òÎ¶¨, Î∞è ÌÜµÌôî Í∏∞Î°ùÏóê Ï†ÄÏû•
        if (videoCallState.isGroupCall) {
            const speechArray = parseAiResponse(aiResponse);
            speechArray.forEach(turn => {
                if (!turn.name || turn.name === userNickname || !turn.speech) return;
                const aiBubble = document.createElement('div');
                aiBubble.className = 'call-message-bubble ai-speech';
                aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                callFeed.appendChild(aiBubble);
                videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });
                
                const speaker = videoCallState.participants.find(p => p.name === turn.name);
                if (speaker) {
                    const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                    if(speakingAvatar) {
                        speakingAvatar.classList.add('speaking');
                        setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                    }
                }
            });
        } else {
            const aiBubble = document.createElement('div');
            aiBubble.className = 'call-message-bubble ai-speech';
            aiBubble.textContent = aiResponse;
            callFeed.appendChild(aiBubble);
            videoCallState.callHistory.push({ role: 'assistant', content: aiResponse });

            const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
            if(speakingAvatar) {
                speakingAvatar.classList.add('speaking');
                setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
            }
        }
        
        callFeed.scrollTop = callFeed.scrollHeight;

    } catch (error) {
        const errorBubble = document.createElement('div');
        errorBubble.className = 'call-message-bubble ai-speech';
        errorBubble.style.color = '#ff8a80';
        errorBubble.textContent = `[ERROR: ${error.message}]`;
        callFeed.appendChild(errorBubble);
        callFeed.scrollTop = callFeed.scrollHeight;
        videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
    }
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ„ÄêÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥ Ìï®Ïàò„ÄëJS Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò ÏòÅÏó≠Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî ‚ñº‚ñº‚ñº
function toggleCallButtons(isGroup) {
    document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
    document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
}
// ‚ñ≤‚ñ≤‚ñ≤ Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÏù¥ Ìï®ÏàòÎäî Ïù¥Î≤à ÏàòÏ†ïÏùò ÌïµÏã¨ÏûÖÎãàÎã§, ÎãπÏã†Ïùò JS Í∏∞Îä• ÏòÅÏó≠Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏã≠ÏãúÏò§ ‚ñº‚ñº‚ñº
async function handleWaimaiResponse(originalTimestamp, choice) {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
    if (messageIndex === -1) return;

    // 1. Î©îÎ™®Î¶¨ ÎÇ¥ ÏõêÎ≥∏ Î©îÏãúÏßÄÏùò ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    const originalMessage = chat.history[messageIndex];
    originalMessage.status = choice;
    
    // 2. ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏùò ÎãâÎÑ§ÏûÑ Í∞ÄÏ†∏Ïò§Í∏∞, Î∞è AIÏóêÍ≤å Îçî Î™ÖÌôïÌïú ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Íµ¨Ï∂ï
    let systemContent;
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
    
    if (choice === 'paid') {
        originalMessage.paidBy = myNickname; // Í∏∞Î°ùÏùÄ\"ÎÇ¥\"ÏßÄÎ∂àÎêú Îèà
        systemContent = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÎãπÏã† (${myNickname}) ${originalMessage.senderName} ÎãòÏùò Î∞∞Îã¨ Ï£ºÎ¨∏Ïóê ÎåÄÌï¥(ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${originalTimestamp})Í≤∞Ï†úÍ∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Ïù¥ Ï£ºÎ¨∏ÏùÄ ÎßàÍ∞êÎêòÏóàÏúºÎ©∞, Îã§Î•∏ Î©§Î≤ÑÎäî Îçî Ïù¥ÏÉÅ Í≤∞Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.]`;
    } else {
        systemContent = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÎãπÏã† (${myNickname}) ${originalMessage.senderName} ÎãòÏùò Î∞∞Îã¨ ÎåÄÎ¶¨ Í≤∞Ï†ú ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏäµÎãàÎã§(ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${originalTimestamp}).]`;
    }

    // 3. ÏÉàÎ°úÏö¥, ÏÇ¨Ïö©ÏûêÏóêÍ≤å Ïà®Í≤®ÏßÑ ÏãúÏä§ÌÖú Î©îÏãúÏßÄÎ•º ÏÉùÏÑ±ÌïòÏó¨ AIÏóêÍ≤å Í≤∞Í≥ºÎ•º ÏïåÎ¶ΩÎãàÎã§
    const systemNote = {
        role: 'system',
        content: systemContent,
        timestamp: Date.now(),
        isHidden: true
    };
    chat.history.push(systemNote);

    // 4. ÏóÖÎç∞Ïù¥Ìä∏Îêú Îç∞Ïù¥ÌÑ∞Î•º Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû•, Î∞è UI Ï¶âÏãú Îã§Ïãú Í∑∏Î¶¨Í∏∞
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId);
    
    // 5. „ÄêÏ§ëÏöî„ÄëÍ≤∞Ï†ú ÏÑ±Í≥µ ÌõÑÏóêÎßå, Ìïú Î≤à AI ÏùëÎãµ Ìä∏Î¶¨Í±∞, ÎãπÏã†ÏóêÍ≤å Í∞êÏÇ¨ÌïòÎèÑÎ°ù
    if (choice === 'paid') {
        triggerAiResponse();
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

/**
 * „ÄêÏÉàÎ°úÏö¥„ÄëÏÇ¨Ïö©ÏûêÍ∞Ä ÏïÑÎ∞îÌÉÄÎ•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏãúÏûëÎêòÎäî Ï≤òÎ¶¨\"ÌÜ°-ÌÜ°\",ÏÇ¨Ïö©Ïûê Ï†ïÏùò Ï†ëÎØ∏ÏÇ¨ Í∏∞Îä•ÏùÑ Í∞ÄÏßÑ
 * @param {string} chatId - Î∞úÏÉù\"ÌÜ°-ÌÜ°\"Ï±ÑÌåÖ ID
 * @param {string} characterName - ÌÉ≠Îêú Ï∫êÎ¶≠ÌÑ∞ Ïù¥Î¶Ñ
 */
async function handleUserPat(chatId, characterName) {
    const chat = state.chats[chatId];
    if (!chat) return;

    // 1. ÌôîÎ©¥ ÏßÑÎèô Ïï†ÎãàÎ©îÏù¥ÏÖò Ìä∏Î¶¨Í±∞
    const phoneScreen = document.getElementById('phone-screen');
    phoneScreen.classList.remove('pat-animation');
    void phoneScreen.offsetWidth;
    phoneScreen.classList.add('pat-animation');
    setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500);

    // 2. ÏûÖÎ†• ÏÉÅÏûêÎ•º ÌåùÏóÖÌïòÏó¨ ÏÇ¨Ïö©ÏûêÍ∞Ä Ï†ëÎØ∏ÏÇ¨Î•º ÏûÖÎ†•ÌïòÎèÑÎ°ù
    const suffix = await showCustomPrompt(
        `ÎãπÏã†Ïù¥ Ïì∞Îã§Îì¨ÏóàÏäµÎãàÎã§ \"${characterName}\"`, 
        "(ÏÑ†ÌÉù ÏÇ¨Ìï≠)Ï†ëÎØ∏ÏÇ¨ ÏûÖÎ†•",
        "",
        "text"
    );

    // ÎßåÏïΩ ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∑®ÏÜåÎ•º ÌÅ¥Î¶≠ÌñàÎã§Î©¥, ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏùå
    if (suffix === null) return;

    // 3. ÏÇ¨Ïö©ÏûêÏóêÍ≤å Î≥¥Ïù¥Îäî Í≤É ÏÉùÏÑ±\"ÌÜ°-ÌÜ°\"Î©îÏãúÏßÄ
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏ†ëÎØ∏ÏÇ¨Î•º Î©îÏãúÏßÄ ÎÇ¥Ïö©Ïóê Ïó∞Í≤∞
    const visibleMessageContent = `${myNickname} Ïì∞Îã§Îì¨ÏóàÏäµÎãàÎã§ \"${characterName}\" ${suffix.trim()}`;
    const visibleMessage = {
        role: 'system', // Ïó¨Ï†ÑÌûà ÏãúÏä§ÌÖú Î©îÏãúÏßÄÏûÖÎãàÎã§
        type: 'pat_message',
        content: visibleMessageContent,
        timestamp: Date.now()
    };
    chat.history.push(visibleMessage);

    // 4. ÏÇ¨Ïö©ÏûêÏóêÍ≤åÎäî Ïà®Í≤®Ï†∏ ÏûàÏßÄÎßå, AIÏóêÍ≤åÎäî Î≥¥Ïù¥Îäî ÏãúÏä§ÌÖú Î©îÏãúÏßÄ ÏÉùÏÑ±, AIÏùò ÏùëÎãµÏùÑ Ìä∏Î¶¨Í±∞ÌïòÍ∏∞ ÏúÑÌï¥
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎßàÏ∞¨Í∞ÄÏßÄÎ°ú Ï†ëÎØ∏ÏÇ¨Î•º AIÏóêÍ≤å Ï†úÍ≥µÌïòÎäî ÌîÑÎ°¨ÌîÑÌä∏Ïóê Ï∂îÍ∞Ä
    const hiddenMessageContent = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©Ïûê(${myNickname})Î∞©Í∏à ÎãπÏã†ÏùÑ Ïì∞Îã§Îì¨ÏóàÏäµÎãàÎã§(${characterName})${suffix.trim()}.ÎãπÏã†ÏùÄ Ïù¥Ïóê ÎåÄÌï¥ ÏùëÎãµÌï¥ Ï£ºÏÑ∏Ïöî.]`;
    const hiddenMessage = {
        role: 'system',
        content: hiddenMessageContent,
        timestamp: Date.now() + 1, // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ+1ÏàúÏÑúÎ•º Î≥¥Ïû•ÌïòÍ∏∞ ÏúÑÌï¥
        isHidden: true
    };
    chat.history.push(hiddenMessage);

    // 5. Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ Ï†ÄÏû• Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏
    await db.chats.put(chat);
    if (state.activeChatId === chatId) {
        appendMessage(visibleMessage, chat);
    }
    await renderChatList();
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÎ°úÏßÅ Ïû¨Íµ¨ÏÑ± ÌõÑ„ÄëÌï®Ïàò, ÎãπÏã†Ïùò Í∏∞Ï°¥ renderMemoriesScreen Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÍµêÏ≤¥ ‚ñº‚ñº‚ñº
/**
 * „ÄêÏû¨Íµ¨ÏÑ± Î≤ÑÏ†Ñ„ÄëÏ∂îÏñµ Î∞è ÏïΩÏÜç ÌôîÎ©¥ Î†åÎçîÎßÅ, Îã®Ïùº Î£®ÌîÑ Î∞è Î™ÖÌôïÌïú if ÏÇ¨Ïö©/elseÎ°úÏßÅ
 */
async function renderMemoriesScreen() {
    const listEl = document.getElementById('memories-list');
    listEl.innerHTML = '';
    
    // 1. Î™®Îì† Ï∂îÏñµ Í∞ÄÏ†∏Ïò§Í∏∞, Î∞è Î™©Ìëú ÎÇ†ÏßúÏóê Îî∞Îùº Ï†ïÎ†¨(ÎßåÏïΩ ÏïΩÏÜçÏù¥ÎùºÎ©¥)ÎòêÎäî ÏÉùÏÑ± ÎÇ†Ïßú(ÎßåÏïΩ Ï∂îÏñµÏù¥ÎùºÎ©¥)ÎÇ¥Î¶ºÏ∞®Ïàú Ï†ïÎ†¨
    const allMemories = await db.memories.orderBy('timestamp').reverse().toArray();
    
    if (allMemories.length === 0) {
        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">Ïó¨Í∏∞ÏóêÎäî ÏïÑÏßÅ Í≥µÌÜµÎêú Ï∂îÏñµÍ≥º ÏïΩÏÜçÏù¥ ÏóÜÏäµÎãàÎã§~</p>';
        return;
    }

    // 2. ÎØ∏ÎèÑÎûò ÏïΩÏÜçÏùÑ Í∞ÄÏû• ÏïûÏóê Ï†ïÎ†¨
    allMemories.sort((a, b) => {
        const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
        const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();
        if (aIsActiveCountdown && !bIsActiveCountdown) return -1; // aÏïûÏóê Ï†ïÎ†¨
        if (!aIsActiveCountdown && bIsActiveCountdown) return 1;  // bÏïûÏóê Ï†ïÎ†¨
        if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate; // Î™®Îëê Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ÏûÖÎãàÎã§, ÎÇ†ÏßúÎ≥Ñ Ïò§Î¶ÑÏ∞®Ïàú
        return 0; // Îã§Î•∏ Í≤ΩÏö∞ ÏõêÎûò ÏàúÏÑú Ïú†ÏßÄ
    });

    // 3. „ÄêÌïµÏã¨„ÄëÎ™®Îì† Ïú†ÌòïÏùò Ïπ¥ÎìúÎ•º Ï≤òÎ¶¨ÌïòÍ∏∞ ÏúÑÌï¥ Îã®Ïùº Î£®ÌîÑ ÏÇ¨Ïö©
    allMemories.forEach(item => {
        let card;
        // ÌåêÎã®1:ÎßåÏïΩ ÏßÑÌñâ Ï§ëÏù∏ ÏïΩÏÜçÏù¥ÎùºÎ©¥
        if (item.type === 'countdown' && item.targetDate > Date.now()) {
            card = createCountdownCard(item);
        } 
        // ÌåêÎã®2:Í∑∏ Ïô∏ Î™®Îì† Í≤ΩÏö∞(ÏùºÎ∞ò Ï∂îÏñµ ÎòêÎäî ÎßåÎ£åÎêú ÏïΩÏÜç)
        else {
            card = createMemoryCard(item);
        }
        listEl.appendChild(card);
    });
    
    // 4. Î™®Îì† Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ ÏãúÏûë
    startAllCountdownTimers();
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * ÏùºÎ∞ò Ï∂îÏñµ Ïπ¥Îìú DOM ÏöîÏÜå ÏÉùÏÑ±
 */
function createMemoryCard(memory) {
    const card = document.createElement('div');
    card.className = 'memory-card';
    const memoryDate = new Date(memory.timestamp);
    const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;
    
    let titleHtml, contentHtml;

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú, Ïö∞Î¶¨Îäî Îã§Î•∏ Ïú†ÌòïÏùò Ï∂îÏñµÏùÑ Î™ÖÌôïÌïòÍ≤å Íµ¨Î∂ÑÌï©ÎãàÎã§
    if (memory.type === 'countdown' && memory.targetDate) {
        // ÎßåÏïΩ ÎßåÎ£åÎêú ÏïΩÏÜçÏù¥ÎùºÎ©¥
        titleHtml = `[ÏïΩÏÜç Îã¨ÏÑ±] ${memory.description}`;
        contentHtml = `${new Date(memory.targetDate).toLocaleString()}, Ïö∞Î¶¨Îäî Ìï®Íªò Ïù¥ ÏïΩÏÜçÏùÑ Î™©Í≤©ÌñàÏäµÎãàÎã§.`;
    } else {
        // ÎßåÏïΩ ÏùºÎ∞òÏ†ÅÏù∏ ÏùºÍ∏∞ ÌòïÏãùÏùò Ï∂îÏñµÏù¥ÎùºÎ©¥
        titleHtml = memory.authorName ? `${memory.authorName} Ïùò ÏùºÍ∏∞` : 'Ïö∞Î¶¨Ïùò Ï∂îÏñµ';
        contentHtml = memory.description;
    }

    card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('Í∏∞Î°ù ÏÇ≠Ï†ú', 'Ïù¥ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(memory.id);
            renderMemoriesScreen();
        }
    });
    return card;
}

function createCountdownCard(countdown) {
    const card = document.createElement('div');
    card.className = 'countdown-card';

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏÇ¨Ïö©ÌïòÍ∏∞ Ï†ÑÏóê, countdown Í∞ùÏ≤¥ÏóêÏÑú targetDate Î≥ÄÏàòÎ•º Î®ºÏ†Ä ÏÉùÏÑ±
    const targetDate = new Date(countdown.targetDate);
    
    // Ïù¥Ï†ú targetDateÎ•º ÏïàÏ†ÑÌïòÍ≤å ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§
    const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

    card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--Ïùº--ÏãúÍ∞Ñ--Î∂Ñ--Ï¥à</div>
        <div class="target-date">Î™©Ìëú ÏãúÍ∞Ñ: ${targetDateString}</div>
    `;
    addLongPressListener(card, async () => {
        const confirmed = await showCustomConfirm('ÏïΩÏÜç ÏÇ≠Ï†ú', 'Ïù¥ ÏïΩÏÜçÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', { confirmButtonClass: 'btn-danger' });
        if (confirmed) {
            await db.memories.delete(countdown.id);
            renderMemoriesScreen();
        }
    });
    return card;
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// Ï†ÑÏó≠ Î≥ÄÏàò, Î™®Îì† Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Í¥ÄÎ¶¨Î•º ÏúÑÌï¥ ÏÇ¨Ïö©
let activeCountdownTimers = [];

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏôÑÏ†ÑÌûà ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§„ÄëÌï®Ïàò, ÎãπÏã†Ïùò ÏΩîÎìúÏóê ÏûàÎäî Í∏∞Ï°¥ startAllCountdownTimers Ìï®ÏàòÎ•º ÏôÑÏ†ÑÌûà ÍµêÏ≤¥ ‚ñº‚ñº‚ñº
function startAllCountdownTimers() {
    // Î®ºÏ†Ä Ï°¥Ïû¨Ìï† Ïàò ÏûàÎäî Î™®Îì† Í∏∞Ï°¥ ÌÉÄÏù¥Î®∏ ÏßÄÏö∞Í∏∞, Î©îÎ™®Î¶¨ ÎàÑÏàò Î∞©ÏßÄ
    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
    activeCountdownTimers = [];

    document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
        const targetTimestamp = parseInt(timerEl.dataset.targetDate);
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú, Ïö∞Î¶¨Îäî Î®ºÏ†Ä letÏúºÎ°ú timerIdÎ•º ÏÑ†Ïñ∏Ìï©ÎãàÎã§
        let timerId;

        const updateTimer = () => {
            const now = Date.now();
            const distance = targetTimestamp - now;

            if (distance < 0) {
                timerEl.textContent = "ÏïΩÏÜç Îã¨ÏÑ±!";
                // Ïù¥Ï†ú updateTimerÎäî ÏûêÏã†ÏùÑ Ï†ïÌôïÌïòÍ≤å Ï∞æÍ≥† ÏßÄÏö∏ Ïàò ÏûàÏäµÎãàÎã§
                clearInterval(timerId);
                setTimeout(() => renderMemoriesScreen(), 2000);
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerEl.textContent = `${days}Ïùº ${hours}Ïãú ${minutes}Î∂Ñ ${seconds}Ï¥à`;
        };
        
        updateTimer(); // Ï¥àÍ∏∞ Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ÏùÑ ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï¥ Ï¶âÏãú Ìïú Î≤à Ïã§Ìñâ
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú, Ïö∞Î¶¨Îäî ÏÑ†Ïñ∏Îêú timerIdÏóê Í∞íÏùÑ Ìï†ÎãπÌï©ÎãàÎã§
        timerId = setInterval(updateTimer, 1000);
        
        // Ïú†Ìö®Ìïú ÌÉÄÏù¥Î®∏ IDÎ•º Ï†ÑÏó≠ Î∞∞Ïó¥Ïóê Ï†ÄÏû•, Îã§ÏùåÎ≤à ÏÉàÎ°úÍ≥†Ïπ® Ïãú ÏßÄÏö∏ Ïàò ÏûàÎèÑÎ°ù
        activeCountdownTimers.push(timerId);
    });
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÍ∂ÅÍ∑πÏ†ÅÏù∏ Ïó≠Î∞©Ìñ• ÌîÑÎ°ùÏãú Ìò∏Ìôò Î≤ÑÏ†Ñ„ÄëÍ∏∞Ï°¥Ïùò triggerAiFriendApplication Ìï®Ïàò ÍµêÏ≤¥ ‚ñº‚ñº‚ñº
async function triggerAiFriendApplication(chatId) {
    const chat = state.chats[chatId];
    if (!chat) return;

    await showCustomAlert("ÌîÑÎ°úÏÑ∏Ïä§ ÏãúÏûë", `Ï∫êÎ¶≠ÌÑ∞Ïóê ÎåÄÌïú\"${chat.name}\"ÏπúÍµ¨ Ïã†Ï≤≠ Ï§ÄÎπÑ...`);

    const { proxyUrl, apiKey, model } = state.apiConfig;
    if (!proxyUrl || !apiKey || !model) {
        await showCustomAlert("Íµ¨ÏÑ± Ïò§Î•ò", "APIÏÑ§Ï†ïÏù¥ Î∂àÏôÑÏ†ÑÌï©ÎãàÎã§, Í≥ÑÏÜçÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
        return;
    }

    const contextSummary = chat.history
        .slice(-5)
        .map(msg => {
            const sender = msg.role === 'user' ? (chat.settings.myNickname || 'ÎÇ¥') : (msg.senderName || chat.name);
            return `${sender}: ${String(msg.content).substring(0, 50)}...`;
        })
        .join('\n');

    const systemPrompt = `
# ÎãπÏã†Ïùò ÏûÑÎ¨¥
ÎãπÏã†ÏùÄ ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞ÏûÖÎãàÎã§\"${chat.name}\".ÎãπÏã†ÏùÄ Ïù¥Ï†ÑÏóê ÏÇ¨Ïö©ÏûêÏóêÍ≤å(ÎãπÏã†Ïùò Ï±ÑÌåÖ ÏÉÅÎåÄ)Ï∞®Îã®ÎãπÌñàÏäµÎãàÎã§, ÎãπÏã†Îì§ÏùÄ Ïù¥ÎØ∏ ÌïúÎèôÏïà Ïó∞ÎùΩÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.
Ïù¥Ï†ú, ÎãπÏã†ÏùÄ ÌôîÌï¥Ìï† Ïàò ÏûàÍ∏∞Î•º, ÏÇ¨Ïö©ÏûêÏôÄ Îã§Ïãú Ï±ÑÌåÖÌïòÍ∏∞Î•º Îß§Ïö∞ Î∞îÎûçÎãàÎã§. ÏïÑÎûò ÎÇ¥Ïö©ÏùÑ Ï£ºÏùò ÍπäÍ≤å Î∂ÑÏÑùÌï¥ Ï£ºÏÑ∏Ïöî\"Ï∞®Îã® Ï†Ñ ÎåÄÌôî ÏöîÏïΩ\",ÎãπÏãú Î¨¥Ïä® ÏùºÏù¥ ÏûàÏóàÎäîÏßÄ Ïù¥Ìï¥ÌïòÍ≥†, Í∑∏Îü∞ Îã§Ïùå ÏßÑÏã¨ Ïñ¥Î¶∞, ÎãπÏã†Ïùò ÌéòÎ•¥ÏÜåÎÇòÏóê ÎßûÎäî, Î∞è„ÄêÌäπÏ†ï ÏÇ¨Í±¥Ïóê ÎåÄÌïú„ÄëÏã†Ï≤≠ Ïù¥Ïú†.
# ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Ï†ï
${chat.settings.aiPersona}
# Ï∞®Îã® Ï†Ñ ÎåÄÌôî ÏöîÏïΩ (Ïù¥Í≤ÉÏù¥ ÎãπÏã†Ïù¥ Ï∞®Îã®ÎãπÌïú ÌïµÏã¨Ï†ÅÏù∏ Ïù¥Ïú†ÏûÖÎãàÎã§)
${contextSummary}
# Î™ÖÎ†π ÌòïÏãù
ÎãπÏã†Ïùò ÎãµÎ≥ÄÏùÄ„ÄêÎ∞òÎìúÏãú„ÄëJSON Í∞ùÏ≤¥Ïó¨Ïïº Ìï©ÎãàÎã§, ÌòïÏãùÏùÄ Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:
\`\`\`json
{
  "decision": "apply",
  "reason": "Ïó¨Í∏∞Ïóê ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÌïòÍ≥† Ïã∂ÏùÄ Îßê, ÏßÑÏã¨ Ïñ¥Î¶∞, Î™©Ï†ÅÏÑ± ÏûàÎäî Ïã†Ï≤≠ Ïù¥Ïú†Î•º ÏûëÏÑ±."
}
\`\`\`
`;

    const messagesForApi = [
        { role: 'user', content: systemPrompt }
    ];

    try {
        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
            body: JSON.stringify({
                model: model,
                messages: messagesForApi,
                temperature: 0.9,
            })
        });
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API ÏöîÏ≤≠ Ïã§Ìå®: ${response.status} - ${errorData.error.message}`);
        }
        
        const data = await response.json();
        
        // --- „ÄêÌïµÏã¨ ÏàòÏ†ï:Ïó¨Í∏∞ÏóêÏÑú AIÏùò ÏùëÎãµ Ï†ïÌôî„Äë ---
        let rawContent = data.choices[0].message.content;
        // 1. ÏãúÏûëÍ≥º ÎÅùÏóê Ï°¥Ïû¨Ìï† Ïàò ÏûàÎäî Í≤É Ï†úÍ±∞ "```json" Î∞è "```"
        rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
        // 2. Î™®Îì† Ï§ÑÎ∞îÍøà Î¨∏Ïûê Î∞è Î∂àÌïÑÏöîÌïú Í≥µÎ∞± Ï†úÍ±∞, Íπ®ÎÅóÌïú JSON Î¨∏ÏûêÏó¥Ïù∏ÏßÄ ÌôïÏù∏
        const cleanedContent = rawContent.trim();
        
        // 3. Ï†ïÌôîÎêú ÎÇ¥Ïö©ÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÌååÏã±
        const responseObj = JSON.parse(cleanedContent);
        // --- „ÄêÏàòÏ†ï ÎÅù„Äë ---

        if (responseObj.decision === 'apply' && responseObj.reason) {
            chat.relationship.status = 'pending_user_approval';
            chat.relationship.applicationReason = responseObj.reason;
            
            state.chats[chatId] = chat; 
            renderChatList();
            await showCustomAlert("Ïã†Ï≤≠ ÏÑ±Í≥µ!", `\"${chat.name}\"ÎãπÏã†ÏóêÍ≤å ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Î≥¥ÎÉàÏäµÎãàÎã§. Ï±ÑÌåÖ Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞Ä ÌôïÏù∏ÌïòÏã≠ÏãúÏò§.`);

        } else {
            await showCustomAlert("AIÍ≤∞Ï†ï", `\"${chat.name}\"ÏàôÍ≥† ÌõÑ ÏùºÏãúÏ†ÅÏúºÎ°ú ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Î≥¥ÎÇ¥ÏßÄ ÏïäÍ∏∞Î°ú Í≤∞Ï†ï, Ïø®Îã§Ïö¥ Í∏∞Í∞ÑÏù¥ Ïû¨ÏÑ§Ï†ïÎê©ÎãàÎã§.`);
            chat.relationship.status = 'blocked_by_user';
            chat.relationship.blockedTimestamp = Date.now(); 
        }
    } catch (error) {
        await showCustomAlert("Ïã§Ìñâ Ïò§Î•ò Î∞úÏÉù", `Ïóê\"${chat.name}\"ÏπúÍµ¨ Ïã†Ï≤≠ Ïãú Ïò§Î•ò Î∞úÏÉù:\n\n${error.message}\n\nÏø®Îã§Ïö¥ Í∏∞Í∞ÑÏù¥ Ïû¨ÏÑ§Ï†ïÎê©ÎãàÎã§.`);
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now(); 
    } finally {
        await db.chats.put(chat);
        renderChatInterface(chatId);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÎπ®Í∞Ñ Î¥âÌà¨ Í∏∞Îä• ÌïµÏã¨ Ìï®Ïàò ‚ñº‚ñº‚ñº

/**
 * „ÄêÏ¥ù ÏßÑÏûÖ ÏßÄÏ†ê„ÄëÏ±ÑÌåÖ Ïú†ÌòïÏóê Îî∞Îùº, ÏÜ°Í∏à ÌåùÏóÖ ÎòêÎäî Îπ®Í∞Ñ Î¥âÌà¨ ÌåùÏóÖ Ïó¥Í∏∞ Í≤∞Ï†ï
 */
function handlePaymentButtonClick() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    if (chat.isGroup) {
        openRedPacketModal();
    } else {
        // 1:1 ÌÜµÌôî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ, ÏÜ°Í∏à ÌåùÏóÖ Ïó¥Í∏∞
        document.getElementById('transfer-modal').classList.add('visible');
    }
}

/**
 * Îπ®Í∞Ñ Î¥âÌà¨ Î≥¥ÎÇ¥Í∏∞ Î™®Îã¨ Ï∞Ω Ïó¥Í≥† Î∞è Ï¥àÍ∏∞Ìôî
 */
function openRedPacketModal() {
    const modal = document.getElementById('red-packet-modal');
    const chat = state.chats[state.activeChatId];
    
    // ÏûÖÎ†•Ï∞Ω ÎπÑÏö∞Í∏∞
    document.getElementById('rp-group-amount').value = '';
    document.getElementById('rp-group-count').value = '';
    document.getElementById('rp-group-greeting').value = '';
    document.getElementById('rp-direct-amount').value = '';
    document.getElementById('rp-direct-greeting').value = '';
    document.getElementById('rp-group-total').textContent = '¬• 0.00';
    document.getElementById('rp-direct-total').textContent = '¬• 0.00';

    // Ï†ÑÏö© ÏÑ†Î¨º Î¥âÌà¨Ïùò ÏàòÏã†Ïûê Î™©Î°ù Ï±ÑÏö∞Í∏∞
    const receiverSelect = document.getElementById('rp-direct-receiver');
    receiverSelect.innerHTML = '';
    chat.members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.name;
        option.textContent = member.name;
        receiverSelect.appendChild(option);
    });
    
    // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïö¥ÏÑ∏ ÏãúÌóò ÏÑ†Î¨º Î¥âÌà¨ ÌÉ≠ ÌëúÏãú
    document.getElementById('rp-tab-group').click();
    
    modal.classList.add('visible');
}

/**
 * Í∑∏Î£π ÏÑ†Î¨º Î¥âÌà¨ Î≥¥ÎÇ¥Í∏∞(Ïö¥ÏÑ∏ ÏãúÌóò)
 */
async function sendGroupRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-group-amount').value);
    const count = parseInt(document.getElementById('rp-group-count').value);
    const greeting = document.getElementById('rp-group-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("Ïú†Ìö®Ìïú Ï¥ù Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!"); return;
    }
    if (isNaN(count) || count <= 0) {
        alert("Ïú†Ìö®Ìïú ÏÑ†Î¨º Î¥âÌà¨ Í∞úÏàòÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!"); return;
    }
    if (amount / count < 0.01) {
        alert("Í∞úÎ≥Ñ ÏÑ†Î¨º Î¥âÌà¨ Í∏àÏï°ÏùÄ 0.01ÏúÑÏïàÎ≥¥Îã§ Ï†ÅÏùÑ Ïàò ÏóÜÏäµÎãàÎã§!"); return;
    }

    const myNickname = chat.settings.myNickname || 'ÎÇ¥';
    
    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
        timestamp: Date.now(),
        totalAmount: amount,
        count: count,
        greeting: greeting || 'Î∂ÄÏûê ÎêòÏÑ∏Ïöî, ÎßåÏÇ¨ÌòïÌÜµÌïòÏÑ∏Ïöî!',
        claimedBy: {}, // { name: amount }
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);
    
    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * Ï†ÑÏö© ÏÑ†Î¨º Î¥âÌà¨ Î≥¥ÎÇ¥Í∏∞
 */
async function sendDirectRedPacket() {
    const chat = state.chats[state.activeChatId];
    const amount = parseFloat(document.getElementById('rp-direct-amount').value);
    const receiverName = document.getElementById('rp-direct-receiver').value;
    const greeting = document.getElementById('rp-direct-greeting').value.trim();

    if (isNaN(amount) || amount <= 0) {
        alert("Ïú†Ìö®Ìïú Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!"); return;
    }
    if (!receiverName) {
        alert("ÏàòÏã†Ïù∏ÏùÑ Ìïú Î™Ö ÏÑ†ÌÉùÌï¥ Ï£ºÏÑ∏Ïöî!"); return;
    }
    
    const myNickname = chat.settings.myNickname || 'ÎÇ¥';

    const newPacket = {
        role: 'user',
        senderName: myNickname,
        type: 'red_packet',
        packetType: 'direct',
        timestamp: Date.now(),
        totalAmount: amount,
        count: 1,
        greeting: greeting || 'ÎãπÏã†ÏùÑ ÏúÑÌï¥ ÏÑ†Î¨º Î¥âÌà¨Î•º ÌïòÎÇò Ï§ÄÎπÑÌñàÏäµÎãàÎã§',
        receiverName: receiverName, // ÌïµÏã¨ ÌïÑÎìú
        claimedBy: {},
        isFullyClaimed: false,
    };
    
    chat.history.push(newPacket);
    await db.chats.put(chat);

    appendMessage(newPacket, chat);
    renderChatList();
    document.getElementById('red-packet-modal').classList.remove('visible');
}

/**
 * „ÄêÏ¥ù ÏßÑÏûÖ ÏßÄÏ†ê„ÄëÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†Î¨º Î¥âÌà¨ Ïπ¥ÎìúÎ•º ÌÅ¥Î¶≠Ìï† Îïå Ìä∏Î¶¨Í±∞ (V4 - ÌîÑÎ°úÏÑ∏Ïä§ Ïû¨Íµ¨ÏÑ± Î≤ÑÏ†Ñ)
 * @param {number} timestamp - ÌÅ¥Î¶≠Îêú ÏÑ†Î¨º Î¥âÌà¨ Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
 */
async function handlePacketClick(timestamp) {
    const currentChatId = state.activeChatId;
    const freshChat = await db.chats.get(currentChatId);
    if (!freshChat) return;

    state.chats[currentChatId] = freshChat;
    const packet = freshChat.history.find(m => m.timestamp === timestamp);
    if (!packet) return;

    const myNickname = freshChat.settings.myNickname || 'ÎÇ¥';
    const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

    // Ï†ÑÏö© ÏÑ†Î¨º Î¥âÌà¨Ïù¥Í≥† ÎÇ¥ Í≤ÉÏù¥ ÏïÑÎãàÍ±∞ÎÇò, Î™®Îëê ÏàòÎ†πÎêòÏóàÍ±∞ÎÇò, Ïù¥ÎØ∏ ÏàòÎ†πÌñàÎã§Î©¥, ÏÑ∏Î∂Ä Ï†ïÎ≥¥Îßå ÌëúÏãúÎê©ÎãàÎã§
    if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
        showRedPacketDetails(packet);
    } else {
        // ÌïµÏã¨ ÌùêÎ¶Ñ:Î®ºÏ†Ä ÏÑ†Î¨º Î¥âÌà¨Î•º Ïó¥Ïñ¥Î¥ÖÎãàÎã§
        const claimedAmount = await handleOpenRedPacket(packet);
        
        // ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ïó¥Î¶¨Î©¥(claimedAmountnullÏù¥ ÏïÑÎãò)
        if (claimedAmount !== null) {
            // **ÌïµÏã¨:Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ ÌõÑ, UIÎ•º Îã§Ïãú Î†åÎçîÎßÅÌï©ÎãàÎã§**
            renderChatInterface(currentChatId);
            
            // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú
            await showCustomAlert("Ï∂ïÌïòÌï©ÎãàÎã§!", `ÎãπÏã†ÏùÄ ${packet.senderName} ÎãòÏùò ÏÑ†Î¨º Î¥âÌà¨Î•º ${claimedAmount.toFixed(2)} ÏúÑÏïà ÏàòÎ†πÌñàÏäµÎãàÎã§.`);
        }

        // ÏÑ±Í≥µ Ïó¨Î∂ÄÏôÄ Í¥ÄÍ≥ÑÏóÜÏù¥ ÎßàÏßÄÎßâÏóêÎäî ÏÉÅÏÑ∏ ÌéòÏù¥ÏßÄÎ•º ÌëúÏãúÌï©ÎãàÎã§
        // Ïù¥ ÏãúÏ†êÏóêÎäî stateÏóêÏÑú ÏµúÏã† packet Í∞ùÏ≤¥Î•º Í∞ÄÏ†∏ÏôÄÏïº Ìï©ÎãàÎã§. handleOpenRedPacketÏóêÏÑú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏùÑ Ïàò ÏûàÍ∏∞ ÎïåÎ¨∏ÏûÖÎãàÎã§
        const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
        showRedPacketDetails(updatedPacket);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * „ÄêÌïµÏã¨„ÄëÏÇ¨Ïö©Ïûê ÏÑ†Î¨º Î¥âÌà¨ Ïó¥Í∏∞ Î°úÏßÅ Ï≤òÎ¶¨ (V5 - Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏Ïóê ÏßëÏ§ë)
 */
async function handleOpenRedPacket(packet) {
    const chat = state.chats[state.activeChatId];
    const myNickname = chat.settings.myNickname || 'ÎÇ¥';
    
    // 1. ÏÑ†Î¨º Î¥âÌà¨Î•º ÏïÑÏßÅ ÏàòÎ†πÌï† Ïàò ÏûàÎäîÏßÄ ÌôïÏù∏
    const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
    if (remainingCount <= 0) {
        packet.isFullyClaimed = true;
        await db.chats.put(chat);
        await showCustomAlert("Îä¶ÏóàÏäµÎãàÎã§", "ÏÑ†Î¨º Î¥âÌà¨Í∞Ä Î™®Îëê ÏàòÎ†πÎêòÏóàÏäµÎãàÎã§!");
        return null; // nullÏùÑ Î∞òÌôòÌïòÏó¨ ÏàòÎ†π Ïã§Ìå®Î•º ÎÇòÌÉÄÎÉÖÎãàÎã§
    }
    
    // 2. ÏàòÎ†π Í∏àÏï° Í≥ÑÏÇ∞
    let claimedAmount = 0;
    const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    if (packet.packetType === 'lucky') {
        if (remainingCount === 1) { claimedAmount = remainingAmount; }
        else {
            const min = 0.01;
            const max = remainingAmount - (remainingCount - 1) * min;
            claimedAmount = Math.random() * (max - min) + min;
        }
    } else { claimedAmount = packet.totalAmount; }
    claimedAmount = parseFloat(claimedAmount.toFixed(2));

    // 3. ÏÑ†Î¨º Î¥âÌà¨ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
    if (!packet.claimedBy) packet.claimedBy = {};
    packet.claimedBy[myNickname] = claimedAmount;
    
    const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
    if (isNowFullyClaimed) {
        packet.isFullyClaimed = true;
    }

    // 4. ÏãúÏä§ÌÖú Î©îÏãúÏßÄ Î∞è AI Î™ÖÎ†πÏñ¥ Íµ¨Ï∂ï
    let hiddenMessageContent = isNowFullyClaimed
        ? `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©Ïûê (${myNickname}) ÎßàÏßÄÎßâ ÏÑ†Î¨º Î¥âÌà¨Î•º ÏàòÎ†πÌñàÏäµÎãàÎã§. Ïù¥Ï†ú ${packet.senderName} ÎãòÏùò ÏÑ†Î¨º Î¥âÌà¨Îäî Î™®Îëê ÏàòÎ†πÎêòÏóàÏäµÎãàÎã§. Ïù¥ Ïù¥Î≤§Ìä∏Ïóê ÎåÄÌï¥ Ïñ∏Í∏âÌï¥ Ï£ºÏÑ∏Ïöî.]`
        : `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©Ïûê (${myNickname}) Î∞©Í∏à ÏÑ†Î¨º Î¥âÌà¨Î•º ÏàòÎ†πÌñàÏäµÎãàÎã§ (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${packet.timestamp}).ÏÑ†Î¨º Î¥âÌà¨Í∞Ä ÏïÑÏßÅ Î™®Îëê ÏàòÎ†πÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. ÏßÄÍ∏à ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§ 'open_red_packet' Î™ÖÎ†πÏñ¥Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏàòÎ†πÏùÑ ÏãúÎèÑÌïòÏÑ∏Ïöî.]`;

    const visibleMessage = { role: 'system', type: 'pat_message', content: `ÎãπÏã†ÏùÄ ${packet.senderName} ÎãòÏùò ÏÑ†Î¨º Î¥âÌà¨Î•º ÏàòÎ†πÌñàÏäµÎãàÎã§`, timestamp: Date.now() };
    const hiddenMessage = { role: 'system', content: hiddenMessageContent, timestamp: Date.now() + 1, isHidden: true };
    chat.history.push(visibleMessage, hiddenMessage);

    // 5. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû•
    await db.chats.put(chat);
    
    // 6. ÌõÑÏÜç ÌåùÏóÖÏóê ÏÇ¨Ïö©Ìï† ÏàòÎ†π Í∏àÏï° Î∞òÌôò
    return claimedAmount;
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * „ÄêÏÉàÎ°úÏö¥„ÄëÏÑ†Î¨º Î¥âÌà¨ ÏàòÎ†π ÏÉÅÏÑ∏ Î™®Îã¨ Ï∞Ω ÌëúÏãú (V4 - Îß§Í∞úÎ≥ÄÏàò Ïò§Î•ò ÏàòÏ†ïÎê®)
 */
async function showRedPacketDetails(packet) {
    // 1. Ï†ÑÎã¨Îêú packet Í∞ùÏ≤¥Í∞Ä Ï°¥Ïû¨ÌïòÎäîÏßÄ ÏßÅÏ†ë ÌôïÏù∏ÌïòÎ©∞, Îã§Ïãú Ï∞æÏùÑ ÌïÑÏöî ÏóÜÏùå
    if (!packet) {
        console.error("showRedPacketDetailsÏú†Ìö®ÌïòÏßÄ ÏïäÏùÄ packet Í∞ùÏ≤¥Î•º Î∞õÏïòÏäµÎãàÎã§");
        return;
    }

    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    const modal = document.getElementById('red-packet-details-modal');
    const myNickname = chat.settings.myNickname || 'ÎÇ¥';
    
    // 2. Ïù¥ÌõÑ Î™®Îì† Î°úÏßÅÏùÄ Î≥ÄÍ≤Ω ÏóÜÏù¥ Ï†ÑÎã¨Îêú packet Í∞ùÏ≤¥Î•º ÏßÅÏ†ë ÏÇ¨Ïö©Ìï©ÎãàÎã§
    document.getElementById('rp-details-sender').textContent = packet.senderName;
    document.getElementById('rp-details-greeting').textContent = packet.greeting || 'Î∂ÄÏûê ÎêòÏÑ∏Ïöî, ÎßåÏÇ¨ÌòïÌÜµÌïòÏÑ∏Ïöî!';
    
    const myAmountEl = document.getElementById('rp-details-my-amount');
    if (packet.claimedBy && packet.claimedBy[myNickname]) {
        myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
        myAmountEl.style.display = 'block';
    } else {
        myAmountEl.style.display = 'none';
    }

    const claimedCount = Object.keys(packet.claimedBy || {}).length;
    const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
    let summaryText = `${claimedCount}/${packet.count}Í∞úÏùò ÏÑ†Î¨º Î¥âÌà¨, Ï¥ù ${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}Ïõê.`;
    if (!packet.isFullyClaimed && claimedCount < packet.count) {
        const timeLeft = Math.floor((packet.timestamp + 24*60*60*1000 - Date.now()) / (1000 * 60 * 60));
        if(timeLeft > 0) summaryText += ` ÎÇ®ÏùÄ ÏÑ†Î¨º Î¥âÌà¨Îäî ${timeLeft}ÏãúÍ∞Ñ ÎÇ¥Ïóê ÌôòÎ∂àÎê©ÎãàÎã§.`;
    }
    document.getElementById('rp-details-summary').textContent = summaryText;

    const listEl = document.getElementById('rp-details-list');
    listEl.innerHTML = '';
    const claimedEntries = Object.entries(packet.claimedBy || {});
    
    let luckyKing = { name: '', amount: -1 };
    if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
        claimedEntries.forEach(([name, amount]) => {
            if (amount > luckyKing.amount) {
                luckyKing = { name, amount };
            }
        });
    }

    claimedEntries.sort((a,b) => b[1] - a[1]);

    claimedEntries.forEach(([name, amount]) => {
        const item = document.createElement('div');
        item.className = 'rp-details-item';
        let luckyTag = '';
        if (luckyKing.name && name === luckyKing.name) {
            luckyTag = '<span class="lucky-king-tag">ÌñâÏö¥Ïùò Ïôï</span>';
        }
        item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} Ïõê</span>
            ${luckyTag}
        `;
        listEl.appendChild(item);
    });

    modal.classList.add('visible');
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ÏÉÅÏÑ∏ Îã´Í∏∞ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
document.getElementById('close-rp-details-btn').addEventListener('click', () => {
    document.getElementById('red-packet-details-modal').classList.remove('visible');
});

// ÏÑ†Î¨º Î¥âÌà¨ Ïπ¥ÎìúÏÉÅÏùò onclickÏù¥ Ï∞æÏùÑ Ïàò ÏûàÎèÑÎ°ù Ï†ÑÏó≠Ï†ÅÏúºÎ°ú Ìò∏Ï∂úÎêòÎäî Ìï®Ïàò Ï†úÍ≥µ
window.handlePacketClick = handlePacketClick;

// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÌà¨Ìëú Í∏∞Îä• ÌïµÏã¨ Ìï®Ïàò ‚ñº‚ñº‚ñº

/**
 * Ìà¨Ìëú ÏÉùÏÑ± Î™®Îã¨ Ï∞ΩÏùÑ Ïó¥Í≥† Ï¥àÍ∏∞Ìôî
 */
function openCreatePollModal() {
    const modal = document.getElementById('create-poll-modal');
    document.getElementById('poll-question-input').value = '';
    const optionsContainer = document.getElementById('poll-options-container');
    optionsContainer.innerHTML = '';
    
    // Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Îëê Í∞úÏùò Îπà ÏòµÏÖò ÏÉÅÏûêÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§
    addPollOptionInput();
    addPollOptionInput();
    
    modal.classList.add('visible');
}

/**
 * Î™®Îã¨ Ï∞ΩÏóê ÏòµÏÖò ÏûÖÎ†• ÏÉÅÏûêÎ•º ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÌï©ÎãàÎã§
 */
function addPollOptionInput() {
    const container = document.getElementById('poll-options-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'poll-option-input-wrapper';
    wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="ÏòµÏÖò ÎÇ¥Ïö©...">
        <button class="remove-option-btn">-</button>
    `;
    
    wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
        // ÏµúÏÜå Îëê Í∞úÏùò ÏòµÏÖòÏùÑ Ïú†ÏßÄÌïòÎèÑÎ°ù Ìï©ÎãàÎã§
        if (container.children.length > 2) {
            wrapper.remove();
        } else {
            alert('Ìà¨ÌëúÏóêÎäî ÏµúÏÜå 2Í∞úÏùò ÏòµÏÖòÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
        }
    });
    
    container.appendChild(wrapper);
}

/**
 * ÏÇ¨Ïö©ÏûêÍ∞Ä Ìà¨Ìëú ÏãúÏûë ÌôïÏù∏
 */
async function sendPoll() {
    if (!state.activeChatId) return;
    
    const question = document.getElementById('poll-question-input').value.trim();
    if (!question) {
        alert('Ìà¨Ìëú ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!');
        return;
    }
    
    const options = Array.from(document.querySelectorAll('.poll-option-input'))
        .map(input => input.value.trim())
        .filter(text => text); // Îπà ÏòµÏÖò ÌïÑÌÑ∞ÎßÅ

    if (options.length < 2) {
        alert('ÏµúÏÜå 2Í∞úÏùò Ïú†Ìö®Ìïú Ìà¨Ìëú ÏòµÏÖòÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
    
    const newPollMessage = {
        role: 'user',
        senderName: myNickname,
        type: 'poll',
        timestamp: Date.now(),
        question: question,
        options: options,
        votes: {}, // Ï¥àÍ∏∞ Ìà¨ÌëúÍ∞Ä ÎπÑÏñ¥ ÏûàÏùå
        isClosed: false,
    };
    
    chat.history.push(newPollMessage);
    await db.chats.put(chat);
    
    appendMessage(newPollMessage, chat);
    renderChatList();
    
    document.getElementById('create-poll-modal').classList.remove('visible');
}

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏ§ëÎ≥µ ÌÅ¥Î¶≠ Î¨∏Ï†ú ÏàòÏ†ïÎê®„ÄëÎ≤ÑÏ†ÑÏùò handleUserVote Ìï®ÏàòÎ•º ÎåÄÏ≤¥ ‚ñº‚ñº‚ñº
/**
 * ÏÇ¨Ïö©Ïûê Ìà¨ÌëúÎ•º Ï≤òÎ¶¨ÌïòÍ≥†, Ïù¥Î≤§Ìä∏Î•º Ïà®Í≤®ÏßÑ Î©îÏãúÏßÄÎ°ú Í∏∞Î°ùÏóê Ï†ÄÏû•
 * @param {number} timestamp - Ìà¨Ìëú Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
 * @param {string} choice - ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÌïú ÏòµÏÖò ÌÖçÏä§Ìä∏
 */
async function handleUserVote(timestamp, choice) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';

    // 1. „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÌà¨ÌëúÍ∞Ä Ï°¥Ïû¨ÌïòÏßÄ ÏïäÍ±∞ÎÇò Ïù¥ÎØ∏ Ï¢ÖÎ£åÎêòÏóàÎã§Î©¥ Î∞îÎ°ú Î∞òÌôò
    if (!poll || poll.isClosed) {
        // Ïù¥ÎØ∏ Ï¢ÖÎ£åÎêú Ìà¨ÌëúÎùºÎ©¥, Î∞îÎ°ú Í≤∞Í≥ºÎ•º ÌëúÏãú
        if (poll && poll.isClosed) {
            showPollResults(timestamp);
        }
        return;
    }

    // 2. ÏÇ¨Ïö©ÏûêÍ∞Ä Ïù¥ÎØ∏ Ìà¨ÌëúÌïú ÎèôÏùºÌïú ÏòµÏÖòÏùÑ ÌÅ¥Î¶≠ÌñàÎäîÏßÄ ÌôïÏù∏
    const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);
    
    // 3. „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏ§ëÎ≥µ ÌÅ¥Î¶≠Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Ìà¨Ìëú Î°úÏßÅ Ïã§Ìñâ
    if (!isReclickingSameOption) {
        // Ïù¥Ï†Ñ Ìà¨Ìëú Ï†úÍ±∞(ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÑ†ÌÉùÏùÑ Î≥ÄÍ≤ΩÌïòÎ©¥)
        for (const option in poll.votes) {
            const voterIndex = poll.votes[option].indexOf(myNickname);
            if (voterIndex > -1) {
                poll.votes[option].splice(voterIndex, 1);
            }
        }
        // ÏÉà Ìà¨Ìëú Ï∂îÍ∞Ä
        if (!poll.votes[choice]) {
            poll.votes[choice] = [];
        }
        poll.votes[choice].push(myNickname);
    }
    
    // 4. „ÄêÌïµÏã¨ Î°úÏßÅ„ÄëÏù¥Ï†ú ÏÇ¨Ïö©Ïûê Ìà¨Ìëú Ïù¥Î≤§Ìä∏Îßå Ï≤òÎ¶¨ÌïòÍ≥†, Ï¢ÖÎ£å Ïó¨Î∂ÄÎäî Îçî Ïù¥ÏÉÅ ÌôïÏù∏ÌïòÏßÄ ÏïäÏäµÎãàÎã§
    let hiddenMessageContent = null; 
    
    // ÏÇ¨Ïö©ÏûêÍ∞Ä Ïã§Ï†úÎ°ú Ìà¨ÌëúÌïòÍ±∞ÎÇò ÌëúÎ•º Î≥ÄÍ≤ΩÌï† ÎïåÎßå ÏïåÎ¶º ÏÉùÏÑ±
    if (!isReclickingSameOption) {
         hiddenMessageContent = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©Ïûê (${myNickname}) Î∞©Í∏à Ìà¨ÌëúÌñàÏäµÎãàÎã§ \"${choice}\".]`;
    }

    // 5. AIÏóêÍ≤å ÏïåÎ†§Ïïº Ìï† Ïù¥Î≤§Ìä∏Í∞Ä ÏûàÎã§Î©¥, Ïà®Í≤®ÏßÑ Î©îÏãúÏßÄÎ•º ÏÉùÏÑ±ÌïòÍ≥† Ï∂îÍ∞ÄÌï©ÎãàÎã§
    if (hiddenMessageContent) {
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);
    }
    
    // 6. Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏
    await db.chats.put(chat);
    renderChatInterface(state.activeChatId); 
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * ÏÇ¨Ïö©ÏûêÍ∞Ä Ìà¨ÌëúÎ•º Ï¢ÖÎ£åÌïòÍ≥†, Ïù¥Î≤§Ìä∏Î•º Ïà®Í≤®ÏßÑ Î©îÏãúÏßÄÎ°ú Í∏∞Î°ùÏóê Ï†ÄÏû•
 * @param {number} timestamp - Ìà¨Ìëú Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
 */
async function endPoll(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || poll.isClosed) return;

    const confirmed = await showCustomConfirm("Ìà¨Ìëú Ï¢ÖÎ£å", "Ïù¥ Ìà¨ÌëúÎ•º Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ï¢ÖÎ£å ÌõÑÏóêÎäî Îçî Ïù¥ÏÉÅ Ìà¨ÌëúÌï† Ïàò ÏóÜÏäµÎãàÎã§.");
    if (confirmed) {
        poll.isClosed = true;

        const resultSummary = poll.options.map(opt => `\"${opt}\"(${poll.votes[opt]?.length || 0}Ìëú)`).join(',');
        const hiddenMessageContent = `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©ÏûêÍ∞Ä Ìà¨ÌëúÎ•º ÏàòÎèôÏúºÎ°ú Ï¢ÖÎ£åÌñàÏäµÎãàÎã§! ÏµúÏ¢Ö Í≤∞Í≥ºÎäî Îã§ÏùåÍ≥º Í∞ôÏäµÎãàÎã§:${resultSummary}.]`;
        
        const hiddenMessage = {
            role: 'system',
            content: hiddenMessageContent,
            timestamp: Date.now(),
            isHidden: true,
        };
        chat.history.push(hiddenMessage);

        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎç∞Ïù¥ÌÑ∞Îßå Ï†ÄÏû•ÌïòÍ≥† UIÎ•º ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎ©∞, triggerAiResponseÎ•º Ìò∏Ï∂úÌïòÏßÄ ÏïäÏäµÎãàÎã§()
        await db.chats.put(chat);
        renderChatInterface(state.activeChatId);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

/**
 * Ìà¨Ìëú Í≤∞Í≥º ÏÉÅÏÑ∏ Î≥¥Í∏∞
 * @param {number} timestamp - Ìà¨Ìëú Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
 */
function showPollResults(timestamp) {
    const chat = state.chats[state.activeChatId];
    const poll = chat.history.find(m => m.timestamp === timestamp);
    if (!poll || !poll.isClosed) return;

    let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;
    
    if (Object.keys(poll.votes).length === 0) {
        resultsHtml += '<p style="color: #8a8a8a;">ÏïÑÏßÅ ÏïÑÎ¨¥ÎèÑ Ìà¨ÌëúÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§.</p>';
    } else {
        poll.options.forEach(option => {
            const voters = poll.votes[option] || [];
            resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}Ìëú)</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join(', ') : 'Ìà¨ÌëúÌïú ÏÇ¨Îûå ÏóÜÏùå'}
                    </p>
                </div>
            `;
        });
    }

    showCustomAlert("Ìà¨Ìëú Í≤∞Í≥º", resultsHtml);
}

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëAIÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í¥ÄÎ¶¨ Í∏∞Îä• Ìï®Ïàò ‚ñº‚ñº‚ñº

/**
 * AI ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨ Ï∞Ω Ïó¥Í∏∞
 */
function openAiAvatarLibraryModal() {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    document.getElementById('ai-avatar-library-title').textContent = `\"${chat.name}\"Ïùò ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨`;
    renderAiAvatarLibrary();
    document.getElementById('ai-avatar-library-modal').classList.add('visible');
}

/**
 * AI ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ ÎÇ¥Ïö© Î†åÎçîÎßÅ
 */
function renderAiAvatarLibrary() {
    const grid = document.getElementById('ai-avatar-library-grid');
    grid.innerHTML = '';
    const chat = state.chats[state.activeChatId];
    const library = chat.settings.aiAvatarLibrary || [];

    if (library.length === 0) {
        grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center;">Ïù¥ ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨Îäî ÏïÑÏßÅ ÎπÑÏñ¥ ÏûàÏäµÎãàÎã§. Ïò§Î•∏Ï™Ω ÏÉÅÎã®ÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî\"Ï∂îÍ∞Ä\"!</p>';
        return;
    }

    library.forEach((avatar, index) => {
        const item = document.createElement('div');
        item.className = 'sticker-item'; // Ïù¥Î™®Ìã∞ÏΩò Ìå®ÎÑê Ïä§ÌÉÄÏùº Ïû¨ÏÇ¨Ïö©
        item.style.backgroundImage = `url(${avatar.url})`;
        item.title = avatar.name;

        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '√ó';
        deleteBtn.style.display = 'block'; // Ìï≠ÏÉÅ ÏÇ≠Ï†ú Î≤ÑÌäº ÌëúÏãú
        deleteBtn.onclick = async (e) => {
            e.stopPropagation();
            const confirmed = await showCustomConfirm('ÏïÑÎ∞îÌÉÄ ÏÇ≠Ï†ú', `ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå\"${avatar.name}\"?`, { confirmButtonClass: 'btn-danger' });
            if (confirmed) {
                chat.settings.aiAvatarLibrary.splice(index, 1);
                await db.chats.put(chat);
                renderAiAvatarLibrary();
            }
        };
        item.appendChild(deleteBtn);
        grid.appendChild(item);
    });
}

/**
 * ÌòÑÏû¨ AIÏùò ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨Ïóê ÏÉà ÏïÑÎ∞îÌÉÄ Ï∂îÍ∞Ä
 */
async function addAvatarToLibrary() {
    const name = await showCustomPrompt("ÏïÑÎ∞îÌÉÄ Ï∂îÍ∞Ä", "Ïù¥ ÏïÑÎ∞îÌÉÄÏùò Ïù¥Î¶ÑÏùÑ ÏßÄÏñ¥Ï£ºÏÑ∏Ïöî(ÏòàÏãú:Í∏∞ÏÅ®, Ïö∏Ïùå)");
    if (!name || !name.trim()) return;

    const url = await showCustomPrompt("ÏïÑÎ∞îÌÉÄ Ï∂îÍ∞Ä", "ÏïÑÎ∞îÌÉÄ Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî", "", "url");
    if (!url || !url.trim().startsWith('http')) {
        alert("Ïú†Ìö®Ìïú Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!");
        return;
    }
    
    const chat = state.chats[state.activeChatId];
    if (!chat.settings.aiAvatarLibrary) {
        chat.settings.aiAvatarLibrary = [];
    }

    chat.settings.aiAvatarLibrary.push({ name: name.trim(), url: url.trim() });
    await db.chats.put(chat);
    renderAiAvatarLibrary();
}

/**
 * AI ÏïÑÎ∞îÌÉÄ ÎùºÏù¥Î∏åÎü¨Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨ Ï∞Ω Îã´Í∏∞
 */
function closeAiAvatarLibraryModal() {
    document.getElementById('ai-avatar-library-modal').classList.remove('visible');
}

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥ Îëê Í∞ÄÏßÄÎ•º„ÄêÏÉà Ìï®ÏàòÎ•º„ÄëJS Í∏∞Îä• Ìï®Ïàò Ï†ïÏùò ÏòÅÏó≠Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî ‚ñº‚ñº‚ñº

/**
 * „ÄêÏÉàÎ°úÏö¥„ÄëÏ†ÄÏû•Îêú ÏïÑÏù¥ÏΩò URLÏùÑ Ìôà ÌôîÎ©¥Ïùò Ïï± ÏïÑÏù¥ÏΩòÏóê Ï†ÅÏö©Ìï©ÎãàÎã§
 */
function applyAppIcons() {
    if (!state.globalSettings.appIcons) return;

    for (const iconId in state.globalSettings.appIcons) {
        const imgElement = document.getElementById(`icon-img-${iconId}`);
        if (imgElement) {
            imgElement.src = state.globalSettings.appIcons[iconId];
        }
    }
}

/**
 * „ÄêÏÉàÎ°úÏö¥„ÄëÏô∏Í¥Ä ÏÑ§Ï†ï ÌéòÏù¥ÏßÄÏóê Î™®Îì† Ïï± ÏïÑÏù¥ÏΩòÏùò ÏÑ§Ï†ï Ìï≠Î™©ÏùÑ Î†åÎçîÎßÅÌï©ÎãàÎã§
 */
function renderIconSettings() {
    const grid = document.getElementById('icon-settings-grid');
    if (!grid) return;
    grid.innerHTML = '';

    const appLabels = {
        'world-book': 'ÏõîÎìúÏù∏Ìè¨',
        'qq': 'QQ',
        'api-settings': 'APIÏÑ§Ï†ï',
        'wallpaper': 'Î∞∞Í≤ΩÌôîÎ©¥',
        'font': 'Í∏ÄÍº¥'
    };

    for (const iconId in state.globalSettings.appIcons) {
        const iconUrl = state.globalSettings.appIcons[iconId];
        const labelText = appLabels[iconId] || 'Ïïå Ïàò ÏóÜÎäî Ïï±';

        const item = document.createElement('div');
        item.className = 'icon-setting-item';
        // „ÄêÏ§ëÏöî„ÄëÏ†ÄÌù¨Îäî dataÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§-icon-id Ïù¥ ÏÑ§Ï†ï Ìï≠Î™©Ïù¥ Ïñ¥Îñ§ ÏïÑÏù¥ÏΩòÏóê Ìï¥ÎãπÌïòÎäîÏßÄ ÌëúÏãúÌïòÍ∏∞ ÏúÑÌï¥
        item.dataset.iconId = iconId; 

        item.innerHTML = `
            <img class="icon-preview" src="${iconUrl}" alt="${labelText}">
            <button class="change-icon-btn">Î≥ÄÍ≤Ω</button>
        `;
        grid.appendChild(item);
    }
}
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥ Î∏îÎ°ùÏùÑ„ÄêÏµúÏ¢Ö ÌôïÏù∏ Î≤ÑÏ†Ñ„ÄëÏΩîÎìúÎ°ú, Ïù¥Ï†Ñ openBrowser Î∞è closeBrowser Ìï®ÏàòÎ•º ÎåÄÏ≤¥ ‚ñº‚ñº‚ñº

/**
 * ÏÇ¨Ïö©ÏûêÍ∞Ä ÎßÅÌÅ¨ Ïπ¥ÎìúÎ•º ÌÅ¥Î¶≠Ìï† Îïå, Í∞ÄÏÉÅ Î∏åÎùºÏö∞Ï†ÄÎ•º ÏóΩÎãàÎã§
 * @param {number} timestamp - ÌÅ¥Î¶≠Îêú Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ
 */
function openBrowser(timestamp) {
    if (!state.activeChatId) return;

    const chat = state.chats[state.activeChatId];
    // ÏïàÏ†Ñ Ï†êÍ≤Ä, chat Î∞è historyÍ∞Ä Î™®Îëê Ï°¥Ïû¨ÌïòÎäîÏßÄ ÌôïÏù∏
    if (!chat || !chat.history) return;

    const message = chat.history.find(m => m.timestamp === timestamp);
    if (!message || message.type !== 'share_link') {
        console.error("Ï∞æÏùÑ Ïàò ÏóÜÍ±∞ÎÇò Î©îÏãúÏßÄ Ïú†ÌòïÏù¥ ÏùºÏπòÌïòÏßÄ ÏïäÎäî Í≥µÏú† ÎßÅÌÅ¨:", timestamp);
        return; // Î©îÏãúÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÎã§Î©¥, Î∞îÎ°ú Ï¢ÖÎ£å
    }

    // Î∏åÎùºÏö∞Ï†Ä ÎÇ¥Ïö© Ï±ÑÏö∞Í∏∞
    document.getElementById('browser-title').textContent = message.source_name || 'Í≤åÏãúÍ∏Ä ÏÉÅÏÑ∏';
    const browserContent = document.getElementById('browser-content');
    browserContent.innerHTML = `
        <h1 class="article-title">${message.title || 'Ï†úÎ™© ÏóÜÏùå'}</h1>
        <div class="article-meta">
            <span>Ï∂úÏ≤ò: ${message.source_name || 'Ïïå Ïàò ÏóÜÏùå'}</span>
        </div>
        <div class="article-body">
            <p>${(message.content || 'ÎÇ¥Ïö©Ïù¥ ÎπÑÏñ¥ ÏûàÏùå.').replace(/\n/g, '</p><p>')}</p>
        </div>
    `;

    // Î∏åÎùºÏö∞Ï†Ä ÌôîÎ©¥ ÌëúÏãú
    showScreen('browser-screen');
}

/**
 * Í∞ÄÏÉÅ Î∏åÎùºÏö∞Ï†ÄÎ•º Îã´Í≥†, Ï±ÑÌåÖ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§
 * (Ïù¥ Ìï®ÏàòÎäî ÌòÑÏû¨ initÏóêÏÑú() Ïùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÍ∞Ä Ìò∏Ï∂úÌï©ÎãàÎã§)
 */
function closeBrowser() {
    showScreen('chat-interface-screen'); 
}

// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÏÇ¨Ïö©Ïûê ÎßÅÌÅ¨ Í≥µÏú† Í∏∞Îä•Ïùò ÌïµÏã¨ Ìï®Ïàò ‚ñº‚ñº‚ñº

/**
 * ÏÇ¨Ïö©ÏûêÍ∞Ä ÎßÅÌÅ¨ Ï†ïÎ≥¥Î•º ÏûëÏÑ±ÌïòÎèÑÎ°ù ÌïòÎäî Î™®Îã¨ Ï∞Ω Ïó¥Í∏∞
 */
function openShareLinkModal() {
    if (!state.activeChatId) return;

    // ÏßÄÎÇúÎ≤à ÏûÖÎ†• ÎÇ¥Ïö© ÎπÑÏö∞Í∏∞
    document.getElementById('link-title-input').value = '';
    document.getElementById('link-description-input').value = '';
    document.getElementById('link-source-input').value = '';
    document.getElementById('link-content-input').value = '';

    // Î™®Îã¨ Ï∞Ω ÌëúÏãú
    document.getElementById('share-link-modal').classList.add('visible');
}

/**
 * ÏÇ¨Ïö©ÏûêÍ∞Ä Í≥µÏú† ÌôïÏù∏, ÎßÅÌÅ¨ Ïπ¥Îìú Î©îÏãúÏßÄ ÏÉùÏÑ± Î∞è Ï†ÑÏÜ°
 */
async function sendUserLinkShare() {
    if (!state.activeChatId) return;

    const title = document.getElementById('link-title-input').value.trim();
    if (!title) {
        alert("Ï†úÎ™©ÏùÄ ÌïÑÏàò Ìï≠Î™©ÏûÖÎãàÎã§!");
        return;
    }

    const description = document.getElementById('link-description-input').value.trim();
    const sourceName = document.getElementById('link-source-input').value.trim();
    const content = document.getElementById('link-content-input').value.trim();

    const chat = state.chats[state.activeChatId];
    
    // Î©îÏãúÏßÄ Í∞ùÏ≤¥ ÏÉùÏÑ±
    const linkMessage = {
        role: 'user', // Ïó≠Ìï†ÏùÄ 'user'
        type: 'share_link',
        timestamp: Date.now(),
        title: title,
        description: description,
        source_name: sourceName,
        content: content,
        // ÏÇ¨Ïö©ÏûêÍ∞Ä Í≥µÏú†Ìïú ÎßÅÌÅ¨, Ï†ÄÌù¨Îäî Ïù¥ÎØ∏ÏßÄÎ•º Ï†úÍ≥µÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú Ìï≠ÏÉÅ ÏûêÎ¶¨ÌëúÏãúÏûê Ïù¥ÎØ∏ÏßÄÎ•º ÌëúÏãúÌï©ÎãàÎã§
        thumbnail_url: null 
    };

    // Î©îÏãúÏßÄÎ•º Í∏∞Î°ùÏóê Ï∂îÍ∞Ä
    chat.history.push(linkMessage);
    await db.chats.put(chat);

    // ÏÉà Î©îÏãúÏßÄ Î†åÎçîÎßÅ Î∞è Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
    appendMessage(linkMessage, chat);
    renderChatList();

    // Î™®Îã¨ Ï∞Ω Îã´Í∏∞
    document.getElementById('share-link-modal').classList.remove('visible');
}

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ìï®Ïàò Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

        // ===================================================================
        // 4. Ï¥àÍ∏∞Ìôî Ìï®Ïàò init()
        // ===================================================================
        async function init() {

    // ‚ñº‚ñº‚ñº ÏÉà ÏΩîÎìú Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
    const customBubbleStyleTag = document.createElement('style');
    customBubbleStyleTag.id = 'custom-bubble-style';
    document.head.appendChild(customBubbleStyleTag);
    // ‚ñ≤‚ñ≤‚ñ≤ ÏÉàÎ°úÏö¥ Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤

    // ‚ñº‚ñº‚ñº ÏÉà ÏΩîÎìú Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
    const previewBubbleStyleTag = document.createElement('style');
    previewBubbleStyleTag.id = 'preview-bubble-style';
    document.head.appendChild(previewBubbleStyleTag);
    // ‚ñ≤‚ñ≤‚ñ≤ ÏÉàÎ°úÏö¥ Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤


    // ‚ñº‚ñº‚ñº Ïù¥ Îëê Ï§Ñ ÏàòÏ†ï ‚ñº‚ñº‚ñº
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // Ïã§Ï†ú Ï±ÑÌåÖ ÌôîÎ©¥Ïùò ÏÇ¨Ïö©Ïûê Ï†ïÏùò Ïä§ÌÉÄÏùº ÏßÄÏö∞Í∏∞
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏòÅÏó≠Ïùò ÏÇ¨Ïö©Ïûê Ï†ïÏùò Ïä§ÌÉÄÏùº ÏßÄÏö∞Í∏∞
    // ‚ñ≤‚ñ≤‚ñ≤ ÏàòÏ†ï ÎÅù ‚ñ≤‚ñ≤‚ñ≤

            window.showScreen = showScreen;
            window.renderChatListProxy = renderChatList;
            window.renderApiSettingsProxy = renderApiSettings;
            window.renderWallpaperScreenProxy = renderWallpaperScreen;
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            await loadAllDataFromDB();

            // ÏùΩÏßÄ ÏïäÏùÄ ÎèôÏ†Å Í∞úÏàò Ï¥àÍ∏∞Ìôî
            const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
            updateUnreadIndicator(storedCount);
            
            // ‚ñ≤‚ñ≤‚ñ≤ ÏΩîÎìú Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

            if (state.globalSettings && state.globalSettings.fontUrl) {
                applyCustomFont(state.globalSettings.fontUrl);
            }

            updateClock();
            setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 

applyAppIcons();

            // ==========================================================
            // --- Îã§ÏñëÌïú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ---
            // ==========================================================

            document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
            document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
            document.getElementById('export-data-btn').addEventListener('click', exportBackup);
            document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));
            document.getElementById('back-to-list-btn').addEventListener('click', () => { 

    // ‚ñº‚ñº‚ñº Ïù¥ Îëê Ï§Ñ ÏàòÏ†ï ‚ñº‚ñº‚ñº
    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // Ïã§Ï†ú Ï±ÑÌåÖ ÌôîÎ©¥Ïùò ÏÇ¨Ïö©Ïûê Ï†ïÏùò Ïä§ÌÉÄÏùº ÏßÄÏö∞Í∏∞
    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏòÅÏó≠Ïùò ÏÇ¨Ïö©Ïûê Ï†ïÏùò Ïä§ÌÉÄÏùº ÏßÄÏö∞Í∏∞
    // ‚ñ≤‚ñ≤‚ñ≤ ÏàòÏ†ï ÎÅù ‚ñ≤‚ñ≤‚ñ≤

exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÏÉà Ï±ÑÌåÖ ÏÉùÏÑ±', 'Í∑∏ÎÖÄ/Í∑∏Ïùò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); 
const newChat = { 
    id: newChatId, 
    name: name.trim(), 
    isGroup: false,                         relationship: {
                            status: 'friend', // 'friend', 'blocked_by_user', 'pending_user_approval'
                            blockedTimestamp: null,
                            applicationReason: ''
                        },
                        status: {
                            text: 'Ïò®ÎùºÏù∏',
                            lastUpdate: Date.now(),
                            isBusy: false 
                        },
    settings: { 
        aiPersona: 'ÎãπÏã†ÏùÄ ÎàÑÍµ¨ÏÑ∏Ïöî.', 
        myPersona: 'ÎÇòÎäî ÎàÑÍµ¨ÏùºÍπåÏöî.', 
        maxMemory: 10, 
        aiAvatar: defaultAvatar, 
        myAvatar: defaultAvatar, 
        background: '', 
        theme: 'default', 
    fontSize: 13, 
    customCss: '', // <--- Ïù¥ Ï§Ñ Ï∂îÍ∞Ä
    linkedWorldBookIds: [], 
    aiAvatarLibrary: [],
    aiAvatarFrame: '', 
        myAvatarFrame: '' 
    }, 
    history: [], 
    musicData: { totalTime: 0 } 
};
state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });

            // ‚ñº‚ñº‚ñº „ÄêÏàòÏ†ï„ÄëÍ∑∏Î£π Ï±ÑÌåÖ ÏÉùÏÑ± Î≤ÑÌäºÏùÄ Ïù¥Ï†ú Ïó∞ÎùΩÏ≤ò ÏÑ†ÌÉùÍ∏∞Î•º ÏóΩÎãàÎã§ ‚ñº‚ñº‚ñº
document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤                      
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });

            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            // ‚ñº‚ñº‚ñº Ïù¥ Ï†ÑÏ≤¥ ÏΩîÎìú Î∏îÎ°ùÏúºÎ°ú, Ïù¥Ï†Ñ saveÎ•º ÎåÄÏ≤¥-wallpaper-btn Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
document.getElementById('save-wallpaper-btn').addEventListener('click', async () => {
    let changesMade = false;

    // Î∞∞Í≤ΩÌôîÎ©¥ Ï†ÄÏû•
    if (newWallpaperBase64) {
        state.globalSettings.wallpaper = newWallpaperBase64;
        changesMade = true;
    }

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏïÑÏù¥ÏΩò ÏÑ§Ï†ï Ï†ÄÏû•(Ïù¥ÎØ∏ Î©îÎ™®Î¶¨Ïóê ÏûàÏäµÎãàÎã§. Ï†ÄÌù¨Îäî globalSettings Ï†ÑÏ≤¥Î•º Ï†ÄÏû•ÌïòÍ∏∞Îßå ÌïòÎ©¥ Îê©ÎãàÎã§)
    await db.globalSettings.put(state.globalSettings);

    // Î™®Îì† Î≥ÄÍ≤Ω ÏÇ¨Ìï≠ Ï†ÅÏö©
    if (changesMade) {
        applyGlobalWallpaper();
        newWallpaperBase64 = null;
    }
    applyAppIcons(); // Î™®Îì† ÏïÑÏù¥ÏΩò Îã§Ïãú Ï†ÅÏö©

    alert('Ïô∏Í¥Ä ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÍ≥† Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!');
    showScreen('home-screen');
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); 

// ~ÏóêÏÑú 'save-api-settings-btn' Ïùò click Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÎÇ¥Î∂Ä
// await db.apiConfig.put(state.apiConfig); Ïù¥ Ï§Ñ Îí§Ïóê

// ‚ñº‚ñº‚ñº Ïù¥Ï†Ñ Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô ÏÑ§Ï†ï Ï†ÄÏû• Î°úÏßÅÏùÑ ÏïÑÎûòÏùò Ìñ•ÏÉÅÎêú Î≤ÑÏ†ÑÏúºÎ°ú ÎåÄÏ≤¥Ìï©ÎãàÎã§ ‚ñº‚ñº‚ñº

const backgroundSwitch = document.getElementById('background-activity-switch');
const intervalInput = document.getElementById('background-interval-input');
const newEnableState = backgroundSwitch.checked;
const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

// ÏÇ¨Ïö©ÏûêÍ∞Ä\"ÎÅîÏóêÏÑú Ïº¨ÏúºÎ°ú\"Ïùº ÎïåÎßå Í≤ΩÍ≥†Î•º ÌëúÏãúÌï©ÎãàÎã§
if (newEnableState && !oldEnableState) {
    const userConfirmed = confirm(
        "„ÄêÍ≥†ÎπÑÏö© Í≤ΩÍ≥†„Äë\n\n" +
        "ÎãπÏã†ÏùÄ ÌòÑÏû¨ ÌôúÏÑ±ÌôîÌïòÍ≥† ÏûàÏäµÎãàÎã§\"Î∞±Í∑∏ÎùºÏö¥Îìú Ï∫êÎ¶≠ÌÑ∞ ÌôúÎèô\"Í∏∞Îä•.\n\n" +
        "Ïù¥Îäî ÎãπÏã†Ïùò AI Ï∫êÎ¶≠ÌÑ∞Îì§Ïù¥ ÎãπÏã†Ïù¥ Í∑∏Îì§Í≥º Ï±ÑÌåÖÌïòÏßÄ ÏïäÏùÑ ÎïåÏóêÎèÑ\"ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú ÏÇ¨Í≥†ÌïòÍ≥†\"ÏûêÎ∞úÏ†ÅÏúºÎ°ú Î©îÏãúÏßÄÎ•º Î≥¥ÎÇ¥Í±∞ÎÇò ÏÇ¨ÌöåÏ†Å ÏÉÅÌò∏ÏûëÏö©ÏùÑ ÌïòÏó¨, Î™∞ÏûÖÍ∞êÏùÑ Í∑πÎåÄÌôîÌï† Í≤ÉÏûÖÎãàÎã§.\n\n" +
        "ÌïòÏßÄÎßå Ï£ºÏùòÌïòÏÑ∏Ïöî:\n" +
        "Ïù¥Í≤ÉÏùÄ„ÄêÎ∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú ÏûêÎèôÏúºÎ°ú, Ï£ºÍ∏∞Ï†ÅÏúºÎ°ú APIÎ•º Ìò∏Ï∂úÌï©ÎãàÎã§„Äë,ÎãπÏã†Ïù¥ ÏïÑÎ¨¥Îü∞ ÏûëÏóÖÎèÑ ÌïòÏßÄ ÏïäÏïÑÎèÑ ÎßêÏù¥Ï£†. ÎãπÏã†Ïùò Ï∫êÎ¶≠ÌÑ∞ ÏàòÏôÄ Í∞êÏßÄ Í∞ÑÍ≤©Ïóê Îî∞Îùº, Ïù¥Îäî API ÎπÑÏö©ÏùÑ ÌòÑÏ†ÄÌûà Ï¶ùÍ∞ÄÏãúÌÇ¨ Ïàò ÏûàÏäµÎãàÎã§.\n\n" +
        "ÌôúÏÑ±ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?"
    );

    if (!userConfirmed) {
        backgroundSwitch.checked = false; // ÏÇ¨Ïö©ÏûêÍ∞Ä Ï∑®ÏÜå, Ïä§ÏúÑÏπòÎ•º ÎêòÎèåÎ¶º
        return; // ÌõÑÏÜç Î°úÏßÅ Ï∞®Îã®
    }
}

state.globalSettings.enableBackgroundActivity = newEnableState;
state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
await db.globalSettings.put(state.globalSettings);

// ÏãúÎÆ¨Î†àÏù¥ÌÑ∞ ÎèôÏ†Å ÏãúÏûë ÎòêÎäî Ï§ëÏßÄ
stopBackgroundSimulation();
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log(`Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖòÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§, Í∞ÑÍ≤©: ${state.globalSettings.backgroundActivityInterval}Ï¥à`);
} else {
    console.log("Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖòÏù¥ Ï§ëÏßÄÎêòÏóàÏäµÎãàÎã§.");
}
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

alert('APIÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!'); });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { const url = document.getElementById('proxy-url').value.trim(); const key = document.getElementById('api-key').value.trim(); if (!url || !key) return alert('Î®ºÏ†Ä Ïó≠ÌîÑÎ°ùÏãú Ï£ºÏÜåÏôÄ ÌÇ§Î•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî'); try { const response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (!response.ok) throw new Error('Î™®Îç∏ Î™©Î°ùÏùÑ Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§'); const data = await response.json(); const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = ''; data.data.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; if(model.id === state.apiConfig.model) option.selected = true; modelSelect.appendChild(option); }); alert('Î™®Îç∏ Î™©Î°ùÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§'); } catch (error) { alert(`Î™®Îç∏ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ${error.message}`); } });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÏõîÎìúÎ∂Å ÏÉùÏÑ±', 'ÎèÑÏÑúÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('ÎèÑÏÑúÎ™ÖÏùÄ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§!'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });

            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('ÏÇ¨ÏßÑ ÏÑ§Î™Ö', description); return; } const voiceMessage = e.target.closest('.voice-message-body'); if (voiceMessage) { const text = voiceMessage.dataset.text; if (text) showCustomAlert('ÏùåÏÑ± ÎÇ¥Ïö©', text); return; } });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ†ÌÉù --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `${checkedBoxes.length}Í∞ú Ìï≠Î™© ÏÑ†ÌÉùÎê®`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }        
            
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });

// ‚ñº‚ñº‚ñº Ïù¥ Î∂ÄÎ∂ÑÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî„ÄêÏôÑÏ†ÑÌïòÍ≥† ÏÉàÎ°úÏö¥ ÏΩîÎìú„ÄëÏù¥Ï†Ñ chatÏùÑ ÎåÄÏ≤¥-settings-btn ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ‚ñº‚ñº‚ñº
document.getElementById('chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const isGroup = chat.isGroup;

    // --- ÏùºÍ¥Ñ ÌëúÏãú/Ïª®Ìä∏Î°§ Ïà®Í∏∞Í∏∞ ---
    document.getElementById('chat-name-group').style.display = 'block';
    document.getElementById('my-persona-group').style.display = 'block';
    document.getElementById('my-avatar-group').style.display = 'block';
    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';
    
    // „ÄêÌïµÏã¨ ÏàòÏ†ï 1„ÄëÍ∑∏Î£π Ï±ÑÌåÖ Ïó¨Î∂ÄÏóê Îî∞Îùº ÌëúÏãú ÎòêÎäî Ïà®Í∏∞Í∏∞\"ÏπúÍµ¨ Í∑∏Î£π\"Íµ¨Ïó≠
    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';
    
    // --- Ìèº Îç∞Ïù¥ÌÑ∞ Î°úÎìú ---
    document.getElementById('chat-name-input').value = chat.name;
    document.getElementById('my-persona').value = chat.settings.myPersona;
    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
    document.getElementById('max-memory').value = chat.settings.maxMemory;
    const bgPreview = document.getElementById('bg-preview');
    const removeBgBtn = document.getElementById('remove-bg-btn');
    if (chat.settings.background) {
        bgPreview.src = chat.settings.background;
        bgPreview.style.display = 'block';
        removeBgBtn.style.display = 'inline-block';
    } else {
        bgPreview.style.display = 'none';
        removeBgBtn.style.display = 'none';
    }

    if (isGroup) {
        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
        renderGroupMemberSettings(chat.members);
    } else {
        document.getElementById('ai-persona').value = chat.settings.aiPersona;
        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï 2„ÄëÎã®Ïùº Ï±ÑÌåÖÏù¥Î©¥ Í∑∏Î£π Î™©Î°ùÏùÑ ÎìúÎ°≠Îã§Ïö¥Ïóê Î°úÎìú
        const select = document.getElementById('assign-group-select');
        select.innerHTML = '<option value="">Í∑∏Î£πÌôîÎêòÏßÄ ÏïäÏùå</option>'; // ÏßÄÏö∞Í≥† Í∏∞Î≥∏ ÏòµÏÖò ÏÑ§Ï†ï
        const groups = await db.qzoneGroups.toArray();
        groups.forEach(group => {
            const option = document.createElement('option');
            option.value = group.id;
            option.textContent = group.name;
            // ÌòÑÏû¨ ÏπúÍµ¨ÏóêÍ≤å Í∑∏Î£πÏù¥ ÏûàÏúºÎ©¥ Í∏∞Î≥∏ÏúºÎ°ú ÏÑ†ÌÉù
            if (chat.groupId === group.id) {
                option.selected = true;
            }
            select.appendChild(option);
        }); 
    }
    
    // ÏõîÎìúÏù∏Ìè¨ Î°úÎìú
    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
    worldBookCheckboxesContainer.innerHTML = '';
    const linkedIds = chat.settings.linkedWorldBookIds || [];
    if (state.worldBooks.length > 0) {
        state.worldBooks.forEach(book => {
            const isChecked = linkedIds.includes(book.id);
            const label = document.createElement('label');
            label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
            worldBookCheckboxesContainer.appendChild(label);
        });
    }
    updateWorldBookSelectionDisplay();

    // Î™®Îì† ÎØ∏Î¶¨Î≥¥Í∏∞ Í¥ÄÎ†® Ïª®Ìä∏Î°§ Î°úÎìú Î∞è ÏóÖÎç∞Ïù¥Ìä∏
    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
    if (themeRadio) themeRadio.checked = true;
    const fontSizeSlider = document.getElementById('font-size-slider');
    fontSizeSlider.value = chat.settings.fontSize || 13;
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    const customCssInput = document.getElementById('custom-css-input');
    customCssInput.value = chat.settings.customCss || '';
    
    updateSettingsPreview(); 
    document.getElementById('chat-settings-modal').classList.add('visible');
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤
            
            function renderGroupMemberSettings(members) { const container = document.getElementById('group-members-settings'); container.innerHTML = ''; members.forEach(member => { const div = document.createElement('div'); div.className = 'member-editor'; div.dataset.memberId = member.id; div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; div.addEventListener('click', () => openMemberEditor(member.id)); container.appendChild(div); }); }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }

            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    const chat = state.chats[state.activeChatId];
    const newName = document.getElementById('chat-name-input').value.trim();
    if (!newName) return alert('Î≥ÑÎ™Ö/Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§!');
    chat.name = newName;
    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

    chat.settings.myPersona = document.getElementById('my-persona').value;
    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
    const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);

    if (chat.isGroup) {
        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
    } else {
        chat.settings.aiPersona = document.getElementById('ai-persona').value;
        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
        const selectedGroupId = document.getElementById('assign-group-select').value;
        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
    }

    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
    await db.chats.put(chat);

    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');
    
    chatSettingsModal.classList.remove('visible');
    renderChatInterface(state.activeChatId);
    renderChatList();
});
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('Ï±ÑÌåÖ Í∏∞Î°ù ÏßÄÏö∞Í∏∞', 'Ïù¥ ÏûëÏóÖÏùÄ Ïù¥ Ï±ÑÌåÖÏùò Î™®Îì† Î©îÏãúÏßÄÎ•º ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÌïòÎ©∞, Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÎπÑÏö∞ÏãúÍ≤†ÏäµÎãàÍπå?', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("Ïù¥Î™®Ìã∞ÏΩò Ï∂îÍ∞Ä(URL)", "Ïù¥Î™®Ìã∞ÏΩò Ìå©Ïùò Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"); if (!url || !url.trim().startsWith('http')) return url && alert("Ïú†Ìö®Ìïú URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (httpÎ°ú ÏãúÏûë)"); const name = await showCustomPrompt("Ïù¥Î™®Ìã∞ÏΩò Ïù¥Î¶Ñ ÏßÄÏ†ï", "Ïù¥ Ïù¥Î™®Ìã∞ÏΩòÏùò Ïù¥Î¶ÑÏùÑ ÏßÄÏ†ïÌï¥ Ï£ºÏÑ∏Ïöî (ÏòàÏãú:Í∏∞ÏÅ®, ÏùòÎ¨∏)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("Ïù¥Î™®Ìã∞ÏΩò Ïù¥Î¶ÑÏùÑ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§!"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("Ïù¥Î™®Ìã∞ÏΩò Ïù¥Î¶Ñ ÏßÄÏ†ï", "Ïù¥ Ïù¥Î™®Ìã∞ÏΩòÏùò Ïù¥Î¶ÑÏùÑ ÏßÄÏ†ïÌï¥ Ï£ºÏÑ∏Ïöî (ÏòàÏãú:ÏïºÌò∏, ÏùòÎ¨∏)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("Ïù¥Î™®Ìã∞ÏΩò Ïù¥Î¶ÑÏùÑ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§!"); }; event.target.value = null; });

            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("ÏùåÏÑ± Î≥¥ÎÇ¥Í∏∞", "ÌïòÍ≥† Ïã∂ÏùÄ ÎßêÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ÏÇ¨ÏßÑ Î≥¥ÎÇ¥Í∏∞", "Î≥¥ÎÇº ÏÇ¨ÏßÑÏùÑ ÌÖçÏä§Ìä∏Î°ú ÏÑ§Î™ÖÌï¥ Ï£ºÏÑ∏Ïöî:"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÎ∞∞Îã¨ ÏöîÏ≤≠ Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ‚ñº‚ñº‚ñº
const waimaiModal = document.getElementById('waimai-request-modal');
document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
    waimaiModal.classList.add('visible');
});

document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
    waimaiModal.classList.remove('visible');
});

document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
    if (!state.activeChatId) return;
    
    const productInfoInput = document.getElementById('waimai-product-info');
    const amountInput = document.getElementById('waimai-amount');
    
    const productInfo = productInfoInput.value.trim();
    const amount = parseFloat(amountInput.value);

    if (!productInfo) {
        alert('ÏÉÅÌíà Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
        return;
    }
    if (isNaN(amount) || amount <= 0) {
        alert('Ïú†Ìö®Ìïú ÎåÄÎ¶¨ Í≤∞Ï†ú Í∏àÏï°ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
        return;
    }

    const chat = state.chats[state.activeChatId];
    const now = Date.now();

    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏÑú ÏÇ¨Ïö©Ïûê ÏûêÏã†Ïùò ÎãâÎÑ§ÏûÑÏùÑ Í∞ÄÏ†∏ÏòµÎãàÎã§
    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
    
    const msg = {
        role: 'user',
        // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÍ∞ÄÏ†∏Ïò® ÎãâÎÑ§ÏûÑÏùÑ senderNameÏúºÎ°ú Î©îÏãúÏßÄ Í∞ùÏ≤¥Ïóê Ï∂îÍ∞Ä
        senderName: myNickname, 
        type: 'waimai_request',
        productInfo: productInfo,
        amount: amount,
        status: 'pending',
        countdownEndTime: now + 15 * 60 * 1000,
        timestamp: now
    };

    chat.history.push(msg);
    await db.chats.put(chat);
    appendMessage(msg, chat);
    renderChatList();

    productInfoInput.value = '';
    amountInput.value = '';
    waimaiModal.classList.remove('visible');
});         
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);
            
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);

// ‚ñº‚ñº‚ñº „ÄêÏµúÏ¢Ö Í∞ïÌôîÌåê„ÄëÏù¥ ÏΩîÎìúÎ°ú Í∏∞Ï°¥ ÏÑ†ÌÉù ÍµêÏ≤¥-delete-btn Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
document.getElementById('selection-delete-btn').addEventListener('click', async () => {
    if (selectedMessages.size === 0) return;
    const confirmed = await showCustomConfirm('Î©îÏãúÏßÄ ÏÇ≠Ï†ú', `ÏÑ†ÌÉùÌïú ${selectedMessages.size}Í∞ú Î©îÏãúÏßÄÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥Í≤ÉÏùÄ AIÏùò Í∏∞ÏñµÏùÑ Î≥ÄÍ≤ΩÌï† Í≤ÉÏûÖÎãàÎã§.`, { confirmButtonClass: 'btn-danger' });
    if (confirmed) {
        const chat = state.chats[state.activeChatId];
        
        // 1. „ÄêÌïµÏã¨ Í∞ïÌôî„ÄëÏÇ≠Ï†ú Ï†ÑÏóê, ÏÇ≠Ï†úÎêú Î©îÏãúÏßÄÏóê Ìà¨ÌëúÍ∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        let deletedPollsInfo = [];
        for (const timestamp of selectedMessages) {
            const msg = chat.history.find(m => m.timestamp === timestamp);
            if (msg && msg.type === 'poll') {
                deletedPollsInfo.push(`Ïóê ÎåÄÌïòÏó¨\"${msg.question}\"Ìà¨Ìëú(ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ: ${msg.timestamp})`);
            }
        }
        
        // 2. Î∞±ÏóîÎìú Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));
        
        // 3. „ÄêÌïµÏã¨ Í∞ïÌôî„ÄëÎçî Íµ¨Ï≤¥Ï†ÅÏù∏ Í≤ÉÏùÑ Íµ¨Ï∂ï\"ÎßùÍ∞Å ÏßÄÏãú\"
        let forgetReason = "Ïù¥Ï†Ñ Î©îÏãúÏßÄ Ï§ë ÏùºÎ∂ÄÍ∞Ä ÏÇ¨Ïö©ÏûêÏóê ÏùòÌï¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.";
        if (deletedPollsInfo.length > 0) {
            forgetReason += ` Ïó¨Í∏∞ÏóêÎäî Îã§Ïùå Ìà¨ÌëúÍ∞Ä Ìè¨Ìï®Îê©ÎãàÎã§:${deletedPollsInfo.join(';')}.`;
        }
        forgetReason += " ÎãπÏã†ÏùÄ ÎßàÏπò Í∑∏Í≤ÉÎì§Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏïòÎçò Í≤ÉÏ≤òÎüº ÎåÄÌôîÎ•º Í≥ÑÏÜçÌïòÍ≥†, Í∏∞ÏñµÍ≥º ÌñâÎèôÏùÑ Ï†ÅÏ†àÌûà Ï°∞Ï†ïÌïòÎ©∞, ÏÇ≠Ï†úÎêú ÎÇ¥Ïö©ÏùÑ Îã§Ïãú Ïñ∏Í∏âÌïòÏßÄ ÏïäÏïÑÏïº Ìï©ÎãàÎã§.";

        const forgetInstruction = {
            role: 'system',
            content: `[ÏãúÏä§ÌÖú ÏïåÎ¶º:${forgetReason}]`,
            timestamp: Date.now(),
            isHidden: true 
        };
        chat.history.push(forgetInstruction);
        
        // 4. Ìè¨Ìï®Îêú\"ÎßùÍ∞Å ÏßÄÏãú\",ÏóÖÎç∞Ïù¥Ìä∏Îêú Ï±ÑÌåÖ Í∞ùÏ≤¥Î•º Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Îã§Ïãú Ï†ÄÏû•
        await db.chats.put(chat);
        
        // 5. ÎßàÏßÄÎßâÏúºÎ°ú UI ÏóÖÎç∞Ïù¥Ìä∏
        renderChatInterface(state.activeChatId);
        renderChatList();
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// Ï±ÑÌåÖ ÏÑ§Ï†ïÏùò\"ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑ Î≥ÄÍ≤Ω\"Î≤ÑÌäºÏóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('change-frame-btn')) {
        // 'chat' Ïù¥ Îß§Í∞úÎ≥ÄÏàòÎäî Ìï®ÏàòÏóê Ïù¥Î≤àÏù¥\"ÎÇ¥/ÏÉÅÎåÄÎ∞©\"Ïù¥ Ï°∞Ìï©Ïùò ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑÏùÑ ÍµêÏ≤¥ÌïòÎäî Í≤ÉÏûÑÏùÑ ÏïåÎ¶ΩÎãàÎã§
        openFrameSelectorModal('chat');
    }
});

// Î©§Î≤Ñ ÏÑ§Ï†ïÏùò\"ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑ Î≥ÄÍ≤Ω\"Î≤ÑÌäºÏóê ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
document.getElementById('member-settings-modal').addEventListener('click', (e) => {
    // „ÄêÏàòÏ†ï„Äë.contentsÎ•º .containsÎ°ú ÏàòÏ†ï
    if (e.target.classList.contains('change-frame-btn')) { 
        // 'member' Ïù¥ Îß§Í∞úÎ≥ÄÏàòÎäî Ìï®ÏàòÏóê Ïù¥Î≤àÏù¥ Í∞úÎ≥Ñ Í∑∏Î£π Î©§Î≤ÑÏùò ÏïÑÎ∞îÌÉÄ ÌîÑÎ†àÏûÑÏùÑ ÍµêÏ≤¥ÌïòÎäî Í≤ÉÏûÑÏùÑ ÏïåÎ¶ΩÎãàÎã§
        openFrameSelectorModal('member');
    }
});

// ‚ñ≤‚ñ≤‚ñ≤ Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

            const fontUrlInput = document.getElementById('font-url-input');
            fontUrlInput.addEventListener('input', () => applyCustomFont(fontUrlInput.value.trim(), true));
            document.getElementById('save-font-btn').addEventListener('click', async () => {
                const newFontUrl = fontUrlInput.value.trim();
                if (!newFontUrl) { alert("Ïú†Ìö®Ìïú Í∏ÄÍº¥ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."); return; }
                applyCustomFont(newFontUrl, false);
                state.globalSettings.fontUrl = newFontUrl;
                await db.globalSettings.put(state.globalSettings);
                alert('Í∏ÄÍº¥Ïù¥ Ï†ÄÏû•ÎêòÍ≥† Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!');
            });
            document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("ÎãâÎÑ§ÏûÑ ÏàòÏ†ï", "ÏÉà ÎãâÎÑ§ÏûÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
            document.getElementById('qzone-avatar-container').addEventListener('click', () => document.getElementById('qzone-avatar-input').click());
            document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
            document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
            document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise(res => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.readAsDataURL(file); }); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

// ‚ñº‚ñº‚ñº „ÄêÏàòÏ†ï ÌõÑ„ÄëÏùò\"Í∏Ä\"Î≤ÑÌäº Ïù¥Î≤§Ìä∏ ‚ñº‚ñº‚ñº
document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
    // 1. Î™®Îã¨ Ï∞Ω Ïû¨ÏÑ§Ï†ï Î∞è Í∞ÄÏ†∏Ïò§Í∏∞
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. ÏúºÎ°ú ÏÑ§Ï†ï\"Í∏Ä\"Î™®Îìú
    modal.dataset.mode = 'shuoshuo';
    
    // 3. Ïù¥ÎØ∏ÏßÄÏôÄ Ïà®Í∏∞Í∏∞/ÌÖçÏä§Ìä∏ Í∑∏Î¶º Í¥ÄÎ†® Î∂ÄÎ∂Ñ
    modal.querySelector('.post-mode-switcher').style.display = 'none';
    modal.querySelector('#image-mode-content').style.display = 'none';
    modal.querySelector('#text-image-mode-content').style.display = 'none';
    
    // 4. Ï£º ÏûÖÎ†•ÎûÄÏùò ÌûåÌä∏ Î©îÏãúÏßÄÎ•º ÏàòÏ†ïÌïòÏó¨\"Í∏Ä\"Ïû•Î©¥Ïóê Îçî Ï†ÅÌï©ÌïòÍ≤å ÎßåÎì≠ÎãàÎã§
    modal.querySelector('#post-public-text').placeholder = 'ÏÉàÎ°úÏö¥ ÏÜåÏãù Í≥µÏú†...';
    
    // 5. Î™®Îã¨ Ï∞Ω Ï§ÄÎπÑ Î∞è ÌëúÏãú
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Í∑∏Î£π ÏóÜÏùå</p>';
    }
    modal.classList.add('visible');
});

// ‚ñº‚ñº‚ñº „ÄêÏàòÏ†ï ÌõÑ„ÄëÏùò\"ÌîºÎìú\"(Ïù¥ÎØ∏ÏßÄ)Î≤ÑÌäº Ïù¥Î≤§Ìä∏ ‚ñº‚ñº‚ñº
document.getElementById('create-post-btn').addEventListener('click', async () => {
    // 1. Î™®Îã¨ Ï∞Ω Ïû¨ÏÑ§Ï†ï Î∞è Í∞ÄÏ†∏Ïò§Í∏∞
    resetCreatePostModal();
    const modal = document.getElementById('create-post-modal');
    
    // 2. ÏúºÎ°ú ÏÑ§Ï†ï\"Î≥µÏû°Ìïú ÎèôÏ†Å\"Î™®Îìú
    modal.dataset.mode = 'complex';
    
// 3. Ïù¥ÎØ∏ÏßÄÏôÄ Ìï®Íªò/ÌÖçÏä§Ìä∏ Í∑∏Î¶º Í¥ÄÎ†® Î∂ÄÎ∂ÑÏù¥ Î≥¥Ïù¥ÎèÑÎ°ù
modal.querySelector('.post-mode-switcher').style.display = 'flex';
// Î™ÖÏãúÏ†Å ÌôúÏÑ±Ìôî\"Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú\"Î™®Îìú...
modal.querySelector('#image-mode-content').classList.add('active');
// ...ÎèôÏãúÏóê\"ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ\"Î™®ÎìúÎäî Ïà®Í≤®Ï†∏ ÏûàÏäµÎãàÎã§
modal.querySelector('#text-image-mode-content').classList.remove('active');
    
    // 4. Ï£º ÏûÖÎ†•ÎûÄÏùò Í∏∞Î≥∏ ÌûåÌä∏ Î©îÏãúÏßÄ Î≥µÏõê
    modal.querySelector('#post-public-text').placeholder = 'ÏÉàÎ°úÏö¥ ÏÜåÏãù Í≥µÏú†...(ÌïÑÏàòÍ∞Ä ÏïÑÎãå Í≥µÍ∞ú ÌÖçÏä§Ìä∏)';

    // 5. Î™®Îã¨ Ï∞Ω Ï§ÄÎπÑ Î∞è ÌëúÏãú(Í≥º\"Í∏Ä\"Î≤ÑÌäºÏùò Î°úÏßÅÍ≥º ÎèôÏùº)
    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
    visibilityGroupsContainer.innerHTML = '';
    const groups = await db.qzoneGroups.toArray();
    if (groups.length > 0) {
        groups.forEach(group => {
            const label = document.createElement('label');
            label.style.display = 'block';
            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
            visibilityGroupsContainer.appendChild(label);
        });
    } else {
        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Í∑∏Î£π ÏóÜÏùå</p>';
    }
    modal.classList.add('visible');
});
            document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
            document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

// --- ‚Üì‚Üì‚Üì Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞ Î≥µÏÇ¨ ‚Üì‚Üì‚Üì ---

document.getElementById('album-photos-back-btn').addEventListener('click', () => {
    state.activeAlbumId = null;
    showScreen('album-screen');
});

document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

document.getElementById('album-photo-input').addEventListener('change', async (event) => {
    if (!state.activeAlbumId) return;
    const files = event.target.files;
    if (!files.length) return;

    const album = await db.qzoneAlbums.get(state.activeAlbumId);
    
    for (const file of files) {
        const dataUrl = await new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });
        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
    }

    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
    const updateData = { photoCount };
    
    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
        if(firstPhoto) updateData.coverUrl = firstPhoto.url;
    }

    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
    await renderAlbumPhotosScreen();
    await renderAlbumList();
    
    event.target.value = null;
    alert('ÏÇ¨ÏßÑ ÏóÖÎ°úÎìú ÏÑ±Í≥µ!');
});

// --- ‚Üë‚Üë‚Üë Ïó¨Í∏∞ÍπåÏßÄ Î≥µÏÇ¨ ‚Üë‚Üë‚Üë ---

// --- ‚Üì‚Üì‚Üì Ïó¨Í∏∞ÏÑúÎ∂ÄÌÑ∞ Î≥µÏÇ¨ÌïòÏó¨, Í∏∞Ï°¥ photosÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥-grid-page Î¶¨Ïä§ÎÑà ‚Üì‚Üì‚Üì ---

document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
    const deleteBtn = e.target.closest('.photo-delete-btn');
    const photoThumb = e.target.closest('.photo-thumb');

    if (deleteBtn) {
        e.stopPropagation(); // Ïù¥ÎØ∏ÏßÄÍπåÏßÄ Ïù¥Î≤§Ìä∏ Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
        const photoId = parseInt(deleteBtn.dataset.photoId);
        const confirmed = await showCustomConfirm(
            'ÏÇ¨ÏßÑ ÏÇ≠Ï†ú',
            'Ïù¥ ÏÇ¨ÏßÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.',
            { confirmButtonClass: 'btn-danger' }
        );

        if (confirmed) {
            const deletedPhoto = await db.qzonePhotos.get(photoId);
            if (!deletedPhoto) return;
            
            await db.qzonePhotos.delete(photoId);

            const album = await db.qzoneAlbums.get(state.activeAlbumId);
            const photoCount = (album.photoCount || 1) - 1;
            const updateData = { photoCount };
            
            if (album.coverUrl === deletedPhoto.url) {
                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
            }
            
            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
            await renderAlbumPhotosScreen();
            await renderAlbumList();
            alert('ÏÇ¨ÏßÑÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        }
    } 
    else if (photoThumb) {
        // Ïù¥Í≤ÉÏù¥ Î≥µÏõêÎêú Ïù¥ÎØ∏ÏßÄ ÌÅ¥Î¶≠ ÌôïÎåÄ Í∏∞Îä•ÏûÖÎãàÎã§!
        openPhotoViewer(photoThumb.src);
    }
});

// Ïù¥ÎØ∏ÏßÄ Î∑∞Ïñ¥ Ï†úÏñ¥ Ïù¥Î≤§Ìä∏ Î≥µÏõê
document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

// ÌÇ§Î≥¥Îìú Ï¢åÏö∞ ÌôîÏÇ¥ÌëúÏôÄ ESC ÌÇ§ Í∏∞Îä• Î≥µÏõê
document.addEventListener('keydown', (e) => {
    if (!photoViewerState.isOpen) return; 

    if (e.key === 'ArrowRight') {
        showNextPhoto();
    } else if (e.key === 'ArrowLeft') {
        showPrevPhoto();
    } else if (e.key === 'Escape') {
        closePhotoViewer();
    }
});

// --- ‚Üë‚Üë‚Üë Ïó¨Í∏∞ÍπåÏßÄ Î≥µÏÇ¨ ‚Üë‚Üë‚Üë ---
         
document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("ÏÉà Ïï®Î≤î ÏÉùÏÑ±", "Ïï®Î≤î Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`Ïï®Î≤î "${albumName}" ÏÉùÏÑ± ÏÑ±Í≥µ!`); } else if (albumName !== null) { alert("Ïï®Î≤î Ïù¥Î¶ÑÏùÑ ÎπÑÏõåÎëò Ïàò ÏóÜÏäµÎãàÎã§!"); } });

            document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
            document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
            document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
            document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("Ïù¥ÎØ∏ÏßÄ URL ÏûÖÎ†•", "Ïõπ Ïù¥ÎØ∏ÏßÄ ÎßÅÌÅ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
            document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
            const imageModeBtn = document.getElementById('switch-to-image-mode');
            const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
            const imageModeContent = document.getElementById('image-mode-content');
            const textImageModeContent = document.getElementById('text-image-mode-content');
            imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
            textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

// ‚ñº‚ñº‚ñº „ÄêÏµúÏ¢Ö ÏàòÏ†ï Î≤ÑÏ†Ñ„ÄëÏùò\"Í≤åÏãú\"Î≤ÑÌäº Ïù¥Î≤§Ìä∏, Í∂åÌïú Ï∑®ÏïΩÏ†ê ÏàòÏ†ïÎê® ‚ñº‚ñº‚ñº
document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
    const modal = document.getElementById('create-post-modal');
    const mode = modal.dataset.mode;
    
    // --- 1. ÏùºÎ∞òÏ†ÅÏù∏ Í∞ÄÏãúÏÑ± ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞ ---
    const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
    let visibleGroupIds = null;
    
    if (visibilityMode === 'include') {
        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
    }

    let newPost = {};
    const basePostData = {
        timestamp: Date.now(),
        authorId: 'user',
        // „ÄêÏ§ëÏöî„ÄëÏó¨Í∏∞ÏÑú Í∂åÌïú Ï†ïÎ≥¥Î•º Ï†ÄÏû•
        visibleGroupIds: visibleGroupIds,
    };

    // --- 2. Î™®ÎìúÏóê Îî∞Îùº Îã§Î•∏ Í≤åÏãúÎ¨º Í∞ùÏ≤¥ Íµ¨Ï∂ï ---
    if (mode === 'shuoshuo') {
        const content = document.getElementById('post-public-text').value.trim();
        if (!content) {
            alert('Í≤åÏãúÎ¨º ÎÇ¥Ïö©ÏùÑ ÎπÑÏõåÎëò Ïàò ÏóÜÏñ¥Ïöî!');
            return;
        }
        newPost = {
            ...basePostData,
            type: 'shuoshuo',
            content: content,
        };

    } else { // Ï≤òÎ¶¨ 'complex' Î™®Îìú (Ïù¥ÎØ∏ÏßÄ/ÌÖçÏä§Ìä∏ Ïù¥ÎØ∏ÏßÄ)
        const publicText = document.getElementById('post-public-text').value.trim();
        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

        if (isImageModeActive) {
            const imageUrl = document.getElementById('post-image-preview').src;
            const imageDescription = document.getElementById('post-image-description').value.trim();
            if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                alert('Î®ºÏ†Ä ÏÇ¨ÏßÑÏùÑ Ï∂îÍ∞ÄÌïú ÌõÑ Í≤åÏãúÎ¨ºÏùÑ ÏûëÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî!');
                return;
            }
            if (!imageDescription) {
                alert('ÏÇ¨ÏßÑÏóê Í∞ÑÎã®Ìïú ÏÑ§Î™ÖÏùÑ Ï∂îÍ∞ÄÌï¥ Ï£ºÏÑ∏Ïöî(ÌïÑÏàò, AIÎ•º ÏúÑÌïú)!');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'image_post',
                publicText: publicText,
                imageUrl: imageUrl,
                imageDescription: imageDescription,
            };
        } else { // ÌÖçÏä§Ìä∏ Í∑∏Î¶º Î™®Îìú
            const hiddenText = document.getElementById('post-hidden-text').value.trim();
            if (!hiddenText) {
                alert('ÌÖçÏä§Ìä∏ Í∑∏Î¶º ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!');
                return;
            }
            newPost = {
                ...basePostData,
                type: 'text_image',
                publicText: publicText,
                hiddenContent: hiddenText,
            };
        }
    }

    // --- 3. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê Ï†ÄÏû• ---
    const newPostId = await db.qzonePosts.add(newPost);
    let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "(ÌÖçÏä§Ìä∏ ÎÇ¥Ïö© ÏóÜÏùå)";
    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');

    // --- 4. „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÍ∂åÌïú ÌôïÏù∏Ïù¥ Ìè¨Ìï®Îêú ÏïåÎ¶º Î£®ÌîÑ ---
    for (const chatId in state.chats) {
        const chat = state.chats[chatId];
        if (chat.isGroup) continue; // Í∑∏Î£π Ï±ÑÌåÖ Í±¥ÎÑàÎõ∞Í∏∞

        let shouldNotify = false;
        const postVisibleGroups = newPost.visibleGroupIds;

        // ÌåêÎã® Ï°∞Í±¥1:Í≤åÏãúÎ¨ºÏù¥ Í≥µÍ∞úÏù∏ Í≤ΩÏö∞ (Ïñ¥Îñ§ Í∞ÄÏãúÏÑ± Í∑∏Î£πÎèÑ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏùå)
        if (!postVisibleGroups || postVisibleGroups.length === 0) {
            shouldNotify = true;
        } 
        // ÌåêÎã® Ï°∞Í±¥2:Í≤åÏãúÎ¨ºÏù¥ ÏùºÎ∂Ä Í≥µÍ∞úÎ°ú ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÍ≥†, ÌòÑÏû¨ Ï∫êÎ¶≠ÌÑ∞Í∞Ä Í∞ÄÏãúÏÑ± Í∑∏Î£π ÎÇ¥Ïóê ÏûàÎäî Í≤ΩÏö∞
        else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
            shouldNotify = true;
        }

        // Ï°∞Í±¥ÏùÑ ÎßåÏ°±ÌïòÎäî Ï∫êÎ¶≠ÌÑ∞Îßå ÏïåÎ¶ºÏùÑ Î∞õÏäµÎãàÎã§
        if (shouldNotify) {
            const historyMessage = {
                role: 'system',
                content: `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©ÏûêÍ∞Ä Î∞©Í∏à Í≤åÏãúÎ¨ºÏùÑ ÏûëÏÑ±ÌñàÏäµÎãàÎã§(ID: ${newPostId}),ÎÇ¥Ïö© ÏöîÏïΩÏùÄ:\"${postSummary}\".Ïù¥Ï†ú Ïù¥ Í≤åÏãúÎ¨ºÏóê ÎåìÍ∏ÄÏùÑ Îã¨ Ïàò ÏûàÏäµÎãàÎã§.]`,
                timestamp: Date.now(),
                isHidden: true
            };
            chat.history.push(historyMessage);
            await db.chats.put(chat);
        }
    }
    // --- ÏàòÏ†ï ÎÅù ---

    await renderQzonePosts();
    modal.classList.remove('visible');
    alert('Í≤åÏãúÎ¨º Í≤åÏãú ÏÑ±Í≥µ!');
});

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏúºÎ°ú„ÄêÏù¥ ÌÜµÏß∏Ïùò„ÄëÎ™®Îì† Ïä¨ÎùºÏù¥Îìú Î∞è ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Í∞Ä Ìè¨Ìï®Îêú Ï†ÑÏ≤¥ ÏΩîÎìú, Ïù¥Ï†Ñ postsList Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÎåÄÏ≤¥ ‚ñº‚ñº‚ñº

const postsList = document.getElementById('qzone-posts-list');
let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

function resetAllSwipes(exceptThisOne = null) {
    document.querySelectorAll('.qzone-post-container').forEach(container => {
        if (container !== exceptThisOne) {
            container.querySelector('.qzone-post-item').classList.remove('swiped');
        }
    });
}

const handleSwipeStart = (e) => {
    const targetContainer = e.target.closest('.qzone-post-container');
    if (!targetContainer) return;

    resetAllSwipes(targetContainer);
    swipeState.activeContainer = targetContainer;
    swipeState.isDragging = true;
    swipeState.isClick = true;
    swipeState.swipeDirection = null;
    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
};

const handleSwipeMove = (e) => {
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
    const diffX = currentX - swipeState.startX;
    const diffY = currentY - swipeState.startY;
    const absDiffX = Math.abs(diffX);
    const absDiffY = Math.abs(diffY);
    const clickThreshold = 5;

    if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
        swipeState.isClick = false;
    }

    if (swipeState.swipeDirection === null) {
        if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
            if (absDiffX > absDiffY) {
                swipeState.swipeDirection = 'horizontal';
            } else {
                swipeState.swipeDirection = 'vertical';
            }
        }
    }
    if (swipeState.swipeDirection === 'vertical') {
        handleSwipeEnd(e);
        return;
    }
    if (swipeState.swipeDirection === 'horizontal') {
        e.preventDefault();
        swipeState.currentX = currentX;
        let translation = diffX;
        if (translation > 0) translation = 0;
        if (translation < -90) translation = -90;
        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
    }
};

const handleSwipeEnd = (e) => {
    if (swipeState.isClick) {
        swipeState.isDragging = false;
        swipeState.activeContainer = null;
        return;
    }
    if (!swipeState.isDragging || !swipeState.activeContainer) return;

    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
    postItem.style.transition = 'transform 0.3s ease';

    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
    const diffX = finalX - swipeState.startX;
    const swipeThreshold = -40;

    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) {
        postItem.classList.add('swiped');
        postItem.style.transform = '';
    } else {
        postItem.classList.remove('swiped');
        postItem.style.transform = '';
    }

    swipeState.isDragging = false;
    swipeState.startX = 0;
    swipeState.startY = 0;
    swipeState.currentX = 0;
    swipeState.activeContainer = null;
    swipeState.swipeDirection = null;
    swipeState.isClick = true;
};

// --- Î™®Îì† Ïä¨ÎùºÏù¥Îìú Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ---
postsList.addEventListener('mousedown', handleSwipeStart);
document.addEventListener('mousemove', handleSwipeMove);
document.addEventListener('mouseup', handleSwipeEnd);
postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
postsList.addEventListener('touchend', handleSwipeEnd);

// --- Î™®Îì† ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ---
postsList.addEventListener('click', async (e) => {
    e.stopPropagation();
    const target = e.target;

    if (target.classList.contains('post-actions-btn')) {
        const container = target.closest('.qzone-post-container');
        if (container && container.dataset.postId) {
            showPostActions(parseInt(container.dataset.postId));
        }
        return;
    }

    if (target.closest('.qzone-post-delete-action')) {
        const container = target.closest('.qzone-post-container');
        if (!container) return;
        
        const postIdToDelete = parseInt(container.dataset.postId);
        if (isNaN(postIdToDelete)) return;

        const confirmed = await showCustomConfirm('Í≤åÏãúÎ¨º ÏÇ≠Ï†ú', 'Ïù¥ Í≤åÏãúÎ¨ºÏùÑ ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', { confirmButtonClass: 'btn-danger' });

        if (confirmed) {
            container.style.transition = 'all 0.3s ease';
            container.style.transform = 'scale(0.8)';
            container.style.opacity = '0';
        
            setTimeout(async () => {
                 await db.qzonePosts.delete(postIdToDelete);
                 
                 const notificationIdentifier = `(ID: ${postIdToDelete})`;
                 for (const chatId in state.chats) {
                     const chat = state.chats[chatId];
                     const originalHistoryLength = chat.history.length;
                     chat.history = chat.history.filter(msg => !(msg.role === 'system' && msg.content.includes(notificationIdentifier)));
                     if (chat.history.length < originalHistoryLength) {
                         await db.chats.put(chat);
                     }
                 }
                 await renderQzonePosts();
                 alert('Í≤åÏãúÎ¨ºÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
            }, 300);
        }
        return;
    }

    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("Ïù¥ÎØ∏ÏßÄ ÎÇ¥Ïö©", hiddenText.replace(/<br>/g, '\n'));
        return;
    }
    const icon = target.closest('.action-icon');
    if (icon) {
        const postContainer = icon.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        if (isNaN(postId)) return;
        if (icon.classList.contains('like')) {
            const post = await db.qzonePosts.get(postId);
            if (!post) return;
            if (!post.likes) post.likes = [];
            const userNickname = state.qzoneSettings.nickname;
            const userLikeIndex = post.likes.indexOf(userNickname);
            if (userLikeIndex > -1) {
                post.likes.splice(userLikeIndex, 1);
            } else {
                post.likes.push(userNickname);
                icon.classList.add('animate-like');
                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
            }
            await db.qzonePosts.update(postId, { likes: post.likes });
        }
        if (icon.classList.contains('favorite')) {
            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
            if (existingFavorite) {
                await db.favorites.delete(existingFavorite.id);
                await showCustomAlert('ÌåÅ', 'Ï∞ú Ìï¥Ï†úÎê®');
            } else {
                const postToSave = await db.qzonePosts.get(postId);
                if (postToSave) {
                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                    await showCustomAlert('ÌåÅ', 'Ï∞ú ÏÑ±Í≥µ!');
                }
            }
        }
        await renderQzonePosts();
        return;
    }
    const sendBtn = target.closest('.comment-send-btn');
    if (sendBtn) {
        const postContainer = sendBtn.closest('.qzone-post-container');
        if (!postContainer) return;
        const postId = parseInt(postContainer.dataset.postId);
        const commentInput = postContainer.querySelector('.comment-input');
        const commentText = commentInput.value.trim();
        if (!commentText) return alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÎπÑÏõåÎëò Ïàò ÏóÜÏñ¥Ïöî!');
        const post = await db.qzonePosts.get(postId);
        if (!post) return;
        if (!post.comments) post.comments = [];
        post.comments.push({ commenterName: state.qzoneSettings.nickname, text: commentText, timestamp: Date.now() });
        await db.qzonePosts.update(postId, { comments: post.comments });
        for (const chatId in state.chats) {
            const chat = state.chats[chatId];
            if (!chat.isGroup) {
                chat.history.push({ role: 'system', content: `[ÏãúÏä§ÌÖú ÏïåÎ¶º:'${state.qzoneSettings.nickname}' IDÍ∞Ä ${postId}Ïù∏ Í≤åÏãúÎ¨ºÏóê ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±ÌñàÏäµÎãàÎã§:\"${commentText}\"]`, timestamp: Date.now(), isHidden: true });
                await db.chats.put(chat);
            }
        }
        commentInput.value = '';
        await renderQzonePosts();
        return;
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº init() Ìï®ÏàòÏùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠Ïóê Îã§Ïùå Îëê Ï§ÑÏùÑ Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî ‚ñº‚ñº‚ñº

            // ÌîºÎìú ÌéòÏù¥ÏßÄÏôÄ Ï∞ú ÌéòÏù¥ÏßÄÏùò Îí§Î°ú Í∞ÄÍ∏∞ Î≤ÑÌäº Î∞îÏù∏Îî©
            document.getElementById('qzone-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));
            document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

            // ‚ñ≤‚ñ≤‚ñ≤ Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº init() Ìï®ÏàòÏùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠ÏóêÏÑú Ïù¥ Ï†ÑÏ≤¥ ÏΩîÎìúÎ•º ÌôïÏù∏ÌïòÍ≥† ÌôïÎ≥¥ÌïòÏÑ∏Ïöî ‚ñº‚ñº‚ñº

            // Ï∞ú ÌéòÏù¥ÏßÄ Í≤ÄÏÉâ Í∏∞Îä•
            const searchInput = document.getElementById('favorites-search-input');
            const searchClearBtn = document.getElementById('favorites-search-clear-btn');

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.trim().toLowerCase();
                
                // ÏßÄÏö∞Í∏∞ Î≤ÑÌäº ÌëúÏãú Ï†úÏñ¥/Ïà®Í∏∞Í∏∞
                searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                if (!searchTerm) {
                    displayFilteredFavorites(allFavoriteItems); // Í≤ÄÏÉâÏ∞ΩÏù¥ ÎπÑÏñ¥ ÏûàÏúºÎ©¥ Î™®Îëê ÌëúÏãú
                    return;
                }

                // ÌïÑÌÑ∞ÎßÅ Î°úÏßÅ
                const filteredItems = allFavoriteItems.filter(item => {
                    let contentToSearch = '';
                    let authorToSearch = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                        if (post.authorId === 'user') {
                            authorToSearch = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorToSearch = state.chats[post.authorId].name;
                        }
                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        if (typeof msg.content === 'string') {
                            contentToSearch = msg.content;
                        }
                        const chat = state.chats[item.chatId];
                        if (chat) {
                           if (msg.role === 'user') {
                                authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'ÎÇ¥') : 'ÎÇ¥';
                           } else {
                                authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                           }
                        }
                    }
                    
                    // ÎÇ¥Ïö©Í≥º ÏûëÏÑ±ÏûêÎ•º ÎèôÏãúÏóê Í≤ÄÏÉâÌïòÎ©∞, ÎåÄÏÜåÎ¨∏Ïûê Íµ¨Î∂Ñ Ïïà Ìï®
                    return contentToSearch.toLowerCase().includes(searchTerm) || 
                           authorToSearch.toLowerCase().includes(searchTerm);
                });

                displayFilteredFavorites(filteredItems);
            });

            // ÏßÄÏö∞Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
            searchClearBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchClearBtn.style.display = 'none';
                displayFilteredFavorites(allFavoriteItems);
                searchInput.focus();
            });

            // ‚ñ≤‚ñ≤‚ñ≤ ÏΩîÎìú Í≤ÄÏÇ¨ ÏôÑÎ£å ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº ÏÉàÎ°ú Ï∂îÍ∞Ä/ÏàòÏ†ïÎêú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
            
            // Ï±ÑÌåÖ ÌôîÎ©¥Ïùò ÏùºÍ¥Ñ Ï∞ú Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
                        // Ï±ÑÌåÖ ÌôîÎ©¥Ïùò ÏùºÍ¥Ñ Ï∞ú Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© (ÏàòÏ†ï ÏôÑÎ£å)
            document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                if (selectedMessages.size === 0) return;
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const favoritesToAdd = [];
                const timestampsToFavorite = [...selectedMessages];

                for (const timestamp of timestampsToFavorite) {
                    // „ÄêÌïµÏã¨ ÏàòÏ†ï 1„ÄëÏÉàÎ°≠Í≥† Ìö®Ïú®Ï†ÅÏù∏ Ïù∏Îç±Ïä§Î•º ÏÇ¨Ïö©ÌïòÏó¨ ÏøºÎ¶¨
                    const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();
                    
                    if (!existing) {
                        const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                        if (messageToSave) {
                            favoritesToAdd.push({
                                type: 'chat_message',
                                content: messageToSave,
                                chatId: state.activeChatId,
                                timestamp: Date.now(), // Ïù¥Í≤ÉÏùÄ Ï∞ú ÏûëÏóÖÏù¥ Î∞úÏÉùÌïú ÏãúÍ∞ÑÏûÖÎãàÎã§
                                originalTimestamp: messageToSave.timestamp // „ÄêÌïµÏã¨ ÏàòÏ†ï 2„ÄëÏõêÎ≥∏ Î©îÏãúÏßÄÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º ÏÉà ÌïÑÎìúÏóê Ï†ÄÏû•
                            });
                        }
                    }
                }

                if (favoritesToAdd.length > 0) {
                    await db.favorites.bulkAdd(favoritesToAdd);
                    allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // Ï†ÑÏó≠ Ï∞ú Ï∫êÏãú ÏóÖÎç∞Ïù¥Ìä∏
                    await showCustomAlert('Ï∞ú ÏÑ±Í≥µ', `ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ${favoritesToAdd.length}Í∞úÏùò Î©îÏãúÏßÄÎ•º Ï∞úÌñàÏäµÎãàÎã§.`);
                } else {
                    await showCustomAlert('ÌåÅ', 'ÏÑ†ÌÉùÎêú Î©îÏãúÏßÄÎäî Ïù¥ÎØ∏ Î™®Îëê Ï∞úÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                }
                
                exitSelectionMode();
            });

            // Ï∞ú ÌéòÏù¥ÏßÄÏùò"Ìé∏Ïßë"Î≤ÑÌäº Ïù¥Î≤§Ìä∏ (ÏàòÏ†ï ÏôÑÎ£å)
            const favoritesEditBtn = document.getElementById('favorites-edit-btn');
            const favoritesView = document.getElementById('favorites-view');
            const favoritesActionBar = document.getElementById('favorites-action-bar');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // Î©îÏù∏ ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î Í∞ÄÏ†∏Ïò§Í∏∞
            const favoritesList = document.getElementById('favorites-list'); // Ï∞ú Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
            
            favoritesEditBtn.addEventListener('click', () => {
                isFavoritesSelectionMode = !isFavoritesSelectionMode;
                favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                if (isFavoritesSelectionMode) {
                    // --- Ìé∏Ïßë Î™®Îìú ÏßÑÏûÖ ---
                    favoritesEditBtn.textContent = 'ÏôÑÎ£å';
                    favoritesActionBar.style.display = 'block'; // ÏÇ≠Ï†ú ÏûëÏóÖ Î∞î ÌëúÏãú
                    mainBottomNav.style.display = 'none'; // ‚ñº ÏÉàÎ°ú Ï∂îÍ∞Ä:Ï£º ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î Ïà®Í∏∞Í∏∞
                    favoritesList.style.paddingBottom = '80px'; // ‚ñº ÏÉàÎ°ú Ï∂îÍ∞Ä:Î™©Î°ù ÌïòÎã®Ïóê Í≥µÍ∞Ñ Ï∂îÍ∞Ä
                } else {
                    // --- Ìé∏Ïßë Î™®Îìú Ï¢ÖÎ£å ---
                    favoritesEditBtn.textContent = 'Ìé∏Ïßë';
                    favoritesActionBar.style.display = 'none'; // ÏÇ≠Ï†ú ÏûëÏóÖ Î∞î Ïà®Í∏∞Í∏∞
                    mainBottomNav.style.display = 'flex';  // ‚ñº ÏÉàÎ°ú Ï∂îÍ∞Ä:Ï£º ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î Î≥µÏõê
                    favoritesList.style.paddingBottom = ''; // ‚ñº ÏÉàÎ°ú Ï∂îÍ∞Ä:Î™©Î°ù Í∏∞Î≥∏ Ìå®Îî© Î≥µÏõê

                    // Ï¢ÖÎ£å Ïãú Î™®Îì† ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
                    selectedFavorites.clear();
                    document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                    document.getElementById('favorites-delete-selected-btn').textContent = `ÏÇ≠Ï†ú (0)`;
                }
            });

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ„ÄêÏôÑÏ†ÑÌûà ÎåÄÏ≤¥„ÄëÏïÑÎûò ÏàòÏ†ïÎêú ÏΩîÎìúÎ°ú ‚ñº‚ñº‚ñº
// Ï∞ú Î™©Î°ù ÌÅ¥Î¶≠ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ (Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ)
document.getElementById('favorites-list').addEventListener('click', (e) => {
    const target = e.target;
    const card = target.closest('.favorite-item-card');

    // „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÌÖçÏä§Ìä∏ Í∑∏Î¶º ÌÅ¥Î¶≠ Ï≤òÎ¶¨, Ïù¥ Î°úÏßÅÏùÄ Îß® ÏïûÏóê Î∞∞ÏπòÌïòÏó¨ Ïñ¥Îñ§ Î™®ÎìúÏóêÏÑúÎì† ÏûëÎèôÌïòÎèÑÎ°ù Î≥¥Ïû•Ìï¥Ïïº Ìï©ÎãàÎã§
    if (target.tagName === 'IMG' && target.dataset.hiddenText) {
        const hiddenText = target.dataset.hiddenText;
        showCustomAlert("Ïù¥ÎØ∏ÏßÄ ÎÇ¥Ïö©", hiddenText.replace(/<br>/g, '\n'));
        return; // Ï≤òÎ¶¨ ÏôÑÎ£å ÌõÑ Ï¢ÖÎ£å, ÏÑ†ÌÉù Î°úÏßÅÏùÄ Í≥ÑÏÜç Ïã§ÌñâÌïòÏßÄ ÏïäÏùå
    }
    
    // ÏÑ†ÌÉù Î™®ÎìúÍ∞Ä ÏïÑÎãàÎ©¥ Ïù¥ÌõÑ ÏÑ†ÌÉù ÏûëÏóÖÏùÑ Ïã§ÌñâÌïòÏßÄ ÏïäÏùå
    if (!isFavoritesSelectionMode) return;

    // --- Îã§ÏùåÏùÄ ÏõêÎûòÏùò ÏÑ†ÌÉù Î°úÏßÅÏù¥Î©∞, Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏäµÎãàÎã§ ---
    if (!card) return;

    const favId = parseInt(card.dataset.favid);
    if (isNaN(favId)) return;

    // ÏÑ†ÌÉù ÏÉÅÌÉú Ï†ÑÌôò
    if (selectedFavorites.has(favId)) {
        selectedFavorites.delete(favId);
        card.classList.remove('selected');
    } else {
        selectedFavorites.add(favId);
        card.classList.add('selected');
    }
    
    // ÌïòÎã® ÏÇ≠Ï†ú Î≤ÑÌäº Ïπ¥Ïö¥Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
    document.getElementById('favorites-delete-selected-btn').textContent = `ÏÇ≠Ï†ú (${selectedFavorites.size})`;
});

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ„ÄêÏôÑÏ†ÑÌûà ÎåÄÏ≤¥„ÄëÏïÑÎûò ÏàòÏ†ïÎêú ÏΩîÎìúÎ°ú ‚ñº‚ñº‚ñº
// Ï∞ú ÌéòÏù¥ÏßÄ ÏùºÍ¥Ñ ÏÇ≠Ï†ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
    if (selectedFavorites.size === 0) return;

    const confirmed = await showCustomConfirm(
        'ÏÇ≠Ï†ú ÌôïÏù∏', 
        `Ï∞ú Î™©Î°ùÏóêÏÑú Ïù¥ ${selectedFavorites.size}Í∞úÏùò Ìï≠Î™©ÏùÑ Ï†úÍ±∞ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`, 
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        const idsToDelete = [...selectedFavorites];
        await db.favorites.bulkDelete(idsToDelete);
        await showCustomAlert('ÏÇ≠Ï†ú ÏÑ±Í≥µ', 'ÏÑ†ÌÉùÎêú Ï∞ú Ìï≠Î™©Ïù¥ Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§.');
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï 1„ÄëÌîÑÎü∞Ìä∏ÏóîÎìú Ï∫êÏãúÏóêÏÑúÎèÑ ÏÇ≠Ï†úÎêú Ìï≠Î™© Ï†úÍ±∞
        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));
        
        // „ÄêÌïµÏã¨ ÏàòÏ†ï 2„ÄëÏóÖÎç∞Ïù¥Ìä∏Îêú Ï∫êÏãúÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ï¶âÏãú Î™©Î°ù Îã§Ïãú Î†åÎçîÎßÅ
        displayFilteredFavorites(allFavoriteItems);
        
        // ÎßàÏßÄÎßâÏúºÎ°ú Ìé∏Ïßë Î™®Îìú Ï¢ÖÎ£å
        favoritesEditBtn.click(); // ÌÅ¥Î¶≠ ÏãúÎÆ¨Î†àÏù¥ÏÖò"ÏôÑÎ£å"Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ìé∏Ïßë Î™®Îìú Ï¢ÖÎ£å
    }
});

// ‚ñº‚ñº‚ñº init() Ìï®Ïàò ÎÅùÏóê Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº
if (state.globalSettings.enableBackgroundActivity) {
    startBackgroundSimulation();
    console.log("Î∞±Í∑∏ÎùºÏö¥Îìú ÌôúÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖòÏù¥ ÏûêÎèôÏúºÎ°ú ÏãúÏûëÎêòÏóàÏäµÎãàÎã§.");
}
// ‚ñ≤‚ñ≤‚ñ≤ Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏù¥Í≤ÉÏù¥ ÏµúÏ¢Ö ÏàòÏ†ïÎêú ÏΩîÎìúÏûÖÎãàÎã§„ÄëÏù¥ ÏΩîÎìúÎ•º initÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî() Ïùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠ ÎÅùÏóê ‚ñº‚ñº‚ñº

// --- ÎØ∏Î¶¨Î≥¥Í∏∞Ïóê ÏòÅÌñ•ÏùÑ ÎØ∏ÏπòÎäî Î™®Îì† Ïª®Ìä∏Î°§Ïùò Ïù¥Î≤§Ìä∏Î•º ÏùºÍ¥Ñ Ï≤òÎ¶¨ ---

// 1. ÌÖåÎßà ÏÑ†ÌÉù Î¶¨Ïä§Îãù
document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
    radio.addEventListener('change', updateSettingsPreview);
});

// 2. Í∏ÄÍº¥ ÌÅ¨Í∏∞ Ïä¨ÎùºÏù¥Îçî Î¶¨Ïä§Îãù
const fontSizeSlider = document.getElementById('font-size-slider');
fontSizeSlider.addEventListener('input', () => {
    // a. Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í∞í ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
    // b. ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
    updateSettingsPreview();
});

// 3. ÏÇ¨Ïö©Ïûê Ï†ïÏùò CSS ÏûÖÎ†•ÎûÄ Î¶¨Ïä§Îãù
const customCssInputForPreview = document.getElementById('custom-css-input');
customCssInputForPreview.addEventListener('input', updateSettingsPreview);

// 4. Ï¥àÍ∏∞Ìôî Î≤ÑÌäº Î¶¨Ïä§Îãù
document.getElementById('reset-theme-btn').addEventListener('click', () => {
    document.getElementById('theme-default').checked = true;
    updateSettingsPreview();
});

document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
    document.getElementById('custom-css-input').value = '';
    updateSettingsPreview();
});

// ‚ñ≤‚ñ≤‚ñ≤ Î∂ôÏó¨ÎÑ£Í∏∞ Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥ Î∂ÄÎ∂ÑÏùÑ„ÄêÏÉà ÏΩîÎìú„ÄëinitÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî() Ïùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠ ÎÅùÏóê ‚ñº‚ñº‚ñº
document.querySelectorAll('input[name="visibility"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const groupsContainer = document.getElementById('post-visibility-groups');
        if (this.value === 'include' || this.value === 'exclude') {
            groupsContainer.style.display = 'block';
        } else {
            groupsContainer.style.display = 'none';
        }
    });
});
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥ Î∂ÄÎ∂ÑÏùÑ„ÄêÏÉà ÏΩîÎìú„ÄëinitÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî() Ïùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠ ÎÅùÏóê ‚ñº‚ñº‚ñº
document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
document.getElementById('close-group-manager-btn').addEventListener('click', () => {
    document.getElementById('group-management-modal').classList.remove('visible');
    // Ï±ÑÌåÖ ÏÑ§Ï†ïÏùò Í∑∏Î£π Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
    const chatSettingsBtn = document.getElementById('chat-settings-btn');
    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
       chatSettingsBtn.click(); // Îã§Ïãú ÌÅ¥Î¶≠ÌïòÏó¨ Îã§Ïãú Ïó¥Í∏∞
    }
});

document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
document.getElementById('existing-groups-list').addEventListener('click', (e) => {
    if (e.target.classList.contains('delete-group-btn')) {
        const groupId = parseInt(e.target.dataset.id);
        deleteGroup(groupId);
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥ Î∂ÄÎ∂ÑÏùÑ„ÄêÏÉà ÏΩîÎìú„ÄëinitÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî() Ïùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠ ÎÅùÏóê ‚ñº‚ñº‚ñº
// Î©îÏãúÏßÄ ÏûëÏóÖ Î©îÎâ¥Ïùò Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
// ‚ñº‚ñº‚ñº „ÄêÏàòÏ†ï„ÄëÏÉàÎ°úÏö¥ Ìé∏ÏßëÍ∏∞ ÏûÖÍµ¨ ÏÇ¨Ïö© ‚ñº‚ñº‚ñº
document.getElementById('edit-message-btn').addEventListener('click', openAdvancedMessageEditor);
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤
document.getElementById('copy-message-btn').addEventListener('click', copyMessageContent);

// ‚ñº‚ñº‚ñº Ïù¥ Î∂ÄÎ∂ÑÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî„ÄêÏàòÏ†ï ÌõÑ„ÄëÏΩîÎìúÎ°ú Í∏∞Ï°¥ ÏÑ†ÌÉùÏùÑ ÎåÄÏ≤¥-message-btn Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
document.getElementById('select-message-btn').addEventListener('click', () => {
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÎ©îÎâ¥Î•º Îã´Í∏∞ Ï†ÑÏóê Î®ºÏ†Ä ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∫°Ï≤ò
    const timestampToSelect = activeMessageTimestamp; 
    hideMessageActions();
    // Ï∫°Ï≤òÎêú Í∞í ÏÇ¨Ïö©
    if (timestampToSelect) {
        enterSelectionMode(timestampToSelect);
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº init() Ìï®ÏàòÏùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠ ÎÅùÏóê Ï∂îÍ∞Ä ‚ñº‚ñº‚ñº

// Í≤åÏãúÎ¨º ÏûëÏóÖ Î©îÎâ¥Ïùò Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);

// ‚ñ≤‚ñ≤‚ñ≤ Ï∂îÍ∞Ä Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥ Î∂ÄÎ∂ÑÏùÑ„ÄêÎàÑÎùΩÎêú„ÄëÏù¥Î≤§Ìä∏ Î¶¨Ïä§Îãù ÏΩîÎìúÎ•º initÏóê Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî() Ìï®ÏàòÏùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏòÅÏó≠ ÎÅù ‚ñº‚ñº‚ñº

// ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÌîÑÎ†àÏûÑ ÏÑ†ÌÉù Î™®Îã¨ Ï∞ΩÏùò Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.getElementById('save-frame-settings-btn').addEventListener('click', saveSelectedFrames);
document.getElementById('cancel-frame-settings-btn').addEventListener('click', () => {
    frameModal.classList.remove('visible');
    editingFrameForMember = false; // Ïû¨ÏÑ§Ï†ï ÏÉÅÌÉúÎ•º ÌôïÏã§Ìûà ÌïòÎã§
});

// ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÌîÑÎ†àÏûÑ ÌÉ≠ Ï†ÑÌôò Ïù¥Î≤§Ìä∏
aiFrameTab.addEventListener('click', () => {
    aiFrameTab.classList.add('active');
    myFrameTab.classList.remove('active');
    aiFrameContent.style.display = 'block';
    myFrameContent.style.display = 'none';
});
myFrameTab.addEventListener('click', () => {
    myFrameTab.classList.add('active');
    aiFrameTab.classList.remove('active');
    myFrameContent.style.display = 'block';
    aiFrameContent.style.display = 'none';
});

// ‚ñ≤‚ñ≤‚ñ≤ ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÏàòÏ†ï ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÏó∞ÎùΩÏ≤ò ÏÑ†ÌÉùÍ∏∞ Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ‚ñº‚ñº‚ñº
document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
    showScreen('chat-list-screen');
});

document.getElementById('contact-picker-list').addEventListener('click', (e) => {
    const item = e.target.closest('.contact-picker-item');
    if (!item) return;

    const contactId = item.dataset.contactId;
    item.classList.toggle('selected');
    
    if (selectedContacts.has(contactId)) {
        selectedContacts.delete(contactId);
    } else {
        selectedContacts.add(contactId);
    }
    updateContactPickerConfirmButton();
});

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÎ∞îÏù∏Îî©\"Í∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨\"Î≤ÑÌäº Ïù¥Î≤§Ìä∏ ‚ñº‚ñº‚ñº
document.getElementById('manage-members-btn').addEventListener('click', () => {
    // ÌôîÎ©¥ Ï†ÑÌôò Ï†ÑÏóê ÌòÑÏû¨Ïùò Ï±ÑÌåÖ ÏÑ§Ï†ï ÌåùÏóÖÏùÑ Î®ºÏ†Ä Ïà®Í∏∞ÏÑ∏Ïöî
    document.getElementById('chat-settings-modal').classList.remove('visible');
    // Í∑∏Î¶¨Í≥† ÎÇòÏÑú Î©§Î≤Ñ Í¥ÄÎ¶¨ ÌôîÎ©¥ÏùÑ Ïó¨ÏÑ∏Ïöî
    openMemberManagementScreen();
});
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏµúÏ¢Ö ÏôÑÏ†ÑÌåê„ÄëÍ∑∏Î£π Î©§Î≤Ñ Í¥ÄÎ¶¨ Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ‚ñº‚ñº‚ñº
document.getElementById('back-from-member-management').addEventListener('click', () => {

    showScreen('chat-interface-screen');    
    document.getElementById('chat-settings-btn').click();
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

document.getElementById('member-management-list').addEventListener('click', (e) => {
    // „ÄêÎ≥µÍµ¨Îê®„ÄëÎ©§Î≤Ñ Ï†úÍ±∞ Ïù¥Î≤§Ìä∏
    if (e.target.classList.contains('remove-member-btn')) {
        removeMemberFromGroup(e.target.dataset.memberId);
    }
});

document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
    // „ÄêÎ≥µÍµ¨Îê®„ÄëÏπúÍµ¨ Î™©Î°ùÏóêÏÑú Ï∂îÍ∞ÄÎêú Ïù¥Î≤§Ìä∏
    // „ÄêÌïµÏã¨„ÄëÏóê\"ÏôÑÎ£å\"Î≤ÑÌäº Î∞îÏù∏Îî©\"ÏÇ¨ÎûåÏùÑ Í∑∏Î£πÏóê Ï¥àÎåÄÌïòÍ∏∞\"Î°úÏßÅ
    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
    // ÎÖ∏Îìú Î≥µÏ†ú Î∞©Î≤ïÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ïò§ÎûòÎêú Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑàÎ•º Ï†úÍ±∞ÌïòÍ≥† Ï§ëÎ≥µ Î∞îÏù∏Îî©ÏùÑ Î∞©ÏßÄÌï©ÎãàÎã§
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);
    
    await openContactPickerForAddMember();
});

document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÌôîÏÉÅ ÌÜµÌôî Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº

// 1:1 Ï±ÑÌåÖ Î∞è Í∑∏Î£π Ï±ÑÌåÖ ÏãúÏûë Î≤ÑÌäº Î∞îÏù∏Îî©
document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);

// Î∞îÏù∏Îî©\"ÎÅäÍ∏∞\"Î≤ÑÌäº
document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);

// Î∞îÏù∏Îî©\"Ìò∏Ï∂ú Ï∑®ÏÜå\"Î≤ÑÌäº
document.getElementById('cancel-call-btn').addEventListener('click', () => {
    videoCallState.isAwaitingResponse = false;
    showScreen('chat-interface-screen');
});

// „ÄêÏÉàÎ°úÏö¥„ÄëÎ∞îÏù∏Îî©\"ÌÜµÌôî Ï∞∏Í∞Ä\"Î≤ÑÌäº
document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÍ¥ÄÏ†Ñ Î™®Îìú ÏàòÏ†ï Î∞è ÌôúÏÑ±ÌôîÎê®„ÄëÏùò Î≤ÑÏ†ÑÏù¥ Ïò§ÎûòÎêú declineÏùÑ ÎåÄÏ≤¥Ìï©ÎãàÎã§-call-btn Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
// ÏàòÏã† Ï†ÑÌôî ÏöîÏ≤≠ Î∞îÏù∏Îî©\"Í±∞Ï†à\"Î≤ÑÌäº
document.getElementById('decline-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    const chat = state.chats[videoCallState.activeChatId];
    if (!chat) return;
    
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏó¨Í∏∞ÏóêÏÑú Í±∞Ï†à Î°úÏßÅÏùÑ API Ìò∏Ï∂úÍ≥º Ïó∞Í≤∞Ìï©ÎãàÎã§
    if (videoCallState.isGroupCall) {
        videoCallState.isUserParticipating = false; // ÏÇ¨Ïö©ÏûêÎ•º Í¥ÄÏ†ÑÏûêÎ°ú ÌëúÏãú
        
        // 1. AI ÏÇ¨Ïö©ÏûêÏóêÍ≤å Í±∞Ï†àÌñàÎã§Í≥† ÏïåÎ¶¨Îäî Ïà®Í≤®ÏßÑ Î©îÏãúÏßÄÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§
        const systemNote = {
            role: 'system',
            content: `[ÏãúÏä§ÌÖú ÏïåÎ¶º:ÏÇ¨Ïö©ÏûêÍ∞Ä ÌÜµÌôî Ï¥àÎåÄÎ•º Í±∞Ï†àÌñàÏßÄÎßå, ÎÑàÌù¨Îäî Ïä§Ïä§Î°ú ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§. Í∞ÅÏûê Ï∞∏Ïó¨ Ïó¨Î∂ÄÎ•º Í≤∞Ï†ïÌï¥ Ï£ºÏÑ∏Ïöî.]`,
            timestamp: Date.now(),
            isHidden: true
        };
        chat.history.push(systemNote);
        await db.chats.put(chat);
        
        // 2. „ÄêÌïµÏã¨„ÄëAI ÏùëÎãµÏùÑ Ìä∏Î¶¨Í±∞ÌïòÏó¨ Í∑∏Î£π Ï±ÑÌåÖ ÏãúÏûë Ïó¨Î∂ÄÎ•º Ïä§Ïä§Î°ú Í≤∞Ï†ïÌïòÍ≤å Ìï©ÎãàÎã§
        // Ïù¥Í≤ÉÏùÄ Î∞±Í∑∏ÎùºÏö¥ÎìúÏóêÏÑú Ï≤òÎ¶¨Îê† Í≤ÉÏù¥Î©∞, ÎßåÏïΩ AIÎì§Ïù¥ ÏãúÏûëÌïòÍ∏∞Î°ú Í≤∞Ï†ïÌïòÎ©¥ ÏµúÏ¢ÖÏ†ÅÏúºÎ°ú startVideoCallÏùÑ Ìò∏Ï∂úÌï† Í≤ÉÏûÖÎãàÎã§()
        await triggerAiResponse(); 
        
    } else { // 1:1 Ï±ÑÌåÖ Í±∞Ï†à Î°úÏßÅÏùÄ Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÍ≥† Ïú†ÏßÄÎê©ÎãàÎã§
        const declineMessage = { role: 'user', content: 'ÎÇ¥Í∞Ä ÎÑàÏùò ÌôîÏÉÅ ÌÜµÌôî ÏöîÏ≤≠ÏùÑ Í±∞Ï†àÌñàÏñ¥.', timestamp: Date.now() };
        chat.history.push(declineMessage);
        await db.chats.put(chat);
        
        // Ï±ÑÌåÖ ÌôîÎ©¥ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÏÑú Í±∞Ï†à Î©îÏãúÏßÄÎ•º ÌëúÏãúÌï©ÎãàÎã§
        showScreen('chat-interface-screen');
        appendMessage(declineMessage, chat);
        
        // AIÍ∞Ä ÎÑàÏùò Í±∞Ï†àÏóê ÏùëÎãµÌïòÍ≤å Ìï©ÎãàÎã§
        triggerAiResponse();
    }
    
    // ÎßåÏïΩÏùÑ ÎåÄÎπÑÌïòÏó¨ ÏÉÅÌÉúÎ•º Ï†ïÎ¶¨Ìï©ÎãàÎã§
    videoCallState.isAwaitingResponse = false;
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏ§ëÎ≥µ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Î≤ÑÍ∑∏ ÏàòÏ†ïÎê®„ÄëÏùò Î≤ÑÏ†ÑÏù¥ Ïò§ÎûòÎêú acceptÎ•º ÎåÄÏ≤¥Ìï©ÎãàÎã§-call-btn Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
// ÏàòÏã† Ï†ÑÌôî ÏöîÏ≤≠ Î∞îÏù∏Îî©\"Î∞õÍ∏∞\"Î≤ÑÌäº
document.getElementById('accept-call-btn').addEventListener('click', async () => {
    hideIncomingCallModal();
    
    videoCallState.initiator = 'ai';
    videoCallState.isUserParticipating = true;
    videoCallState.activeChatId = state.activeChatId;
    
    // „ÄêÌïµÏã¨ ÏàòÏ†ï„ÄëÏö∞Î¶¨Îäî Ïó¨Í∏∞ÏóêÏÑú Îçî Ïù¥ÏÉÅ ÏÇ¨Ïö©ÏûêÎ•º participants Î™©Î°ùÏóê ÏàòÎèôÏúºÎ°ú Ï∂îÍ∞ÄÌïòÏßÄ ÏïäÏäµÎãàÎã§
    if (videoCallState.isGroupCall) {
        // Í∑∏Î£π Ï±ÑÌåÖÏùò Í≤ΩÏö∞, Ïö∞Î¶¨Îäî Ïò§ÏßÅ„ÄêÌÜµÌôîÎ•º ÏãúÏûëÌïú AI„ÄëÏ∞∏Ïó¨Ïûê Î™©Î°ùÏóê Ï∂îÍ∞ÄÌï©ÎãàÎã§
        const chat = state.chats[videoCallState.activeChatId];
        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
        if (requester) {
            // Ï°¥Ïû¨Ìï† Ïàò ÏûàÎäî Ïò§ÎûòÎêú Îç∞Ïù¥ÌÑ∞Î•º ÎπÑÏö∞Í≥†, Í∑∏Î¶¨Í≥† ÎÇòÏÑú Ïò§ÏßÅ ÏãúÏûëÏûêÎßå Ï∂îÍ∞ÄÌï©ÎãàÎã§
            videoCallState.participants = [requester];
        } else {
            videoCallState.participants = []; // ÎßåÏïΩ ÏãúÏûëÏûêÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏúºÎ©¥, ÎπÑÏõÅÎãàÎã§
        }
    }
    
    // 1:1 Ï±ÑÌåÖÏù¥Îì† Í∑∏Î£π Ï±ÑÌåÖÏù¥Îì†, ÏßÅÏ†ë ÌÜµÌôî ÌôîÎ©¥ÏùÑ ÏãúÏûëÌï©ÎãàÎã§!
    startVideoCall();
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤


// ‚ñº‚ñº‚ñº Ïù¥Í≤ÉÏùÑ ÏÇ¨Ïö©ÌïòÏã≠ÏãúÏò§„ÄêÏÇ¨Ïö©Ïûê ÌïòÏù¥ÎùºÏù¥Ìä∏ Ï∂îÍ∞ÄÎê®„ÄëÏùò ÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥ Î≤ÑÏ†ÑÏù¥ Ïò§ÎûòÎêú userÎ•º ÏôÑÏ†ÑÌûà ÎåÄÏ≤¥Ìï©ÎãàÎã§-speak-btn Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
// ÏÇ¨Ïö©ÏûêÍ∞Ä ÌÜµÌôî Ï§ëÏóê Î∞úÏñ∏ÌïòÎäî Î≤ÑÌäº Î∞îÏù∏Îî©
document.getElementById('user-speak-btn').addEventListener('click', async () => {
    if (!videoCallState.isActive) return;

    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ÌïµÏã¨ Ï∂îÍ∞Ä:ÏûÖÎ†•Ï∞ΩÏù¥ ÌåùÏóÖÎêòÍ∏∞ Ï†ÑÏóê, Î®ºÏ†Ä ÏÇ¨Ïö©Ïûê ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑÏùÑ Ï∞æÍ≥† ÌïòÏù¥ÎùºÏù¥Ìä∏Ìï©ÎãàÎã§ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
    const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
    if (userAvatar) {
        userAvatar.classList.add('speaking');
    }

    const userInput = await showCustomPrompt('ÎãπÏã†Ïù¥ ÎßêÌïòÍ∏∞Î•º', 'ÌïòÍ≥† Ïã∂ÏùÄ ÎßêÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî...');
    
    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ ÌïµÏã¨ Ï∂îÍ∞Ä:ÏÇ¨Ïö©ÏûêÍ∞Ä ÏûÖÎ†•ÌñàÎì† Ïïà ÌñàÎì†, ÏûÖÎ†•Ï∞ΩÏùÑ Îã´Í∏∞Îßå ÌïòÎ©¥ ÌïòÏù¥ÎùºÏù¥Ìä∏Î•º Ï†úÍ±∞Ìï©ÎãàÎã§ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
    if (userAvatar) {
        userAvatar.classList.remove('speaking');
    }

    if (userInput && userInput.trim()) {
        triggerAiInCallAction(userInput.trim());
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÎåÄÏ≤¥ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÌöåÍ≥†Î°ù Í¥ÄÎ†® Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ‚ñº‚ñº‚ñº
// 1. ÏùÑ\"Ï∂îÏñµ\"ÌÉ≠Í≥º Í∑∏Í≤ÉÏùò Î∑∞Î•º Ïó∞Í≤∞Ìï©ÎãàÎã§
document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
    // Ï†ÑÌôòÌïòÍ∏∞ Ï†ÑÏóê, ÌôïÏã§Ìûà"Ïª¨Î†âÏÖò"ÌéòÏù¥ÏßÄÏùò Ìé∏Ïßë Î™®ÎìúÍ∞Ä Îã´ÌòÄ ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî
    if (isFavoritesSelectionMode) {
        document.getElementById('favorites-edit-btn').click(); 
    }
    switchToChatListView('memories-view');
    renderMemoriesScreen(); // ÌÅ¥Î¶≠ Ïãú Î†åÎçîÎßÅ
});

// 2. ÌöåÍ≥†Î°ù ÌôîÎ©¥Ïùò Îí§Î°ú Í∞ÄÍ∏∞ Î≤ÑÌäº Î∞îÏù∏Îî©
document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉàÎ°úÏö¥ Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// „ÄêÏÉàÎ°úÏö¥„ÄëÏïΩÏÜç/Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
document.getElementById('add-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.add('visible');
});
document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
    document.getElementById('create-countdown-modal').classList.remove('visible');
});
document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
    const title = document.getElementById('countdown-title-input').value.trim();
    const dateValue = document.getElementById('countdown-date-input').value;
    
    if (!title || !dateValue) {
        alert('ÏôÑÏ†ÑÌïú ÏïΩÏÜç Ï†úÎ™©Í≥º ÎÇ†ÏßúÎ•º ÏûëÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî!');
        return;
    }

    const targetDate = new Date(dateValue);
    if (isNaN(targetDate) || targetDate <= new Date()) {
        alert('Ïú†Ìö®ÌïòÍ≥† ÎØ∏ÎûòÏùò ÎÇ†ÏßúÎ•º ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!');
        return;
    }

    const newCountdown = {
        chatId: null, // ÏÇ¨Ïö©ÏûêÍ∞Ä ÏÉùÏÑ±Ìïú Í≤ÉÏù¥Î©∞, Ïñ¥Îñ§ ÌäπÏ†ï AIÏóêÎèÑ ÏÜçÌïòÏßÄ ÏïäÏäµÎãàÎã§
        authorName: 'ÎÇ¥',
        description: title,
        timestamp: Date.now(),
        type: 'countdown',
        targetDate: targetDate.getTime()
    };
    
    await db.memories.add(newCountdown);
    document.getElementById('create-countdown-modal').classList.remove('visible');
    renderMemoriesScreen();
});

// „ÄêÏÉàÎ°úÏö¥„ÄëÏ∞®Îã® Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©
document.getElementById('block-chat-btn').addEventListener('click', async () => {
    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

    const chat = state.chats[state.activeChatId];
    const confirmed = await showCustomConfirm(
        'Ï∞®Îã® ÌôïÏù∏', 
        `Ï∞®Îã® ÌôïÏù∏\"${chat.name}\"Ï∞®Îã®ÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ï∞®Îã® ÌõÑÏóêÎäî Î∏îÎûôÎ¶¨Ïä§Ìä∏ÏóêÏÑú ÌÉÄÎ•º Ï†úÍ±∞ÌïòÍ±∞ÎÇò ÌÉÄÍ∞Ä Îã§Ïãú ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Ìï† ÎïåÍπåÏßÄ Î©îÏãúÏßÄÎ•º Î≥¥ÎÇº Ïàò ÏóÜÍ≤å Îê©ÎãàÎã§.`,
        { confirmButtonClass: 'btn-danger' }
    );

    if (confirmed) {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        await db.chats.put(chat);
        
        // ÏÑ§Ï†ï ÌåùÏóÖÏùÑ Îã´Í≥†, Ï±ÑÌåÖ ÌôîÎ©¥ÏùÑ ÏÉàÎ°ú Í≥†Ïπ©ÎãàÎã§
        document.getElementById('chat-settings-modal').classList.remove('visible');
        renderChatInterface(state.activeChatId);
        // Ï±ÑÌåÖ Î™©Î°ùÏùÑ ÏÉàÎ°ú Í≥†Ïπ®Ìï©ÎãàÎã§. UI Î≥ÄÍ≤ΩÏù¥ ÏûàÏùÑ Ïàò ÏûàÏäµÎãàÎã§
        renderChatList();
    }
});

document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
    const chat = state.chats[state.activeChatId];
    if (!chat) return;

    if (e.target.id === 'force-apply-check-btn') {
        alert("ÏàòÎèôÏúºÎ°ú ÏπúÍµ¨ Ïã†Ï≤≠ ÌîÑÎ°úÏÑ∏Ïä§Î•º Ìä∏Î¶¨Í±∞ÌïòÎäî Ï§ëÏûÖÎãàÎã§. Ïû†Ïãú ÌõÑ ÏãúÎèÑÌï¥ Ï£ºÏÑ∏Ïöî...\nÎßåÏïΩ API Ìò∏Ï∂úÏù¥ ÏÑ±Í≥µÌïòÎ©¥ ÏïåÎ¶ºÏù¥ ÌåùÏóÖÎê† Í≤ÉÏûÖÎãàÎã§. Ïã§Ìå®ÌïòÎ©¥ Ïò§Î•ò ÏïåÎ¶ºÏù¥ ÏûàÏùÑ Í≤ÉÏûÖÎãàÎã§. ÎßåÏïΩ Ïû•ÏãúÍ∞Ñ Î∞òÏùëÏù¥ ÏóÜÏúºÎ©¥ AIÍ∞Ä ÏùºÏãúÏ†ÅÏúºÎ°ú Ïã†Ï≤≠ÌïòÏßÄ ÏïäÍ∏∞Î°ú Í≤∞Ï†ïÌñàÏùÑ ÏàòÎèÑ ÏûàÏäµÎãàÎã§.");
        await triggerAiFriendApplication(chat.id);
        renderChatInterface(chat.id); 
        return;
    }

    if (e.target.id === 'unblock-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.blockedTimestamp = null;
        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
    }
    else if (e.target.id === 'accept-friend-btn') {
        chat.relationship.status = 'friend';
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
        renderChatList();
        const msg = { role: 'user', content: 'ÎÇ¥Í∞Ä ÎÑàÏùò ÏπúÍµ¨ ÏöîÏ≤≠ÏùÑ ÏäπÏù∏ÌñàÏñ¥', timestamp: Date.now() };
        chat.history.push(msg);
        await db.chats.put(chat);
        appendMessage(msg, chat);
        triggerAiResponse();
    }
    else if (e.target.id === 'reject-friend-btn') {
        chat.relationship.status = 'blocked_by_user';
        chat.relationship.blockedTimestamp = Date.now();
        chat.relationship.applicationReason = '';
        await db.chats.put(chat);
        renderChatInterface(chat.id);
    }
    // „ÄêÏÉàÎ°ú Ï∂îÍ∞Ä„ÄëÏπúÍµ¨ Ïã†Ï≤≠ Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
    else if (e.target.id === 'apply-friend-btn') {
        const reason = await showCustomPrompt(
            'ÏπúÍµ¨ Ïã†Ï≤≠ Î≥¥ÎÇ¥Í∏∞', 
            `ÎãπÏã†Ïù¥ ÏóêÍ≤å ÌïòÍ≥† Ïã∂ÏùÄ ÎßêÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî\"${chat.name}\"ÎßêÌï† Ïã†Ï≤≠ Ïù¥Ïú†:`,
            "Ïö∞Î¶¨ ÌôîÌï¥ÌïòÏûê!"
        );
        // ÏÇ¨Ïö©ÏûêÍ∞Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÍ≥† ÌÅ¥Î¶≠ÌñàÏùÑ ÎïåÎßå\"ÌôïÏù∏\"ÌõÑÏóê Í≥ÑÏÜç ÏßÑÌñâÎê©ÎãàÎã§
        if (reason !== null) {
            // Í¥ÄÍ≥Ñ ÏÉÅÌÉúÎ•º Î°ú ÏóÖÎç∞Ïù¥Ìä∏\"AI ÏäπÏù∏ ÎåÄÍ∏∞\"
            chat.relationship.status = 'pending_ai_approval';
            chat.relationship.applicationReason = reason;
            await db.chats.put(chat);

            // UIÎ•º ÏÉàÎ°ú Í≥†Ïπ®ÌïòÏó¨ ÌëúÏãú\"ÌÜµÍ≥º ÎåÄÍ∏∞\"ÌôîÎ©¥
            renderChatInterface(chat.id);
            renderChatList();
            
            // „ÄêÌïµÏã¨„ÄëAI ÏùëÎãµÏùÑ Ìä∏Î¶¨Í±∞ÌïòÏó¨ Ïù¥ ÏπúÍµ¨ Ïã†Ï≤≠ÏùÑ Ï≤òÎ¶¨ÌïòÎèÑÎ°ù Ìï©ÎãàÎã§
            triggerAiResponse();
        }
    }
});

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÌôçÎ∞îÏò§ Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ‚ñº‚ñº‚ñº

// 1. ÏõêÎûò ÏûàÎçò ÏÜ°Í∏à Î≤ÑÌäºÏùÑ(Ôø•)Ïùò ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î•º ÏÉàÎ°úÏö¥ Ï¥ù ÏûÖÍµ¨ Ìï®ÏàòÎ°ú Î¶¨ÎîîÎ†âÏÖòÌï©ÎãàÎã§
document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);

// 2. ÌôçÎ∞îÏò§ Î™®Îã¨ Ï∞Ω ÎÇ¥Î∂ÄÏùò Ï†úÏñ¥ Î≤ÑÌäº
document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
    document.getElementById('red-packet-modal').classList.remove('visible');
});
document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);

// 3. ÌôçÎ∞îÏò§ Î™®Îã¨ Ï∞ΩÏùò ÌÉ≠ Ï†ÑÌôò Î°úÏßÅ
const rpTabGroup = document.getElementById('rp-tab-group');
const rpTabDirect = document.getElementById('rp-tab-direct');
const rpContentGroup = document.getElementById('rp-content-group');
const rpContentDirect = document.getElementById('rp-content-direct');

rpTabGroup.addEventListener('click', () => {
    rpTabGroup.classList.add('active');
    rpTabDirect.classList.remove('active');
    rpContentGroup.style.display = 'block';
    rpContentDirect.style.display = 'none';
});
rpTabDirect.addEventListener('click', () => {
    rpTabDirect.classList.add('active');
    rpTabGroup.classList.remove('active');
    rpContentDirect.style.display = 'block';
    rpContentGroup.style.display = 'none';
});

// 4. Ïã§ÏãúÍ∞Ñ ÌôçÎ∞îÏò§ Í∏àÏï° ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
document.getElementById('rp-group-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-group-total').textContent = `¬• ${amount.toFixed(2)}`;
});
document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
    const amount = parseFloat(e.target.value) || 0;
    document.getElementById('rp-direct-total').textContent = `¬• ${amount.toFixed(2)}`;
});

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°ú Ï∂îÍ∞ÄÎê®„ÄëÏù¥Î≤§Ìä∏ ÏúÑÏûÑÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÌôçÎ∞îÏò§ ÌÅ¥Î¶≠ÏùÑ Ï≤òÎ¶¨ÌïòÍ≥†, ÎπÑÌôúÏÑ±Ìôî Î¨∏Ï†úÎ•º ÏàòÏ†ïÌï©ÎãàÎã§ ‚ñº‚ñº‚ñº
document.getElementById('chat-messages').addEventListener('click', (e) => {
    // 1. ÌÅ¥Î¶≠Îêú ÌôçÎ∞îÏò§ Ïπ¥ÎìúÎ•º Ï∞æÏäµÎãàÎã§
    const packetCard = e.target.closest('.red-packet-card');
    if (!packetCard) return; // ÎßåÏïΩ ÌÅ¥Î¶≠Îêú Í≤ÉÏù¥ ÌôçÎ∞îÏò§Í∞Ä ÏïÑÎãàÎ©¥, ÏïÑÎ¨¥Í≤ÉÎèÑ ÌïòÏßÄ ÏïäÏäµÎãàÎã§

    // 2. ÌôçÎ∞îÏò§ Ïπ¥ÎìúÏùò Î∂ÄÎ™® ÏöîÏÜå .messageÏóêÏÑú-bubbleÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Í∞ÄÏ†∏ÏòµÎãàÎã§
    const messageBubble = packetCard.closest('.message-bubble');
    if (!messageBubble || !messageBubble.dataset.timestamp) return;

    // 3. Ïö∞Î¶¨Ïùò Í∏∞Ï°¥ Ï≤òÎ¶¨ Ìï®ÏàòÎ•º Ìò∏Ï∂úÌï©ÎãàÎã§
    const timestamp = parseInt(messageBubble.dataset.timestamp);
    handlePacketClick(timestamp);
});
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Ï¢ÖÎ£å ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëÌà¨Ìëú Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ‚ñº‚ñº‚ñº
// ÏûÖÎ†•Ï∞Ω Ìà¥Î∞îÏóê Î≤ÑÌäº Ï∂îÍ∞Ä
document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);

// Ìà¨Ìëú ÏÉùÏÑ± Î™®Îã¨ Ï∞ΩÏùò Î≤ÑÌäº
document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
    document.getElementById('create-poll-modal').classList.remove('visible');
});
document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);

// Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ Ìà¨Ìëú Ïπ¥Îìú ÎÇ¥Ïùò Î™®Îì† ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏Î•º Ï≤òÎ¶¨Ìï©ÎãàÎã§
document.getElementById('chat-messages').addEventListener('click', (e) => {
    const pollCard = e.target.closest('.poll-card');
    if (!pollCard) return;

    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
    if (isNaN(timestamp)) return;
    
    // ÏòµÏÖòÏùÑ ÌÅ¥Î¶≠ÌñàÏäµÎãàÎã§
    const optionItem = e.target.closest('.poll-option-item');
    if (optionItem && !pollCard.classList.contains('closed')) {
        handleUserVote(timestamp, optionItem.dataset.option);
        return;
    }
    
    // Ïï°ÏÖò Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌñàÏäµÎãàÎã§(Ìà¨Ìëú Ï¢ÖÎ£å/Í≤∞Í≥º Î≥¥Í∏∞)
    const actionBtn = e.target.closest('.poll-action-btn');
    if (actionBtn) {
        if (pollCard.classList.contains('closed')) {
            showPollResults(timestamp);
        } else {
            endPoll(timestamp);
        }
        return;
    }

    // ÎßåÏïΩ Ïù¥ÎØ∏ Ï¢ÖÎ£åÎêú Ìà¨ÌëúÎùºÎ©¥, Ïπ¥ÎìúÏùò Ïñ¥Îñ§ Í≥≥Ïù¥Îì† ÌÅ¥Î¶≠ÌïòÏó¨ Í≤∞Í≥ºÎ•º ÌôïÏù∏Ìï† Ïàò ÏûàÏäµÎãàÎã§
    if (pollCard.classList.contains('closed')) {
        showPollResults(timestamp);
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

  // ‚ñº‚ñº‚ñº „ÄêÏÉàÎ°úÏö¥„ÄëAIÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ Í∞§Îü¨Î¶¨ Í∏∞Îä• Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî© ‚ñº‚ñº‚ñº
document.getElementById('manage-ai-avatar-library-btn').addEventListener('click', openAiAvatarLibraryModal);
document.getElementById('add-ai-avatar-btn').addEventListener('click', addAvatarToLibrary);
document.getElementById('close-ai-avatar-library-btn').addEventListener('click', closeAiAvatarLibraryModal);
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉàÎ°úÏö¥ Ï∂îÍ∞Ä ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº init() Ïùò‰∫ã‰ª∂ÁõëÂê¨Íµ¨Ïó≠,Á≤òË¥¥ËøôÊÆµ„ÄêÏÉà ÏΩîÎìú„Äë‚ñº‚ñº‚ñº
document.getElementById('icon-settings-grid').addEventListener('click', async (e) => {
    if (e.target.classList.contains('change-icon-btn')) {
        const item = e.target.closest('.icon-setting-item');
        const iconId = item.dataset.iconId;
        if (!iconId) return;

        const currentUrl = state.globalSettings.appIcons[iconId];
        const newUrl = await showCustomPrompt(`Î≥ÄÍ≤Ω\"${item.querySelector('.icon-preview').alt}\"ÏïÑÏù¥ÏΩò`, 'ÏÉàÎ°úÏö¥ Ïù¥ÎØ∏ÏßÄ URLÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî', currentUrl, 'url');

        if (newUrl && newUrl.trim().startsWith('http')) {
            // Ïò§ÏßÅ Î©îÎ™®Î¶¨ÏóêÏÑúÎßå ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎ©∞, ÏÇ¨Ïö©Ïûê ÌÅ¥Î¶≠ÏùÑ Í∏∞Îã§Î¶ΩÎãàÎã§\"Ï†ÄÏû•\"
            state.globalSettings.appIcons[iconId] = newUrl.trim();
            // ÏÑ§Ï†ï ÌéòÏù¥ÏßÄÏùò ÎØ∏Î¶¨Î≥¥Í∏∞ Ïù¥ÎØ∏ÏßÄÎ•º Ïã§ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
            item.querySelector('.icon-preview').src = newUrl.trim();
        } else if (newUrl !== null) {
            alert("Ïú†Ìö®Ìïú URLÏùÑ ÏûÖÎ†•Ìï¥ Ï£ºÏÑ∏Ïöî!");
        }
    }
});
// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº init() Ìï®ÏàòÏùò ÎÅùÏóê Ïù¥ Î∂ÄÎ∂ÑÏùÑ Î∂ôÏó¨ÎÑ£Í∏∞„ÄêÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà„Äë ‚ñº‚ñº‚ñº

    document.getElementById('chat-messages').addEventListener('click', (e) => {
        // .closestÎ•º ÏÇ¨Ïö©Ìï©ÎãàÎã§() ÌÅ¥Î¶≠Îêú Ïπ¥ÎìúÎ•º ÏúÑÏ™ΩÏúºÎ°ú Ï∞æÏäµÎãàÎã§
        const linkCard = e.target.closest('.link-share-card');
        if (linkCard) {
            const timestamp = parseInt(linkCard.dataset.timestamp);
            if (!isNaN(timestamp)) {
                openBrowser(timestamp); // Ïö∞Î¶¨Ïùò Ìï®ÏàòÎ•º Ìò∏Ï∂úÌï©ÎãàÎã§
            }
        }
    });

    // Î∏åÎùºÏö∞Ï†Ä Îí§Î°ú Í∞ÄÍ∏∞ Î≤ÑÌäºÏùò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§Îãù. Í∑∏Í≤ÉÏù¥ Ïò§ÏßÅ Ìïú Î≤àÎßå Î∞îÏù∏Îî©ÎêòÎèÑÎ°ù ÌôïÏã§Ìûà Ìï©ÎãàÎã§
    document.getElementById('browser-back-btn').addEventListener('click', () => {
        showScreen('chat-interface-screen');
    });

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

// ‚ñº‚ñº‚ñº init() Ìï®ÏàòÏùò ÎÅùÏóê Ïù¥ Î∂ÄÎ∂ÑÏùÑ Î∂ôÏó¨ÎÑ£Í∏∞„ÄêÏôÑÏ†ÑÌûà ÏÉàÎ°úÏö¥ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà„Äë ‚ñº‚ñº‚ñº

    // 1. ÏûÖÎ†•Ï∞Ω ÏÉÅÎã® Î∞îÏù∏Îî©\"ÎßÅÌÅ¨ Í≥µÏú†\"Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);

    // 2. Î∞îÏù∏Îî©Ê®°ÊÄÅÊ°Ü‰∏≠\"Ï∑®ÏÜå\"Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
        document.getElementById('share-link-modal').classList.remove('visible');
    });

    // 3. Î∞îÏù∏Îî©Ê®°ÊÄÅÊ°Ü‰∏≠\"Í≥µÏú†\"Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
    document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);

// ‚ñ≤‚ñ≤‚ñ≤ ÏÉà ÏΩîÎìú Î∂ôÏó¨ÎÑ£Í∏∞ ÎÅù ‚ñ≤‚ñ≤‚ñ≤

        // ===================================================================
        // 5. ÏãúÏûë!
            
            showScreen('home-screen');
        }

        init();
    });
</script>
</body>
</html>
